<div id="Approx_VC_Hoare">
<div class="head">
<h1>Theory Approx_VC_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Vertex Cover"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Approx_VC_Hoare
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm is classical, the proof is based on and augments the one
by Berghammer and M\"uller-Olm \cite{BerghammerM03}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Graph"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A graph is simply a set of edges, where an edge is a 2-element set.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vertex_cover</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vertex_cover</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="bound">e</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">matching</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matching</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> pairwise disjnt <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_matching_vertex_cover<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">C</span><span class="main">;</span>  matching <span class="free">M</span><span class="main">;</span>  <span class="free">M</span> <span class="main">⊆</span> <span class="free">E</span><span class="main">;</span>  vertex_cover <span class="free">E</span> <span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span> card <span class="free">M</span> <span class="main">≤</span> card <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> card_le_if_inj_on_rel<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">e</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">v</span></span> <span class="main"><span class="main">∈</span></span> <span class="bound"><span class="bound">e</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> disjnt_def disjnt_iff vertex_cover_def subsetCE<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> disjnt_iff pairwise_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The Approximation Algorithm"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Formulated using a simple(!) predefined Hoare-logic.
This leads to a streamlined proof based on standard invariant reasoning.

The nondeterministic selection of an element from a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F›</span></span></span></span> is simulated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">F</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SOME›</span></span></span></span> operator is built into HOL: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> that satisfies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>
if such an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> exists; otherwise it denotes an arbitrary element. Note that there is no
actual nondeterminism involved: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is some fixed element
but in general we don't know which one. Proofs about <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SOME›</span></span></span></span> are notoriously tedious.
Typically it involves showing first that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> someI_ex<span class="antiquote"><span class="antiquote">}</span></span></span></span> implies
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">SOME</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. There are a number of (more) useful related theorems:
just click on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> someI_ex<span class="antiquote"><span class="antiquote">}</span></span></span></span> to be taken there.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Convenient notation for choosing an arbitrary element from a set:›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">some</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Edges <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edges2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> card <span class="free">e</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_matching</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
  <span class="main">(</span>matching <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">.</span> <span class="bound">e</span> <span class="main">∩</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">∧</span> vertex_cover <span class="main">(</span><span class="free">E</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> inv_matching <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">M</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of the invariant by the loop body:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invar_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">C</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> some <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> some <span class="free">F</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="main">(</span><span class="free">E</span><span class="main">-</span><span class="free">F</span><span class="main">)</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">C</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="skolem">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∩</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def inv_matching_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fe'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> edges2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> card_ge_0_finite<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∉</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edges2 <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> disj <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> card'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>insert <span class="var">?e</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∉</span> <span class="skolem">M</span>›</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> edges2 card finite_subset<span class="main">[</span><span class="operator">OF</span> m<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finE<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?e</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vc'<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="var">?e</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vertex_cover_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_matching <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="var">?e</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m card' <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> disj
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_matching_def Int_commute disjnt_def pairwise_insert<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> vc' fC fe' m' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> approx_vertex_cover<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">C</span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">F</span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  C <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  F <span class="main">:=</span> <span class="free">E</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">F</span> <span class="main">≠</span> <span class="main">{}</span>
  <span class="keyword1">INV</span> <span class="main">{</span>invar <span class="bound">C</span> <span class="bound">F</span><span class="main">}</span>
  <span class="keyword1">DO</span> C <span class="main">:=</span> <span class="bound">C</span> <span class="main">∪</span> some <span class="bound">F</span><span class="main">;</span>
     F <span class="main">:=</span> <span class="bound">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="bound">F</span><span class="main">.</span> some <span class="bound">F</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span>vertex_cover <span class="free">E</span> <span class="bound">C</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> finite <span class="bound">C'</span> <span class="main">∧</span> vertex_cover <span class="free">E</span> <span class="bound">C'</span> <span class="main">⟶</span> card <span class="bound">C</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="bound">C'</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_matching <span class="main">{}</span> <span class="free">E</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_matching_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def vertex_cover_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    post<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="free">E</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"matching <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def inv_matching_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"vertex_cover <span class="free">E</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">C'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> post<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">M</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_matching_vertex_cover<span class="main">[</span><span class="operator">OF</span> C'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> post<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> C'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> post<span class="main">(</span>1<span class="main">)</span> opt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale Graph *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Version for Hypergraphs"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Almost the same. We assume that the degree of every edge is bounded.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Bounded_Hypergraph <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edge_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> finite <span class="free">e</span> <span class="main">∧</span> card <span class="free">e</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_matching</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
  <span class="main">(</span>matching <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">.</span> <span class="bound">e</span> <span class="main">∩</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">∧</span> vertex_cover <span class="main">(</span><span class="free">E</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> inv_matching <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">M</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invar_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">C</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> some <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> some <span class="free">F</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="main">(</span><span class="free">E</span><span class="main">-</span><span class="free">F</span><span class="main">)</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"matching <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">C</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="skolem">M</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="skolem">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∩</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def inv_matching_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fe'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> edge_bnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">∉</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E1 <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> disj <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> card'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="main">(</span>insert <span class="var">?e</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∉</span> <span class="skolem">M</span>›</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> edge_bnd card finite_subset<span class="main">[</span><span class="operator">OF</span> m<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finE<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?e</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> vc'<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="var">?e</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vertex_cover_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> m'<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_matching <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="var">?e</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="free">F</span><span class="main">.</span> <span class="var">?e</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m card' <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> disj
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_matching_def Int_commute disjnt_def pairwise_insert<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">F</span> <span class="main">⊆</span> <span class="free">E</span>›</span></span> vc' fC fe' m' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> approx_vertex_cover_bnd<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">C</span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">F</span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  C <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  F <span class="main">:=</span> <span class="free">E</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">F</span> <span class="main">≠</span> <span class="main">{}</span>
  <span class="keyword1">INV</span> <span class="main">{</span>invar <span class="bound">C</span> <span class="bound">F</span><span class="main">}</span>
  <span class="keyword1">DO</span> C <span class="main">:=</span> <span class="bound">C</span> <span class="main">∪</span> some <span class="bound">F</span><span class="main">;</span>
     F <span class="main">:=</span> <span class="bound">F</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">e'</span></span> <span class="main">∈</span> <span class="bound">F</span><span class="main">.</span> some <span class="bound">F</span> <span class="main">∩</span> <span class="bound">e'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span>vertex_cover <span class="free">E</span> <span class="bound">C</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> finite <span class="bound">C'</span> <span class="main">∧</span> vertex_cover <span class="free">E</span> <span class="bound">C'</span> <span class="main">⟶</span> card <span class="bound">C</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="bound">C'</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_matching <span class="main">{}</span> <span class="free">E</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_matching_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def vertex_cover_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> invar_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">C</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    post<span class="main">:</span> <span class="quoted"><span class="quoted">"vertex_cover <span class="free">E</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"matching <span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def inv_matching_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"vertex_cover <span class="free">E</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">C'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> post<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> card <span class="skolem">M</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_matching_vertex_cover<span class="main">[</span><span class="operator">OF</span> C'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> post<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> C'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> card <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> post<span class="main">(</span>1<span class="main">)</span> opt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale Bounded_Hypergraph *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Approx_SC_Hoare">
<div class="head">
<h1>Theory Approx_SC_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Set Cover›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Approx_SC_Hoare
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="comment1">(* "HOL-Analysis.Harmonic_Numbers" *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a formalization of the set cover algorithm and proof
in the book by Kleinberg and Tardos \cite{KleinbergT06}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">harm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">harm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> inverse <span class="main">(</span>of_nat <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">(* For simplicity defined locally instead of importing HOL-Analysis.Harmonic_Numbers.
   Only the definition, no theorems are needed.
*)</span>

<span class="keyword1"><span class="command">locale</span></span> Set_Cover <span class="main">=</span> <span class="comment1">(* Set Cover *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> finite <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> w_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">w</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span> <span class="main">⊆</span> U"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> U_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite U"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">using</span></span> S_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_cover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> U <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sc</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">/</span> card <span class="main">(</span><span class="free">S</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cost_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> cost <span class="free">R</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> w_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cost R i = 0›</span></span></span></span> if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>card (S i ∩ R) = 0›</span></span></span></span>! Needs to be accounted for separately in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>min_arg›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min_arg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_arg</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_arg</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">min_arg</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">S</span> <span class="bound">j</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="free">S</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> cost <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">&lt;</span> cost <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> min_arg <span class="free">R</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>min_arg <span class="free">R</span> <span class="free">k</span><span class="main">)</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>min_arg <span class="free">R</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc.IH <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Suc.prems prem <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> IH <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="skolem">k</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> min_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">;</span> <span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> cost <span class="free">R</span> <span class="main">(</span>min_arg <span class="free">R</span> <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> cost <span class="free">R</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Suc.prems Suc.IH <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"cost <span class="free">R</span> <span class="main">(</span>min_arg <span class="free">R</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≤</span> cost <span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.prems False min_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>min_arg <span class="free">R</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness holds quite trivially for both m = 0 and m &gt; 0
      (assuming a set cover can be found at all, otherwise algorithm would not terminate).›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> set_cover_correct<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">R</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">C</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> nat set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> nat<span class="main">)</span>
  <span class="main">{</span>True<span class="main">}</span>
  R <span class="main">:=</span> U<span class="main">;</span> C <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">R</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">R</span> <span class="main">⊆</span> U <span class="main">∧</span> sc <span class="bound">C</span> <span class="main">(</span>U <span class="main">-</span> <span class="bound">R</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">DO</span>
  i <span class="main">:=</span> min_arg <span class="bound">R</span> <span class="free">m</span><span class="main">;</span>
  R <span class="main">:=</span> <span class="bound">R</span> <span class="main">-</span> <span class="free">S</span> <span class="bound">i</span><span class="main">;</span>
  C <span class="main">:=</span> <span class="bound">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span>sc <span class="bound">C</span> U<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> empty_cover<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> min_in_range<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">c_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c_exists</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> sum <span class="free">w</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> sum <span class="bound">c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span>
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="bound">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span>
                   <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟷</span> sc <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span>U <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⊆</span> U <span class="main">∧</span> c_exists <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sc <span class="free">C</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> U"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="bound">c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="bound">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>
                      <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">C</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_def c_exists_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">C</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sc <span class="free">C</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> U"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="bound">c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="bound">i</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="bound">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_def c_exists_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_init<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="main">{}</span> U"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="main">{}</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> U<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> U<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg w_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> U<span class="main">)</span><span class="main">)</span>
             <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> U<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">C</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≡</span> min_arg <span class="free">R</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">from</span></span> empty_cover<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> invD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> hyp <span class="main">=</span> invD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="comment1">― ‹Correctness›</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_in_range<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> hyp<span class="main">(</span>1<span class="main">)</span> S_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">from</span></span> hyp<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
      <span class="comment1">― ‹Set Cover grows›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">S</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> U_def hyp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> S_finite min_in_range<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="comment1">― ‹Proving properties of cost function›</span>
    <span class="keyword1"><span class="command">from</span></span> hyp<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="skolem">c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      SUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>
        <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="keyword1">then</span> cost <span class="free">R</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="skolem">c</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

      <span class="comment1">― ‹Proof of Lemma 11.9›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U_finite S_finite min_in_range<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> U_split<span class="main">:</span> <span class="quoted"><span class="quoted">"U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> U <span class="main">-</span> <span class="free">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hyp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">*</span> cost <span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">w</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cost_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∩</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hyp<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sum.union_disjoint<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">w</span> <span class="free">C</span> <span class="main">+</span> <span class="free">w</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hyp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="main">(</span><span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹Lemma 11.9›</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="skolem">c</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="var">?c</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="bound">i</span>›</span></span> cost_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="comment1">― ‹Proof of Lemma 11.10›</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">=</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rem</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="free">R</span>"</span></span> <span class="comment1">― ‹Remaining elements to be covered›</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?add</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span>"</span></span> <span class="comment1">― ‹Elements that will be covered in this step›</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cov</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹Covered elements›</span>

      <span class="comment1">― ‹Transforming left and right sides›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="free">R</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="free">i</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> U_split <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="main">(</span><span class="var">?cov</span> <span class="main">∪</span> <span class="var">?add</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_Un_distrib Int_assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="var">?cov</span> <span class="main">+</span> sum <span class="var">?c</span> <span class="var">?add</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> S_finite <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="var">?c</span> <span class="var">?cov</span> <span class="main">+</span> sum <span class="var">?c</span> <span class="var">?add</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rem</span> <span class="main">-</span> <span class="var">?add</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?rem</span> <span class="main">-</span> <span class="var">?add</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S_finite <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> rhs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="comment1">― ‹The apparent complexity of the remaining proof is deceiving. Much of this is just about
          convincing Isabelle that these sum transformations are allowed.›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="var">?add</span> <span class="main">=</span> card <span class="var">?add</span> <span class="main">*</span> cost <span class="free">R</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="var">?add</span> <span class="main">*</span> cost <span class="free">R</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?rem</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?add</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_eq_0_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">from</span></span> min_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cost <span class="free">R</span> <span class="free">i</span> <span class="main">≤</span> cost <span class="free">R</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="var">?add</span> <span class="main">*</span> inverse <span class="main">(</span>card <span class="var">?rem</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cost_def divide_inverse_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="main">(</span>card <span class="var">?rem</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?add</span> <span class="main">≤</span> card <span class="var">?rem</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S_finite <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="main">(</span>card <span class="var">?rem</span><span class="main">)</span> <span class="main">≤</span> inverse <span class="bound">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="main">(</span>card <span class="var">?rem</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> w_nonneg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="var">?add</span>
                 <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SUM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="var">?cov</span> 
                           <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">+</span>
                        <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> sum_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">⟹</span> sum <span class="skolem">f</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> sum <span class="skolem">f</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">+</span> sum <span class="skolem">f</span> <span class="main">{</span>Suc <span class="skolem">b</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span>"</span></span>
            <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">nat</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="skolem">b</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span>Suc <span class="skolem">b</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">..</span> <span class="skolem">c</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost sum.union_disjoint<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span>
              <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="var">?rem</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span>
              <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="var">?rem</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="var">?add</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="var">?add</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="var">?rem</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> S_finite <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>card <span class="var">?rem</span> <span class="main">-</span> card <span class="var">?add</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?rem</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?rem</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> S_finite <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_split<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span>U <span class="main">-</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span>card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span> <span class="main">∩</span> <span class="main">(</span><span class="free">R</span> <span class="main">-</span> <span class="free">S</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> card <span class="main">(</span><span class="free">S</span> <span class="skolem">k</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> inverse <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rhs <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cover_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sc <span class="free">C</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">c</span> <span class="free">V</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">C</span><span class="main">.</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> V_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> insert <span class="skolem">i</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">S</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert S_finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">-</span> sum <span class="free">c</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">c</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> insert <span class="skolem">i</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">c</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> V_split <span class="keyword1"><span class="command">using</span></span> sum_Un<span class="main">[</span><span class="operator">OF</span> finite<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="skolem">i</span> <span class="skolem">C</span><span class="main">.</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="skolem">C</span><span class="main">.</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">c</span> <span class="main">(</span><span class="free">S</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≡</span> harm"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d_star</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">d<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main">≡</span> Max <span class="main">(</span>card <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_cover_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">C</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"sc <span class="free">C'</span> U"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="free">C</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> sum <span class="free">w</span> <span class="free">C'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> invD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="skolem">c</span> U"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H_bound<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> H <span class="main">(</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span>"</span></span> <span class="comment1">― ‹Lemma 11.10›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> harm_def Int_absorb2 S_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_star_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> H <span class="main">(</span>card <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> harm_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H_bound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> <span class="free">w</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff atLeastatMost_empty_iff empty_iff mult_right_mono w_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">C'</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> <span class="free">w</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">C'</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> sum <span class="free">w</span> <span class="free">C'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">w</span> <span class="free">C</span> <span class="main">=</span> sum <span class="skolem">c</span> U"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span> <span class="comment1">― ‹Lemma 11.9›</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">C'</span><span class="main">.</span> sum <span class="skolem">c</span> <span class="main">(</span><span class="free">S</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cover_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> sum <span class="free">w</span> <span class="free">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> set_cover_approx<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">R</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">C</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> nat set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> nat<span class="main">)</span>
  <span class="main">{</span>True<span class="main">}</span>
  R <span class="main">:=</span> U<span class="main">;</span> C <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">R</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span>inv <span class="bound">C</span> <span class="bound">R</span><span class="main">}</span> <span class="keyword1">DO</span>
  i <span class="main">:=</span> min_arg <span class="bound">R</span> <span class="free">m</span><span class="main">;</span>
  R <span class="main">:=</span> <span class="bound">R</span> <span class="main">-</span> <span class="free">S</span> <span class="bound">i</span><span class="main">;</span>
  C <span class="main">:=</span> <span class="bound">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span>sc <span class="bound">C</span> U <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C'</span><span class="main">.</span> sc <span class="bound">C'</span> U <span class="main">⟶</span> sum <span class="free">w</span> <span class="bound">C</span> <span class="main">≤</span> H <span class="keyword1">d<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">*</span> sum <span class="free">w</span> <span class="bound">C'</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_init<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_step <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">R</span> <span class="skolem">C</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sc <span class="skolem">C</span> U"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> set_cover_bound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Set Cover *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span>
</pre>
</div><div id="Approx_MIS_Hoare">
<div class="head">
<h1>Theory Approx_MIS_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Independent Set"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Approx_MIS_Hoare
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm is classical, the proofs are inspired by the ones
by Berghammer and M\"uller-Olm \cite{BerghammerM03}.
In particular the approximation ratio is improved from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ+1›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Graph"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A set set is simply a set of edges, where an edge is a 2-element set.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">independent_vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">independent_vertices</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊆</span> <span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Graph_E <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_E<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edges2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> card <span class="free">e</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vertices</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vertices</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≡</span> vertices <span class="free">E</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">approximation_miv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">approximation_miv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> independent_vertices <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">S'</span><span class="main">.</span> independent_vertices <span class="free">E</span> <span class="bound">S'</span> <span class="main">⟶</span> card <span class="bound">S'</span> <span class="main">≤</span> card <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">neighbors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">neighbors</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="main">{</span><span class="bound">u</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="main">∈</span> <span class="free">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">degree_vertex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">degree_vertex</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> card <span class="main">(</span>neighbors <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Δ</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">≡</span> Max<span class="main">{</span>degree_vertex <span class="bound">u</span><span class="main">|</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> finite <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_ge_0_finite <span class="keyword2"><span class="keyword">and</span></span> edges2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_V<span class="main">:</span> <span class="quoted"><span class="quoted">"finite V"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_edges <span class="keyword2"><span class="keyword">and</span></span> finite_E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_neighbors<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>neighbors <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_V <span class="keyword2"><span class="keyword">and</span></span> rev_finite_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted">V</span> <span class="quoted"><span class="quoted">"neighbors <span class="free">u</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> independent_vertices_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span> <span class="main">⟹</span> finite <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_finite_subset independent_vertices_def vertices.simps finite_V<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> edge_ex_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">e</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edges2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≠</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_eq_SucD insertI1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_pos <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> Δ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> edges2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>degree_vertex <span class="bound">u</span> <span class="main">|</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_V finite_imageI Setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Δ <span class="main">∈</span> <span class="main">{</span>degree_vertex <span class="bound">u</span> <span class="main">|</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Δ <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> V"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"degree_vertex <span class="skolem">u</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="skolem">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">}</span> <span class="main">≠</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_neighbors insert_absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> edge_ex_vertices <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">0</span> <span class="main">&lt;</span> Δ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Δ_max_degree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V <span class="main">⟹</span> degree_vertex <span class="free">u</span> <span class="main">≤</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> V"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>degree_vertex <span class="bound">u</span> <span class="main">|</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> V<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_V finite_imageI Setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree_vertex <span class="free">u</span> <span class="main">≤</span> Δ"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wei's algorithm: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(Δ+1)›</span></span></span></span>-approximation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The 'functional' part of the invariant, used to prove that the algorithm produces an independent set of vertices.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inv_iv</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> independent_vertices <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
            <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⊆</span> V
            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v1</span> <span class="main">∈</span> <span class="main">(</span>V <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">{</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span><span class="main">)</span>
            <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strenghten the invariant with an approximation ratio <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_approx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inv_approx</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> inv_iv <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≤</span> card <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of the functional invariant:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_preserv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_iv <span class="free">S</span> <span class="free">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> V"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">∈</span> <span class="main">(</span>V <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> finite_S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv1 <span class="keyword2"><span class="keyword">and</span></span> independent_vertices_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> S1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv4 <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv1 <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> S3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">v2</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">{</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span>
          <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>d<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> a <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> edges2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> b <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> c <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> doubleton_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> d <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* invariant conjunct 1 *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S3 <span class="keyword2"><span class="keyword">and</span></span> inv1 <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* invariant conjunct 2 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> V"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> neighbors <span class="free">x</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> V"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> a
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> b
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> c
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* invariant conjunct 3 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* invariant conjunct 4 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> V <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">v2</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">{</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> V <span class="main">-</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> insert <span class="free">x</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">}</span> <span class="main">∉</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> a
      <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∉</span> neighbors <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> b
      <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> b <span class="keyword2"><span class="keyword">and</span></span> inv4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* conclusion *)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_approx_preserv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_approx <span class="free">S</span> <span class="free">X</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_approx <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite_S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> independent_vertices_finite
    <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(* main invariant is preserved *)</span>
  <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="free">S</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> inv_preserv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* the approximation ratio is preserved (at most Δ+1 vertices are removed in any iteration) *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree_vertex <span class="free">x</span> <span class="main">≤</span> Δ"</span></span> <span class="keyword1"><span class="command">using</span></span> Δ_max_degree <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> Δ <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"neighbors <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">X</span> <span class="main">+</span> Δ <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> Δ <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_S <span class="keyword2"><span class="keyword">and</span></span> Sx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* conclusion *)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv_approx <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* the antecedent combines inv_approx (for an arbitrary ratio r) and the negated post-condition *)</span>
<span class="keyword1"><span class="command">lemma</span></span> inv_approx<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span> <span class="main">⟹</span> card V <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">r</span> <span class="main">⟹</span> approximation_miv <span class="free">r</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card V <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="skolem">S'</span> <span class="main">⟹</span> card <span class="skolem">S'</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">⊆</span> V"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S'</span> <span class="main">≤</span> card V"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_V <span class="keyword2"><span class="keyword">and</span></span> card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S'</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"approximation_miv <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> approximation_miv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wei_approx_Δ_plus_1<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">S</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">X</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>
  <span class="main">{</span> True <span class="main">}</span>
  S <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  X <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">X</span> <span class="main">≠</span> V
  <span class="keyword1">INV</span> <span class="main">{</span> inv_approx <span class="bound">S</span> <span class="bound">X</span> <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">}</span>
  <span class="keyword1">DO</span> x <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="bound">X</span><span class="main">)</span><span class="main">;</span>
     S <span class="main">:=</span> insert <span class="bound">x</span> <span class="bound">S</span><span class="main">;</span>
     X <span class="main">:=</span> <span class="bound">X</span> <span class="main">∪</span> neighbors <span class="bound">x</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span> approximation_miv <span class="main">(</span>Δ <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">S</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant initially true *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant preserved by loop *)</span>
  <span class="comment1">(* definedness of assignment *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V <span class="main">-</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_approx_preserv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant implies post-condition *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_approx <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wei's algorithm: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span>-approximation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The previous approximation uses very little information about the optimal solution (it has at most as many vertices as the set itself). With some extra effort we can improve the ratio to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span> instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ+1›</span></span></span></span>. In order to do that we must show that among the vertices removed in each iteration, at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span> could belong to an optimal solution. This requires carrying around a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> (via a ghost variable) which records the vertices deleted in each iteration.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inv_partition</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> inv_iv <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>
                     <span class="main">∧</span> <span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> V<span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="bound">s</span><span class="main">)</span>
                     <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> card <span class="free"><span class="bound"><span class="entity">S</span></span></span>
                     <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_partition_preserv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_partition <span class="free">S</span> <span class="free">X</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_partition <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite_S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> independent_vertices_finite
    <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(* main invariant is preserved *)</span>
  <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="free">S</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> inv_preserv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* conjunct 1 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* conjunct 2 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> V<span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* conjunct 3 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> x_def <span class="keyword2"><span class="keyword">and</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">⋃</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> card <span class="free">P</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="free">S</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Sx <span class="keyword2"><span class="keyword">and</span></span> finite_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* conjunct 4 *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">(* conclusion *)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv_partition <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="free">x</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Union_le_sum_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> finite <span class="bound">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="free">U</span><span class="main">)</span> <span class="main">≤</span> sum card <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="free">U</span><span class="main">)</span> <span class="main">≤</span> sum card <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_eq_0_iff finite_UnionD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="free">U</span><span class="main">)</span> <span class="main">≤</span> sum card <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="main">⋃</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card<span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">⋃</span><span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card<span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> sum card <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.insert_if <span class="keyword2"><span class="keyword">and</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* this lemma could be more generally about U :: "nat set", but this makes its application more difficult later *)</span>
<span class="keyword1"><span class="command">lemma</span></span> sum_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum card <span class="free">U</span> <span class="main">≤</span> card <span class="free">U</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">U</span> <span class="main">∨</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum card <span class="free">U</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum card <span class="free">U</span> <span class="main">≤</span> card <span class="free">U</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>infinite <span class="free">U</span> <span class="main">∨</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum card <span class="free">U</span> <span class="main">≤</span> card <span class="free">U</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="skolem">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"sum card <span class="skolem">F</span> <span class="main">≤</span> card <span class="skolem">F</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">x</span> <span class="main">+</span> sum card <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.insert_if <span class="keyword2"><span class="keyword">and</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> card <span class="skolem">F</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_insert_if <span class="keyword2"><span class="keyword">and</span></span> insert.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* among the vertices deleted in each iteration, at most Δ can belong to an independent set of
   vertices: the chosen vertex or (some of) its neighbors *)</span>
<span class="keyword1"><span class="command">lemma</span></span> x_or_neighbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> V<span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="bound">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ivS<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> Δ"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> V <span class="main">∧</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> Δ"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> neighbors <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ivS <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_singletonD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Δ"</span></span> <span class="keyword1"><span class="command">using</span></span> Δ_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> Δ"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> a
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ivS <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> b
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span> <span class="main">⊆</span> neighbors <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> degree_vertex <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_mono <span class="keyword2"><span class="keyword">and</span></span> finite_neighbors <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> Δ"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> Δ_max_degree <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* the premise combines the invariant and the negated post-condition *)</span>
<span class="keyword1"><span class="command">lemma</span></span> inv_partition_approx<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_partition <span class="free">S</span> V <span class="free">P</span> <span class="main">⟹</span> approximation_miv Δ <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> H1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_partition <span class="free">S</span> V <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="skolem">S'</span> <span class="main">⟹</span> card <span class="skolem">S'</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> Δ"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">S'</span> <span class="main">∩</span> <span class="bound">p</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="comment1">(* split the optimal solution among the sets of P, which cover V so no element is
       lost. We obtain a cover of S' and show the required bound on its cardinality *)</span>
    <span class="keyword3"><span class="command">assume</span></span> H2<span class="main">:</span> <span class="quoted"><span class="quoted">"independent_vertices <span class="free">E</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">⊆</span> V"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> independent_vertices_def <span class="keyword1"><span class="command">using</span></span> vertices.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> H1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="skolem">S'</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="skolem">S'</span> <span class="main">∩</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Int_Union <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">⋃</span><span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H2 <span class="keyword2"><span class="keyword">and</span></span> independent_vertices_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="skolem">S'</span> <span class="main">∩</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S'</span> <span class="main">≤</span> sum card <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Union_le_sum_card <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="var">?I</span> <span class="main">*</span> Δ"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_or_neighbors <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">S'</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> sum_card <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="quoted">Δ</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> H1 <span class="keyword2"><span class="keyword">and</span></span> H2 <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">*</span> Δ"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?I</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Setcompr_eq_image <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">S'</span> <span class="main">∩</span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> card_image_le <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="free">S</span> <span class="main">*</span> Δ"</span></span> <span class="keyword1"><span class="command">using</span></span> H1 <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S'</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> Δ"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"approximation_miv Δ <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> approximation_miv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wei_approx_Δ<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">S</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">X</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>
  <span class="main">{</span> True <span class="main">}</span>
  S <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  X <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">X</span> <span class="main">≠</span> V
  <span class="keyword1">INV</span> <span class="main">{</span> <span class="main">∃</span><span class="bound">P</span><span class="main">.</span> inv_partition <span class="bound">S</span> <span class="bound">X</span> <span class="bound">P</span> <span class="main">}</span>
  <span class="keyword1">DO</span> x <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="bound">X</span><span class="main">)</span><span class="main">;</span>
     S <span class="main">:=</span> insert <span class="bound">x</span> <span class="bound">S</span><span class="main">;</span>
     X <span class="main">:=</span> <span class="bound">X</span> <span class="main">∪</span> neighbors <span class="bound">x</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span> approximation_miv Δ <span class="bound">S</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant initially true *)</span>
  <span class="comment1">(* the invariant is initially true with the ghost variable P := {} *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_partition <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def inv_iv_def independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant preserved by loop *)</span>
  <span class="comment1">(* definedness of assignment *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_partition <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V <span class="main">-</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> inv_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">(* show that the invariant is true with the ghost variable P := insert ({?x} ∪ neighbors ?x) P *)</span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_partition <span class="main">(</span>insert <span class="var">?x</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> neighbors <span class="var">?x</span> <span class="main">∪</span> <span class="main">{</span><span class="var">?x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="main">{</span><span class="var">?x</span><span class="main">}</span> <span class="main">∪</span> neighbors <span class="var">?x</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv_partition_preserv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="comment1">(* invariant implies post-condition *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_partition_approx <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Wei's algorithm with dynamically computed approximation ratio"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this subsection, we augment the algorithm with a variable used to compute the effective approximation ratio of the solution. In addition, the vertex of smallest degree is picked. With this heuristic, the algorithm achieves an approximation ratio of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(Δ+2)/3›</span></span></span></span>, but this is not proved here.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vertex_heuristic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vertex_heuristic</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> card <span class="main">(</span>neighbors <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>neighbors <span class="bound">u</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* this lemma is needed to show that there exist a vertex to be picked by the heuristic *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ex_min_finite_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">⟹</span> <span class="var">?P2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?minf</span> <span class="free">S</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?minf</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> Py<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?minf</span> <span class="skolem">F</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="var">?minf</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?minf</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Py <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?minf</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Py <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_approx_preserv2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_approx <span class="free">S</span> <span class="free">X</span> <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv_approx <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>card <span class="main">(</span>neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite_S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> independent_vertices_finite <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Sx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword2"><span class="keyword">and</span></span> x_def <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(* main invariant is preserved *)</span>
  <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="free">S</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv_iv <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> inv_preserv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* the approximation ratio is preserved *)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">*</span> max <span class="main">(</span>card <span class="main">(</span>neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="var">?N</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">X</span> <span class="main">+</span> card <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">s</span> <span class="main">+</span> card <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> max <span class="main">(</span>card <span class="var">?N</span><span class="main">)</span> <span class="free">s</span> <span class="main">+</span> card <span class="var">?N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">S</span> <span class="main">*</span> max <span class="main">(</span>card <span class="var">?N</span><span class="main">)</span> <span class="free">s</span> <span class="main">+</span> max <span class="main">(</span>card <span class="var">?N</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">*</span> max <span class="main">(</span>card <span class="var">?N</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Sx <span class="keyword2"><span class="keyword">and</span></span> finite_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">(* conclusion *)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv_approx <span class="main">(</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>card <span class="main">(</span>neighbors <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wei_approx_min_degree_heuristic<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">S</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">X</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">(</span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">r</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="main">::</span> nat<span class="main">)</span>
  <span class="main">{</span> True <span class="main">}</span>
  S <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  X <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  r <span class="main">:=</span> <span class="main">0</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">X</span> <span class="main">≠</span> V
  <span class="keyword1">INV</span> <span class="main">{</span> inv_approx <span class="bound">S</span> <span class="bound">X</span> <span class="bound">r</span> <span class="main">}</span>
  <span class="keyword1">DO</span> x <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="bound">X</span> <span class="main">∧</span> vertex_heuristic <span class="bound">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
     S <span class="main">:=</span> insert <span class="bound">x</span> <span class="bound">S</span><span class="main">;</span>
     r <span class="main">:=</span> max <span class="main">(</span>card <span class="main">(</span>neighbors <span class="bound">x</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">;</span>
     X <span class="main">:=</span> <span class="bound">X</span> <span class="main">∪</span> neighbors <span class="bound">x</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span> approximation_miv <span class="bound">r</span> <span class="bound">S</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="comment1">(* invariant initially true *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def independent_vertices_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="comment1">(* invariant preserved by loop *)</span>
  <span class="comment1">(* definedness of assignment *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span> <span class="main">∧</span> vertex_heuristic <span class="skolem">X</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V <span class="main">-</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>V <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> finite_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span> <span class="main">∧</span> vertex_heuristic <span class="skolem">X</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_min_finite_set <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> card <span class="main">(</span>neighbors <span class="bound">x</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vertex_heuristic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span> <span class="main">∧</span> vertex_heuristic <span class="skolem">X</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI_ex <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> V <span class="main">-</span> <span class="skolem">X</span> <span class="main">∧</span> vertex_heuristic <span class="skolem">X</span> <span class="bound">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_approx_preserv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv_approx <span class="keyword1"><span class="command">unfolding</span></span> inv_approx_def inv_iv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Approx_LB_Hoare">
<div class="head">
<h1>Theory Approx_LB_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Load Balancing›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Approx_LB_Hoare
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a formalization of the load balancing algorithms and proofs
in the book by Kleinberg and Tardos \cite{KleinbergT06}.›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sorted

<span class="comment1">(* TODO: mv *)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_le_card_Max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">≤</span> card <span class="free">A</span> <span class="main">*</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def order.trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="skolem">F</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">F</span> <span class="main">*</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">F</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Max_in image_is_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">=</span><span class="main">{}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f_Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f_Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f_Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f_Max<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le atLeastAtMostSuc_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">≤</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">=</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">m</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> atLeastAtMost_iff le_Suc_eq max.cobounded1 max.coboundedI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">T</span> <span class="free">x</span> <span class="main">⟹</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span> <span class="main">≤</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">m</span> <span class="main">≤</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_out_of_range <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">⟹</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fun_upd_f_Max<span class="hidden">⇩</span><sub>0</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> max <span class="free">y</span> <span class="main">(</span>f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> LoadBalancing <span class="main">=</span> <span class="comment1">(* Load Balancing *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Formalization of a Correct Load Balancing›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat set<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lb</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="comment1">― ‹No job is assigned to more than one machine›</span>
             <span class="main">∧</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span> <span class="comment1">― ‹Every job is assigned›</span>
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="comment1">― ‹The processing times sum up to the correct load›</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">makespan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">makespan</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> f_Max<span class="hidden">⇩</span><sub>0</sub> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free">m</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> makespan_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"makespan <span class="free">T</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">T</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_equiv<span class="main">)</span>
<span class="comment1">(*
lemma makespan_correct:
  "∀x ∈ {1..m}. T x ≤ makespan T m"
  "m &gt; 0 ⟹ ∃x ∈ {1..m}. T x = makespan T m"
   apply (induction m)
     apply simp_all
   apply (metis atLeastAtMost_iff le_Suc_eq max.cobounded1 max.coboundedI2)
  subgoal for m by (cases ‹m = 0›) (auto simp: max_def)
  done

lemma no_machines_lb_iff_no_jobs: "lb T A j 0 ⟷ j = 0"
  unfolding lb_def by auto

lemma machines_if_jobs: "⟦ lb T A j m; j &gt; 0 ⟧ ⟹ m &gt; 0"
  using no_machines_lb_iff_no_jobs by (cases m) auto
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> makespan_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">=</span> makespan <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_correct m_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lbE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lbI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> A_lb_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lbE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms finite_UN finite_atLeastAtMost<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A x›</span></span></span></span> is pairwise disjoint for all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ∈ {1..m}›</span></span></span></span>, then the the sum over the sums of the
      individual <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A x›</span></span></span></span> is equal to the sum over the union of all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A x›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_sum_eq_sum_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> finite <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∪</span> <span class="free">A</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint<span class="main">[</span><span class="operator">OF</span> FINITE DISJNT<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UN_insert image_Suc_lessThan image_insert inf_sup_aci<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> are a correct load balancing for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> jobs and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> machines, 
      then the sum of the loads has to be equal to the sum of the processing times of the jobs›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lb_impl_job_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lbrules <span class="main">=</span> lbE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> finite <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_sum_eq_sum_Un<span class="main">[</span><span class="operator">OF</span> lbrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> FINITE<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lower Bounds for the Makespan›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> are a correct load balancing for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> jobs and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> machines, then the processing time
      of any job <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ∈ {1..j}›</span></span></span></span> is a lower bound for the load of some machine <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y ∈ {1..m}›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> job_lower_bound_machine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">T</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lbrules <span class="main">=</span> lbE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> y_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">y</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> member_le_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">T</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> y_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As the load of any machine is a lower bound for the makespan, the processing time 
      of any job <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ∈ {1..j}›</span></span></span></span> has to also be a lower bound for the makespan.
      Follows from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] job_lower_bound_machine<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] makespan_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> job_lower_bound_makespan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">x</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> job_lower_bound_machine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> makespan_correct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The makespan over <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> jobs is a lower bound for the makespan of any correct load balancing for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> jobs.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> max_job_lower_bound_makespan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">t</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> job_lower_bound_makespan<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> job_dist_lower_bound_makespan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="free">m</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> makespan <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms lb_impl_job_sum<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> sum_le_card_Max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span><span class="main">]</span> m_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> makespan_def'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="main">*</span> real <span class="main">(</span>makespan <span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> of_nat_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> m_gt_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Greedy Approximation Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This function will perform a linear scan from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k ∈ {1..m}›</span></span></span></span> and return the index of the machine with minimum load assuming <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m &gt; 0›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min<span class="hidden">⇩</span><sub>k</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min<span class="hidden">⇩</span><sub>k</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">min<span class="hidden">⇩</span><sub>k</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="free">T</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def le_Suc_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_in_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_job<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lb <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">A</span> <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹lb <span class="var">?T</span> <span class="var">?A</span> <span class="main">_</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lbrules <span class="main">=</span> lbE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>

  <span class="comment1">― ‹Rule 1: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> pairwise disjoint›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> Suc <span class="free">j</span> <span class="main">∉</span> <span class="free">A</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟶</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="var">?A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 2: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> contains all jobs›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> UNION_fun_upd assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Rule 3: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> sums to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?T</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span> <span class="free">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="free">x</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">x</span> <span class="main">∩</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NOTIN assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span> <span class="free">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="free">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span> <span class="free">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="var">?A</span> <span class="bound">i</span><span class="main">.</span> <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> lbI<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> makespan_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">T</span> <span class="free">x</span> <span class="main">⟹</span> makespan <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> makespan <span class="free">T</span> <span class="main">≤</span> makespan <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smaller_optimum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free">j</span> <span class="main">∧</span> makespan <span class="bound">T'</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> lbrules <span class="main">=</span> lbE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> Suc <span class="free">j</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹Rule 1: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> pairwise disjoint›</span>
  <span class="keyword1"><span class="command">from</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="var">?A</span> <span class="bound">x</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Rule 2: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> contains all jobs›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟶</span> Suc <span class="free">j</span> <span class="main">∉</span> <span class="free">A</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>1<span class="main">)</span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> UNION_fun_upd x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lbrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?A</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Rule 3: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?A</span></span><span class="antiquote">}</span></span> sums to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?T</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_diff1_nat x_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> x_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="var">?A</span> <span class="bound">i</span><span class="main">.</span> <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> x_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">makespan</span><span class="antiquote">}</span></span> is not larger›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lb <span class="var">?T</span> <span class="var">?A</span> <span class="free">j</span> <span class="main">∧</span> makespan <span class="var">?T</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbI<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> makespan_mono<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the processing time <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> does not contribute to the makespan, we can ignore it.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> remove_small_job<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"makespan <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"makespan <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> makespan <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">T</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> NOT_X<span class="main">:</span> <span class="quoted"><span class="quoted">"makespan <span class="var">?T</span> <span class="main">≠</span> <span class="var">?T</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> makespan <span class="var">?T</span> <span class="main">=</span> <span class="var">?T</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> makespan_correct<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"makespan <span class="var">?T</span> <span class="main">=</span> <span class="var">?T</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">T</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NOT_X <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"makespan <span class="free">T</span> <span class="main">=</span> <span class="free">T</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> antisym_conv le_add1 makespan_mono<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> makespan_correct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> greedy_makespan_no_jobs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"makespan <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> makespan_def'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_avg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">*</span> <span class="var">?T</span> <span class="main">≤</span> <span class="var">?S</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main"><span class="bound">_</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="var">?T</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?T</span>›</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> min_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat set<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>lb <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> makespan <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"lb <span class="free">T'</span> <span class="free">A'</span> <span class="free">j</span> <span class="main">⟹</span> makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="free">T'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free">j</span> <span class="main">⟶</span> makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">:=</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">A</span> <span class="main">(</span><span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">:=</span> <span class="free">A</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹inv<span class="hidden">⇩</span><sub>1</sub> <span class="var">?T</span> <span class="var">?A</span> <span class="main">_</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
  <span class="comment1">― ‹Greedy is correct›</span>
  <span class="keyword1"><span class="command">have</span></span> LB<span class="main">:</span> <span class="quoted"><span class="quoted">"lb <span class="var">?T</span> <span class="var">?A</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_job<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_in_range<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_gt_0<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹Greedy maintains approximation factor›</span>
  <span class="keyword1"><span class="command">have</span></span> MK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> makespan <span class="var">?T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lb <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> smaller_optimum<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lb <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"makespan <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"makespan <span class="var">?T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹makespan <span class="var">?T</span> <span class="main">=</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_avg<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lb_impl_job_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">m</span> <span class="main">*</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> of_nat_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> m_gt_0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> job_dist_lower_bound_makespan<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lb <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">j</span>›</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹makespan <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> job_lower_bound_makespan<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lb <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_small_job<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> LB _ MK<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> simple_greedy_approximation<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">T</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">A</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
<span class="main">{</span>True<span class="main">}</span>
T <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
A <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
j <span class="main">:=</span> <span class="main">0</span><span class="main">;</span>
<span class="keyword1">WHILE</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">INV</span> <span class="main">{</span>inv<span class="hidden">⇩</span><sub>1</sub> <span class="bound">T</span> <span class="bound">A</span> <span class="bound">j</span><span class="main">}</span> <span class="keyword1">DO</span>
  i <span class="main">:=</span> min<span class="hidden">⇩</span><sub>k</sub> <span class="bound">T</span> <span class="free">m</span><span class="main">;</span>
  j <span class="main">:=</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">;</span>
  A <span class="main">:=</span> <span class="bound">A</span> <span class="main">(</span><span class="bound">i</span> <span class="main">:=</span> <span class="bound">A</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">j</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
  T <span class="main">:=</span> <span class="bound">T</span> <span class="main">(</span><span class="bound">i</span> <span class="main">:=</span> <span class="bound">T</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="bound">j</span><span class="main">)</span>
<span class="keyword1">OD</span>
<span class="main">{</span>lb <span class="bound">T</span> <span class="bound">A</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free">n</span> <span class="main">⟶</span> makespan <span class="bound">T</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lb_def inv<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">t</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_smaller <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sorted <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">j'</span> <span class="main">⟧</span> <span class="main">⟹</span> sorted <span class="free">j'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sorted_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> j_gt_m_pigeonhole<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lbE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_mono finite_atLeastAtMost image_subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inj_on <span class="skolem">f</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pigeonhole <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> are a correct load balancing for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span> jobs and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> machines with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j &gt; m›</span></span></span></span>,
      and the jobs are sorted in descending order, then there exists a machine <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ∈ {1..m}›</span></span></span></span>
      whose load is at least twice as large as the processing time of job <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>j›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sorted_job_lower_bound_machine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">T</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Step 1: Obtaining the jobs›</span>
  <span class="keyword1"><span class="command">note</span></span> lbrules <span class="main">=</span> lbE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_gt_m_pigeonhole<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹Step 2: Jobs contained in sum›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> SUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>4-6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>

  <span class="comment1">― ‹Step 3: Proof of lower bound›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> *<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sorted_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="skolem">x</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SUM <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">T</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lbrules<span class="main">(</span>3<span class="main">)</span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning analogous to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] job_lower_bound_makespan<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sorted_job_lower_bound_makespan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">T</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_job_lower_bound_machine<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> makespan_correct<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="skolem">x</span> <span class="main">≤</span> makespan <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> x_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> min_zero_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> Suc <span class="skolem">k</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> min_in_range<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> min_zero<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> Suc.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat set<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>lb <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="free">n</span>
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> makespan <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span><span class="main">)</span> 
                <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
                <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟶</span> makespan <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">t</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"lb <span class="free">T'</span> <span class="free">A'</span> <span class="free">j</span> <span class="main">⟹</span> makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="free">T'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> <span class="free">j</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> makespan <span class="free">T</span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">t</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lb <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free">j</span> <span class="main">⟶</span> makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> <span class="free">j</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> makespan <span class="free">T</span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">t</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">T</span> <span class="free">A</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span> <span class="main">:=</span> <span class="free">T</span><span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span><span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="free">A</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span> <span class="main">:=</span> <span class="free">A</span><span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">‹inv<span class="hidden">⇩</span><sub>2</sub> <span class="var">?T</span> <span class="var">?A</span> <span class="main">_</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&gt;</span> <span class="free">m</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="comment1">― ‹Greedy is correct›</span>
  <span class="keyword1"><span class="command">have</span></span> LB<span class="main">:</span> <span class="quoted"><span class="quoted">"lb <span class="var">?T</span> <span class="var">?A</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_job<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_in_range<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_gt_0<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹Greedy maintains approximation factor›</span>
  <span class="keyword1"><span class="command">have</span></span> MK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> makespan <span class="var">?T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lb <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> smaller_optimum<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"lb <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"makespan <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"makespan <span class="free">T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"makespan <span class="var">?T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹makespan <span class="var">?T</span> <span class="main">=</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="free">T</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_avg<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lb_impl_job_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">m</span> <span class="main">*</span> <span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> of_nat_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> m_gt_0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> job_dist_lower_bound_makespan<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lb <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">j</span>›</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹makespan <span class="skolem">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> makespan <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sorted_job_lower_bound_makespan<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lb <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="free">j</span> <span class="main">&gt;</span> <span class="free">m</span>›</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> remove_small_job<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> Suc <span class="free">j</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> min_in_range<span class="main">[</span><span class="operator">OF</span> m_gt_0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> LB _ MK<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IN_RANGE<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹Greedy is correct›</span>
  <span class="keyword1"><span class="command">have</span></span> LB<span class="main">:</span> <span class="quoted"><span class="quoted">"lb <span class="var">?T</span> <span class="var">?A</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_job<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> min_in_range<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_gt_0<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹Greedy is trivially optimal›</span>
  <span class="keyword1"><span class="command">from</span></span> IN_RANGE <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span> <span class="main">≤</span> Suc <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_zero_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> EMPTY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> Suc <span class="free">j</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> IN_RANGE <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>min<span class="hidden">⇩</span><sub>k</sub> <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> fun_upd_f_Max<span class="hidden">⇩</span><sub>0</sub><span class="main">[</span><span class="operator">OF</span> min_in_range<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_gt_0<span class="main"><span class="main">]</span></span><span class="main">]</span> invrules<span class="main">(</span>5<span class="main">)</span> False
  <span class="keyword1"><span class="command">have</span></span> TRIV<span class="main">:</span> <span class="quoted"><span class="quoted">"makespan <span class="var">?T</span> <span class="main">=</span> Max<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="free">t</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_Max<span class="hidden">⇩</span><sub>0</sub>_equiv<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> MK<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> makespan <span class="var">?T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> TRIV<span class="main"><span class="main">[</span></span><span class="operator">folded</span> f_Max<span class="hidden">⇩</span><sub>0</sub>_equiv<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_job_lower_bound_makespan<span class="main"><span class="main">[</span></span><span class="operator">folded</span> f_Max<span class="hidden">⇩</span><sub>0</sub>_equiv<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> LB _ MK EMPTY TRIV<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_greedy_approximation<span class="main">:</span>
<span class="quoted"><span class="quoted">"sorted <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">T</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">A</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">i</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">j</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
<span class="main">{</span>True<span class="main">}</span>
T <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">;</span>
A <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
j <span class="main">:=</span> <span class="main">0</span><span class="main">;</span>
<span class="keyword1">WHILE</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">INV</span> <span class="main">{</span>inv<span class="hidden">⇩</span><sub>2</sub> <span class="bound">T</span> <span class="bound">A</span> <span class="bound">j</span><span class="main">}</span> <span class="keyword1">DO</span>
  i <span class="main">:=</span> min<span class="hidden">⇩</span><sub>k</sub> <span class="bound">T</span> <span class="free">m</span><span class="main">;</span>
  j <span class="main">:=</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">;</span>
  A <span class="main">:=</span> <span class="bound">A</span> <span class="main">(</span><span class="bound">i</span> <span class="main">:=</span> <span class="bound">A</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">j</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
  T <span class="main">:=</span> <span class="bound">T</span> <span class="main">(</span><span class="bound">i</span> <span class="main">:=</span> <span class="bound">T</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">t</span> <span class="bound">j</span><span class="main">)</span>
<span class="keyword1">OD</span>
<span class="main">{</span>lb <span class="bound">T</span> <span class="bound">A</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">T'</span> <span class="bound">A'</span><span class="main">.</span> lb <span class="bound">T'</span> <span class="bound">A'</span> <span class="free">n</span> <span class="main">⟶</span> makespan <span class="bound">T</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> makespan <span class="bound">T'</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lb_def inv<span class="hidden">⇩</span><sub>2</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* LoadBalancing *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span></pre>
</div><div id="Approx_BP_Hoare">
<div class="head">
<h1>Theory Approx_BP_Hoare</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bin Packing›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Approx_BP_Hoare
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="../../HOL/HOL-Hoare/Hoare_Logic.html">HOL-Hoare.Hoare_Logic</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm and proofs are based on the work by Berghammer and Reuter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Formalization of a Correct Bin Packing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of the unary operator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟦⋅⟧›</span></span></span></span> from the article.
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B›</span></span></span></span> will only be wrapped into a set if it is non-empty.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wrap</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wrap_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>wrap <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> are pairwise disjoint with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> and not yet contained in V,
      then the union of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>M›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>N›</span></span></span></span> is also pairwise disjoint with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pairwise_disjnt_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">M</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">N</span><span class="main">}</span> <span class="main">∪</span> <span class="free">V</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∉</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">}</span> <span class="main">∪</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A Bin Packing Problem is defined like in the article:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> BinPacking <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="comment1">― ‹A finite, non-empty set of objects›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="comment1">― ‹A mapping from objects to their respective weights (positive real numbers)›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">― ‹The maximum capacity of a bin (a natural number)›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="comment1">― ‹The set of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>small›</span></span> objects (weight no larger than <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>1/2›</span></span> of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>c›</span></span>)›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="comment1">― ‹The set of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>large›</span></span> objects (weight larger than <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>1/2›</span></span> of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>c›</span></span>)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weight<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> U_Finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> U_NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> L_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the article, this is defined as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span> as well. However, to avoid ambiguity,
      we will abbreviate the weight of a bin as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>W›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">W</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> constitutes as a correct bin packing if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a partition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>
      (as defined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] partition_on_def<span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the weights of
      the bins do not exceed their maximum capacity <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bp</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> partition_on <span class="free">U</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Although we assume the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span> sets as given, manually obtaining them from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span> is trivial
      and can be achieved in linear time. Proposed by the article <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "BerghammerR03"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> S_L_set_generation<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">S</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">L</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">W</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">u</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  S <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> L <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> W <span class="main">:=</span> <span class="free">U</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">W</span> <span class="main">≠</span> <span class="main">{}</span>
  <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">W</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">-</span> <span class="bound">W</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">-</span> <span class="bound">W</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span> <span class="keyword1">DO</span>
    u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">W</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">IF</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
    <span class="keyword1">THEN</span> S <span class="main">:=</span> <span class="bound">S</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> L <span class="main">:=</span> <span class="bound">L</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span><span class="main">;</span>
    W <span class="main">:=</span> <span class="bound">W</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span><span class="bound">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Proposed Approximation Algorithm›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹According to the article, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub> ∪ P<span class="hidden">⇩</span><sub>2</sub> ∪ wrap B<span class="hidden">⇩</span><sub>2</sub> ∪ {{v} |v. v ∈ V}›</span></span></span></span>
      is a correct solution for the bin packing problem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, various
      assumptions made in the article seem to suggest that more information is demanded from this
      invariant and, indeed, mere correctness (as defined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] bp_def<span class="antiquote"><span class="antiquote">}</span></span></span></span>) does not appear to suffice.
      To amend this, four additional conjuncts have been added to this invariant, whose necessity
      will be explained in the following proofs. It should be noted that there may be other (shorter) ways to amend this invariant.
      This approach, however, makes for rather straight-forward proofs, as these conjuncts can be utilized and proved in relatively few steps.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> bp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">}</span><span class="main">)</span> <span class="comment1">― ‹A correct solution to the bin packing problem›</span>
                       <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="comment1">― ‹The partial solution does not contain objects that have not yet been assigned›</span>
                       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∉</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span> is distinct from all the other bins›</span>
                       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∉</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span> is distinct from all the other bins›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="comment1">― ‹The first and second partial solutions are disjoint from each other.›</span>"</span></span>
<span class="comment1">(*
lemma "partition_on U (P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub> ∪ P<span class="hidden">⇩</span><sub>2</sub> ∪ wrap B<span class="hidden">⇩</span><sub>2</sub> ∪ {{v} |v. v ∈ V}) ⟹ u ∈ V ⟹
partition_on U (P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap (insert u B<span class="hidden">⇩</span><sub>1</sub>) ∪ P<span class="hidden">⇩</span><sub>2</sub> ∪ wrap B<span class="hidden">⇩</span><sub>2</sub> ∪ {{v} |v. v ∈ (V-{u})})"
  nitpick*)</span>
<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wrap_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wrap <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> wrap_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wrap <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> wrap_not_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> wrap <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="free">M</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds for the current partial solution, and the weight of an object <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V›</span></span></span></span> added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> does
      not exceed its capacity, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> also holds if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span> are replaced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub> ∪ {u}›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"W<span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the proof for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Theorem 3.2›</span></span></span></span> of the article it is erroneously argued that
        if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub> ∪ P<span class="hidden">⇩</span><sub>2</sub> ∪ wrap B<span class="hidden">⇩</span><sub>2</sub> ∪ {{v} |v. v ∈ V}›</span></span></span></span> is a partition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>,
        then the same holds if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is replaced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub> ∪ {u}›</span></span></span></span>.
        This is, however, not necessarily the case if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span> are already contained in the partial solution.
        Suppose <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> contains the non-empty bin <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> would still be pairwise disjoint, provided <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> was pairwise disjoint before, as the union simply ignores the duplicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>. Now, if the algorithm modifies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> by adding an element from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> becomes some non-empty <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>'›</span></span></span></span> with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub> ∩ B<span class="hidden">⇩</span><sub>1</sub>' ≠ ∅›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>' ∉ P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>, one can see that this property would no longer be preserved.
        To avoid such a situation, we will use the first additional conjunct in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> to ensure that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span>
        is not yet contained in the partial solution, and the second additional conjunct to ensure that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>
        is not yet contained in the partial solution.›</span></span>

  <span class="comment1">― ‹Rule 1: Pairwise Disjoint›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> NOTIN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> pairwise_disjnt_Un<span class="main">[</span><span class="operator">OF</span> assm _ this<span class="main">]</span> invrules<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 2: No empty sets›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 3: Union preserved›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="comment1">― ‹Rule 4: Weights below capacity›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>3<span class="main">)</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> bpI<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds for the current partial solution, and the weight of an object <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V›</span></span></span></span> added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> does
      not exceed its capacity, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> also holds if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span> are replaced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub> ∪ {u}›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The argumentation here is similar to the one in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="antiquote"><span class="antiquote">}</span></span></span></span> with
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> replaced with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> and using the first and third additional conjuncts of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>
      to amend the issue, instead of the first and second.›</span></span>
  <span class="comment1">― ‹Rule 1: Pairwise Disjoint›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> NOTIN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> pairwise_disjnt_Un<span class="main">[</span><span class="operator">OF</span> assm _ this<span class="main">]</span> invrules<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 2: No empty sets›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 3: Union preserved›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="comment1">― ‹Rule 4: Weights below capacity›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>3<span class="main">)</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> bpI<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds for the current partial solution, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> also holds if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> are
      added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> respectively, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is emptied and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> initialized with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="comment1">― ‹Rule 1-4: Correct Bin Packing›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>
      <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_assoc Un_empty_right insert_not_empty wrap_empty wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>
                  <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> EQ <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A simplified version of the bin packing algorithm proposed in the article.
      It serves as an introduction into the approach taken, and, while it does not provide the desired
      approximation factor, it does ensure that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a correct solution of the bin packing problem.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> simple_bp_correct<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">V</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">u</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> V <span class="main">:=</span> <span class="free">U</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span>inv<span class="hidden">⇩</span><sub>1</sub> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">V</span><span class="main">}</span> <span class="keyword1">DO</span>
    u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">)</span><span class="main">;</span> V <span class="main">:=</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">;</span>
    <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
    <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
         <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
         <span class="keyword1">ELSE</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span><span class="main">;</span>
         P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span> <span class="keyword1">FI</span>
  <span class="keyword1">OD</span><span class="main">;</span>
  P <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">}</span>
  <span class="main">{</span>bp <span class="bound">P</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def pairwise_def wrap_def inv<span class="hidden">⇩</span><sub>1</sub>_def
    <span class="keyword1"><span class="command">using</span></span> weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> INV IN<span class="main">]</span> inv<span class="hidden">⇩</span><sub>1</sub>_stepB<span class="main">[</span><span class="operator">OF</span> INV IN<span class="main">]</span> inv<span class="hidden">⇩</span><sub>1</sub>_stepC<span class="main">[</span><span class="operator">OF</span> INV IN<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lower Bounds for the Bin Packing Problem›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bp_bins_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> finite <span class="bound">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bp_sol_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_UnionD<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a solution of the bin packing problem, then no bin in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> may contain more than
      one large object.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> only_one_L_per_bin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">L</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffD1 sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a solution of the bin packing problem, then the amount of large objects
      is a lower bound for the amount of bins in P.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> L_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">L</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">L</span><span class="main">.</span> <span class="main">∃</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">L</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">using</span></span> only_one_L_per_bin<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> card_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">L</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="free">L</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="free">L</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> card_eq <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a solution of the bin packing problem, then the amount of bins of a subset of P
      in which every bin contains a large object is a lower bound on the amount of large objects.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> subset_bp_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">M</span> <span class="main">≤</span> card <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">L</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inj_on <span class="skolem">f</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∩</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pairwise_subset<span class="main">[</span><span class="operator">OF</span> bpE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_def U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="free">M</span> <span class="main">⊆</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_inj_on_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a correct solution of the bin packing problem, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds for the partial solution,
      and every bin in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> contains a large object, then the amount of bins in
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub> ∪ {{v} |v. v ∈ V ∩ L}›</span></span></span></span> is a lower bound for the amount of bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> L_bins_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> subset_bp_card<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> L_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a correct solution of the bin packing problem, then the sum of the weights of the
      objects is equal to the sum of the weights of the bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_Un_eq_sum_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> finite <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.Union_disjoint<span class="main">[</span><span class="operator">OF</span> FINITE DISJNT<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a correct solution of the bin packing problem, then the sum of the weights of the items
      is a lower bound of amount of bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> multiplied by their maximum capacity.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">∧</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2-4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnionI assms bp_bins_finite sum_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un_eq_sum_sum<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mono * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bp_NE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U_NE bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_Un_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">M</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">N</span> <span class="main">-</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffD1 inf.cobounded2 UnCI sum_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">M</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">M</span> <span class="main">+</span> sum <span class="free">f</span> <span class="free">N</span> <span class="main">-</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bij_exists›</span></span></span></span> holds, one can obtain a function which is bijective between the bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>
and the objects in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span> such that an object returned by the function would cause the bin to
exceed its capacity.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bij_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bij_exists</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a functionally correct solution of the bin packing problem, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds for the
partial solution, and such a bijective function exists between the bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and the objects in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">∪</span></span> wrap <span class="free"><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the following strict lower bound can be shown:›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_NE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right Suc_diff_1 Suc_le_mono card_gt_0_iff le0 mult_Suc_right nat_mult_1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> bp_sol_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> finite <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.Union_disjoint<span class="main">[</span><span class="operator">OF</span> F D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> W <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnionI bp_bins_finite invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un_ge<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">W</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_assoc Un_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> W <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_Un_eq_sum_sum<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹This follows from the fourth and final additional conjunct of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span> and is necessary to combine the sums of the bins
      of the two partial solutions. This does not inherently follow from the union being a correct solution,
      as this need not be the case if <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>2</sub> ∪ wrap B<span class="hidden">⇩</span><sub>2</sub>›</span></span> happened to be equal.›</span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹This part of the proof is based on the proof on page 72 of the article <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">cite</span> BerghammerR03<span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> sum_strict_mono<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups_Big.comm_monoid_add_class.sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> W <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum.reindex_bij_betw<span class="main">[</span><span class="operator">OF</span> f_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> DISJNT<span class="main">,</span> <span class="operator">of</span> <span class="quoted">W</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> discrete nat_mult_less_cancel_disj of_nat_less_imp_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wrap_card<span class="antiquote"><span class="antiquote">}</span></span></span></span> holds, it follows that the amount of bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub> ∪ wrap B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span>
      are a lower bound for the amount of bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>1</sub>_B<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> holds, there are at most half as many bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> as there are objects in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>, and we can again
      obtain a bijective function between the bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and the objects of the second partial solution,
      then the amount of bins in the second partial solution are a strict lower bound for half the bins of
      the first partial solution.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> pairwise_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sup_bot.right_neutral Un_insert_right disjnt_iff mk_disjoint_insert pairwise_insert wrap_Un<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_Finite bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_bins_finite<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> wrap_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_sol_finite<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leI <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹This part of the proof is based on the proof on page 73 of the article <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">cite</span> BerghammerR03<span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wrap_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> DISJNT<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> DISJNT2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> bij_betw_same_card <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proving the Approximation Factor›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> as it is defined in the article.
      These conjuncts allow us to prove the desired approximation factor.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> inv<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span> holds for the partial solution›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹If there are still large objects left, then every bin of the first partial solution must contain a large object›</span>
                       <span class="main">∧</span> bij_exists <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹There exists a bijective function between the bins of the first partial solution and the objects of the second one›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹There are at most twice as many bins in <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span> as there are objects in <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span>›</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is a correct solution of the bin packing problem, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> holds for the partial solution,
      and there are no more small objects left to be distributed, then the amount of bins of the partial solution
      is no larger than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>3 / 2›</span></span></span></span> of the amount of bins in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>. This proof strongly follows the proof in
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Theorem 4.1›</span></span></span></span> of the article <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bin_packing_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>
           <span class="main">=</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>1</sub>_B<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="free">P</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_def L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>
      <span class="main">=</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_bins_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> NE<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="free">P</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> as it is defined in the article.
      This final conjunct allows us to prove that the invariant will be maintained by the algorithm.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>3</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> inv<span class="hidden">⇩</span><sub>2</sub> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>3</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>3</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> loop_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def pairwise_def wrap_def inv<span class="hidden">⇩</span><sub>1</sub>_def
    <span class="keyword1"><span class="command">using</span></span> weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">{}</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">{}</span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betwI' <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> * _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is empty and there are no large objects left, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> will be maintained
      if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is initialized with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ S›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loop_stepA<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> WEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_def assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this WEIGHT<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is empty and there are large objects left, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> will be maintained
      if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is initialized with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ L›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loop_stepB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> WEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_def weight assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this WEIGHT<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff UnE empty_iff insertE singletonI wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is not empty and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ S›</span></span></span></span> does not exceed its maximum capacity, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span>
      will be maintained if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span> are replaced with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub> ∪ {u}›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loop_stepC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute Un_empty_right Un_insert_right assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> disjoint_insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_iff wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is not empty and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ S›</span></span></span></span> does exceed its maximum capacity but not the capacity of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>,
      then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> will be maintained if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and emptied, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{u}›</span></span></span></span> are replaced with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub> ∪ {u}›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loop_stepD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepB<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_empty Un_assoc Union_Un_distrib ccpo_Sup_singleton wrap_empty wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> UN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> BIJ<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> UN <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_betw_cong fun_upd_other fun_upd_same notIn_Un_bij_betw3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> BIJ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the maximum capacity of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> is exceeded by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ S›</span></span></span></span>,
      then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> must contain at least two objects.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> B<span class="hidden">⇩</span><sub>2</sub>_at_least_two_objects<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Finite_Set.finite.simps U_Finite Union_Un_distrib bpE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ccpo_Sup_singleton finite_Un wrap_not_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FINITE <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_1_singletonE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> is not empty and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u ∈ V ∩ S›</span></span></span></span> exceeds the maximum capacity of both <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>,
      then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>3</sub>›</span></span></span></span> will be maintained if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> are added to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> respectively,
      emptied, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> initialized with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loop_stepE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepC<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> UN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> BIJ<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> UN <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_betw_cong fun_upd_other fun_upd_same notIn_Un_bij_betw3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> BIJ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> pairwise_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sup_bot.right_neutral Un_insert_right disjnt_iff mk_disjoint_insert pairwise_insert wrap_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_Finite bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> bp_bins_finite wrap_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B<span class="hidden">⇩</span><sub>2</sub>_at_least_two_objects<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DISJNT card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The bin packing algorithm as it is proposed in the article <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> will not only be a correct solution of the bin packing problem, but the amount of bins
      will be a lower bound for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>3 / 2›</span></span></span></span> of the amount of bins of any correct solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>, and thus
      guarantee an approximation factor of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>3 / 2›</span></span></span></span> for the optimum.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bp_approx<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">V</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">u</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> V <span class="main">:=</span> <span class="free">U</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span>inv<span class="hidden">⇩</span><sub>3</sub> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">V</span><span class="main">}</span> <span class="keyword1">DO</span> 
    <span class="keyword1">IF</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="keyword1">THEN</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span>
    <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span>
         <span class="keyword1">THEN</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">L</span><span class="main">)</span>
         <span class="keyword1">ELSE</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">FI</span> <span class="keyword1">FI</span><span class="main">;</span>
    V <span class="main">:=</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">;</span>
    <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
    <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
         <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
         <span class="keyword1">ELSE</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span><span class="main">;</span>
         P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span> <span class="keyword1">FI</span>
  <span class="keyword1">OD</span><span class="main">;</span>
  P <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">}</span>
  <span class="main">{</span>bp <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> bp <span class="bound">Q</span> <span class="main">⟶</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> loop_init<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">∩</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> LIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="var">?l</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">∩</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> LWEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">w</span> <span class="var">?l</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L_def weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="var">?s</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> LWEIGHT loop_stepA<span class="main">[</span><span class="operator">OF</span> INV _ _ IN<span class="main">]</span> loop_stepB<span class="main">[</span><span class="operator">OF</span> INV _ LIN<span class="main">]</span> loop_stepC<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> loop_stepD<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span> loop_stepE<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">∩</span> <span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> EMPTY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bin_packing_lower_bound_card<span class="main">[</span><span class="operator">OF</span> EMPTY inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* BinPacking *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Full Linear Time Version of the Proposed Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we prove the Algorithm proposed on page 78 of the article <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      This version generates the S and L sets beforehand and uses them directly to calculate the solution,
      thus removing the need for intersection operations, and ensuring linear time if we can
      perform <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>insertion, removal, and selection of an element, the union of two sets,
      and the emptiness test in constant time›</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> BinPacking_Complete <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="comment1">― ‹A finite, non-empty set of objects›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="comment1">― ‹A mapping from objects to their respective weights (positive real numbers)›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">― ‹The maximum capacity of a bin (as a natural number)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weight<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> U_Finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> U_NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The correctness proofs will be identical to the ones of the simplified algorithm.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">W</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bp</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> partition_on <span class="free">U</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W<span class="main">(</span><span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> bp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">}</span><span class="main">)</span> <span class="comment1">― ‹A correct solution to the bin packing problem›</span>
                       <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="comment1">― ‹The partial solution does not contain objects that have not yet been assigned›</span>
                       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∉</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B<span class="hidden">⇩</span><sub>1</sub>›</span></span> is distinct from all the other bins›</span>
                       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∉</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B<span class="hidden">⇩</span><sub>2</sub>›</span></span> is distinct from all the other bins›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="comment1">― ‹The first and second partial solutions are disjoint from each other.›</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wrap_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wrap <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> wrap_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wrap <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> wrap_not_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> wrap <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="free">M</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"W<span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

  <span class="comment1">― ‹Rule 1: Pairwise Disjoint›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> NOTIN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> pairwise_disjnt_Un<span class="main">[</span><span class="operator">OF</span> assm _ this<span class="main">]</span> invrules<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 2: No empty sets›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 3: Union preserved›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="comment1">― ‹Rule 4: Weights below capacity›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>3<span class="main">)</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> bpI<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> NOTIN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> pairwise_disjnt_Un<span class="main">[</span><span class="operator">OF</span> assm _ this<span class="main">]</span> invrules<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 2: No empty sets›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹Rule 3: Union preserved›</span>
  <span class="keyword1"><span class="command">from</span></span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="comment1">― ‹Rule 4: Weights below capacity›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>3<span class="main">)</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="free">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∈</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> bpI<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty wrap_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="comment1">― ‹Rule 1-4: Correct Bin Packing›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>
      <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_assoc Un_empty_right insert_not_empty wrap_empty wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span>
                  <span class="main">=</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bp <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> EQ <span class="keyword1"><span class="command">.</span></span>

  <span class="comment1">― ‹Auxiliary information is preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> NOTIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">.</span> <span class="free">u</span> <span class="main">∉</span> <span class="bound">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="free">V</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="main">-</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L R <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span> <span class="main">∪</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NOTIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> NOTIN <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4 5<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From this point onward, we will require a different approach for proving lower bounds.
      Instead of fixing and assuming the definitions of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span> sets, we will introduce
      the abbreviations <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S<span class="hidden">⇩</span><sub>U</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L<span class="hidden">⇩</span><sub>U</sub>›</span></span></span></span> for any occurrences of the original <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span> sets.
      The union of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span> can be interpreted as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V›</span></span></span></span>. As a result, occurrences of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V ∩ S›</span></span></span></span>
      become <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(S ∪ L) ∩ S = S›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>V ∩ L›</span></span></span></span> become <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(S ∪ L) ∩ L = L›</span></span></span></span>.
      Occurrences of these sets will have to be replaced appropriately.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">S<span class="hidden">⇩</span><sub>U</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S<span class="hidden">⇩</span><sub>U</sub></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">L<span class="hidden">⇩</span><sub>U</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">L<span class="hidden">⇩</span><sub>U</sub></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="bound">u</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As we will remove elements from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span>, we will only be able to show that they remain
      subsets of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S<span class="hidden">⇩</span><sub>U</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L<span class="hidden">⇩</span><sub>U</sub>›</span></span></span></span> respectively.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SL</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SL</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊆</span> S<span class="hidden">⇩</span><sub>U</sub> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⊆</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bp_bins_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> finite <span class="bound">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bp_sol_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_UnionD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> only_one_L_per_bin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∉</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∉</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∧</span> real <span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="bound">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">∧</span> real <span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="bound">y</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B</span> <span class="main">=</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> W <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffD1 sum_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">&lt;</span> <span class="free">w</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">w</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">.</span> <span class="main">∃</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">using</span></span> only_one_L_per_bin<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> card_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"card L<span class="hidden">⇩</span><sub>U</sub> <span class="main">=</span> card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> card_eq <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subset_bp_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">M</span> <span class="main">≤</span> card L<span class="hidden">⇩</span><sub>U</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">B</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">∧</span> <span class="bound">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">B</span> <span class="main">∈</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">B</span> <span class="main">∈</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inj_on <span class="skolem">f</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∩</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pairwise_subset<span class="main">[</span><span class="operator">OF</span> bpE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite L<span class="hidden">⇩</span><sub>U</sub>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_Finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="free">M</span> <span class="main">⊆</span> L<span class="hidden">⇩</span><sub>U</sub>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_inj_on_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_bins_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> SL_def<span class="main">:</span> <span class="quoted"><span class="quoted">"SL <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> subset_bp_card<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> L_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_Un_eq_sum_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> finite <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.Union_disjoint<span class="main">[</span><span class="operator">OF</span> FINITE DISJNT<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">∧</span> W <span class="bound">B</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2-4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnionI assms bp_bins_finite sum_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un_eq_sum_sum<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_mono * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bp_NE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U_NE bpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_Un_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">M</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">N</span> <span class="main">-</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> DiffD1 inf.cobounded2 UnCI sum_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">M</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">M</span> <span class="main">+</span> sum <span class="free">f</span> <span class="free">N</span> <span class="main">-</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∩</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bij_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bij_exists</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> bij_betw <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_NE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right Suc_diff_1 Suc_le_mono card_gt_0_iff le0 mult_Suc_right nat_mult_1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> bp_sol_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> finite <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def disjnt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.Union_disjoint<span class="main">[</span><span class="operator">OF</span> F D<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> W <span class="bound">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bpE<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> weight <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnionI bp_bins_finite invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sum_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_Un_ge<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">W</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_assoc Un_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> W <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_Un_eq_sum_sum<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">≤</span> W <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹This part of the proof is based on the proof on page 72 of the article <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">cite</span> BerghammerR03<span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> sum_strict_mono<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Groups_Big.comm_monoid_add_class.sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> W <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum.reindex_bij_betw<span class="main">[</span><span class="operator">OF</span> f_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> W <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.union_disjoint<span class="main">[</span><span class="operator">OF</span> FINITE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> DISJNT<span class="main">,</span> <span class="operator">of</span> <span class="quoted">W</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="free">w</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> discrete nat_mult_less_cancel_disj of_nat_less_imp_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>1</sub>_B<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> pairwise_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sup_bot.right_neutral Un_insert_right disjnt_iff mk_disjoint_insert pairwise_insert wrap_Un<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_Finite bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_bins_finite<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> wrap_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bp_sol_finite<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> DISJNT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leI <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹This part of the proof is based on the proof on page 73 of the article <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">cite</span> BerghammerR03<span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wrap_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> DISJNT<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> DISJNT2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> bij_betw_same_card <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We add <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SL S L›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> to ensure that the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>L›</span></span></span></span> sets only contain objects with correct weights.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟷</span> inv<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span> holds for the partial solution›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹If there are still large objects left, then every bin of the first partial solution must contain a large object›</span>
                       <span class="main">∧</span> bij_exists <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∪</span> wrap <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹There exists a bijective function between the bins of the first partial solution and the objects of the second one›</span>
                       <span class="main">∧</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹There are at most twice as many bins in <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span> as there are objects in <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>P<span class="hidden">⇩</span><sub>2</sub>›</span></span>›</span>
                       <span class="main">∧</span> SL <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>S›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>L›</span></span> are subsets of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>S<span class="hidden">⇩</span><sub>U</sub>›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>L<span class="hidden">⇩</span><sub>U</sub>›</span></span>›</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"SL <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"SL <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> bin_packing_lower_bound_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"bp <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span>
           <span class="main">=</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>1</sub>_B<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="free">P</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span>
      <span class="main">=</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span> <span class="main">∪</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">‹<span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">L</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_bins_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span> invrules<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">P</span> <span class="main">+</span> card <span class="free">P</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P<span class="hidden">⇩</span><sub>2</sub>_B<span class="hidden">⇩</span><sub>2</sub>_lower_bound_P<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="hidden">⇩</span><sub>1</sub>_lower_bound_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv<span class="hidden">⇩</span><sub>3</sub></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⟷</span> inv<span class="hidden">⇩</span><sub>2</sub> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊆</span> S<span class="hidden">⇩</span><sub>U</sub>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> S<span class="hidden">⇩</span><sub>U</sub>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>3</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> S<span class="hidden">⇩</span><sub>U</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> inv<span class="hidden">⇩</span><sub>3</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> loop_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> S<span class="hidden">⇩</span><sub>U</sub> L<span class="hidden">⇩</span><sub>U</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S<span class="hidden">⇩</span><sub>U</sub> <span class="main">∪</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">=</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">(</span>S<span class="hidden">⇩</span><sub>U</sub> <span class="main">∪</span> L<span class="hidden">⇩</span><sub>U</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bp_def partition_on_def pairwise_def wrap_def inv<span class="hidden">⇩</span><sub>1</sub>_def
    <span class="keyword1"><span class="command">using</span></span> weight <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">{}</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">{}</span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betwI' <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> * _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> <span class="main">{}</span> S<span class="hidden">⇩</span><sub>U</sub> L<span class="hidden">⇩</span><sub>U</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop_stepA<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> WEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this WEIGHT<span class="main">]</span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop_stepB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> WEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="free">u</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="comment1">― ‹This observation follows from the fact that the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>S›</span></span> and <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>L›</span></span> sets have to be disjoint from each other,
      and allows us to reuse our proofs of the preservation of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>inv<span class="hidden">⇩</span><sub>1</sub>›</span></span> by simply replacing <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>V›</span></span> with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>S ∪ L›</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∪</span> <span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∪</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this WEIGHT<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> invrules<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Un_iff empty_iff insert_iff wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="main">(</span><span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop_stepC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span>

  <span class="comment1">― ‹Same approach, but removing <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>{u}›</span></span> from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>S›</span></span> instead of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>L›</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∪</span> <span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepA<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Int_insert_left Un_empty_right Un_iff Un_insert_right assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_not_empty singletonD singletonI wrap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> invrules <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop_stepD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∪</span> <span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepB<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_empty Un_assoc Union_Un_distrib ccpo_Sup_singleton wrap_empty wrap_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> UN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> BIJ<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> UN <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_betw_cong fun_upd_other fun_upd_same notIn_Un_bij_betw3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> BIJ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{}</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> invrules<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> B<span class="hidden">⇩</span><sub>2</sub>_at_least_two_objects<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> FINITE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Finite_Set.finite.simps U_Finite Union_Un_distrib bpE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ccpo_Sup_singleton finite_Un wrap_not_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FINITE <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_1_singletonE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">w</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> loop_stepE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"W <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="free">u</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> invrules <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span></span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∪</span> <span class="free">L</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>_stepC<span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">∪</span> <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="main">{}</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∩</span> L<span class="hidden">⇩</span><sub>U</sub> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> invrules<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wrap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> UN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_not_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:=</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> BIJ<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wrap_empty <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> UN <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> bij_betw_cong fun_upd_other fun_upd_same notIn_Un_bij_betw3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> W <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> f_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> BIJ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">c</span> <span class="main">&lt;</span> W <span class="bound">B</span> <span class="main">+</span> <span class="free">w</span> <span class="main">(</span><span class="var">?f</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_exists <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_exists_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> bprules <span class="main">=</span> bpE<span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">OF</span></span></span></span> invrules<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pairwise disjnt <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bprules<span class="main">(</span>1<span class="main">)</span> pairwise_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∉</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> DISJNT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> sup_bot.right_neutral Un_insert_right disjnt_iff mk_disjoint_insert pairwise_insert wrap_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_Finite bprules<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> invrules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> bp_bins_finite wrap_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> card <span class="main">(</span>wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="quoted">‹wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrap_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> card <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B<span class="hidden">⇩</span><sub>2</sub>_at_least_two_objects<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DISJNT card_Un_disjoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="main">⋃</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>2</sub>I<span class="main">[</span><span class="operator">OF</span> 1 2 3 4<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">{}</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> invrules<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>3</sub>I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> invrules<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The bin packing algorithm as it is proposed on page 78 of the article <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> BerghammerR03<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> will not only be a correct solution of the bin packing problem, but the amount of bins
      will be a lower bound for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>3 / 2›</span></span></span></span> of the amount of bins of any correct solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>, and thus
      guarantee an approximation factor of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>3 / 2›</span></span></span></span> for the optimum.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bp_approx<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">VARS</span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">V</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">S</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">L</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">u</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
  <span class="main">{</span>True<span class="main">}</span>
  S <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> L<span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> V <span class="main">:=</span> <span class="free">U</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">V</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">V</span> <span class="main">⊆</span> <span class="free">U</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">-</span> <span class="bound">V</span><span class="main">.</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">u</span></span> <span class="main">∈</span> <span class="free">U</span> <span class="main">-</span> <span class="bound">V</span><span class="main">.</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="keyword1">DO</span>
    u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">IF</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">/</span> <span class="numeral">2</span>
    <span class="keyword1">THEN</span> S <span class="main">:=</span> <span class="bound">S</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> L <span class="main">:=</span> <span class="bound">L</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span><span class="main">;</span>
    V <span class="main">:=</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
  <span class="keyword1">OD</span><span class="main">;</span>
  P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{}</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">INV</span> <span class="main">{</span>inv<span class="hidden">⇩</span><sub>3</sub> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">S</span> <span class="bound">L</span><span class="main">}</span> <span class="keyword1">DO</span> 
    <span class="keyword1">IF</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="keyword1">THEN</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span><span class="main">;</span> S <span class="main">:=</span> <span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> <span class="bound">L</span> <span class="main">≠</span> <span class="main">{}</span>
         <span class="keyword1">THEN</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span><span class="main">;</span> L <span class="main">:=</span> <span class="bound">L</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
         <span class="keyword1">ELSE</span> u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span><span class="main">;</span> S <span class="main">:=</span> <span class="bound">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span> <span class="keyword1">FI</span><span class="main">;</span>
    <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
    <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
    <span class="keyword1">ELSE</span> <span class="keyword1">IF</span> W<span class="main">(</span><span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">+</span> <span class="free">w</span><span class="main">(</span><span class="bound">u</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>
         <span class="keyword1">THEN</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
         <span class="keyword1">ELSE</span> P<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>2</sub> <span class="main">:=</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">FI</span><span class="main">;</span>
         P<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> B<span class="hidden">⇩</span><sub>1</sub> <span class="main">:=</span> <span class="main">{}</span> <span class="keyword1">FI</span>
  <span class="keyword1">OD</span><span class="main">;</span>
  P <span class="main">:=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> V <span class="main">:=</span> <span class="bound">L</span><span class="main">;</span>
  <span class="keyword1">WHILE</span> <span class="bound">V</span> <span class="main">≠</span> <span class="main">{}</span>
  <span class="keyword1">INV</span> <span class="main">{</span><span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> inv<span class="hidden">⇩</span><sub>3</sub> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">S</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">V</span> <span class="main">⊆</span> <span class="bound">L</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">=</span> <span class="bound">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="bound">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="bound">L</span> <span class="main">-</span> <span class="bound">V</span><span class="main">}</span><span class="main">}</span> <span class="keyword1">DO</span>
    u <span class="main">:=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">V</span><span class="main">)</span><span class="main">;</span> P <span class="main">:=</span> <span class="bound">P</span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">}</span><span class="main">;</span> V <span class="main">:=</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span>
  <span class="keyword1">OD</span>
  <span class="main">{</span>bp <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> bp <span class="bound">Q</span> <span class="main">⟶</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="bound">Q</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">vcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> loop_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> INV<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">S</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> SL_def <span class="main">=</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> INV<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> LIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="var">?l</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> LWEIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">w</span> <span class="var">?l</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> weight SL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="var">?s</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> LWEIGHT loop_stepA<span class="main">[</span><span class="operator">OF</span> INV _ _ IN<span class="main">]</span> loop_stepB<span class="main">[</span><span class="operator">OF</span> INV _ LIN<span class="main">]</span> loop_stepC<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> loop_stepD<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span> loop_stepE<span class="main">[</span><span class="operator">OF</span> INV _ IN<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">‹<span class="skolem">L</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_in_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">L</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>
           <span class="main">=</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> wrap <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> wrap <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∪</span> <span class="main">{</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">L</span> <span class="main">-</span> <span class="skolem">V</span> <span class="main">∪</span> <span class="main">{</span><span class="keyword1">SOME</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">V</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> 6 * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">V</span> <span class="skolem">S</span> <span class="skolem">L</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"inv<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">S</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv<span class="hidden">⇩</span><sub>3</sub>E<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv<span class="hidden">⇩</span><sub>1</sub>E<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> inv<span class="hidden">⇩</span><sub>2</sub>E<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">]</span> 7
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bp <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> bin_packing_lower_bound_card<span class="main">[</span><span class="operator">OF</span> _ *<span class="main">]</span> 7
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* BinPacking_Complete *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span></pre>
</div>