<div id="CSPNoninterference">
<div class="head">
<h1>Theory CSPNoninterference</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Noninterference Security in Communicating Sequential Processes
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Noninterference in CSP"</span></span>

<span class="keyword1"><span class="command">theory</span></span> CSPNoninterference
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

An extension of classical noninterference security for deterministic state machines, as introduced
by Goguen and Meseguer \cite{R2} and elegantly formalized by Rushby \cite{R3}, to nondeterministic
systems should satisfy two fundamental requirements: it should be based on a mathematically precise
theory of nondeterminism, and should be equivalent to (or at least not weaker than) the classical
notion in the degenerate deterministic case.

The purpose of this section is to formulate a definition of noninterference security that meet these
requirements, applying to the concept of process as formalized by Hoare in his remarkable theory of
Communicating Sequential Processes (CSP) \cite{R1}. The general case of a possibly intransitive
noninterference policy will be considered.

Throughout this paper, the salient points of definitions and proofs are commented; for additional
information see Isabelle documentation, particularly \cite{R5}, \cite{R6}, \cite{R7}, and \cite{R8}.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
It is convenient to represent CSP processes by means of a type definition including a type variable,
which stands for the process alphabet. Type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process›</span></span></span></span> shall then be isomorphic to the subset
of the product type of failures sets and divergences sets comprised of the pairs that satisfy the
properties enunciated in \cite{R1}, section 3.9. Such subset shall be shown to contain process
\emph{STOP}, which proves that it is nonempty.

Property \emph{C5} is not considered as it is entailed by \emph{C7}. Moreover, the formalization of
properties \emph{C2} and \emph{C6} only takes into account event lists \emph{t} containing a single
item. Such formulation is equivalent to the original one, since the truth of \emph{C2} and \emph{C6}
for a singleton list \emph{t} immediately derives from that for a generic list, and conversely:

\begin{itemize}

\item
the truth of \emph{C2} and \emph{C6} for a generic nonempty list \emph{t} results from the repeated
application of \emph{C2} and \emph{C6} for a singleton list;

\item
the truth of \emph{C2} for \emph{t} matching the empty list is implied by property \emph{C3};

\item
the truth of \emph{C6} for \emph{t} matching the empty list is a tautology.

\end{itemize}

The advantage of the proposed formulation is that it facilitates the task to prove that pairs of
failures and divergences sets defined inductively indeed be processes, viz. be included in the set
of pairs isomorphic to type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process›</span></span></span></span>, since the introduction rules in such inductive
definitions will typically construct process traces by appending one item at a time.

In what follows, the concept of process is formalized according to the previous considerations.

\null
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> failure <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> process_prod <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> failure set <span class="main">×</span> <span class="tfree">'a</span> list set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_1</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_3</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="bound">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_4</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span>
  <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> insert <span class="bound">x</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_5</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_prop_6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_prop_6</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process_prod set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">process_set</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span>
  process_prop_1 <span class="bound">P</span> <span class="main">∧</span>
  process_prop_2 <span class="bound">P</span> <span class="main">∧</span>
  process_prop_3 <span class="bound">P</span> <span class="main">∧</span>
  process_prop_4 <span class="bound">P</span> <span class="main">∧</span>
  process_prop_5 <span class="bound">P</span> <span class="main">∧</span>
  process_prop_6 <span class="bound">P</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> process <span class="main">=</span> <span class="quoted"><span class="quoted">"process_set <span class="main">::</span> <span class="tfree">'a</span> process_prod set"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
  process_set_def
  process_prop_1_def
  process_prop_2_def
  process_prop_3_def
  process_prop_4_def
  process_prop_5_def
  process_prop_6_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below are the definitions of some functions acting on processes. Functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>failures›</span></span></span></span>,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>traces›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>deterministic›</span></span></span></span> match the homonymous notions defined in \cite{R1}. As for
the other ones:

\begin{itemize}

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>futures P xs›</span></span></span></span> matches the failures set of process \emph{P / xs};

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>refusals P xs›</span></span></span></span> matches the refusals set of process \emph{P / xs};

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next_events P xs›</span></span></span></span> matches the event set (\emph{P / xs})\textsuperscript{0}.

\end{itemize}

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">failures</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> failure set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">failures</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>Rep_process <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">futures</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> failure set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">futures</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">traces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">traces</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Domain <span class="main">(</span>failures <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">refusals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">refusals</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> failures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">next_events</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">deterministic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">deterministic</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> refusals <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∩</span> next_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, properties <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process_prop_2›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process_prop_3›</span></span></span></span> of processes are put
into the form of introduction rules, which will turn out to be useful in subsequent proofs.
Particularly, the more general formulation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process_prop_2›</span></span></span></span> as given in \cite{R1} (section
3.9, property \emph{C2}) is restored, and it is expressed in terms of both functions
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>failures›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>futures›</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_2_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep_process <span class="free">P</span> <span class="main">∈</span> process_set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rep_process<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="bound">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def process_prop_3_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> fst <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_2_failures <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs'</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_rule_2_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Noninterference"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the classical theory of noninterference, a deterministic state machine is considered to be secure
just in case, for any trace of the machine and any action occurring next, the observable effect of
the action, i.e. the produced output, is compatible with the assigned noninterference policy.

Thus, by analogy, it seems reasonable to regard a process as being noninterference-secure just in
case, for any of its traces and any event occurring next, the observable effect of the event, i.e.
the set of the possible futures of the process, is compatible with a given noninterference policy.

More precisely, let <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks I D u xs›</span></span></span></span> be the set of the security domains of the events within
event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> that may be affected by domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> according to interference relation
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is the mapping of events into their domains. Since the general case of a
possibly intransitive relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span> is considered, function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span> has to be defined
recursively, similarly to what happens for function \emph{sources} in \cite{R3}. However,
contrariwise to function \emph{sources}, function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span> takes into account the influence of
the input domain on the input event list, so that the recursive decomposition of the latter has to
be performed by item appending rather than prepending.

Furthermore, let <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr I D u xs›</span></span></span></span> be the sublist of event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> obtained by
recursively deleting the events that may be affected by domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> as detected via function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_ref I D u xs X›</span></span></span></span> be the subset of refusal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>X›</span></span></span></span> whose elements
may not be affected by either <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> or any domain in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks I D u xs›</span></span></span></span>.

Then, a process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> is secure just in case, for each event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> and each
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(y # ys, Y), (zs, Z) ∈ futures P xs›</span></span></span></span>, both of the following conditions are satisfied:

\begin{itemize}

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(ipurge_tr I D (D y) ys, ipurge_ref I D (D y) ys Y) ∈ futures P xs›</span></span></span></span>.
\\Otherwise, the absence of event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> after <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> would affect the possibility for pair
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(ipurge_tr I D (D y) ys, ipurge_ref I D (D y) ys Y)›</span></span></span></span> to occur as a future of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>,
although its components, except for the deletion of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>, are those of possible future
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(y # ys, Y)›</span></span></span></span> deprived of any event allowed to be affected by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>.

\item
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(y # ipurge_tr I D (D y) zs, ipurge_ref I D (D y) zs Z)›</span></span></span></span>
\\<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∈ futures P xs›</span></span></span></span>.
\\Otherwise, the presence of event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> after <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> would affect the possibility for pair
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(y # ipurge_tr I D (D y) zs, ipurge_ref I D (D y) zs Z)›</span></span></span></span> to occur as a future of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>, although its components, except for the addition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>, are those of possible
future <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(zs, Z)›</span></span></span></span> deprived of any event allowed to be affected by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>.

\end{itemize}

Observe that this definition of security, henceforth referred to as
\emph{CSP noninterference security}, does not rest on the supposition that noninterference policy
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I›</span></span></span></span> be reflexive, even though any policy of practical significance will be such.

Moreover, this simpler formulation is equivalent to the one obtained by restricting the range of
event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> to the traces of process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>. In fact, for each <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>zs›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Z›</span></span></span></span>,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(zs, Z) ∈ futures P xs›</span></span></span></span> just in case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(xs @ zs, Z) ∈ failures P›</span></span></span></span>, which by virtue
of rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>process_rule_2_failures›</span></span></span></span> implies that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> is a trace of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>. Therefore,
formula <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(zs, Z) ∈ futures P xs›</span></span></span></span> is invariably false in case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> is not a trace of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>.

Here below are the formal counterparts of the definitions discussed so far.

\null
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">sinks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sinks</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sinks</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">sinks</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sinks</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">sinks</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">ipurge_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_tr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> sinks <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="free">ipurge_tr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">ipurge_tr</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipurge_ref</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ipurge_ref</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">secure</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">Y</span> <span class="bound">zs</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">⟶</span>
  <span class="main">(</span>ipurge_tr <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="bound">ys</span><span class="main">,</span> ipurge_ref <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="bound">ys</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">∧</span>
  <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> ipurge_tr <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="bound">zs</span><span class="main">,</span> ipurge_ref <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="bound">zs</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The continuation of this section is dedicated to the demonstration of some lemmas concerning
functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_ref›</span></span></span></span> which will turn out to be useful
in subsequent proofs.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sinks_cons_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>
    <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">{}</span>
    <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="free">D</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps if_True<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps if_False<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_tr_cons_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">then</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="free">D</span> <span class="free">x</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps if_True<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="free">D</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps if_False<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sinks_cons_nonint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>
    <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">{}</span>
    <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d'</span> <span class="main">=</span> <span class="var">?d</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?d'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>
    <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?d'</span>
    <span class="keyword1">else</span> <span class="var">?d'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?d</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="var">?d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sinks_empty <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">⊆</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_insertI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_mp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ipurge_ref_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span>
    ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span> <span class="main">{</span><span class="bound"><span class="bound">x'</span></span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ClassicalNoninterference">
<div class="head">
<h1>Theory ClassicalNoninterference</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Noninterference Security in Communicating Sequential Processes
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"CSP noninterference vs. classical noninterference"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ClassicalNoninterference
<span class="keyword2"><span class="keyword">imports</span></span> <a href="CSPNoninterference.html">CSPNoninterference</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The purpose of this section is to prove the equivalence of CSP noninterference security as defined
previously to the classical notion of noninterference security as formulated in \cite{R3} in the
case of processes representing deterministic state machines, henceforth briefly referred to as
\emph{classical processes}.

For clarity, all the constants and fact names defined in this section, with the possible exception
of main theorems, contain prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Classical noninterference"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below are the formalizations of the functions \emph{sources} and \emph{ipurge} defined in
\cite{R3}, as well as of the classical notion of noninterference security as stated ibid. for a
deterministic state machine in the general case of a possibly intransitive noninterference policy.

Observe that the function \emph{run} used in \emph{R3} is formalized as function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>foldl step›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>step›</span></span></span></span> is the state transition function of the machine.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">c_sources</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_sources</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">c_sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">c_sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">c_sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">c_sources</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">c_ipurge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_ipurge</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">c_ipurge</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> c_sources <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">c_ipurge</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">c_ipurge</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">c_secure</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_secure</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">(</span>foldl <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">(</span>foldl <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>c_ipurge <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In addition, the definitions are given of variants of functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_sources›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_ipurge›</span></span></span></span> accepting in input a set of security domains rather than a single domain, and then
some lemmas concerning them are demonstrated. These definitions and lemmas will turn out to be
useful in subsequent proofs.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">c_sources_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'d</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_sources_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">c_sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">c_sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>
  <span class="keyword1">then</span> insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">c_sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">c_sources_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">c_ipurge_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span> set <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_ipurge_aux</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">c_ipurge_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> c_sources_aux <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">c_ipurge_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="keyword1">else</span> <span class="free">c_ipurge_aux</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_aux_singleton_1<span class="main">:</span> <span class="quoted"><span class="quoted">"c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_aux_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u</span><span class="main">}</span> <span class="free">xs</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_sources_aux_singleton_1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_aux_singleton_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_aux_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>
    <span class="keyword1">then</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="free">xs</span>
    <span class="keyword1">else</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_aux_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>
    <span class="keyword1">then</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>
    <span class="keyword1">else</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_sources_aux_append<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, a few useful lemmas are proven about functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_sources›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_ipurge›</span></span></span></span>
and their relationships with functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr›</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_ipurge<span class="main">:</span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_append_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_append_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_sources_append_1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_append_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_append_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"refl <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def c_sources_append_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> D <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">zs</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_insertI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_sources_sinks <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟶</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
    sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_insertI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⊆</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_sources_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contra_subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_ipurge.simps if_True if_False<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x'</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free">x</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">x'</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_nonint<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> c_ipurge_tr_ipurge <span class="main">=</span> c_sources_sinks <span class="main">[</span><span class="operator">THEN</span> sinks_empty<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_aux_ipurge_tr <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
    c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">U</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="bound">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> bexE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">D</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="main"><span class="main">∈</span></span> sinks <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">ys</span></span> <span class="main"><span class="main">@</span></span> <span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
   c_ipurge_aux_append append_same_eq if_True if_False<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> c_sources_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_sources_aux_singleton_2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> bexE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span>
      <span class="main">=</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_ipurge_ipurge_tr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u'</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">{</span><span class="free">u'</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u'</span><span class="main">}</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    c_ipurge_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">u'</span><span class="main">}</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_aux_ipurge_tr<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_aux_singleton<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Classical processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The deterministic state machines used as model of computation in the classical theory of
noninterference security, as expounded in \cite{R3}, have the property that each action produces an
output. Hence, it is natural to take as alphabet of a classical process the universe of the pairs
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, p)›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> is an action and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> an output. For any state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>,
such an event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, p)›</span></span></span></span> may occur just in case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> matches the output produced by
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.

Therefore, a trace of a classical process can be defined as an event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xps›</span></span></span></span> such that for
each item <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, p)›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is equal to the output produced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> in the state
resulting from the previous actions in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xps›</span></span></span></span>. Furthermore, for each trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xps›</span></span></span></span>, the
refusals set associated to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xps›</span></span></span></span> is comprised of any set of pairs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, p)›</span></span></span></span> such that
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is different from the output produced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> in the state resulting from the actions
in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xps›</span></span></span></span>.

In accordance with the previous considerations, an inductive definition is formulated here below for
the failures set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_failures step out s<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> corresponding to the deterministic state machine
with state transition function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>step›</span></span></span></span>, output function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>out›</span></span></span></span>, and initial state
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span>. Then, the classical process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_process step out s<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> representing this machine is
defined as the process having <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_failures step out s<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> as failures set and the empty set as
divergences set.

\null
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">c_failures</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'o</span><span class="main">)</span> failure set"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'o</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="free">c_failures</span> <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">|</span>
R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xps</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">c_failures</span> <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xps</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xps</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free">out</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="free">c_failures</span> <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">|</span>
R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">c_failures</span> <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xps</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">c_failures</span> <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">c_process</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'o</span><span class="main">)</span> process"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_process</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≡</span> Abs_process <span class="main">(</span>c_failures <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, the fact that classical processes are indeed processes is proven as a theorem.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_1 <span class="main">(</span>c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_2 <span class="main">(</span>c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> process_prop_2_def fst_conv<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps</span> <span class="skolem">xp</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>butlast <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures.induct
   <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">xps</span></span> <span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span>butlast <span class="bound"><span class="bound">xps</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">{}</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> c_failures <span class="free"><span class="free">step</span></span> <span class="free"><span class="free">out</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps'</span> <span class="skolem">X'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_3 <span class="main">(</span>c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> process_prop_3_def fst_conv<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_4 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_4 <span class="main">(</span>c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> process_prop_4_def fst_conv<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps</span> <span class="skolem">xp</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span>
    <span class="main">(</span><span class="skolem">xps</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">xp</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_failures.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="var">?X</span><span class="main">)</span>
      <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">xp</span> <span class="var">?X</span> <span class="main">=</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert_absorb<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">xps'</span> <span class="skolem">X'</span> <span class="skolem">s</span> <span class="skolem">x'</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="skolem">xps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="free">out</span> <span class="skolem">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span> <span class="main">(</span><span class="var">?xps</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="var">?X</span><span class="main">)</span>
      <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="var">?xps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⊆</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xp</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">xp</span> <span class="var">?X</span> <span class="main">=</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert_absorb<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps'</span> <span class="skolem">X'</span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span>
       <span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="var">?B</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">xp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="skolem">X'</span><span class="main">)</span>
      <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?A</span> <span class="main">∨</span> <span class="var">?B</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">xp</span> <span class="skolem">X'</span> <span class="main">⊆</span> insert <span class="skolem">xp</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">⊆</span> <span class="skolem">Y</span>›</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps'</span><span class="main">,</span> insert <span class="skolem">xp</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_5 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_5 <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_5_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_process_prop_6 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"process_prop_6 <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_prop_6_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> c_process_process<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> process_set"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The continuation of this section is dedicated to the proof of a few lemmas on the properties of
classical processes, particularly on the application to them of the generic functions acting on
processes defined previously, and culminates in the theorem stating that classical processes are
deterministic. Since they are intended to be a representation of deterministic state machines as
processes, this result provides an essential confirmation of the correctness of such correspondence.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_failures_last <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">xps</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
  snd <span class="main">(</span>last <span class="free">xps</span><span class="main">)</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> c_failures.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_failures_ref<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> c_failures.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_failures_failures<span class="main">:</span> <span class="quoted"><span class="quoted">"failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> failures_def c_process_def c_process_process Abs_process_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_futures_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> futures_def failures_def c_process_def c_process_process Abs_process_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_traces<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">∈</span> traces <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def failures_def Domain_iff c_process_def c_process_process
 Abs_process_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_refusals<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> refusals <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refusals_def c_failures_failures<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_next_events<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xp</span> <span class="main">∈</span> next_events <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">xp</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def c_traces<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_traces_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">∈</span> traces <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_traces<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rev_cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xps</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R0 split_paired_all<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">yps</span> <span class="skolem">y</span> <span class="skolem">p</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="skolem">yps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="skolem">yps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="var">?ys'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="var">?ys'</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> c_process_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"deterministic <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> deterministic_def c_refusals c_next_events set_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">∈</span> traces <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="skolem">xps</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∉</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">Y</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?X'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_ref<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?X'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="var">?xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="var">?xs'</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_traces_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∉</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="skolem">xps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Traces in classical processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below is the definition of function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_tr›</span></span></span></span>, where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_tr step out s xs›</span></span></span></span> is the
trace of classical process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_process step out s›</span></span></span></span> corresponding to the trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> of
the associated deterministic state machine. Moreover, some useful lemmas are proven about this
function.

\null
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">c_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'o</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_tr</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">c_tr</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">c_tr</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">(</span>foldl <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_map<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">out</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">[]</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">out</span> <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> xs <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_hd_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span>hd <span class="free">xs</span><span class="main">,</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="free">s</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">@</span> tl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">@</span> tl <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">[</span>hd <span class="free">xs</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>hd <span class="free">xs</span><span class="main">,</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_failures_tr<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">xps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> c_failures.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_futures_tr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">yps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">yps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span> <span class="main">@</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">yps</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_failures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
  <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R0<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
    <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">,</span>
   <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_futures<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span>
  <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
  <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_append<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span>
    <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Noninterference in classical processes"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Given a mapping <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> of the actions of a deterministic state machine into their security
domains, it is natural to map each event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, p)›</span></span></span></span> of the corresponding classical process
into the domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D x›</span></span></span></span> of action <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.

Such mapping of events into domains, formalized as function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_dom D›</span></span></span></span> in the continuation,
ensures that the same noninterference policy applying to a deterministic state machine be applicable
to the associated classical process as well. This is the simplest, and thus preferable way to
construct a policy for the process such as to be isomorphic to the one assigned for the machine, as
required in order to prove the equivalence of CSP noninterference security to the classical notion
in the case of classical processes.

In what follows, function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_dom›</span></span></span></span> will be used in the proof of some useful lemmas concerning
the application of functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sinks›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ipurge_tr›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_sources›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_ipurge›</span></span></span></span>
from noninterference theory to the traces of classical processes, constructed by means of function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c_tr›</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">c_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c_dom</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">xp</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">xp</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_dom_sources<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="free">xps</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_dom_sinks<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="free">xps</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>map fst <span class="free">xps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_sources<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_sources c_tr_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_sinks<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_sinks c_tr_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_ipurge<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="bound">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="bound">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> c_sources.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_hd_tl<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> c_sources_ipurge<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_sources<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      c_tr <span class="free">step</span> <span class="free">out</span> <span class="skolem">s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_ipurge_tr_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="free">D</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
  <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span><span class="main">.</span>
    <span class="free">D</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    <span class="free">D</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="bound">n</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span><span class="main">.</span>
    <span class="free">D</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> c_tr_sinks<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> c_tr_sinks<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> length <span class="skolem">xs</span><span class="main">)</span>
        <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_ipurge_tr_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..</span>length <span class="free">ys</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span>
    <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span> <span class="main">⟶</span> <span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nat_less_induct<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?yp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span> <span class="main">⟶</span>
      <span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="bound">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="bound">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">.</span>
    <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp</span>
    <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_tr_sinks<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span>
    <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_ipurge_tr_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span> <span class="main">⟶</span>
      <span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span> <span class="main">⟶</span>
      <span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures c_tr_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="main">(</span>map fst <span class="var">?xps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>map fst <span class="var">?xps</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_map butlast_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_tr_ipurge_tr <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{..</span>length <span class="free">ys</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span>
    <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_ipurge_tr_1<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{..</span>length <span class="free">ys</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Y</span><span class="main">.</span>
    <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{..&lt;</span>length <span class="free">ys</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_ipurge_tr_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Equivalence between security properties"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The remainder of this section is dedicated to the proof of the equivalence between the CSP
noninterference security of a classical process and the classical noninterference security of the
corresponding deterministic state machine.

In some detail, it will be proven that CSP noninterference security alone is a sufficient condition
for classical noninterference security, whereas the latter security property entails the former for
any reflexive noninterference policy. Therefore, the security properties under consideration turn
out to be equivalent if the enforced noninterference policy is reflexive, which is the case for any
policy of practical significance.

\null
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> secure_implies_c_secure_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">xs</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?yp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">,</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_hd_tl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="var">?yp</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="var">?yp</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?Z</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="var">?yp</span><span class="main">)</span>
      <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_ipurge<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> c_sources_append_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_sources_ipurge<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span>
      <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">y</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_map<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_sources <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> c_dom_sources<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp</span> <span class="main">∉</span> c_sources <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="var">?yp</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      c_ipurge <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_tr_ipurge<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?yp</span> <span class="main">#</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_ipurge<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span> <span class="main">@</span> <span class="var">?yp</span> <span class="main">#</span>
      c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span>
      <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures c_ipurge_append_1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="main">(</span>map fst <span class="var">?xps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>map fst <span class="var">?xps</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_map butlast_append<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps</span><span class="main">)</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure_implies_c_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
    <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> secure_implies_c_secure_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_secure_futures_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">yps</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="free">yp</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?Y'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?X'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_tr_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all c_dom_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?Y'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_append_2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_secure_implies_secure_aux_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
    <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="free">yps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="free">yps</span> <span class="free">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">yps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">yps</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">yps'</span><span class="main">.</span> length <span class="bound">yps'</span> <span class="main">&lt;</span> length <span class="skolem">yps</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="bound">yps'</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
      <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="bound">yps'</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="bound">yps'</span> <span class="bound">Y'</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">yps</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">yps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">yps</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">yps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_futures_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">wps</span> <span class="bound">wp</span><span class="main">.</span> <span class="skolem">yps</span> <span class="main">=</span> <span class="bound">wps</span> <span class="main">@</span> <span class="main">[</span><span class="bound">wp</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">yps</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wps</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">wp</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yps</span> <span class="main">=</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> C<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">cases</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">wp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">wps</span> <span class="main">&lt;</span> length <span class="skolem">yps</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="bound">Y'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">wps</span> <span class="main">&lt;</span> length <span class="skolem">yps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Y'</span><span class="main">.</span>
        <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="bound">Y'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Y'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_futures_1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Y'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
        D<span class="main">:</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span> <span class="main">=</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Y'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="free">xps</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="free">yp</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">wps</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">wp</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures c_failures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_futures_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> W'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_cons_same<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> W' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_tr_ipurge_tr<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">W</span><span class="main">.</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span>
          <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">W</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_hd_tl<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="var">?s</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">W</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">W</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?wps'</span> <span class="main">&lt;</span> length <span class="skolem">yps</span> <span class="main">⟶</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
            <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
            ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="bound">Y'</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?wps'</span> <span class="main">&lt;</span> length <span class="skolem">yps</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_length<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Y'</span><span class="main">.</span>
            <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
            <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
            ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="bound">Y'</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
            <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
            ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
           <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">=</span> <span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">#</span>
            c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="var">?ws</span> <span class="main">@</span> drop <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> W' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_hd_tl<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">=</span> <span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">=</span> <span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span> <span class="main">@</span>
            c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">)</span> <span class="main">@</span>
            c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">m</span> <span class="var">?ws</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="main">=</span>
            ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_cons_same<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">)</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">W</span><span class="main">.</span>
            <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?y</span><span class="main">,</span> <span class="free">out</span> <span class="var">?s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">#</span> <span class="var">?wps'</span><span class="main">)</span><span class="main">,</span> <span class="bound">W</span><span class="main">)</span>
            <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?W'</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps'</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="main">(</span>map fst <span class="var">?xps'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>map fst <span class="var">?xps'</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_append<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def sinks_cons_same R<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
        <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span>
        <span class="main">[</span><span class="main">(</span><span class="var">?w</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span><span class="main">)</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wp</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span>
        <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span> <span class="main">⊆</span> <span class="var">?Y'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all ipurge_ref_def c_dom_def
       <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
        <span class="keyword3"><span class="command">assume</span></span>
          G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_ref<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
          <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="var">?y</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="var">?y</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def ipurge_tr_cons_same<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span>
          <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_cons_same<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_secure_futures_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="free">yp</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?Y'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?X'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_tr_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?X'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all c_dom_def
   <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append foldl_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?Y'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="var">?zs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_append_2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="var">?X</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_secure_ipurge_tr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>
    <span class="main">=</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_tr.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
    <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="main">_</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span> <span class="main">(</span><span class="main">_</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_tr_map<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_tr_map<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp'</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_tr_map<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="var">?yp</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span>
      <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_tr_map<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?yp</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same R B<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span>
        <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span>
        <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_cons_same<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="main">(</span><span class="free">step</span> <span class="var">?s</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_secure_implies_secure_aux_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">zps</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="free">zps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="free">zps</span> <span class="free">Z</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zps</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">zps'</span><span class="main">.</span> length <span class="bound">zps'</span> <span class="main">&lt;</span> length <span class="skolem">zps</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">Z'</span><span class="main">.</span> <span class="main">(</span><span class="bound">zps'</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="bound">zps'</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="bound">zps'</span> <span class="bound">Z'</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zps</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">zps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">zps</span> <span class="skolem">Z</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_futures_2<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">wps</span> <span class="bound">wp</span><span class="main">.</span> <span class="skolem">zps</span> <span class="main">=</span> <span class="bound">wps</span> <span class="main">@</span> <span class="main">[</span><span class="bound">wp</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zps</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wps</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">wp</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zps</span> <span class="main">=</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> C<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">cases</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">wp</span><span class="main">,</span> c_dom <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">wps</span> <span class="main">&lt;</span> length <span class="skolem">zps</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">Z'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">wps</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="bound">Z'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">wps</span> <span class="main">&lt;</span> length <span class="skolem">zps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">wps</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="bound">Z'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wps</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Z'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wps</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_futures_1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Z'</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
        D<span class="main">:</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">=</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="var">?Z'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="free">xps</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="free">yp</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">wps</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">wp</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures c_failures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_failures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">@</span> <span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">@</span> <span class="free">yps</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>map fst <span class="main">[</span><span class="free">yp</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_futures_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">yp</span><span class="main">]</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wps</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> W'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span> <span class="var">?ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_futures_tr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span>
        <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> W' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
        ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_ipurge_tr c_dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> foldl_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_tr_ipurge_tr<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?wps'</span> <span class="main">&lt;</span> length <span class="skolem">zps</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">Z'</span><span class="main">.</span> <span class="main">(</span><span class="var">?wps'</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
          ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="bound">Z'</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?wps'</span> <span class="main">&lt;</span> length <span class="skolem">zps</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_length<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Z'</span><span class="main">.</span>
          <span class="main">(</span><span class="var">?wps'</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
          ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="bound">Z'</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?wps'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span>
          ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span> <span class="main">{}</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wps</span> <span class="main">=</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span> <span class="main">@</span> drop <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> W' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wps</span> <span class="main">=</span> <span class="var">?wps'</span> <span class="main">@</span>
          c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?wps'</span> <span class="main">@</span> c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?wps'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_futures<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
          ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
          <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> XY <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?wps'</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span>
          <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?W'</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def c_secure_ipurge_tr<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">W</span><span class="main">.</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span>
          <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">W</span><span class="main">)</span>
          <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?W'</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?xps'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xps'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>last <span class="var">?xps'</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>butlast <span class="main">(</span>map fst <span class="var">?xps'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>map fst <span class="var">?xps'</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_last<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_append<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∉</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
        <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
        <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def ipurge_tr_cons_same<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same c_dom_def R G <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="var">?w</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
        ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">=</span>
        c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_ipurge_tr<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
        <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">wp</span> <span class="main">=</span>
        <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span>
        <span class="main">[</span><span class="main">(</span><span class="var">?w</span><span class="main">,</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="var">?w</span><span class="main">)</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Y' <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wp</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span> <span class="main">@</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s'</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="main">[</span><span class="var">?y</span><span class="main">]</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="var">?s</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span>
        <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_tr <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?xs</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="var">?Z'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all ipurge_ref_def c_dom_def
       <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps foldl.simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">p</span>
        <span class="keyword3"><span class="command">assume</span></span>
          H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_ref<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span>
          <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">x'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
          <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
          J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="var">?w</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks.simps if_True if_False<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_dom <span class="free">D</span> <span class="skolem">wp</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_sinks<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_cons_same<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="var">?y</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_cons_same<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">D</span> <span class="var">?y</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span> <span class="main">@</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ipurge_ipurge_tr <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ipurge_tr.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
          ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span><span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_ipurge_ipurge_tr<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>c_ipurge <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>
          <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">out</span> <span class="main">(</span>foldl <span class="free">step</span> <span class="var">?s</span>
          <span class="main">(</span><span class="var">?y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="var">?y</span><span class="main">)</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">[</span><span class="var">?w</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xps</span> <span class="main">@</span> <span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span>
        <span class="main">∈</span> c_failures <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
        ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="free">yp</span><span class="main">)</span> <span class="main">(</span><span class="skolem">wps</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">wp</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span>
        <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">xps</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> c_secure_implies_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> secure_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps</span> <span class="skolem">yp</span> <span class="skolem">yps</span> <span class="skolem">Y</span> <span class="skolem">zps</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yp</span> <span class="main">#</span> <span class="skolem">yps</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">xps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zps</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">xps</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">yp</span><span class="main">)</span> <span class="skolem">yps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">yp</span><span class="main">)</span> <span class="skolem">yps</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">xps</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">yp</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">yp</span><span class="main">)</span> <span class="skolem">zps</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">D</span> <span class="skolem">yp</span><span class="main">)</span> <span class="skolem">zps</span> <span class="skolem">Z</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">xps</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∧</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> Y
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_implies_secure_aux_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> Y <span class="keyword2"><span class="keyword">and</span></span> Z
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_secure_implies_secure_aux_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure_equals_c_secure<span class="main">:</span>
 <span class="quoted"><span class="quoted">"refl <span class="free">I</span> <span class="main">⟹</span> secure <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>c_dom <span class="free">D</span><span class="main">)</span> <span class="main">=</span> c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> secure_implies_c_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_secure_implies_secure<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="GeneralizedNoninterference">
<div class="head">
<h1>Theory GeneralizedNoninterference</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Noninterference Security in Communicating Sequential Processes
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"CSP noninterference vs. generalized noninterference"</span></span>

<span class="keyword1"><span class="command">theory</span></span> GeneralizedNoninterference
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ClassicalNoninterference.html">ClassicalNoninterference</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The purpose of this section is to compare CSP noninterference security as defined previously with
McCullough's notion of generalized noninterference security as formulated in \cite{R4}. It will be
shown that this security property is weaker than both CSP noninterference security for a generic
process, and classical noninterference security for classical processes, viz. it is a necessary but
not sufficient condition for them. This renders CSP noninterference security preferable as an
extension of classical noninterference security to nondeterministic systems.

For clarity, all the constants and fact names defined in this section, with the possible exception
of datatype constructors and main theorems, contain prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g_›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Generalized noninterference"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The original formulation of generalized noninterference security as contained in \cite{R4} focuses
on systems whose events, split in inputs and outputs, are mapped into either of two security levels,
\emph{high} and \emph{low}. Such a system is said to be secure just in case, for any trace
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> and any high-level input <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, the set of the \emph{possible low-level futures} of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>, i.e. of the sequences of low-level events that may succeed <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> in the traces of
the system, is equal to the set of the possible low-level futures of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span>.

This definition requires the following corrections:

\begin{itemize}

\item
Variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> must range over all high-level events rather than over high-level inputs alone,
since high-level outputs must not be allowed to affect low-level futures as well.

\item
For any <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, the range of trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> must be restricted to the traces of the system that
may be succeeded by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, viz. trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> must be such that event list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span>
be itself a trace.
\\Otherwise, a system that admits both high-level and low-level events in its alphabet but never
accepts any high-level event, always accepting any low-level one instead, would turn out not to be
secure, which is paradoxical since \emph{high} can by no means affect \emph{low} in a system never
engaging in high-level events. The cause of the paradox is that, for each trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> and each
high-level event <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> of such a system, the set of the possible low-level futures of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span>
matches the Kleene closure of the set of low-level events, whereas the set of the possible low-level
futures of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span> matches the empty set as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span> is not a trace.

\end{itemize}

Observe that the latter correction renders it unnecessary to explicitly assume that event list
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> be a trace of the system, as this follows from the assumption that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span> be
such.

Here below is a formal definition of the notion of generalized noninterference security for
processes, amended in accordance with the previous considerations.

\null
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> g_level <span class="main">=</span> High <span class="main">|</span> Low

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> g_level<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_secure</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">⟶</span>
  <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

It is possible to prove that a weaker sufficient (as well as necessary, as obvious) condition for
generalized noninterference security is that the set of the possible low-level futures of trace
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> be included in the set of the possible low-level futures of trace <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs @ [x]›</span></span></span></span>,
because the latter is always included in the former.

In what follows, such security property is defined formally and its sufficiency for generalized
noninterference security to hold is demonstrated in the form of an introduction rule, which will
turn out to be useful in subsequent proofs.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_secure_suff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> g_level<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_secure_suff</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">⟶</span>
  <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span> <span class="main">⊆</span>
  <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_secure_suff_implies_g_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"g_secure_suff <span class="free">P</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_secure <span class="free">P</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_secure_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span> <span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="bound">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span> <span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span><span class="main">}</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">ys</span> <span class="bound">ys'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?Q'</span> <span class="bound">ys</span> <span class="bound">ys'</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">ys</span> <span class="bound">ys'</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?Q'</span> <span class="bound">ys</span> <span class="bound">ys'</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> S <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_secure_suff_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="skolem">ys'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">ys</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Comparison between security properties"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the continuation, it will be proven that CSP noninterference security is a sufficient condition
for generalized noninterference security for any process whose events are mapped into either
security domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>High›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Low›</span></span></span></span>, under the policy that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>High›</span></span></span></span> may not affect
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Low›</span></span></span></span>.

Particularly, this is the case for any such classical process. This fact, along with the equivalence
between CSP noninterference security and classical noninterference security for classical processes,
is used to additionally prove that the classical noninterference security of a deterministic state
machine is a sufficient condition for the generalized noninterference security of the corresponding
classical process under the aforesaid policy.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_level <span class="main">×</span> g_level<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_I</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>High<span class="main">,</span> High<span class="main">)</span><span class="main">,</span> <span class="main">(</span>Low<span class="main">,</span> Low<span class="main">)</span><span class="main">,</span> <span class="main">(</span>Low<span class="main">,</span> High<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_I_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"refl g_I"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> g_I"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_I_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_sinks<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks g_I <span class="free">L</span> High <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span>High<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks g_I <span class="free">L</span> High <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span>High<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sinks g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>High<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span>High<span class="main">,</span> <span class="free">L</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> g_I <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks g_I <span class="free">L</span> High <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">L</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> g_I<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>High<span class="main">,</span> Low<span class="main">)</span> <span class="main">∈</span> g_I"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>High<span class="main">,</span> Low<span class="main">)</span> <span class="main">∉</span> g_I"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_I_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks g_I <span class="free">L</span> High <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> Low<span class="main">)</span> <span class="main">∈</span> g_I"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> sinks g_I <span class="free">L</span> High <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> Low<span class="main">)</span> <span class="main">∈</span> g_I"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span>High<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>High<span class="main">,</span> Low<span class="main">)</span> <span class="main">∈</span> g_I"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>High<span class="main">,</span> Low<span class="main">)</span> <span class="main">∉</span> g_I"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_I_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_ipurge_tr<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr g_I <span class="free">L</span> High <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr g_I <span class="free">L</span> High <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr g_I <span class="free">L</span> High <span class="skolem">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_I_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">∉</span> sinks g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> B<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>High<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> g_sinks<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Low <span class="main">∈</span> sinks g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Low <span class="main">∈</span> <span class="main">{</span>High<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr g_I <span class="free">L</span> High <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ipurge_tr g_I <span class="free">L</span> High <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x'</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">L</span> <span class="bound">x'</span> <span class="main">=</span> Low<span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> secure_implies_g_secure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> g_I <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"g_secure <span class="free">P</span> <span class="free">L</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> g_secure_suff_implies_g_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_secure_suff_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">ys</span> <span class="skolem">ys'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> ipurge_tr g_I <span class="free">L</span> <span class="main">(</span><span class="free">L</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span>
    ipurge_ref g_I <span class="free">L</span> <span class="main">(</span><span class="free">L</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_ipurge_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> futures <span class="free">P</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> traces_def Domain_iff futures_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">ys'</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys'</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">ys'</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">∧</span> <span class="skolem">ys'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="bound">ys</span><span class="main">.</span> <span class="free">L</span> <span class="bound">y</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> c_secure_implies_g_secure<span class="main">:</span>
 <span class="quoted"><span class="quoted">"c_secure <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> g_I <span class="free">L</span> <span class="main">⟹</span> g_secure <span class="main">(</span>c_process <span class="free">step</span> <span class="free">out</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>c_dom <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> secure_implies_g_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> c_secure_implies_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> g_I_refl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Since the definition of generalized noninterference security does not impose any explicit
requirement on process refusals, intuition suggests that this security property is likely to be
generally weaker than CSP noninterference security for nondeterministic processes, which are such
that even a complete specification of their traces leaves underdetermined their refusals. This is
not the case for deterministic processes, so the aforesaid security properties might in principle
be equivalent as regards such processes.

However, a counterexample proving the contrary is provided by a deterministic state machine
resembling systems \emph{A} and \emph{B} described in \cite{R4}, section 3.1. This machine is proven
not to be classical noninterference-secure, whereas the corresponding classical process turns out to
be generalized noninterference-secure, which proves that the generalized noninterference security of
a classical process is not a sufficient condition for the classical noninterference security of the
associated deterministic state machine.

This result, along with the equivalence between CSP noninterference security and classical
noninterference security for classical processes, is then used to demonstrate that the generalized
noninterference security of the aforesaid classical process does not entail its CSP noninterference
security, which proves that generalized noninterference security is actually not a sufficient
condition for CSP noninterference security even in the case of deterministic processes.

The remainder of this section is dedicated to the construction of such counterexample.

\null
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> g_state <span class="main">=</span> Even <span class="main">|</span> Odd

<span class="keyword1"><span class="command">datatype</span></span> g_action <span class="main">=</span> Any <span class="main">|</span> Count

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">g_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"g_state <span class="main">⇒</span> g_action <span class="main">⇒</span> g_state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Any <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Even <span class="main">⇒</span> Odd <span class="main">|</span> Odd <span class="main">⇒</span> Even<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">g_step</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Count <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">g_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"g_state <span class="main">⇒</span> g_action <span class="main">⇒</span> g_state option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_out</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Any <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">g_out</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> Count <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">g_D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"g_action <span class="main">⇒</span> g_level"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_D</span> Any <span class="main">=</span> High"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">g_D</span> Count <span class="main">=</span> Low"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">g_s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">g_state</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">g_s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> Even"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> g_secure_counterexample<span class="main">:</span>
 <span class="quoted"><span class="quoted">"g_secure <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">(</span>c_dom g_D<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> g_secure_suff_implies_g_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_secure_suff_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xps</span> <span class="skolem">x</span> <span class="skolem">p</span> <span class="skolem">yps</span> <span class="skolem">yps'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> traces <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> c_tr g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_failures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"c_dom g_D <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> High"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Any"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> c_tr g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span>map fst <span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="skolem">yps</span> <span class="main">∈</span> traces <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">yps</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> futures <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="skolem">xps</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yps</span> <span class="main">=</span> c_tr g_step g_out <span class="main">(</span>foldl g_step g_s<span class="hidden">⇩</span><sub>0</sub> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">yps</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> c_tr <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?ys</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_futures_tr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yps</span> <span class="main">=</span>
    c_tr g_step g_out <span class="main">(</span>foldl g_step <span class="main">(</span>foldl g_step g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span> <span class="var">?ys</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> c_tr <span class="main">_</span> <span class="main">_</span> <span class="main">(</span>foldl <span class="main">_</span> <span class="var">?s</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"foldl g_step g_s<span class="hidden">⇩</span><sub>0</sub> <span class="var">?xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c_tr g_step g_out <span class="var">?s</span> <span class="main">[</span>Any<span class="main">]</span> <span class="main">@</span> <span class="skolem">yps</span> <span class="main">=</span> c_tr g_step g_out <span class="var">?s</span> <span class="main">(</span><span class="main">[</span>Any<span class="main">]</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?yp</span> <span class="main">@</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> c_tr_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c_tr g_step g_out <span class="var">?s</span> <span class="main">(</span><span class="main">[</span>Any<span class="main">]</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">,</span>
    <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> g_out <span class="main">(</span>foldl g_step <span class="var">?s</span> <span class="main">(</span><span class="main">[</span>Any<span class="main">]</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">(</span>c_tr g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> c_tr_futures<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span>
    <span class="main">∈</span> futures <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_futures_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">xps</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> c_failures g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xps</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">#</span> <span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span> <span class="main">∈</span> traces <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yps'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">yp</span><span class="main">←</span><span class="skolem">yps</span><span class="main">.</span> c_dom g_D <span class="bound">yp</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yps'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">yp</span><span class="main">←</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">.</span> c_dom g_D <span class="bound">yp</span> <span class="main">=</span> Low<span class="main">]</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_tr_singleton c_dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="main">(</span><span class="var">?yp</span> <span class="main">@</span> <span class="skolem">yps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">yps</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">yps</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">yps</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_c_secure_counterexample<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> c_secure g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub> g_I g_D"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_secure_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"g_out <span class="main">(</span>foldl g_step g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span> Count <span class="main">=</span> Some Odd"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> Count <span class="main">[</span>Any<span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_s<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"g_out <span class="main">(</span>foldl g_step g_s<span class="hidden">⇩</span><sub>0</sub> <span class="main">(</span>c_ipurge g_I g_D <span class="main">(</span>g_D Count<span class="main">)</span> <span class="main">[</span>Any<span class="main">]</span><span class="main">)</span><span class="main">)</span> Count <span class="main">=</span>
    Some Even"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> Count <span class="main">[</span>Any<span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_I_def g_s<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> Count <span class="main">[</span>Any<span class="main">]</span> <span class="main">≠</span> <span class="var">?g</span> Count <span class="main">[</span>Any<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="var">?g</span> <span class="bound">x</span> <span class="bound">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> not_g_secure_implies_c_secure<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>g_secure <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">(</span>c_dom g_D<span class="main">)</span> <span class="main">⟶</span>
  c_secure g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub> g_I g_D<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> g_secure_counterexample<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> not_c_secure_counterexample<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> not_g_secure_implies_secure<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>g_secure <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">(</span>c_dom g_D<span class="main">)</span> <span class="main">⟶</span>
  secure <span class="main">(</span>c_process g_step g_out g_s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> g_I <span class="main">(</span>c_dom g_D<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> g_secure_counterexample<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> secure_implies_c_secure<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> not_c_secure_counterexample<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>