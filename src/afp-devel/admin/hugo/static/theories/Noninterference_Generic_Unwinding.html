<div id="GenericUnwinding">
<div class="head">
<h1>Theory GenericUnwinding</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Generic Unwinding Theorem for CSP Noninterference Security
    Author:      Pasquale Noce
                 Security Certification Specialist at Arjo Systems - Gep S.p.A.
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at arjowiggins-it dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Generic Unwinding Theorem"</span></span>

<span class="keyword1"><span class="command">theory</span></span> GenericUnwinding
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Noninterference_Ipurge_Unwinding/DeterministicProcesses.html">Noninterference_Ipurge_Unwinding.DeterministicProcesses</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The classical definition of noninterference security for a deterministic state machine with outputs
requires to consider the outputs produced by machine actions after any trace, i.e. any indefinitely
long sequence of actions, of the machine. In order to render the verification of the security of
such a machine more straightforward, there is a need of some sufficient condition for security such
that just individual actions, rather than unbounded sequences of actions, have to be taken into
consideration.

By extending previous results applying to transitive noninterference policies, Rushby \cite{R4} has
proven an unwinding theorem that provides a sufficient condition of this kind in the general case of
a possibly intransitive policy. This condition consists of a combination of predicates, which have
to be satisfied by a generic function mapping security domains into equivalence relations over
machine states.

An analogous problem arises for CSP noninterference security, whose definition given in \cite{R1}
requires to consider any possible future, i.e. any indefinitely long sequence of subsequent events
and any indefinitely large set of refused events associated to that sequence, for each process
trace.

This paper provides a sufficient condition for CSP noninterference security, which indeed requires
to just consider individual accepted and refused events and applies to the general case of a
possibly intransitive policy. This condition follows Rushby's one for classical noninterference
security; in some detail, it consists of a combination of predicates, which are the translations of
Rushby's ones into Hoare's Communicating Sequential Processes model of computation \cite{R3}. These
predicates have to be satisfied by a generic function mapping security domains into equivalence
relations over process traces; hence the name given to the condition,
\emph{Generic Unwinding Theorem}. Variants of this theorem applying to deterministic processes and
trace set processes (cf. \cite{R2}) are also proven.

The sufficient condition for security expressed by the Generic Unwinding Theorem would be even more
valuable if it also provided a necessary condition, viz. if for any secure process, there existed
some domain-relation map satisfying the condition. Particularly, a constructive proof of such
proposition, showing that some specified domain-relation map satisfies the condition whatever secure
process is given, would permit to determine whether a process is secure or not by verifying whether
the condition is satisfied by that map or not. However, this paper proves by counterexample that the
Generic Unwinding Theorem does not express a necessary condition for security as well, viz. a
process and a noninterference policy for that process are constructed such that the process is
secure with respect to the policy, but no domain-relation map satisfying the condition exists.

The contents of this paper are based on those of \cite{R1} and \cite{R2}. The salient points of
definitions and proofs are commented; for additional information, cf. Isabelle documentation,
particularly \cite{R5}, \cite{R6}, \cite{R7}, and \cite{R8}.

For the sake of brevity, given a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F›</span></span></span></span> of type
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a<span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>m</sub> ⇒ 'a<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>n</sub> ⇒ 'b›</span></span></span></span>, the explanatory text may discuss of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F›</span></span></span></span>
using attributes that would more exactly apply to a term of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>1</sub> ⇒ … ⇒ 'a<span class="hidden">⇩</span><sub>n</sub> ⇒ 'b›</span></span></span></span>.
In this case, it shall be understood that strictly speaking, such attributes apply to a term
matching pattern <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>F a<span class="hidden">⇩</span><sub>1</sub> … a<span class="hidden">⇩</span><sub>m</sub>›</span></span></span></span>.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Propaedeutic definitions and lemmas"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below are the translations of Rushby's predicates \emph{weakly step consistent} and
\emph{locally respects} \cite{R4}, applying to deterministic state machines, into Hoare's
Communicating Sequential Processes model of computation \cite{R3}.

The differences with respect to Rushby's original predicates are the following ones:

\begin{itemize}

\item
The relations in the range of the domain-relation map hold between event lists rather than machine
states.

\item
The domains appearing as inputs of the domain-relation map do not unnecessarily encompass all the
possible values of the data type of domains, but just the domains in the range of the event-domain
map.

\item
While every machine action is accepted in a machine state, not every process event is generally
accepted after a process trace. Thus, whenever an event is appended to an event list in the
consequent of an implication, the antecedent of the implication constrains the event list to be a
trace, and the event to be accepted after that trace. In this way, the predicates do not
unnecessarily impose that the relations in the range of the domain-relation map hold between event
lists not being process traces.

\end{itemize}

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weakly_step_consistent</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">weakly_step_consistent</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span>
  <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">∩</span> next_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">ys</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_respects</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">locally_respects</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">u</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, some lemmas propaedeutic for the proof of the Generic Unwinding Theorem are
demonstrated.

\null
›</span></span>

<span class="keyword1" id="GenericUnwinding-ipurge_tr_aux_single_event"><span class="command">lemma</span></span> ipurge_tr_aux_single_event<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>
   <span class="keyword1">then</span> <span class="main">[]</span>
   <span class="keyword1">else</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-ipurge_tr_aux_cons"><span class="command">lemma</span></span> ipurge_tr_aux_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>
   <span class="keyword1">then</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="free">xs</span>
   <span class="keyword1">else</span> <span class="free">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">v</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">U</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">D</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_event <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="var">?T'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_cons<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="free">U</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">=</span> <span class="var">?T'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="free">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_cons<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="var">?T'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-unaffected_domains_subset"><span class="command">lemma</span></span> unaffected_domains_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> unaffected_domains_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sinks_aux_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">-</span><span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The Generic Unwinding Theorem: proof of condition sufficiency"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Rushby's \emph{Unwinding Theorem for Intransitive Policies} \cite{R4} states that a sufficient
condition for a deterministic state machine with outputs to be secure is the existence of some
domain-relation map \emph{R} such that:

\begin{enumerate}

\item
\emph{R} is a \emph{view partition}, i.e. the relations over machine states in its range are
equivalence relations;

\item
\emph{R} is \emph{output consistent}, i.e. states equivalent with respect to the domain of an action
produce the same output as a result of that action;

\item
\emph{R} is weakly step consistent;

\item
\emph{R} locally respects the policy.

\end{enumerate}

The idea behind the theorem is that a machine is secure if its states can be partitioned, for each
domain \emph{u}, into equivalence classes (1), such that the states in any such class \emph{C} are
indistinguishable with respect to the actions in \emph{u} (2), transition into the same equivalence
class \emph{C'} as a result of an action (3), and transition remaining inside \emph{C} as a result
of an action not allowed to affect \emph{u} (4).

This idea can simply be translated into the realm of Communicating Sequential Processes \cite{R3} by
replacing the words "machine", "state", "action" with "process", "trace", "event", respectively, as
long as a clarification is provided of what it precisely means for a pair of traces to be
"indistinguishable" with respect to the events in a given domain. Intuitively, this happens just in
case the events in that domain being accepted or refused after either trace are the same, thus the
simplest choice would be to replace output consistency with \emph{future consistency} as defined in
\cite{R2}. However, indistinguishability between traces in the same equivalence class is not
required in the case of a domain allowed to be affected by any domain, since the policy puts no
restriction on the differences in process histories that may be detected by such a domain. Hence, it
is sufficient to replace output consistency with \emph{weak future consistency} \cite{R2}.

Furthermore, indistinguishability with respect to individual refused events does not imply
indistinguishability with respect to sets of refused events, i.e. refusals, unless for each trace,
the corresponding refusals set is closed under set union. Therefore, for the condition to be
sufficient for process security, the \emph{refusals union closure} of the process \cite{R2} is also
required. As remarked in \cite{R2}, this property holds for any process admitting a meaningful
interpretation, so that taking it as an additional assumption does not give rise to any actual
limitation on the applicability of the theorem.

As a result of these considerations, the Generic Unwinding Theorem, formalized in what follows as
theorem <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>generic_unwinding›</span></span></span></span>, states that a sufficient condition for the CSP noninterference
security \cite{R1} of a process being refusals union closed \cite{R2} is the existence of some
domain-relation map \emph{R} such that:

\begin{enumerate}

\item
\emph{R} is a view partition \cite{R2};

\item
\emph{R} is weakly future consistent \cite{R2};

\item
\emph{R} is weakly step consistent;

\item
\emph{R} locally respects the policy.

\end{enumerate}

\null
›</span></span>

<span class="keyword1" id="GenericUnwinding-ruc_wfc_failures"><span class="command">lemma</span></span> ruc_wfc_failures<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"singleton_set <span class="main">(</span><span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_some<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> IntE<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> WFC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs'</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> singleton_set_union<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs'</span> <span class="main">∈</span> traces <span class="free">P</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfc_traces <span class="main"><span class="main">[</span></span><span class="operator">OF</span> WFC<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs'</span><span class="main">,</span> <span class="free">X</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="free">U</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-ruc_wfc_lr_failures_1"><span class="command">lemma</span></span> ruc_wfc_lr_failures_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"singleton_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_some<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> WFC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> singleton_set_union<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-ruc_wfc_lr_failures_2"><span class="command">lemma</span></span> ruc_wfc_lr_failures_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Y<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"singleton_set <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_union_closed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_some<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> WFC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">x</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">∧</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="bound">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_dom_events_def refusals_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">X</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> singleton_set_union<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> traces_failures<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-gu_condition_imply_secure_aux"><span class="command">lemma</span></span> gu_condition_imply_secure_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    VP<span class="main">:</span>   <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WSC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">⟶</span> <span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="main">[]</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">.</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="free">U</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">xs</span> <span class="skolem">xs'</span> <span class="skolem">U</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">xs'</span> <span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">⟶</span> <span class="bound">U</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="bound">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">,</span> <span class="bound">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="bound">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_cons<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U'</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">⟶</span> <span class="var">?U'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?U'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?U'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?U'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="var">?U'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?U'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> VP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symE<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transE<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="var">?U'</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">⟶</span> <span class="skolem">U</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">,</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">-</span><span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">⟶</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span> <span class="main">∧</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> WFC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟶</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">ys</span> <span class="main">∧</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="bound">ys</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟶</span>
        next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs'</span> <span class="main">∧</span>
        ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> ref_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs'</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> next_dom_events <span class="free">P</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> K <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">ys</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> WSC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_step_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">ys</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">xs'</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sinks_aux_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="skolem">U</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-gu_condition_imply_secure_1"><span class="command">lemma</span></span> gu_condition_imply_secure_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    VP<span class="main">:</span>   <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WSC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">ys</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_lr_failures_1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y'</span> <span class="skolem">ys</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y'</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="bound">Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">y'</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y'</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_lr_failures_1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="var">?Y'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span> <span class="main">=</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="var">?Y'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unaffected_domains_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_interference_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def sinks_aux_single_dom set_eq_iff<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span>
      <span class="free">xs</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gu_condition_imply_secure_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> VP WFC WSC LR<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def C<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_traces<span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> VP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symE<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">,</span>
      <span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="var">?U</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_failures <span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUC WFC<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="var">?U</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y'</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> unaffected_domains_single_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-gu_condition_imply_secure_2"><span class="command">lemma</span></span> gu_condition_imply_secure_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    VP<span class="main">:</span>   <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WSC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Y<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">,</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="free">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipurge_ref_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_lr_failures_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Z'</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span>
      ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="bound">Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
    ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="skolem">z</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sinks.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">z</span><span class="main">,</span> <span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_lr_failures_1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="var">?Z'</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">=</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="var">?Z'</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ipurge_ref_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="skolem">Z</span><span class="main">)</span>
        <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> range <span class="free">D</span> <span class="main">∩</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">``</span> range <span class="free">D</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unaffected_domains_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sinks_interference_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> sinks <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def sinks_aux_single_dom set_eq_iff<span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="free">D</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span>
      <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> ipurge_tr_aux <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gu_condition_imply_secure_aux <span class="main"><span class="main">[</span></span><span class="operator">OF</span> VP WFC WSC LR<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unaffected_domains_def C<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_events_def<span class="main">)</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> <span class="var">?U</span><span class="main">.</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">,</span>
      <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ipurge_tr_aux_single_dom<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Z</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="var">?U</span><span class="main">)</span>
      <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ruc_wfc_failures <span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUC WFC<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∩</span> <span class="free">D</span> <span class="main">-`</span> <span class="var">?U</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">Z</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">∈</span> unaffected_domains <span class="free">I</span> <span class="free">D</span> <span class="main">{</span><span class="free">D</span> <span class="free">y</span><span class="main">}</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> unaffected_domains_single_dom<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> generic_unwinding<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    RUC<span class="main">:</span>  <span class="quoted"><span class="quoted">"ref_union_closed <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    VP<span class="main">:</span>   <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WFC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WSC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> secure_def futures_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">Y</span> <span class="skolem">zs</span> <span class="skolem">Z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> ipurge_tr <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">,</span> ipurge_ref <span class="free">I</span> <span class="free">D</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">zs</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∧</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="keyword1"><span class="command">using</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> VP <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> WSC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword2"><span class="keyword">and</span></span> A
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gu_condition_imply_secure_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> failures <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_rule_2_failures<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">∈</span> traces <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> failures_traces<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RUC <span class="keyword2"><span class="keyword">and</span></span> VP <span class="keyword2"><span class="keyword">and</span></span> WFC <span class="keyword2"><span class="keyword">and</span></span> WSC <span class="keyword2"><span class="keyword">and</span></span> LR <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="keyword1"><span class="command">using</span></span> B
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gu_condition_imply_secure_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

It is interesting to observe that unlike symmetry and transitivity, the assumed reflexivity of the
relations in the range of the domain-relation map is never used in the proof of the Generic
Unwinding Theorem. Nonetheless, by assuming that such relations be equivalence relations over
process traces rather than just symmetric and transitive ones, reflexivity has been kept among
assumptions for both historical reasons -- Rushby's Unwinding Theorem for deterministic state
machines deals with equivalence relations -- and practical reasons -- predicate
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="main"><span class="main">(</span></span>traces <span class="free"><span class="free">P</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may only be verified by a relation included in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"traces <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">×</span></span> traces <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, thus ensuring that traces be not correlated with non-trace event
lists, which is a necessary condition for weak future consistency (cf. \cite{R2}).

Here below are convenient variants of the Generic Unwinding Theorem applying to deterministic
processes and trace set processes (cf. \cite{R2}).

\null
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> d_generic_unwinding<span class="main">:</span>
 <span class="quoted"><span class="quoted">"deterministic <span class="free">P</span> <span class="main">⟹</span>
  view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  d_weakly_future_consistent <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  secure <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> generic_unwinding<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> d_implies_ruc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">drule</span> d_wfc_equals_dwfc <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ts_generic_unwinding<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set <span class="free">T</span> <span class="main">⟹</span>
  view_partition <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  d_weakly_future_consistent <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  weakly_step_consistent <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  locally_respects <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span> <span class="main">⟹</span>
  secure <span class="main">(</span>ts_process <span class="free">T</span><span class="main">)</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> d_generic_unwinding<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> ts_process_d<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"The Generic Unwinding Theorem: counterexample to condition necessity"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
At a first glance, it seems reasonable to hypothesize that the Generic Unwinding Theorem expresses
a necessary, as well as sufficient, condition for security, viz. that whenever a process is secure
with respect to a policy, there should exist a set of "views" of process traces, one per domain,
satisfying the apparently simple assumptions of the theorem.

It can thus be surprising to discover that this hypothesis is false, as proven in what follows by
constructing a counterexample. The key observation for attaining this result is that symmetry,
transitivity, weak step consistency, and local policy respect permit to infer the correlation of
pairs of traces, and can then be given the form of introduction rules in the inductive definition of
a set. In this way, a "minimum" domain-relation map <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_induct›</span></span></span></span> is obtained, viz. a map such
that, for each domain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span>, the image of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> under this map is included in the image of
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> under any map which has the aforesaid properties -- particularly, which satisfies the
assumptions of the Generic Unwinding Theorem.

Although reflexivity can be given the form of an introduction rule, too, it has been omitted from
the inductive definition. This has been done in order to ensure that the "minimum" domain-relation
map, and consequently the counterexample as well, still remain such even if reflexivity, being
unnecessary (cf. above), were removed from the assumptions of the Generic Unwinding Theorem.

\null
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">rel_induct_aux</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
rule_sym<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="main">|</span>
rule_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">;</span>
             <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">⟧</span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="main">|</span>
rule_WSC<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">;</span>
             <span class="main">(</span><span class="free">D</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span><span class="main">;</span>
             <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span> <span class="main">|</span>
rule_LR<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∈</span> range <span class="free">D</span><span class="main">;</span> <span class="main">(</span><span class="free">D</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
               <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rel_induct_aux</span> <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_induct</span> <span class="main">::</span>
 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> dom_rel_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_induct</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> rel_induct_aux <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="GenericUnwinding-rel_induct_subset"><span class="command">lemma</span></span> rel_induct_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    VP<span class="main">:</span>   <span class="quoted"><span class="quoted">"view_partition <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    WSC<span class="main">:</span>  <span class="quoted"><span class="quoted">"weakly_step_consistent <span class="free">P</span> <span class="free">D</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    LR<span class="main">:</span>   <span class="quoted"><span class="quoted">"locally_respects <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_induct <span class="free">P</span> <span class="free">I</span> <span class="free">D</span> <span class="free">u</span> <span class="main">⊆</span> <span class="free">R</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_induct_def split_paired_all<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> rel_induct_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> VP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_induct_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> VP <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> view_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_induct_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv <span class="main">(</span>traces <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">R</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">ys</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> WSC <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_step_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux <span class="free">P</span> <span class="free">I</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_induct_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="bound">ys</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">∩</span> next_events <span class="free">P</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range <span class="free">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
    <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="bound">u</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> LR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_respects_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> range <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span>
    <span class="main">(</span><span class="free">D</span> <span class="bound">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">D</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> next_events <span class="free">P</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The next step consists of the definition of a trace set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T<span class="hidden">⇩</span><sub>c</sub>›</span></span></span></span>, the corresponding trace set
process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P<span class="hidden">⇩</span><sub>c</sub>›</span></span></span></span> (cf. \cite{R2}), and a reflexive, intransitive noninterference policy <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>I<span class="hidden">⇩</span><sub>c</sub>›</span></span></span></span>
for this process, where subscript "c" stands for "counterexample". As event-domain map, the identity
function is used, which explains why the policy is defined over events themselves.

\null
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> event<span class="hidden">⇩</span><sub>c</sub> <span class="main">=</span> a<span class="hidden">⇩</span><sub>c</sub> <span class="main">|</span> b<span class="hidden">⇩</span><sub>c</sub> <span class="main">|</span> c<span class="hidden">⇩</span><sub>c</sub>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event<span class="hidden">⇩</span><sub>c</sub> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">≡</span> <span class="main">{</span><span class="main">[]</span><span class="main">,</span>
  <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span>
  <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event<span class="hidden">⇩</span><sub>c</sub> process"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">P<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">≡</span> ts_process T<span class="hidden">⇩</span><sub>c</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">I<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>event<span class="hidden">⇩</span><sub>c</sub> <span class="main">×</span> event<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">I<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">,</span> <span class="main">(</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">,</span> <span class="main">(</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">,</span> <span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">,</span> <span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">P<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be shown to be secure with respect to policy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">I<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This result can be
obtained by applying the Ipurge Unwinding Theorem, in the version for trace set processes \cite{R2},
and then performing an exhaustive case distinction over all traces and domains, which obviously is
possible by virtue of their finiteness.

Nevertheless, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">P<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">I<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are such that there exists no domain-relation map satisfying
the assumptions of the Generic Unwinding Theorem. A proof \emph{ad absurdum} is given, based on the
fact that the pair of traces <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">[</span></span>a<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> b<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> c<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[</span></span>b<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> a<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> c<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be shown to be contained in
the image of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under the "minimum" domain-relation map <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rel_induct›</span></span></span></span>. Therefore, it
would also be contained in the image of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under a map satisfying the assumptions of the
Generic Unwinding Theorem, so that according to weak future consistency, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> should be a
possible subsequent event for trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>a<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> b<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> c<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> just in case it were such for trace
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span>b<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> a<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">,</span></span> c<span class="hidden">⇩</span><sub>c</sub><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, this conclusion contradicts the fact that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a<span class="hidden">⇩</span><sub>c</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a possible
subsequent event for the former trace only.

\null
›</span></span>

<span class="keyword1" id="GenericUnwinding-counterexample_trace_set"><span class="command">lemma</span></span> counterexample_trace_set<span class="main">:</span>
 <span class="quoted"><span class="quoted">"trace_set T<span class="hidden">⇩</span><sub>c</sub>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_set_def T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>

<span class="keyword1" id="GenericUnwinding-counterexample_next_events_1"><span class="command">lemma</span></span> counterexample_next_events_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> next_events <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_process_next_events<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> counterexample_trace_set<span class="main">)</span>

<span class="keyword1" id="GenericUnwinding-counterexample_next_events_2"><span class="command">lemma</span></span> counterexample_next_events_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> P<span class="hidden">⇩</span><sub>c</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> counterexample_next_events_1<span class="main">)</span>

<span class="keyword1" id="GenericUnwinding-counterexample_secure"><span class="command">lemma</span></span> counterexample_secure<span class="main">:</span>
 <span class="quoted"><span class="quoted">"secure P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P<span class="hidden">⇩</span><sub>c</sub>_def ts_ipurge_unwinding <span class="main"><span class="main">[</span></span><span class="operator">OF</span> counterexample_trace_set<span class="main"><span class="main">]</span></span>
 dfc_equals_dwfc_rel_ipurge <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> d_future_consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> rel_ipurge <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> I<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">u</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="skolem">xs</span> <span class="main">∈</span> traces <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">∈</span> traces <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    next_dom_events <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> id <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span>
    next_dom_events <span class="main">(</span>ts_process T<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> id <span class="skolem">u</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_ipurge_def ts_process_traces <span class="main"><span class="main">[</span></span><span class="operator">OF</span> counterexample_trace_set<span class="main"><span class="main">]</span></span>
   next_dom_events_def counterexample_next_events_1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub> <span class="main">∧</span>
      ipurge_tr_rev I<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">u</span> <span class="skolem">xs</span> <span class="main">=</span> ipurge_tr_rev I<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">u</span> <span class="skolem">ys</span> <span class="main">⟶</span>
      <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">u</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">∈</span> T<span class="hidden">⇩</span><sub>c</sub><span class="main">}</span>"</span></span>
    <span class="comment1">(* The following proof step performs an exhaustive case distinction over all traces and domains,
       and then could take ca. 20 seconds to be completed. *)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T<span class="hidden">⇩</span><sub>c</sub>_def I<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-counterexample_not_gu_condition_aux"><span class="command">lemma</span></span> counterexample_not_gu_condition_aux<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_induct_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"a<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> range id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="main">∉</span> I<span class="hidden">⇩</span><sub>c</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_LR<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[]</span> <span class="main">∩</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_WSC<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_LR<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_sym<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"c<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> range id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="main">∉</span> I<span class="hidden">⇩</span><sub>c</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"a<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_LR<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> range id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="main">∉</span> I<span class="hidden">⇩</span><sub>c</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_LR<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[]</span> <span class="main">∩</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_WSC <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_sym<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_LR<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">∩</span> next_events P<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rule_WSC<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> rel_induct_aux P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="GenericUnwinding-counterexample_not_gu_condition"><span class="command">lemma</span></span> counterexample_not_gu_condition<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span>  view_partition P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          weakly_future_consistent P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          weakly_step_consistent P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          locally_respects P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"weakly_future_consistent P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> range id <span class="main">∩</span> <span class="main">(</span><span class="main">-</span>I<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="main">``</span> range id<span class="main">.</span> <span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="bound">u</span> <span class="main">⟶</span>
    next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">u</span> <span class="bound">xs</span> <span class="main">=</span> next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">u</span> <span class="bound">ys</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weakly_future_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a<span class="hidden">⇩</span><sub>c</sub> <span class="main">∈</span> range id <span class="main">∩</span> <span class="main">(</span><span class="main">-</span>I<span class="hidden">⇩</span><sub>c</sub><span class="main">)</span> <span class="main">``</span> range id"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="hidden">⇩</span><sub>c</sub>_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ImageI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">b<span class="hidden">⇩</span><sub>c</sub></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span> a<span class="hidden">⇩</span><sub>c</sub> <span class="main">⟶</span>
    next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="bound">xs</span> <span class="main">=</span> next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span> a<span class="hidden">⇩</span><sub>c</sub> <span class="main">⟶</span>
    next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">=</span> next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"view_partition P<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"weakly_step_consistent P<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"locally_respects P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_induct P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="main">⊆</span> <span class="skolem">R</span> a<span class="hidden">⇩</span><sub>c</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_induct_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">,</span> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">R</span> a<span class="hidden">⇩</span><sub>c</sub>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> counterexample_not_gu_condition_aux <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span> <span class="main">=</span> next_dom_events P<span class="hidden">⇩</span><sub>c</sub> id a<span class="hidden">⇩</span><sub>c</sub> <span class="main">[</span>b<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> a<span class="hidden">⇩</span><sub>c</sub><span class="main">,</span> c<span class="hidden">⇩</span><sub>c</sub><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next_dom_events_def counterexample_next_events_2 T<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> not_secure_implies_gu_condition<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>secure P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span>  view_partition P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          weakly_future_consistent P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          weakly_step_consistent P<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span> <span class="main">∧</span>
          locally_respects P<span class="hidden">⇩</span><sub>c</sub> I<span class="hidden">⇩</span><sub>c</sub> id <span class="bound">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> not_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> counterexample_secure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> counterexample_not_gu_condition<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>