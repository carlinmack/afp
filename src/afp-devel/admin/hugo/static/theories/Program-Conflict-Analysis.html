<div id="Misc">
<div class="head">
<h1>Theory Misc</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Miscellanneous Definitions and Lemmas
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellanneous Definitions and Lemmas›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Misc
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Subseq_Order.html">HOL-Library.Subseq_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Misc}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we provide a collection of miscellaneous definitions and helper lemmas›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Miscellanneous (1)"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This stuff is used in this theory itself, and thus occurs in first place. There is another ,,Miscellaneous''-section at the end of this theory›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"AC-operators"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Locale to declare AC-laws as simplification rules›</span></span>
<span class="keyword1"><span class="command">locale</span></span> AC <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> AC<span class="main">)</span> left_commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">(</span><span class="free">f</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Locale to define functions from surjective, unique relations›</span></span>
<span class="keyword1"><span class="command">locale</span></span> su_rel_fun <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">;</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B'</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">=</span><span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> surjective<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">!!</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">A</span> <span class="main">==</span> <span class="keyword1">THE</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">f</span> <span class="free">A</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> f_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> surjective<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> theI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unique<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">=</span><span class="free">f</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> repr1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> unique<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> su_rel_fun<span class="main">)</span> repr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">)</span><span class="main">∈</span><span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> repr1 repr2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span> 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations for list order›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ileq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(≼)</span></span> <span class="main">≡</span> <span class="main">(≤)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ilt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≺</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(≺)</span></span> <span class="main">≡</span> <span class="main">(&lt;)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets›</span></span>

<span class="comment1">(*
  The following is a syntax extension for multisets. Unfortunately, it depends on a change in the Library/Multiset.thy, so it is commented out here, until it will be incorporated 
  into Library/Multiset.thy by its maintainers.

  The required change in Library/Multiset.thy is removing the syntax for single:
     - single :: "'a =&gt; 'a multiset"    ("{#_#}")
     + single :: "'a =&gt; 'a multiset"

  And adding the following translations instead:
  
     + syntax
     + "_multiset" :: "args ⇒ 'a multiset" ("{#(_)#}")

     + translations
     +   "{#x, xs#}" == "{#x#} + {#xs#}" 
     +   "{# x #}" == "single x"

  This translates "{# … #}" into a sum of singletons, that is parenthesized to the right. ?? Can we also achieve left-parenthesizing ??

*)</span>


  <span class="comment1">(* Let's try what happens if declaring AC-rules for multiset union as simp-rules *)</span>
<span class="comment1">(*declare union_ac[simp] -- don't do it !*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case distinction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_induct'<span class="main">[</span><span class="operator">case_names</span> empty add<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">{#}</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">M</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="main">{#</span><span class="bound">x</span><span class="main">#}</span><span class="main">+</span><span class="bound">M</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multiset_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Count›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> count_ne_remove<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">~=</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> count <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_empty_count<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">=</span><span class="main">{#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Union, difference and intersection›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> size_diff_se<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span> size <span class="free">S</span> <span class="main">=</span> size <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> size_multiset_overloaded_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?SIZE</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> SPLITPRE<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⊆</span><span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sum.subset_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">S</span> <span class="free">t</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">arith</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">x</span><span class="main">:</span><span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> count <span class="free">S</span> <span class="bound">x</span> <span class="main">=</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_ne_remove<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∉#</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> at_most_one_mset_mset_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> CASE D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> CASE <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">S</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> more_than_one_mset_mset_diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SPLITPRE sum.subset_diff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?SIZE</span> <span class="main">=</span> sum <span class="main">(</span>count <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: Check whether this proof can be done simpler *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_union_diff_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">+</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">+</span> <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="free">t</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈#</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> add_mset <span class="free">t</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_DiffM<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_right_cancel_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_left_cancel_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> mset_cancel_union <span class="main">=</span> mset_right_cancel_union mset_left_cancel_union

  <span class="keyword1"><span class="command">lemma</span></span> mset_right_cancel_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">;</span> <span class="free">a</span><span class="main">~=</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_left_cancel_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">+</span><span class="free">A</span><span class="main">;</span> <span class="free">a</span><span class="main">~=</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_cancel_elem <span class="main">=</span> mset_right_cancel_elem mset_left_cancel_elem

  <span class="keyword1"><span class="command">lemma</span></span> mset_diff_cancel1elem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">-</span><span class="free">B</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">-</span><span class="free">B</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> count <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">e</span> <span class="main">.</span> <span class="bound">e</span><span class="main">~=</span><span class="free">a</span> <span class="main">⟶</span> count <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">-</span><span class="free">B</span><span class="main">)</span> <span class="bound">e</span> <span class="main">=</span> count <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="bound">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(*lemma union_diff_assoc_se: "t ∈# B ⟹ (A+B)-{#t#} = A + (B-{#t#})"
    by (auto iff add: multiset_eq_iff)
  lemma union_diff_assoc_se2: "t ∈# A ⟹ (A+B)-{#t#} = (A-{#t#}) + B"
    by (auto iff add: multiset_eq_iff)
  lemmas union_diff_assoc_se = union_diff_assoc_se1 union_diff_assoc_se2*)</span>

  <span class="keyword1"><span class="command">lemma</span></span> union_diff_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="free">B</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span><span class="main">-</span><span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_union_2_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">b</span><span class="main">#}</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">=</span><span class="free">M</span> <span class="main">&amp;</span> <span class="free">b</span><span class="main">=</span><span class="free">c</span> <span class="main">|</span> <span class="free">a</span><span class="main">=</span><span class="free">c</span> <span class="main">&amp;</span> <span class="main">{#</span><span class="free">b</span><span class="main">#}</span><span class="main">=</span><span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_conv_diff<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_un_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">;</span> <span class="free">a</span><span class="main">∈#</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">a</span><span class="main">∈#</span><span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_unplusm_dist_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">B</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">C</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> L<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">A</span> <span class="main">=</span> add_mset <span class="free">s</span> <span class="main">(</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> R<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_unplusm_dist_cases2<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">+</span><span class="free">C</span> <span class="main">=</span> add_mset <span class="free">s</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">B</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">C</span><span class="main">=</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
    <span class="keyword1"><span class="command">using</span></span> mset_unplusm_dist_cases<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> L R <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_single_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">)</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="free">r'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASE CASES <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">r'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈#</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">+</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈#</span> <span class="free">c'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> insert_DiffM<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> add_mset <span class="free">s</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 3 CASES <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_single_cases'<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">cc</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">+</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A  CASES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_single_cases<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_single_cases2<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="main">(</span><span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="main">(</span><span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span> <span class="main">=</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_single_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> loc <span class="keyword1"><span class="command">with</span></span> CASES <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> env <span class="keyword1"><span class="command">with</span></span> CASES <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_single_cases2'<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc env<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s</span> <span class="free">c</span> <span class="main">=</span> add_mset <span class="free">r'</span> <span class="free">c'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span><span class="main">=</span><span class="free">r'</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">cc</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="bound">cc</span><span class="main">+</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">;</span> <span class="free">c</span><span class="main">=</span><span class="bound">cc</span><span class="main">+</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">;</span> <span class="free">c'</span><span class="main">-</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">;</span> <span class="free">c</span><span class="main">-</span><span class="main">{#</span><span class="free">r'</span><span class="main">#}</span><span class="main">=</span><span class="bound">cc</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A  CASES <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_single_cases2<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_un_single_un_cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASES<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> left<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="free">B</span><span class="main">+</span><span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> CASES<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> right<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

      <span class="comment1">(* TODO: Can this proof be done more automatically ? *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_distrib<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> dist<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span> <span class="main">=</span> <span class="free">M</span><span class="main">+</span><span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">Am</span> <span class="bound">An</span> <span class="bound">Bm</span> <span class="bound">Bn</span><span class="main">.</span> <span class="main">⟦</span><span class="free">A</span><span class="main">=</span><span class="bound">Am</span><span class="main">+</span><span class="bound">An</span><span class="main">;</span> <span class="free">B</span><span class="main">=</span><span class="bound">Bm</span><span class="main">+</span><span class="bound">Bn</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="bound">Am</span><span class="main">+</span><span class="bound">Bm</span><span class="main">;</span> <span class="free">N</span><span class="main">=</span><span class="bound">An</span><span class="main">+</span><span class="bound">Bn</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> BN_MA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">-</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_right assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> union_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span><span class="main">∩#</span> <span class="skolem">C</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∩#</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_intersect_left_idem mset_subset_eq_add_left subset_eq_diff_conv
          subset_mset.add_diff_inverse subset_mset.inf_absorb1 subset_mset.inf_le1 that<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A</span><span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="free">B</span><span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩#</span> <span class="free">M</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">N</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> BN_MA<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> diff_intersect_left_idem
          diff_union_cancelR multiset_inter_commute subset_mset.diff_add subset_mset.inf.cobounded1
          union_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">∩#</span> <span class="free">N</span> <span class="main">+</span> <span class="free">B</span> <span class="main">∩#</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_union_cancelL inter_union_distrib_left inter_union_distrib_right
          mset_subset_eq_multiset_union_diff_commute subset_mset.inf.cobounded1 subset_mset.inf.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Singleton multisets›</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> mset_size_le1_cases<span class="main">[</span><span class="operator">case_names</span> empty singleton<span class="main">,</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> size <span class="free">M</span> <span class="main">≤</span> Suc <span class="main">0</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">m</span><span class="main">.</span> <span class="free">M</span><span class="main">=</span><span class="main">{#</span><span class="bound">m</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_union_single_conv2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">J</span> <span class="main">⟹</span> <span class="free">J</span> <span class="main">+</span> <span class="free">I</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">J</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> diff_union_single_conv <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> diff_union_single_convs <span class="main">=</span> diff_union_single_conv diff_union_single_conv2

<span class="keyword1"><span class="command">lemma</span></span> mset_contains_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="free">M</span><span class="main">-</span><span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">)</span><span class="main">=</span><span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">m</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointwise ordering›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_le_incr_right1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">⊆#</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_incr_right2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">⊆#</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">c</span><span class="main">+</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_incr_right1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> mset_le_incr_right <span class="main">=</span> mset_le_incr_right1 mset_le_incr_right2

  <span class="keyword1"><span class="command">lemma</span></span> mset_le_decr_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">c</span><span class="main">⊆#</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_incr_right1 mset_subset_eq_mono_add_right_cancel
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_decr_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">+</span><span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">⊆#</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_le_decr_left1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_add_mset_decr_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">c</span> <span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">⊆#</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD subset_mset.dual_order.strict_implies_order<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_add_mset_decr_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">c</span> <span class="free">a</span><span class="main">⊆#</span><span class="main">(</span><span class="free">b</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD subset_mset.dual_order.strict_implies_order<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> mset_le_decr_left <span class="main">=</span> mset_le_decr_left1 mset_le_decr_left2 mset_le_add_mset_decr_left1
    mset_le_add_mset_decr_left2
  
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_subtract<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">⊆#</span><span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">-</span><span class="free">C</span> <span class="main">⊆#</span> <span class="free">B</span><span class="main">-</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> subseteq_mset_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="improper">a</span> <span class="main">≤</span> count <span class="free">B</span> <span class="improper">a</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_union_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">⊆#</span><span class="free">C</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_decr_left<span class="main">)</span>
 
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_add_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">C</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="main">(</span><span class="free">C</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_decr_left<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_subtract_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">A</span> <span class="main">∧</span> <span class="free">A</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span><span class="main"><span class="main">]</span></span> mset_union_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_subtract_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">B</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>"</span></span><span class="main"><span class="main">]</span></span> mset_union_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_le_subtract_add_mset_left<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">∧</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> mset_le_add_mset<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_le_subtract_add_mset_right<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">X</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">X</span><span class="main">-</span><span class="free">B</span> <span class="main">∧</span> <span class="free">B</span><span class="main">⊆#</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_le_subtract<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">x</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>"</span></span><span class="main"><span class="main">]</span></span> mset_le_add_mset<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_le_addE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">xs</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">⊆#</span> <span class="free">ys</span><span class="main">;</span> <span class="main">!!</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span><span class="main">=</span><span class="free">xs</span><span class="main">+</span><span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_exists_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">declare</span></span> subset_mset.diff_add<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_2dist2_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span> <span class="main">+</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="free">a</span> <span class="main">+</span> count <span class="free">B</span> <span class="free">a</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="quoted"><span class="quoted">"count <span class="free">A</span> <span class="free">b</span> <span class="main">+</span> count <span class="free">B</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_count <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> mset_subset_eq_count <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff Suc_le_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> mset_subset_eq_mono_add <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉#</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> B A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_subset_eq_iff diff_union_single_convs
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subset_mset.add_diff_assoc2<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> C mset_subset_eq_mono_add <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">-</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉#</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉#</span> <span class="free">B</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_union_subset_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> B<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_mset_remove_trivial insert_DiffM2 
            mset_diff_cancel1elem single_subset_iff subset_eq_diff_conv subset_mset.diff_diff_right
            union_single_eq_member<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">using</span></span> CASES <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_union_subset_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">+</span><span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈#</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">⊆#</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> mset_union_subset<span class="main">)</span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_single_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty singleton<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">M</span><span class="main">⊆#</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="free">M</span><span class="main">=</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>
      
  <span class="keyword1"><span class="command">lemma</span></span> mset_le_distrib<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> dist<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span><span class="main">⊆#</span><span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="tfree">'a</span> multiset<span class="main">)</span><span class="main">+</span><span class="free">B</span><span class="main">;</span> <span class="main">!!</span><span class="bound">Xa</span> <span class="bound">Xb</span><span class="main">.</span> <span class="main">⟦</span><span class="free">X</span><span class="main">=</span><span class="bound">Xa</span><span class="main">+</span><span class="bound">Xb</span><span class="main">;</span> <span class="bound">Xa</span><span class="main">⊆#</span><span class="free">A</span><span class="main">;</span> <span class="bound">Xb</span><span class="main">⊆#</span><span class="free">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_le_addE mset_distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_le_mono_add_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">∈#</span> <span class="free">ys</span><span class="main">;</span> <span class="free">b</span> <span class="main">∈#</span> <span class="free">ws</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">{#</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">ys</span> <span class="main">+</span> <span class="free">ws</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">b</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> mset_size1elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>size <span class="free">P</span> <span class="main">≤</span> <span class="main">1</span><span class="main">;</span> <span class="free">q</span> <span class="main">∈#</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">=</span><span class="main">{#</span><span class="free">q</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_size_le1_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> mset_size2elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>size <span class="free">P</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">;</span> <span class="main">{#</span><span class="free">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">q'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">=</span><span class="main">{#</span><span class="free">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free">q'</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Image under function›</span></span>

<span class="keyword1"><span class="command">notation</span></span> image_mset <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">`#</span>"</span> 90<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_map_single_rightE<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> orig<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">;</span> <span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span><span class="main">=</span><span class="main">{#</span><span class="bound">x</span><span class="main">#}</span><span class="main">;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_map_split_orig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">M1</span> <span class="bound">M2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">f</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">=</span> <span class="bound">M1</span><span class="main">+</span><span class="bound">M2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">P1</span> <span class="bound">P2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span><span class="main">=</span><span class="bound">P1</span><span class="main">+</span><span class="bound">P2</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P1</span> <span class="main">=</span> <span class="bound">M1</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P2</span> <span class="main">=</span> <span class="bound">M2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_un_single_un_cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span> <span class="comment1">(* TODO: This proof need's quite long. Try to write a faster one. *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_map_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`#</span> <span class="free">g</span> <span class="main">`#</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a very specialized lemma. Intuitively, it splits the original multiset›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a very specialized   by a splitting of some pointwise supermultiset of its image.

  Application:
  This lemma came in handy when proving the correctness of a constraint system that collects at most k sized submultisets of the sets of spawned threads.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mset_map_split_orig_le<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="free">M1</span><span class="main">+</span><span class="free">M2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">P1</span> <span class="bound">P2</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span><span class="main">=</span><span class="bound">P1</span><span class="main">+</span><span class="bound">P2</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P1</span> <span class="main">⊆#</span> <span class="free">M1</span><span class="main">;</span> <span class="free">f</span> <span class="main">`#</span> <span class="bound">P2</span> <span class="main">⊆#</span> <span class="free">M2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A EX <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_distrib mset_map_split_orig<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse lists›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> list_rev_decomp<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">~=</span><span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">ll</span> <span class="bound">e</span> <span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="bound">ll</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="comment1">(* Was already there as rev_induct
  lemma list_rev_induct: "⟦P []; !! l e . P l ⟹ P (l@[e]) ⟧ ⟹ P l"
    by (blast intro: rev_induct)
  proof (induct l rule: measure_induct[of length])
    fix x :: "'a list"
    assume A: "∀y. length y &lt; length x ⟶ P [] ⟶ (∀x xa. P (x::'a list) ⟶ P (x @ [xa])) ⟶ P y" "P []" and IS: "⋀l e. P l ⟹ P (l @ [e])"
    show "P x" proof (cases "x=[]")
      assume "x=[]" with A show ?thesis by simp
    next
      assume CASE: "x~=[]"
      then obtain xx e where DECOMP: "x=xx@[e]" by (blast dest: list_rev_decomp)
      hence LEN: "length xx &lt; length x" by auto
      with A IS have "P xx" by auto
      with IS have "P (xx@[e])" by auto
      with DECOMP show ?thesis by auto
    qed
  qed
  *)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Caution: Same order of case variables in snoc-case as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rev_exhaust<span class="antiquote"><span class="antiquote">}</span></span></span></span>, the other way round than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rev_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span> !›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> length_compl_rev_induct<span class="main">[</span><span class="operator">case_names</span> Nil snoc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">l</span> <span class="bound">e</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">!!</span> <span class="bound">ll</span> <span class="main">.</span> length <span class="bound">ll</span> <span class="main">&lt;=</span> length <span class="bound">l</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ll</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">l</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> list_append_eq_Cons_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ys</span><span class="main">@</span><span class="free">zs</span> <span class="main">=</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">;</span> <span class="main">⟦</span><span class="free">ys</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">zs</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ys</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="bound">ys'</span><span class="main">;</span> <span class="bound">ys'</span><span class="main">@</span><span class="free">zs</span><span class="main">=</span><span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> list_Cons_eq_append_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">@</span><span class="free">zs</span><span class="main">;</span> <span class="main">⟦</span><span class="free">ys</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">zs</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">ys'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ys</span><span class="main">=</span><span class="free">x</span><span class="main">#</span><span class="bound">ys'</span><span class="main">;</span> <span class="bound">ys'</span><span class="main">@</span><span class="free">zs</span><span class="main">=</span><span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_eq_append_conv<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"folding"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Ugly lemma about foldl over associative operator with left and right neutral element"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> foldl_A1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">!!</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="free">n</span> <span class="bound">e</span> <span class="main">=</span> <span class="bound">e</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">e</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">e</span><span class="main">;</span> <span class="main">!!</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span> foldl <span class="free">f</span> <span class="bound">i</span> <span class="free">ww</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="free">ww</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ww</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">=</span>this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">ww</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="skolem">ww</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="skolem">a</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">n</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="free">n</span> <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> foldl_conc_empty_eq <span class="main">=</span> foldl_A1_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(@)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> foldl_un_empty_eq <span class="main">=</span> foldl_A1_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> Un_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_set<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(∪)</span> <span class="main">{}</span> <span class="free">l</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_un_empty_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> length_compl_induct<span class="main">[</span><span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">e</span> <span class="bound">l</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">!!</span> <span class="bound">ll</span> <span class="main">.</span> length <span class="bound">ll</span> <span class="main">&lt;=</span> length <span class="bound">l</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ll</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">l</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simultaneous induction over two lists, prepending an element to one of the lists in each step›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> list_2pre_induct<span class="main">[</span><span class="operator">case_names</span> base left right<span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> BASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LEFT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">e</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RIGHT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">e</span> <span class="bound">w1</span> <span class="bound">w2'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w1</span> <span class="free">w2</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="comment1">― ‹The proof is done by induction over the sum of the lengths of the lists›</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span>length <span class="bound">w1</span> <span class="main">+</span> length <span class="bound">w2</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">;</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w1</span> <span class="bound">w2'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">w1</span> <span class="bound">w2</span> "</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w1</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w2</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> _ BASE LEFT RIGHT<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">lemma</span></span> list_decomp_1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span><span class="main">=</span><span class="main">1</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> list_decomp_2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">l</span><span class="main">=</span><span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">l</span><span class="main">=</span><span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_decomp_1<span class="main">)</span>


  <span class="keyword1"><span class="command">lemma</span></span> drop_all_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> list_rest_coinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">s2</span> <span class="main">&lt;=</span> length <span class="free">s1</span><span class="main">;</span> <span class="free">s1</span><span class="main">@</span><span class="free">r1</span> <span class="main">=</span> <span class="free">s2</span><span class="main">@</span><span class="free">r2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">r1p</span> <span class="main">.</span> <span class="free">r2</span><span class="main">=</span><span class="bound">r1p</span><span class="main">@</span><span class="free">r1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">s2</span> <span class="main">&lt;=</span> length <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s1</span><span class="main">@</span><span class="free">r1</span> <span class="main">=</span> <span class="free">s2</span><span class="main">@</span><span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">s1</span><span class="main">)</span> <span class="main">(</span><span class="free">s2</span><span class="main">@</span><span class="free">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>drop_all_conc <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s1</span> <span class="main">=</span> length <span class="free">s1</span> <span class="main">-</span> length <span class="free">s2</span> <span class="main">+</span> length <span class="free">s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> drop <span class="main">(</span><span class="main">(</span>length <span class="free">s1</span> <span class="main">-</span> length <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="free">r2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r2</span> <span class="main">=</span> take <span class="main">(</span><span class="main">(</span>length <span class="free">s1</span> <span class="main">-</span> length <span class="free">s2</span><span class="main">)</span><span class="main">)</span> <span class="free">r2</span> <span class="main">@</span> <span class="free">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> list_tail_coinc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n1</span><span class="main">#</span><span class="free">r1</span> <span class="main">=</span> <span class="free">n2</span><span class="main">#</span><span class="free">r2</span> <span class="main">⟹</span> <span class="free">n1</span><span class="main">=</span><span class="free">n2</span> <span class="main">&amp;</span> <span class="free">r1</span><span class="main">=</span><span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


  <span class="keyword1"><span class="command">lemma</span></span> last_in_set<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">≠</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> last <span class="free">l</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induction on nat›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> nat_compl_induct<span class="main">[</span><span class="operator">case_names</span> 0 Suc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">0</span><span class="main">;</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">.</span> <span class="keyword1">ALL</span> <span class="bound">nn</span> <span class="main">.</span> <span class="bound">nn</span> <span class="main">&lt;=</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">nn</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"bool<span class="main"><span class="main">⇒</span></span>bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> boolfun_cases_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">|</span> <span class="free">g</span><span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">g</span> True"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> boolfun_cases<span class="main">[</span><span class="operator">case_names</span> False Id True Neg<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span><span class="main">;</span> <span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> boolfun_cases_helper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">=</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definite and indefinite description›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Combined definite and indefinite description for binary predicate"</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> some_theI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BUN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="main">.</span> <span class="main">⟦</span><span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b1</span><span class="main">;</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">b1</span><span class="main">=</span><span class="bound">b2</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> EX <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">a</span> <span class="main">.</span> <span class="keyword1">EX</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> EX <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">b</span> <span class="main">.</span> <span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> BUN theI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span> <span class="main">.</span> <span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span> <span class="main">.</span> <span class="keyword1">EX</span> <span class="bound">a</span> <span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Ex1_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> BUN
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Interleave">
<div class="head">
<h1>Theory Interleave</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/List Interleaving Operator
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"List Interleaving Operator"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Interleave
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span> <a href="Misc.html">Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Interleave}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory defines an operator to return the set of all possible interleavings of two lists.
›</span></span>

<span class="comment1">(*
  Is ⨂-operator needed ?
    Should we better do a reformulation of ⊗ on sets of lists, to get an associative, commutative operator with identity (ACI ?) ?
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Prepend and concatenate lifted to sets"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_set_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⋅</span></span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(#)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_set_append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊙</span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⊙</span></span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(@)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"The interleaving operator"</span></span>

<span class="keyword1"><span class="command">function</span></span>
  <span class="entity">interleave</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 64<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">⊗</span></span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⊗</span></span><span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Properties"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lifted prepend and concatenate operators"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cons_set_cons_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">l</span> <span class="main">∈</span> <span class="free">b</span><span class="main">⋅</span><span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="free">b</span> <span class="main">&amp;</span> <span class="free">l</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> append_set_append_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">@</span><span class="free">l</span> <span class="main">∈</span> <span class="free">b</span><span class="main">⊙</span><span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="free">b</span> <span class="main">&amp;</span> <span class="free">l</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_set_cons_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">a</span><span class="main">⋅</span><span class="free">S</span><span class="main">;</span> <span class="main">!!</span><span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="free">a</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> list_set_append_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">a</span><span class="main">⊙</span><span class="free">S</span><span class="main">;</span> <span class="main">!!</span><span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="free">a</span><span class="main">@</span><span class="bound">w'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Standard simplification-, introduction-, elimination-, and induction rules"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">#</span><span class="free">l</span> <span class="main">∈</span> <span class="free">x</span><span class="main">#</span><span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> interleave_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">#</span><span class="free">l</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">x</span><span class="main">#</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_cons <span class="main">=</span> interleave_cons1 interleave_cons2


<span class="keyword1"><span class="command">lemma</span></span> interleave_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">∈</span><span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">=</span><span class="main">[]</span> <span class="main">&amp;</span> <span class="free">b</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* TODO: Is this wise as default simp ?*)</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_length<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">x</span> <span class="main">:</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> length <span class="free">a</span> <span class="main">+</span> length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">l</span><span class="main">⊗</span><span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length <span class="free">y</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">+</span> length <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> interleave_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> interleave_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_comm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">=</span> <span class="free">b</span><span class="main">⊗</span><span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">f</span> <span class="free">a</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_cont_conc<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">a</span><span class="main">@</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_cont_rev_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">@</span><span class="free">a</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">@</span><span class="free">a</span> <span class="main">∈</span> <span class="free">b</span><span class="main">⊗</span><span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> interleave_cont_conc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">~=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cons_interleave_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span><span class="main">#</span><span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="free">l2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">lh</span> <span class="main">.</span> <span class="free">l1</span><span class="main">=</span><span class="free">a</span><span class="main">#</span><span class="bound">lh</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="bound">lh</span><span class="main">⊗</span><span class="free">l2</span> <span class="main">|</span> <span class="free">l2</span><span class="main">=</span><span class="free">a</span><span class="main">#</span><span class="bound">lh</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="bound">lh</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l1</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cons_interleave_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span><span class="main">#</span><span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="free">l2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">lh</span> <span class="main">.</span> <span class="main">⟦</span><span class="free">l1</span><span class="main">=</span><span class="free">a</span><span class="main">#</span><span class="bound">lh</span><span class="main">;</span> <span class="free">l</span> <span class="main">∈</span> <span class="bound">lh</span><span class="main">⊗</span><span class="free">l2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">lh</span><span class="main">.</span> <span class="main">⟦</span><span class="free">l2</span><span class="main">=</span><span class="free">a</span><span class="main">#</span><span class="bound">lh</span><span class="main">;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="bound">lh</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> empty left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">∈</span><span class="free">l1</span><span class="main">⊗</span><span class="free">l2</span><span class="main">;</span> <span class="main">⟦</span> <span class="free">l</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">l1</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">l2</span><span class="main">=</span><span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">a</span> <span class="bound">l'</span> <span class="bound">l1'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">l</span><span class="main">=</span><span class="bound">a</span><span class="main">#</span><span class="bound">l'</span><span class="main">;</span> <span class="free">l1</span><span class="main">=</span><span class="bound">a</span><span class="main">#</span><span class="bound">l1'</span><span class="main">;</span> <span class="bound">l'</span><span class="main">∈</span><span class="bound">l1'</span><span class="main">⊗</span><span class="free">l2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> <span class="main">!!</span><span class="bound">a</span> <span class="bound">l'</span> <span class="bound">l2'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">l</span><span class="main">=</span><span class="bound">a</span><span class="main">#</span><span class="bound">l'</span><span class="main">;</span> <span class="free">l2</span><span class="main">=</span><span class="bound">a</span><span class="main">#</span><span class="bound">l2'</span><span class="main">;</span> <span class="bound">l'</span><span class="main">∈</span><span class="free">l1</span><span class="main">⊗</span><span class="bound">l2'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> cons_interleave_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_elem_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> empty left right<span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span><span class="main">;</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">;</span> <span class="bound">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w</span><span class="main">)</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span> <span class="main">!!</span><span class="bound">e</span> <span class="bound">w</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">w</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">;</span> <span class="bound">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w</span><span class="main">)</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">w</span> <span class="bound">w1</span> <span class="bound">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cons_interleave_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_rev_cons1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="free">l</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">⊗</span><span class="bound">b</span> <span class="main">⟶</span> <span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⊗</span> <span class="bound">b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">l</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">a</span><span class="main">⊗</span><span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">l</span><span class="main">∈</span><span class="skolem">c</span><span class="main">⊗</span><span class="skolem">b</span> <span class="main">|</span> <span class="skolem">b</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">l</span><span class="main">∈</span><span class="skolem">a</span><span class="main">⊗</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">∈</span><span class="skolem">c</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">⊗</span><span class="skolem">b</span> <span class="main">|</span> <span class="skolem">b</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">∈</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">⊗</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">∈</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">⊗</span><span class="skolem">b</span> <span class="main">|</span> <span class="skolem">b</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">∈</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">⊗</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">∈</span><span class="skolem">a</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">⊗</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> interleave_rev_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">∈</span><span class="free">b</span><span class="main">⊗</span><span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">∈</span> <span class="free">b</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⊗</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_rev_cons1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_rev_cons <span class="main">=</span> interleave_rev_cons1 interleave_rev_cons2


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Interleaving and list concatenation"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_append1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">@</span><span class="free">l</span> <span class="main">∈</span> <span class="free">x</span><span class="main">@</span><span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">⊗</span><span class="bound">b</span> <span class="main">⟶</span> <span class="free">x</span><span class="main">@</span><span class="bound">l</span> <span class="main">∈</span> <span class="free">x</span><span class="main">@</span><span class="bound">a</span> <span class="main">⊗</span> <span class="bound">b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">a</span> <span class="main">⊗</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">x</span><span class="main">@</span><span class="skolem">a</span> <span class="main">⊗</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> interleave_cons1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">a</span> <span class="main">⊗</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_append2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span> <span class="main">∈</span> <span class="free">a</span><span class="main">⊗</span><span class="free">b</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">@</span><span class="free">l</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">x</span><span class="main">@</span><span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">l</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">⊗</span><span class="bound">b</span> <span class="main">⟶</span> <span class="free">x</span><span class="main">@</span><span class="bound">l</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">⊗</span> <span class="free">x</span><span class="main">@</span><span class="bound">b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">⊗</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">@</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">a</span> <span class="main">⊗</span> <span class="skolem">x</span> <span class="main">@</span> <span class="bound">b</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="bound">aa</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">aa</span> <span class="main">⊗</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="bound">l</span> <span class="main">∈</span> <span class="bound">aa</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aa</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">aa</span> <span class="main">⊗</span> <span class="skolem">b</span>"</span></span>

      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">@</span><span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">aa</span> <span class="main">⊗</span> <span class="skolem">x</span><span class="main">@</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> interleave_cons2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">aa</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_append <span class="main">=</span> interleave_append1 interleave_append2

<span class="keyword1"><span class="command">lemma</span></span> interleave_rev_append1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span><span class="bound">a</span><span class="main">⊗</span><span class="bound">b</span> <span class="main">⟹</span> <span class="bound">w</span><span class="main">@</span><span class="free">w'</span> <span class="main">∈</span> <span class="bound">a</span><span class="main">@</span><span class="free">w'</span> <span class="main">⊗</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">e</span> <span class="skolem">w'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">@</span><span class="skolem">w'</span><span class="main">∈</span><span class="skolem">a</span><span class="main">@</span><span class="skolem">w'</span><span class="main">⊗</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> interleave_rev_cons1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">@</span><span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">@</span><span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_rev_append2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">a</span><span class="main">⊗</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">@</span><span class="free">w'</span> <span class="main">∈</span> <span class="free">a</span> <span class="main">⊗</span> <span class="free">b</span><span class="main">@</span><span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> interleave_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> interleave_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">@</span><span class="free">w'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_rev_append1<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> interleave_rev_append <span class="main">=</span> interleave_rev_append1 interleave_rev_append2

<span class="keyword1"><span class="command">lemma</span></span> interleave_rev1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">.</span> <span class="main">(</span><span class="free">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>rev <span class="free">w</span> <span class="main">∈</span> rev <span class="bound">w1</span> <span class="main">⊗</span> rev <span class="bound">w2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">w</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w'</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">|</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> rev <span class="skolem">w</span><span class="main">∈</span>rev <span class="skolem">w'</span> <span class="main">⊗</span> rev <span class="skolem">w2</span> <span class="main">|</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> rev <span class="skolem">w</span> <span class="main">∈</span> rev <span class="skolem">w1</span> <span class="main">⊗</span> rev <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">∈</span>rev <span class="skolem">w1</span> <span class="main">⊗</span> rev <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_rev_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> interleave_rev2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">w</span> <span class="main">∈</span> rev <span class="free">w1</span> <span class="main">⊗</span> rev <span class="free">w2</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="free">w</span><span class="main">∈</span>rev <span class="free">w1</span><span class="main">⊗</span>rev <span class="free">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">w</span><span class="main">)</span> <span class="main">∈</span> rev <span class="main">(</span>rev <span class="free">w1</span><span class="main">)</span> <span class="main">⊗</span> rev <span class="main">(</span>rev <span class="free">w2</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_rev1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_rev <span class="main">=</span> interleave_rev1 interleave_rev2

<span class="keyword1"><span class="command">lemma</span></span> rev_cons_interleave_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="free">l2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">lh</span> <span class="main">.</span> <span class="free">l1</span><span class="main">=</span><span class="bound">lh</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="bound">lh</span><span class="main">⊗</span><span class="free">l2</span> <span class="main">|</span> <span class="free">l2</span><span class="main">=</span><span class="bound">lh</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="bound">lh</span> <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∈</span> <span class="free">l1</span><span class="main">⊗</span><span class="free">l2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span>rev <span class="free">l</span> <span class="main">∈</span> rev <span class="free">l1</span> <span class="main">⊗</span> rev <span class="free">l2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">l1</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span><span class="skolem">lh</span> <span class="main">&amp;</span> rev <span class="free">l</span> <span class="main">∈</span> <span class="skolem">lh</span><span class="main">⊗</span>rev <span class="free">l2</span> <span class="main">|</span> rev <span class="free">l2</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span><span class="skolem">lh</span> <span class="main">&amp;</span> rev <span class="free">l</span> <span class="main">∈</span> rev <span class="free">l1</span> <span class="main">⊗</span> <span class="skolem">lh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">l1</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span><span class="skolem">lh</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> rev <span class="skolem">lh</span> <span class="main">⊗</span> <span class="free">l2</span> <span class="main">|</span> rev <span class="free">l2</span> <span class="main">=</span> <span class="free">a</span><span class="main">#</span><span class="skolem">lh</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span> <span class="main">⊗</span> rev <span class="skolem">lh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">=</span> rev <span class="skolem">lh</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> rev <span class="skolem">lh</span> <span class="main">⊗</span> <span class="free">l2</span> <span class="main">|</span> <span class="free">l2</span> <span class="main">=</span> rev <span class="skolem">lh</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">&amp;</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">l1</span> <span class="main">⊗</span> rev <span class="skolem">lh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_swap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Associativity"</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> interleave_s_assoc1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w1</span> <span class="bound">ws</span> <span class="bound">w2</span> <span class="bound">w3</span> <span class="main">.</span> <span class="main">(</span><span class="free">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">ws</span> <span class="main">&amp;</span> <span class="bound">ws</span><span class="main">∈</span><span class="bound">w2</span><span class="main">⊗</span><span class="bound">w3</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">ws'</span> <span class="main">:</span> <span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> <span class="bound">ws'</span><span class="main">⊗</span><span class="bound">w3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w1</span> <span class="bound">ws</span> <span class="bound">w2</span> <span class="bound">w3</span> <span class="main">.</span> <span class="skolem">w</span><span class="main">∈</span><span class="bound">w1</span><span class="main">⊗</span><span class="bound">ws</span> <span class="main">&amp;</span> <span class="bound">ws</span><span class="main">∈</span><span class="bound">w2</span><span class="main">⊗</span><span class="bound">w3</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">ws'</span> <span class="main">:</span> <span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">.</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span><span class="main">⊗</span><span class="bound">w3</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">ws</span> <span class="skolem">w2</span> <span class="skolem">w3</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">ws</span> <span class="main">∧</span> <span class="skolem">ws</span> <span class="main">∈</span> <span class="skolem">w2</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wh</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">wh</span><span class="main">⊗</span><span class="skolem">ws</span> <span class="main">|</span> <span class="skolem">ws</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">wh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">wh</span><span class="main">⊗</span><span class="skolem">ws</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span><span class="main">∈</span><span class="skolem">wh</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">ws'</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">ws'</span><span class="main">∈</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span><span class="main">)</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">ws'</span><span class="main">)</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">∈</span><span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">wh</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">whh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">whh</span> <span class="main">&amp;</span> <span class="skolem">wh</span><span class="main">∈</span><span class="skolem">whh</span><span class="main">⊗</span><span class="skolem">w3</span> <span class="main">|</span> <span class="skolem">w3</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">whh</span> <span class="main">&amp;</span> <span class="skolem">wh</span><span class="main">∈</span><span class="skolem">w2</span><span class="main">⊗</span><span class="skolem">whh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> SCASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">whh</span> <span class="main">&amp;</span> <span class="skolem">wh</span><span class="main">∈</span><span class="skolem">whh</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> CASE IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">whh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">ws'</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> SCASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">ws'</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">ws'</span><span class="main">)</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">∈</span><span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> SCASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">whh</span> <span class="main">&amp;</span> <span class="skolem">wh</span><span class="main">∈</span><span class="skolem">w2</span><span class="main">⊗</span><span class="skolem">whh</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> CASE IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">ws'</span><span class="main">⊗</span><span class="skolem">whh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> SCASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">ws'</span><span class="main">⊗</span><span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">∈</span><span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">∈</span><span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ws'</span><span class="main">∈</span><span class="skolem">w1</span> <span class="main">⊗</span> <span class="skolem">w2</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="bound">ws'</span> <span class="main">⊗</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_s_assoc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">ws</span><span class="main">⊗</span><span class="free">w3</span><span class="main">;</span> <span class="free">ws</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">ws'</span> <span class="main">:</span> <span class="free">w2</span><span class="main">⊗</span><span class="free">w3</span> <span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">w1</span><span class="main">⊗</span><span class="bound">ws'</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">ws</span> <span class="main">⊗</span> <span class="free">w3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> <span class="free">w1</span> <span class="main">⊗</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">w3</span> <span class="main">⊗</span> <span class="free">ws</span> <span class="main">&amp;</span> <span class="free">ws</span> <span class="main">∈</span> <span class="free">w2</span> <span class="main">⊗</span> <span class="free">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">ws'</span><span class="main">:</span><span class="free">w3</span><span class="main">⊗</span><span class="free">w2</span> <span class="main">.</span> <span class="free">w</span><span class="main">∈</span><span class="bound">ws'</span><span class="main">⊗</span><span class="free">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> interleave_s_assoc1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> interleave_s_assoc <span class="main">=</span> interleave_s_assoc1 interleave_s_assoc2

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Relation to other standard list operations"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span> <span class="main">⟹</span> set <span class="free">w</span> <span class="main">=</span> set <span class="free">w1</span> <span class="main">∪</span> set <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_elem_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="free">w</span> <span class="main">∈</span> map <span class="free">f</span> <span class="free">w1</span> <span class="main">⊗</span> map <span class="free">f</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_elem_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span> <span class="main">⟹</span> filter <span class="free">f</span> <span class="free">w</span> <span class="main">∈</span> filter <span class="free">f</span> <span class="free">w1</span> <span class="main">⊗</span> filter <span class="free">f</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interleave_elem_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Relation to sublist order"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ileq_interleave_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span><span class="main">≼</span><span class="free">l</span> <span class="main">==</span> <span class="main">∃</span><span class="bound">lb</span><span class="main">.</span> <span class="free">l</span><span class="main">∈</span><span class="bound">lb</span> <span class="main">⊗</span> <span class="free">l'</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span> <span class="skolem">l</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span><span class="main">≼</span><span class="skolem">l</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">lb</span><span class="main">.</span> <span class="skolem">l</span><span class="main">∈</span><span class="bound">lb</span> <span class="main">⊗</span> <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">lb</span> <span class="bound">l'</span><span class="main">.</span> <span class="skolem">l</span><span class="main">∈</span><span class="bound">lb</span><span class="main">⊗</span><span class="bound">l'</span> <span class="main">⟹</span> <span class="bound">l'</span><span class="main">≼</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_eq_list_drop <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cons_interleave_cases<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">≼</span><span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">lb</span><span class="main">.</span> <span class="free">l</span><span class="main">∈</span><span class="bound">lb</span> <span class="main">⊗</span> <span class="free">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ileq_interleave<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span> <span class="main">⟹</span> <span class="free">w1</span><span class="main">≼</span><span class="free">w</span> <span class="main">&amp;</span> <span class="free">w2</span><span class="main">≼</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ileq_interleave_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ilt_ex_notempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="bound">xs</span> <span class="main">⊗</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_less_le ileq_interleave_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">lb</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> ilt_interleave1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span><span class="main">;</span> <span class="free">w1</span><span class="main">~=</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w2</span><span class="main">&lt;</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ilt_ex_notempty<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> ilt_interleave2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span><span class="main">;</span> <span class="free">w2</span><span class="main">~=</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w1</span><span class="main">&lt;</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ilt_ex_notempty interleave_comm<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">w2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> ilt_interleave <span class="main">=</span> ilt_interleave1 ilt_interleave2


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Exotic/specialized lemmas"</span></span>
<span class="comment1">― ‹Recover structure of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">w</span><span class="antiquote">}</span></span> wrt. to structure of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"w1"</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_recover1<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="bound">w2</span> <span class="main">.</span> <span class="free">w</span><span class="main">∈</span><span class="main">(</span><span class="bound">w1a</span><span class="main">@</span><span class="bound">w1b</span><span class="main">)</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">EX</span> <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">w2a</span> <span class="bound">w2b</span> <span class="main">.</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span> <span class="main">&amp;</span> <span class="bound">w2</span><span class="main">=</span><span class="bound">w2a</span><span class="main">@</span><span class="bound">w2b</span> <span class="main">&amp;</span> <span class="bound">wa</span><span class="main">∈</span><span class="bound">w1a</span><span class="main">⊗</span><span class="bound">w2a</span> <span class="main">&amp;</span> <span class="bound">wb</span><span class="main">∈</span><span class="bound">w1b</span><span class="main">⊗</span><span class="bound">w2b</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ALL</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="bound">w2</span> <span class="main">.</span> <span class="var">?PRE</span> <span class="free">w</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="bound">w2</span> <span class="main">⟶</span> <span class="var">?CONS</span> <span class="free">w</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="bound">w2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>
      <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1a</span> <span class="main">@</span> <span class="skolem">w1b</span> <span class="main">⊗</span> <span class="skolem">w2</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1a</span><span class="main">=</span><span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> PRE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">=</span><span class="main">[]</span><span class="main">@</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="main">&amp;</span> <span class="skolem">w2</span><span class="main">=</span><span class="main">[]</span><span class="main">@</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="main">[]</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">⊗</span><span class="main">[]</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CONS</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1a</span><span class="main">~=</span><span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> PRE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wh</span></span> <span class="keyword2"><span class="keyword">where</span></span> SCASES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1a</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">wh</span><span class="main">⊗</span><span class="skolem">w2</span> <span class="main">|</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">wh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> SCASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1a</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">wh</span><span class="main">⊗</span><span class="skolem">w2</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> CASE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1ah</span></span> <span class="keyword2"><span class="keyword">where</span></span> W1AFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1a</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w1ah</span> <span class="main">&amp;</span> <span class="skolem">w1ah</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">=</span><span class="skolem">wh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w1a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> SCASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1ah</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1ah</span></span> <span class="quoted"><span class="skolem">w1b</span></span> <span class="quoted"><span class="skolem">w2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="skolem"><span class="skolem">w2a</span></span> <span class="skolem"><span class="skolem">w2b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">wa</span><span class="main">@</span><span class="skolem">wb</span> <span class="main">&amp;</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">w2a</span><span class="main">@</span><span class="skolem">w2b</span> <span class="main">&amp;</span> <span class="skolem">wa</span><span class="main">∈</span><span class="skolem">w1ah</span><span class="main">⊗</span><span class="skolem">w2a</span> <span class="main">&amp;</span> <span class="skolem">wb</span><span class="main">∈</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> W1AFMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">@</span><span class="skolem">wb</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">∈</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">⊗</span><span class="skolem">wb</span> <span class="main">&amp;</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">w2a</span><span class="main">@</span><span class="skolem">w2b</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">⊗</span><span class="skolem">w2a</span> <span class="main">&amp;</span> <span class="skolem">wb</span><span class="main">∈</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CONS</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> SCASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wh</span> <span class="main">&amp;</span> <span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">@</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">wh</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1a</span></span> <span class="quoted"><span class="skolem">w1b</span></span> <span class="quoted"><span class="skolem">wh</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="skolem"><span class="skolem">w2a</span></span> <span class="skolem"><span class="skolem">w2b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">wa</span><span class="main">@</span><span class="skolem">wb</span> <span class="main">&amp;</span> <span class="skolem">wh</span><span class="main">=</span><span class="skolem">w2a</span><span class="main">@</span><span class="skolem">w2b</span> <span class="main">&amp;</span> <span class="skolem">wa</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">⊗</span><span class="skolem">w2a</span> <span class="main">&amp;</span> <span class="skolem">wb</span><span class="main">∈</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> SCASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">@</span><span class="skolem">wb</span> <span class="main">&amp;</span> <span class="skolem">w2</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2a</span><span class="main">)</span><span class="main">@</span><span class="skolem">w2b</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">∈</span><span class="skolem">w1a</span><span class="main">⊗</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2a</span> <span class="main">&amp;</span> <span class="skolem">wb</span><span class="main">∈</span><span class="skolem">w1b</span><span class="main">⊗</span><span class="skolem">w2b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CONS</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CONS</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CONS</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">)</span> <span class="skolem">w1a</span> <span class="skolem">w1b</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interleave_recover2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="main">(</span><span class="free">w2a</span><span class="main">@</span><span class="free">w2b</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">EX</span> <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="main">.</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span> <span class="main">&amp;</span> <span class="free">w1</span><span class="main">=</span><span class="bound">w1a</span><span class="main">@</span><span class="bound">w1b</span> <span class="main">&amp;</span> <span class="bound">wa</span><span class="main">∈</span><span class="bound">w1a</span><span class="main">⊗</span><span class="free">w2a</span> <span class="main">&amp;</span> <span class="bound">wb</span><span class="main">∈</span><span class="bound">w1b</span><span class="main">⊗</span><span class="free">w2b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="main">(</span><span class="free">w2a</span><span class="main">@</span><span class="free">w2b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="main">(</span><span class="free">w2a</span><span class="main">@</span><span class="free">w2b</span><span class="main">)</span><span class="main">⊗</span><span class="free">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">EX</span> <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">w1a</span> <span class="bound">w1b</span> <span class="main">.</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span> <span class="main">&amp;</span> <span class="free">w1</span><span class="main">=</span><span class="bound">w1a</span><span class="main">@</span><span class="bound">w1b</span> <span class="main">&amp;</span> <span class="bound">wa</span><span class="main">∈</span><span class="free">w2a</span><span class="main">⊗</span><span class="bound">w1a</span> <span class="main">&amp;</span> <span class="bound">wb</span><span class="main">∈</span><span class="free">w2b</span><span class="main">⊗</span><span class="bound">w1b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_recover1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> interleave_recover <span class="main">=</span> interleave_recover1 interleave_recover2

<span class="comment1">― ‹Split operands according to element of result›</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_unconc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">l2</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">.</span> <span class="free">l1</span><span class="main">@</span><span class="bound">l2</span> <span class="main">∈</span> <span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">w11</span> <span class="bound">w12</span> <span class="bound">w21</span> <span class="bound">w22</span> <span class="main">.</span> <span class="bound">w1</span><span class="main">=</span><span class="bound">w11</span><span class="main">@</span><span class="bound">w12</span> <span class="main">∧</span> <span class="bound">w2</span><span class="main">=</span><span class="bound">w21</span><span class="main">@</span><span class="bound">w22</span> <span class="main">∧</span> <span class="free">l1</span><span class="main">∈</span><span class="bound">w11</span><span class="main">⊗</span><span class="bound">w21</span> <span class="main">∧</span> <span class="bound">l2</span><span class="main">∈</span><span class="bound">w12</span><span class="main">⊗</span><span class="bound">w22</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="main">[]</span><span class="main">@</span><span class="skolem">w1</span> <span class="main">&amp;</span> <span class="skolem">w2</span><span class="main">=</span><span class="main">[]</span><span class="main">@</span><span class="skolem">w2</span> <span class="main">&amp;</span> <span class="main">[]</span><span class="main">∈</span><span class="main">[]</span><span class="main">⊗</span><span class="main">[]</span> <span class="main">&amp;</span> <span class="skolem">l2</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">l1'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="main">(</span><span class="skolem">l1'</span><span class="main">@</span><span class="skolem">l2</span><span class="main">)</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cons_interleave_split <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w1</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">l1'</span><span class="main">@</span><span class="skolem">l2</span><span class="main">∈</span><span class="skolem">w'</span><span class="main">⊗</span><span class="skolem">w2</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="skolem">w2</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">l1'</span><span class="main">@</span><span class="skolem">l2</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">⊗</span><span class="skolem">w'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">|</span> <span class="var">?C2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w11'</span></span> <span class="skolem"><span class="skolem">w12'</span></span> <span class="skolem"><span class="skolem">w21</span></span> <span class="skolem"><span class="skolem">w22</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">=</span><span class="skolem">w11'</span><span class="main">@</span><span class="skolem">w12'</span> <span class="main">∧</span> <span class="skolem">w2</span><span class="main">=</span><span class="skolem">w21</span><span class="main">@</span><span class="skolem">w22</span> <span class="main">∧</span> <span class="skolem">l1'</span><span class="main">∈</span><span class="skolem">w11'</span><span class="main">⊗</span><span class="skolem">w21</span> <span class="main">∧</span> <span class="skolem">l2</span><span class="main">∈</span><span class="skolem">w12'</span><span class="main">⊗</span><span class="skolem">w22</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w11'</span><span class="main">)</span><span class="main">@</span><span class="skolem">w12'</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">l1'</span><span class="main">∈</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w11'</span><span class="main">)</span><span class="main">⊗</span><span class="skolem">w21</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w11</span></span> <span class="skolem"><span class="skolem">w12</span></span> <span class="skolem"><span class="skolem">w21'</span></span> <span class="skolem"><span class="skolem">w22'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">=</span><span class="skolem">w11</span><span class="main">@</span><span class="skolem">w12</span> <span class="main">∧</span> <span class="skolem">w'</span><span class="main">=</span><span class="skolem">w21'</span><span class="main">@</span><span class="skolem">w22'</span> <span class="main">∧</span> <span class="skolem">l1'</span><span class="main">∈</span><span class="skolem">w11</span><span class="main">⊗</span><span class="skolem">w21'</span> <span class="main">∧</span> <span class="skolem">l2</span><span class="main">∈</span><span class="skolem">w12</span><span class="main">⊗</span><span class="skolem">w22'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w21'</span><span class="main">)</span><span class="main">@</span><span class="skolem">w22'</span> <span class="main">&amp;</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">l1'</span><span class="main">∈</span><span class="skolem">w11</span><span class="main">⊗</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w21'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Reverse direction of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] "interleave_unconc"<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_reconc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w11</span> <span class="bound">w21</span> <span class="bound">l2</span> <span class="bound">w12</span> <span class="bound">w22</span> <span class="main">.</span> <span class="main">⟦</span><span class="free">l1</span><span class="main">∈</span><span class="bound">w11</span><span class="main">⊗</span><span class="bound">w21</span><span class="main">;</span><span class="bound">l2</span><span class="main">∈</span><span class="bound">w12</span><span class="main">⊗</span><span class="bound">w22</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">l1</span><span class="main">@</span><span class="bound">l2</span><span class="main">∈</span><span class="main">(</span><span class="bound">w11</span><span class="main">@</span><span class="bound">w12</span><span class="main">)</span><span class="main">⊗</span><span class="main">(</span><span class="bound">w21</span><span class="main">@</span><span class="bound">w22</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">l1'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w11</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">l1'</span><span class="main">∈</span><span class="skolem">w'</span><span class="main">⊗</span><span class="skolem">w21</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="skolem">w21</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w'</span> <span class="main">&amp;</span> <span class="skolem">l1'</span><span class="main">∈</span><span class="skolem">w11</span><span class="main">⊗</span><span class="skolem">w'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">|</span> <span class="var">?C2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cons_interleave_split<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> IHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1'</span><span class="main">@</span><span class="skolem">l2</span><span class="main">∈</span><span class="main">(</span><span class="skolem">w'</span><span class="main">@</span><span class="skolem">w12</span><span class="main">)</span><span class="main">⊗</span><span class="main">(</span><span class="skolem">w21</span><span class="main">@</span><span class="skolem">w22</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> IHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1'</span><span class="main">@</span><span class="skolem">l2</span><span class="main">∈</span><span class="main">(</span><span class="skolem">w11</span><span class="main">@</span><span class="skolem">w12</span><span class="main">)</span><span class="main">⊗</span><span class="main">(</span><span class="skolem">w'</span><span class="main">@</span><span class="skolem">w22</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* interleave_unconc and interleave_reconc as equivalence *)</span>
<span class="keyword1"><span class="command">lemma</span></span> interleave_unconc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">l2</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">.</span> <span class="free">l1</span><span class="main">@</span><span class="bound">l2</span> <span class="main">∈</span> <span class="bound">w1</span><span class="main">⊗</span><span class="bound">w2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w11</span> <span class="bound">w12</span> <span class="bound">w21</span> <span class="bound">w22</span> <span class="main">.</span> <span class="bound">w1</span><span class="main">=</span><span class="bound">w11</span><span class="main">@</span><span class="bound">w12</span> <span class="main">∧</span> <span class="bound">w2</span><span class="main">=</span><span class="bound">w21</span><span class="main">@</span><span class="bound">w22</span> <span class="main">∧</span> <span class="free">l1</span><span class="main">∈</span><span class="bound">w11</span><span class="main">⊗</span><span class="bound">w21</span> <span class="main">∧</span> <span class="bound">l2</span><span class="main">∈</span><span class="bound">w12</span><span class="main">⊗</span><span class="bound">w22</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interleave_reconc interleave_unconc<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ConsInterleave">
<div class="head">
<h1>Theory ConsInterleave</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Monitor Consistent Interleaving
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Monitor Consistent Interleaving"</span></span>
<span class="keyword1"><span class="command">theory</span></span> ConsInterleave
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Interleave.html">Interleave</a> <a href="Misc.html">Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:ConsInterleave}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The monitor consistent interleaving operator is defined on two lists of arbitrary elements, provided an abstraction function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">α</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that maps list elements to pairs of sets of monitors is available.
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">α</span></span> <span class="free"><span class="free">e</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">M</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">M'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> intuitively means that step <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> enters the monitors in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and passes (enters and leaves) the monitors in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The consistent interleaving describes all interleavings of the two lists that are consistent w.r.t. the monitor usage. 
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Monitors of lists of monitor pairs"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following defines the set of all monitors that occur in a list of pairs of monitors. This definition is used in the following context:
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mon_pl (map α w)›</span></span></span></span> is the set of monitors used by a word <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span> w.r.t. the abstraction <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mon_pl</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">==</span> foldl <span class="main">(∪)</span> <span class="main">{}</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∪</span> snd <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mon_pl_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_pl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_pl_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">e</span> <span class="main">∪</span> snd <span class="free">e</span> <span class="main">∪</span> mon_pl <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_pl_def<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> foldl_un_empty_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_pl_unconc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">b</span><span class="main">.</span> mon_pl <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="bound">b</span><span class="main">)</span> <span class="main">=</span> mon_pl <span class="free">a</span> <span class="main">∪</span> mon_pl <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_pl_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≼</span><span class="free">w'</span> <span class="main">⟹</span> mon_pl <span class="free">w</span> <span class="main">⊆</span> mon_pl <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_pl_set<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_pl <span class="free">w</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span> fst <span class="bound">e</span> <span class="main">∪</span> snd <span class="bound">e</span> <span class="main">|</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span>set <span class="free">w</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_def foldl_set<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">cil</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span> set <span class="main">×</span> <span class="tfree">'m</span> set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> 
    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊗⇘</span>_<span class="keyword1">⇙</span> _"</span> <span class="main">[</span>64<span class="main">,</span>64<span class="main">,</span>64<span class="main">]</span> 64<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹Interleaving with the empty word results in the empty word›</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> ⊗<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span> </sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span> 
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> ⊗<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span>
  <span class="comment1">― ‹If both words are not empty, we can take the first step of one word, 
  interleave the rest with the other word and then append
  the first step to all result set elements, provided it does not allocate 
  a monitor that is used by the other word›</span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span> ⊗<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w2</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> 
      <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span> ⊗<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w2</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="main">{}</span>
  <span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>
    <span class="keyword1">if</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> 
      <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">⋅</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w1</span></span></span> ⊗<span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">α</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">w2</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="main">{}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that this definition allows reentrant monitors, because it only checks that a monitor that is going to be entered by one word is not used in the {\em other} word. Thus the same word may enter the same monitor
  multiple times.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are some auxiliary lemmas to simplify the handling of the consistent interleaving operator.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cil_last_case_split<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">⟦</span> <span class="free">w</span><span class="main">∈</span><span class="free">e1</span><span class="main">#</span><span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">e2</span><span class="main">#</span><span class="free">w2</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="free">e1</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="main">(</span><span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">e2</span><span class="main">#</span><span class="free">w2</span><span class="main">)</span><span class="main">;</span> 
           fst <span class="main">(</span><span class="free">α</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="free">e2</span><span class="main">#</span><span class="free">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="free">e2</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="main">(</span><span class="free">e1</span><span class="main">#</span><span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">w2</span><span class="main">)</span><span class="main">;</span> 
           fst <span class="main">(</span><span class="free">α</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="free">e1</span><span class="main">#</span><span class="free">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_set_cons_cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> both_empty left_empty right_empty app_left app_right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">⟦</span> <span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> 
    <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">wa</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">wb</span><span class="main">=</span><span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">⟦</span><span class="free">wa</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="free">w</span><span class="main">=</span><span class="free">wb</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="free">wa</span><span class="main">;</span> <span class="free">wb</span><span class="main">=</span><span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">ea</span> <span class="bound">wa'</span> <span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="bound">ea</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="free">wa</span><span class="main">=</span><span class="bound">ea</span><span class="main">#</span><span class="bound">wa'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="bound">wa'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> 
                  fst <span class="main">(</span><span class="free">α</span> <span class="bound">ea</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">eb</span> <span class="bound">wb'</span> <span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="bound">eb</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="free">wb</span><span class="main">=</span><span class="bound">eb</span><span class="main">#</span><span class="bound">wb'</span><span class="main">;</span> <span class="bound">w'</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">wb'</span><span class="main">;</span> 
                  fst <span class="main">(</span><span class="free">α</span> <span class="bound">eb</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">wa</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">wb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ea</span> <span class="skolem">wa'</span> <span class="skolem">α</span> <span class="skolem">eb</span> <span class="skolem">wb'</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_last_case_split<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">w'</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> left<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ left<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">w'</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> right<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ right<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cil_induct'<span class="main">[</span><span class="operator">case_names</span> both_empty left_empty right_empty append<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  <span class="main">⋀</span><span class="bound">α</span><span class="main">.</span> <span class="free">P</span> <span class="bound">α</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">α</span> <span class="bound">ad</span> <span class="bound">ae</span><span class="main">.</span> <span class="free">P</span> <span class="bound">α</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">ad</span> <span class="main">#</span> <span class="bound">ae</span><span class="main">)</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">α</span> <span class="bound">z</span> <span class="bound">aa</span><span class="main">.</span> <span class="free">P</span> <span class="bound">α</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">[]</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">α</span> <span class="bound">e1</span> <span class="bound">w1</span> <span class="bound">e2</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="main">⟦</span>fst <span class="main">(</span><span class="bound">α</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="bound">α</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">α</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">⟦</span>fst <span class="main">(</span><span class="bound">α</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="bound">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="bound">w2</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">P</span> <span class="bound">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="free">wa</span> <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">wa</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">wb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> cil_induct_fixα<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  <span class="free">P</span> <span class="free">α</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">ad</span> <span class="bound">ae</span><span class="main">.</span> <span class="free">P</span> <span class="free">α</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">ad</span> <span class="main">#</span> <span class="bound">ae</span><span class="main">)</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">z</span> <span class="bound">aa</span><span class="main">.</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">[]</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">e1</span> <span class="bound">w1</span> <span class="bound">e2</span> <span class="bound">w2</span><span class="main">.</span>
    <span class="main">⟦</span>fst <span class="main">(</span><span class="free">α</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span>
     fst <span class="main">(</span><span class="free">α</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">α</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="free">v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cil_induct_fixα'<span class="main">[</span><span class="operator">case_names</span> both_empty left_empty right_empty append<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  <span class="free">P</span> <span class="free">α</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">ad</span> <span class="bound">ae</span><span class="main">.</span> <span class="free">P</span> <span class="free">α</span> <span class="main">[]</span> <span class="main">(</span><span class="bound">ad</span> <span class="main">#</span> <span class="bound">ae</span><span class="main">)</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">z</span> <span class="bound">aa</span><span class="main">.</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">aa</span><span class="main">)</span> <span class="main">[]</span><span class="main">;</span>
  <span class="main">⋀</span><span class="bound">e1</span> <span class="bound">w1</span> <span class="bound">e2</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span>
    fst <span class="main">(</span><span class="free">α</span> <span class="bound">e1</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span><span class="main">;</span>
    fst <span class="main">(</span><span class="free">α</span> <span class="bound">e2</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="bound">w2</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="main">(</span><span class="bound">e1</span> <span class="main">#</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">(</span><span class="bound">e2</span> <span class="main">#</span> <span class="bound">w2</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">α</span> <span class="free">wa</span> <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">wa</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">wb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">w</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="main">[]</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_contains_empty<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> <span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wa</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">wb</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">wa</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">wb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_cons_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e</span><span class="main">#</span><span class="free">w</span> <span class="main">∈</span> <span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span><span class="main">;</span> 
  <span class="main">!!</span><span class="bound">w1'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w1</span><span class="main">=</span><span class="free">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">;</span> <span class="free">w</span><span class="main">∈</span><span class="bound">w1'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
  <span class="main">!!</span><span class="bound">w2'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w2</span><span class="main">=</span><span class="free">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">;</span> <span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w2'</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_set_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> empty left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">α</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="free">w</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="bound">α</span></sub><span class="hidden">⇙</span><span class="bound">w2</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">α</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">α</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">α</span> <span class="bound">e</span> <span class="bound">w'</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">w'</span><span class="main">∈</span><span class="bound">w1'</span>⊗<span class="hidden">⇘</span><sub><span class="bound">α</span></sub><span class="hidden">⇙</span><span class="bound">w2</span><span class="main">;</span> fst <span class="main">(</span><span class="bound">α</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="bound">α</span> <span class="bound">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> 
                      <span class="free">P</span> <span class="bound">w'</span> <span class="bound">α</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">)</span> <span class="bound">α</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">α</span> <span class="bound">e</span> <span class="bound">w'</span> <span class="bound">w2'</span> <span class="bound">w1</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">w'</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="bound">α</span></sub><span class="hidden">⇙</span><span class="bound">w2'</span><span class="main">;</span> fst <span class="main">(</span><span class="bound">α</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="bound">α</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> 
                      <span class="free">P</span> <span class="bound">w'</span> <span class="bound">α</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">)</span> <span class="bound">α</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">w</span> <span class="bound">α</span> <span class="bound">w1</span> <span class="bound">w2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cil_contains_empty <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cil_cons_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_set_induct_fixα<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> empty left right<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="free">w</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w2</span><span class="main">;</span> 
    <span class="free">P</span> <span class="main">[]</span> <span class="free">α</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">e</span> <span class="bound">w'</span> <span class="bound">w1'</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">w'</span><span class="main">∈</span><span class="bound">w1'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w2</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="bound">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> 
                    <span class="free">P</span> <span class="bound">w'</span> <span class="free">α</span> <span class="bound">w1'</span> <span class="bound">w2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">)</span> <span class="free">α</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w1'</span><span class="main">)</span> <span class="bound">w2</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">e</span> <span class="bound">w'</span> <span class="bound">w2'</span> <span class="bound">w1</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">w'</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w2'</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> 
                    <span class="free">P</span> <span class="bound">w'</span> <span class="free">α</span> <span class="bound">w1</span> <span class="bound">w2'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">)</span> <span class="free">α</span> <span class="bound">w1</span> <span class="main">(</span><span class="bound">e</span><span class="main">#</span><span class="bound">w2'</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">w</span> <span class="free">α</span> <span class="bound">w1</span> <span class="bound">w2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cil_contains_empty <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cil_cons_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
                  <span class="main">⟹</span> <span class="free">e</span><span class="main">#</span><span class="free">w</span> <span class="main">∈</span> <span class="free">e</span><span class="main">#</span><span class="free">wa</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">wb</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> fst <span class="main">(</span><span class="free">α</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
                  <span class="main">⟹</span> <span class="free">e</span><span class="main">#</span><span class="free">w</span> <span class="main">∈</span> <span class="free">wa</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">#</span><span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">wa</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Properties of consistent interleaving"</span></span>

<span class="comment1">― ‹Consistent interleaving is a restriction of interleaving›</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_subset_il<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w'</span> <span class="main">⊆</span> <span class="free">w</span><span class="main">⊗</span><span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cil_subset_il'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">∈</span><span class="free">w1</span><span class="main">⊗</span><span class="free">w2</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> cil_subset_il <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹Consistent interleaving preserves the set of letters of both operands›</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> set <span class="free">w</span> <span class="main">=</span> set <span class="free">w1</span> <span class="main">∪</span> set <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">corollary</span></span> cil_mon_pl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> 
  <span class="main">⟹</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">w1</span><span class="main">)</span> <span class="main">∪</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="free">w2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mon_pl_unconc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_set cil_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> 20<span class="main">)</span>

<span class="comment1">― ‹Consistent interleaving preserves the length of both operands›</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_length<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> length <span class="free">wa</span> <span class="main">+</span> length <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">― ‹Consistent interleaving contains all letters of each operand in the original order›</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> <span class="free">w1</span><span class="main">≼</span><span class="free">w</span> <span class="main">∧</span> <span class="free">w2</span><span class="main">≼</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI cil_subset_il' ileq_interleave<span class="main">)</span>

<span class="comment1">― ‹Consistent interleaving is commutative and associative›</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w'</span> <span class="main">=</span> <span class="free">w'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cil_assoc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">wl</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="bound">w3</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">∈</span><span class="bound">wl</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w3</span><span class="main">;</span> <span class="bound">wl</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w2</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">wr</span><span class="main">.</span> <span class="free">w</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">wr</span> <span class="main">∧</span> <span class="bound">wr</span><span class="main">∈</span><span class="bound">w2</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="bound">w3</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_cons_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">wl'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">wl'</span> <span class="main">∈</span> <span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_cons_cases<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> left' right'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left' <span class="skolem">w1'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ left<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> left'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1'</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">wr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wr</span> <span class="main">∈</span> <span class="skolem">w2</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">∈</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w1'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="skolem">wr</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> left left' cil_mon_pl<span class="main">[</span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">wr</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>2<span class="main">)</span> left' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right' <span class="skolem">w2'</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ left<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> right'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">wr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wr</span> <span class="main">∈</span> <span class="skolem">w2'</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">)</span> left <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">wr</span> <span class="main">∈</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w2'</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cil_cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> right' IHAPP<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cil_cons2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> right' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">w3'</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ right<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">wr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wr</span> <span class="main">∈</span> <span class="skolem">w2</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">w3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">)</span> right cil_mon_pl<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">wr</span> <span class="main">∈</span> <span class="skolem">w2</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cil_cons2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>1<span class="main">)</span> right cil_mon_pl<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cil_cons2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> cil_assoc2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">wr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr</span><span class="main">∈</span><span class="free">w2</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w3</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">wl</span><span class="main">.</span> <span class="free">w</span><span class="main">∈</span><span class="bound">wl</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w3</span> <span class="main">∧</span> <span class="bound">wl</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">wr</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wr</span><span class="main">∈</span><span class="free">w3</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cil_assoc1<span class="main">[</span><span class="operator">OF</span> A' B'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">w3</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="skolem">wl</span> <span class="main">∧</span> <span class="skolem">wl</span> <span class="main">∈</span> <span class="free">w2</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">― ‹Parts of the abstraction can be moved to the operands›</span>
<span class="comment1">(* FIXME: ?? Something strange is going on with the simplification of α∘f and implicit η-contraction/expansion, hence this lengthy isar proof. Usually, this proof should be a just few lines apply-script !*)</span>
<span class="keyword1"><span class="command">lemma</span></span> cil_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="main">(</span><span class="free">α</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="free">w2</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="free">w</span> <span class="main">∈</span> map <span class="free">f</span> <span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> map <span class="free">f</span> <span class="free">w2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w1'</span> <span class="skolem">w2</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">e</span> <span class="main">#</span> map <span class="free">f</span> <span class="skolem">w'</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">e</span> <span class="main">#</span> map <span class="free">f</span> <span class="skolem">w1'</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> map <span class="free">f</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons1<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> left<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="free">α</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> left<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w2'</span> <span class="skolem">w1</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">e</span> <span class="main">#</span> map <span class="free">f</span> <span class="skolem">w'</span> <span class="main">∈</span> map <span class="free">f</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">f</span> <span class="skolem">e</span> <span class="main">#</span> map <span class="free">f</span> <span class="skolem">w2'</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> right<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="free">α</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span>map <span class="free">f</span> <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> right<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="AcquisitionHistory">
<div class="head">
<h1>Theory AcquisitionHistory</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Acquisition histories
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Acquisition Histories"</span></span>
<span class="keyword1"><span class="command">theory</span></span> AcquisitionHistory
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ConsInterleave.html">ConsInterleave</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:AcquisitionHistory}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The concept of {\em acquisition histories} was introduced by Kahlon, Ivancic, and Gupta \cite{KIG05} as a bounded size abstraction of executions that acquire and release locks that contains enough information
  to decide consistent interleavability. In this work, we use this concept for reentrant monitors.
  As in Section~\ref{thy:ConsInterleave}, we encode monitor usage information in pairs of sets of monitors, and regard lists of such pairs as (abstract) executions.
  An item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">E</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">U</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of such a list describes a sequence of steps of the concrete execution that first enters the monitors in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then passes through the monitors in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The monitors in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are
  never left by the execution. Note that due to the syntactic binding of monitors to the program structure, any execution of a single thread can be abstracted to a sequence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">E</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">U</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>-pairs. 
  Restricting the possible schedules (see Section \ref{thy:Normalization}) will allow us to also abstract executions reaching a single program point to a sequence of such pairs.

  We want to decide whether two executions are interleavable. The key observation of \cite{KIG05} is, that two executions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are {\em not} interleavable if and only if 
  there is a conflicting pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">m</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">m'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of monitors, such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> enters (and never leaves) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then uses <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> enters (and never leaves) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then uses <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  

  An acquisition history is a map from monitors to set of monitors. The acquisition history of an execution maps a monitor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that is allocated at the end of the execution to all monitors that are used after or in the 
  same step that finally enters <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Monitors that are not allocated at the end of an execution are mapped to the empty set. Though originally used for a setting without reentrant monitors, acquisition histories also work
  for our setting with reentrant monitors. 

  This theory contains the definition of acquisition histories and acquisition history interleavability, an ordering on acquisition histories that reflects the blocking potential of acquisition histories, 
  and a mapping function from paths to acquisition histories that is shown to be compatible with monitor consistent interleaving.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Acquisition histories are modeled as functions from monitors to sets of monitors. Intuitively <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">m'</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">h</span></span> <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> models that an execution finally is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and monitor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has been used (i.e. passed or entered)
  after or at the same time <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has been finally entered. By convention, we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">m</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">h</span></span> <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="free"><span class="free">m</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">{}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

  <span class="comment1">(* TODO: Make acquisition histories an own type, with access and update operator of sort order  *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ah</span> <span class="main">==</span> <span class="main">{</span> <span class="main">(</span><span class="bound">h</span><span class="main">::</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">h</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="bound">m</span><span class="main">∈</span><span class="bound">h</span> <span class="bound">m</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ah_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">h</span><span class="main">∈</span>ah<span class="main">;</span> <span class="free">h</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">m</span> <span class="main">∈</span> <span class="free">h</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_def<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Interleavability"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two acquisition histories <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are considered interleavable, iff there is no conflicting pair of monitors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  where a pair of monitors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is called {\em conflicting} iff <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> after entering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and, vice versa, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> after entering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ah_il</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">[*]</span>"</span> 65<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main"><span class="free">[*]</span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">==</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">m1</span> <span class="bound">m2</span><span class="main">.</span> <span class="bound">m1</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="bound">m2</span> <span class="main">∧</span> <span class="bound">m2</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="bound">m1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From our convention, it follows (as expected) that the sets of entered monitors (lock-sets) of two interleavable acquisition histories are disjoint›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_il_lockset_disjoint<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h1</span><span class="main">∈</span>ah<span class="main">;</span> <span class="free">h2</span><span class="main">∈</span>ah<span class="main">;</span> <span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h1</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">h2</span> <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ah_cases<span class="main">)</span>    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Of course, acquisition history interleavability is commutative›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_il_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2</span> <span class="main">⟹</span> <span class="free">h2</span> <span class="main">[*]</span> <span class="free">h1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Used monitors"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let's define the monitors of an acquisition history, as all monitors that occur in the acquisition history›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">mon_ah</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'m</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_ah</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">==</span> <span class="main">⋃</span><span class="main">{</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">|</span> <span class="bound">m</span><span class="main">.</span> True<span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Ordering"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The element-wise subset-ordering on acquisition histories intuitively reflects the blocking potential: The bigger the acquisition history, the fewer acquisition histories are interleavable with it.›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the Isabelle standard library automatically lifts the subset ordering to functions, so we need no explicit definition here.›</span></span>
  
<span class="comment1">― ‹The ordering is compatible with interleavability, i.e.\ smaller acquisition histories are more likely to be interleavable.›</span>
<span class="keyword1"><span class="command">lemma</span></span> ah_leq_il<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2</span><span class="main">;</span> <span class="free">h1'</span> <span class="main">≤</span> <span class="free">h1</span><span class="main">;</span> <span class="free">h2'</span> <span class="main">≤</span> <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h1'</span> <span class="main">[*]</span> <span class="free">h2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> set"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_leq_il_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2</span><span class="main">;</span> <span class="free">h1'</span> <span class="main">≤</span> <span class="free">h1</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h1'</span> <span class="main">[*]</span> <span class="free">h2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      ah_leq_il_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2</span><span class="main">;</span> <span class="free">h2'</span> <span class="main">≤</span> <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">h1</span> <span class="main">[*]</span> <span class="free">h2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> set"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Acquisition histories of executions"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define a function that abstracts from executions (lists of enter/use pairs) to acquisition histories›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">αah</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> set <span class="main">×</span> <span class="tfree">'m</span> set<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">αah</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">αah</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">∈</span>fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> snd <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> mon_pl <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">else</span> <span class="free">αah</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">αah</span></span><span class="antiquote">}</span></span> generates valid acquisition histories›</span>
<span class="keyword1"><span class="command">lemma</span></span> αah_ah<span class="main">:</span> <span class="quoted"><span class="quoted">"αah <span class="free">w</span> <span class="main">∈</span> ah"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ah_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> αah_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span><span class="main">∈</span>fst <span class="free">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>fst <span class="free">e</span> <span class="main">∪</span> snd <span class="free">e</span> <span class="main">∪</span> mon_pl <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>αah <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> αah_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span><span class="main">∉</span>fst <span class="free">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>αah <span class="free">w</span> <span class="free">m</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>αah <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> αah_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> hd tl<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="free">x</span><span class="main">∈</span>αah <span class="free">w</span> <span class="free">m</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">e</span> <span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="free">m</span><span class="main">∈</span>fst <span class="bound">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>fst <span class="bound">e</span> <span class="main">∪</span> snd <span class="bound">e</span> <span class="main">∪</span> mon_pl <span class="bound">w'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">e</span> <span class="bound">w'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="bound">e</span><span class="main">#</span><span class="bound">w'</span><span class="main">;</span> <span class="free">m</span><span class="main">∉</span>fst <span class="bound">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>αah <span class="bound">w'</span> <span class="free">m</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> αah_cons_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> hd tl<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="free">x</span><span class="main">∈</span>αah <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w'</span><span class="main">)</span> <span class="free">m</span><span class="main">;</span>  
    <span class="main">⟦</span><span class="free">m</span><span class="main">∈</span>fst <span class="free">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>fst <span class="free">e</span> <span class="main">∪</span> snd <span class="free">e</span> <span class="main">∪</span> mon_pl <span class="free">w'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">⟦</span><span class="free">m</span><span class="main">∉</span>fst <span class="free">e</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>αah <span class="free">w'</span> <span class="free">m</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_ah_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_ah <span class="main">(</span>αah <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> mon_pl <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ah_def<span class="main">)</span>

<span class="comment1">― ‹Subwords generate smaller acquisition histories›</span>
<span class="keyword1"><span class="command">lemma</span></span> αah_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w1</span><span class="main">≼</span><span class="free">w2</span> <span class="main">⟹</span> αah <span class="free">w1</span> <span class="main">≤</span> αah <span class="free">w2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> set"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>drop <span class="skolem">l'</span> <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> le_fun_def  <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> αah <span class="skolem">l'</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> drop<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>αah <span class="skolem">l</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> le_fun_def  <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree"><span class="tfree">'a</span></span></span> set"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>mon_pl <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_ah_subset<span class="main">[</span><span class="operator">unfolded</span> mon_ah_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>αah <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>take <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">l'</span> <span class="skolem">l</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> set"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>αah <span class="main">(</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">l'</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> αah <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> αah_cons_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> hd
      <span class="keyword1"><span class="command">with</span></span> mon_pl_ileq<span class="main">[</span><span class="operator">OF</span> take.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> tl
      <span class="keyword1"><span class="command">with</span></span> take.hyps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can now prove the relation of monitor consistent interleavability and interleavability of the acquisition histories.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_interleavable1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">w2</span> <span class="main">⟹</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w2</span><span class="main">)</span>"</span></span> 
  <span class="comment1">― ‹The lemma is shown by induction on the structure of the monitor consistent interleaving operator›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_il_def<span class="main">)</span> <span class="comment1">― ‹The base case is trivial by the definition of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">([*])</span>"</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Case: First step comes from the left word›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w1'</span> <span class="skolem">w2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="comment1">― ‹We do a proof by contradiction›</span>
    <span class="comment1">― ‹Assume there is a conflicting pair in the acquisition histories›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="skolem"><span class="skolem">m2</span></span> <span class="keyword2"><span class="keyword">where</span></span> CPAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span> <span class="skolem">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="comment1">― ‹It comes either from the first step or not›</span>
    <span class="keyword1"><span class="command">from</span></span> CPAIR<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m2</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m1</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> snd <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">m2</span><span class="main">∉</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m1</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="skolem">m2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CASE1</span> <span class="main">∨</span> <span class="var">?CASE2</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="comment1">― ‹Case: One monitor of the conflicting pair is entered in the first step of the left path›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?CASE1</span></span></span> <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> 
      <span class="comment1">― ‹Because the paths are consistently interleavable, the monitors entered in the first step must not occur in the other path›</span>
      <span class="keyword1"><span class="command">from</span></span> left<span class="main">(</span>2<span class="main">)</span> mon_ah_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="free">α</span> <span class="skolem">w2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_ah <span class="main">(</span>αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="comment1">― ‹But this is a contradiction to being a conflicting pair›</span>
      <span class="keyword1"><span class="command">with</span></span> C CPAIR<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ah_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="comment1">― ‹Case: The first monitor of the conflicting pair is entered after the first step of the left path›</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?CASE2</span></span></span> <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="skolem">m2</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> 
      <span class="comment1">― ‹But this is a contradiction to the induction hypothesis, that says that the acquisition histories of the tail of the left path and the 
        right path are interleavable›</span>
      <span class="keyword1"><span class="command">with</span></span> left<span class="main">(</span>3<span class="main">)</span> CPAIR<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Case: First step comes from the right word. This case is shown completely analogous›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w2'</span> <span class="skolem">w1</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="skolem"><span class="skolem">m2</span></span> <span class="keyword2"><span class="keyword">where</span></span> CPAIR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span> <span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> CPAIR<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m1</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m2</span> <span class="main">∈</span> fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> snd <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∪</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">m1</span><span class="main">∉</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">m2</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2'</span><span class="main">)</span> <span class="skolem">m1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?CASE1</span> <span class="main">∨</span> <span class="var">?CASE2</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?CASE1</span></span></span> <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> 
      <span class="keyword1"><span class="command">from</span></span> right<span class="main">(</span>2<span class="main">)</span> mon_ah_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="free">α</span> <span class="skolem">w1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_ah <span class="main">(</span>αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">with</span></span> C CPAIR<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ah_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?CASE2</span></span></span> <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2'</span><span class="main">)</span> <span class="skolem">m1</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> 
      <span class="keyword1"><span class="command">with</span></span> right<span class="main">(</span>3<span class="main">)</span> CPAIR<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> ah_interleavable2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w2</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="free">w2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="comment1">― ‹This lemma is shown by induction on the sum of the word lengths›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹To apply this induction in Isabelle, we have to rewrite the lemma a bit›</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="main">⟦</span>αah <span class="main">(</span>map <span class="free">α</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="bound">w2</span><span class="main">)</span><span class="main">;</span> <span class="skolem">n</span><span class="main">=</span>length <span class="bound">w1</span> <span class="main">+</span> length <span class="bound">w2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">w1</span> ⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span> <span class="bound">w2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> I<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="comment1">― ‹We first rule out the cases that one of the words is empty›</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>I <span class="skolem">n</span> <span class="skolem">w1</span> <span class="skolem">w2</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w1</span></span><span class="main">)</span> 
        <span class="comment1">― ‹If the first word is empty, the lemma is trivial›</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> I.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e1</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CONS1<span class="main">=</span>this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w2</span></span><span class="main">)</span>
          <span class="comment1">― ‹If the second word is empty, the lemma is also trivial›</span>
          <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> I.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">― ‹The interesting case is if both words are not empty›</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e2</span> <span class="skolem">w2'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CONS2<span class="main">=</span>this 
          <span class="comment1">― ‹In this case, we check whether the first step of one of the words can safely be executed without blocking any steps of the other word›</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹The first step of the first word can safely be executed›</span>
            <span class="comment1">― ‹From the induction hypothesis, we get that there is a consistent interleaving of the rest of the first word and the second word›</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1'</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="skolem">w2</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">from</span></span> I.prems<span class="main">(</span>1<span class="main">)</span> CONS1 ah_leq_il_left<span class="main">[</span><span class="operator">OF</span> _ αah_ileq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_list_map<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> less_eq_list_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CONS1 I.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w1'</span><span class="main">+</span>length <span class="skolem">w2</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="comment1">― ‹And because the first step of the first word can be safely executed, we can prepend it to that consistent interleaving›</span>
            <span class="keyword1"><span class="command">with</span></span> cil_cons1<span class="main">[</span><span class="operator">OF</span> _ True<span class="main">]</span> CONS1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> C1<span class="main">=</span>this
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹The first step of the second word can safely be executed›</span>
              <span class="comment1">― ‹This case is shown analogously to the latter one›</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="skolem">w2'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">from</span></span> I.prems<span class="main">(</span>1<span class="main">)</span> CONS2 ah_leq_il_right<span class="main">[</span><span class="operator">OF</span> _ αah_ileq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_list_map<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> less_eq_list_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CONS2 I.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w1</span><span class="main">+</span>length <span class="skolem">w2'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> I.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">with</span></span> cil_cons2<span class="main">[</span><span class="operator">OF</span> _ True<span class="main">]</span> CONS2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> C2<span class="main">=</span>this <span class="comment1">― ‹Neither first step can safely be executed. This is exactly the situation from that we can extract a conflicting pair›</span>
              <span class="keyword1"><span class="command">from</span></span> C1 C2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="skolem"><span class="skolem">m2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">∈</span>mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span><span class="main">∈</span>fst <span class="main">(</span><span class="free">α</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span><span class="main">∈</span>mon_pl <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">with</span></span> CONS1 CONS2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w1</span><span class="main">)</span> <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="skolem">w2</span><span class="main">)</span> <span class="skolem">m2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="comment1">― ‹But by assumption, there are no conflicting pairs, thus we get a contradiction›</span>
              <span class="keyword1"><span class="command">with</span></span> I.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ah_il_def<span class="main">)</span> <span class="operator">blast</span> 
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
              
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we can state the relationship between monitor consistent interleaving and interleaving of acquisition histories›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> ah_interleavable<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="free">α</span> <span class="free">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span><span class="main">≠</span><span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ah_interleavable1 ah_interleavable2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Acquisition history backward update"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a function to update an acquisition history backwards. This function is useful for constructing acquisition histories in backward constraint systems.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ah_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span> set <span class="main">*</span> <span class="tfree">'m</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'m</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ah_update</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">==</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">∈</span>fst <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="keyword1">then</span> fst <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∪</span> snd <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Intuitively, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ah_update <span class="free"><span class="free">h</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">E</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">U</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">M</span></span> <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means to prepend a step <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">E</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">U</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the acquisition history <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a path that uses monitors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that we need the extra parameter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, since
  an acquisition history does not contain information about the monitors that are used on a path before the first monitor that will not be left has been entered. 
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_update_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> ah_update <span class="main">(</span>αah <span class="free">w</span><span class="main">)</span> <span class="free">e</span> <span class="main">(</span>mon_pl <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The backward-update function is monotonic in the first and third argument as well as in the used monitors of the second argument. 
  Note that it is, in general, not monotonic in the entered monitors of the second argument.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ah_update_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">h</span> <span class="main">≤</span> <span class="free">h'</span><span class="main">;</span> <span class="free">F</span><span class="main">=</span><span class="free">F'</span><span class="main">;</span> <span class="free">M</span><span class="main">⊆</span><span class="free">M'</span><span class="main">⟧</span> 
  <span class="main">⟹</span> ah_update <span class="free">h</span> <span class="free">F</span> <span class="free">M</span> <span class="main">≤</span> ah_update <span class="free">h'</span> <span class="free">F'</span> <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_def le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> ah_update_mono2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">h</span> <span class="main">≤</span> <span class="free">h'</span><span class="main">;</span> <span class="free">U</span><span class="main">⊆</span><span class="free">U'</span><span class="main">;</span> <span class="free">M</span><span class="main">⊆</span><span class="free">M'</span><span class="main">⟧</span> 
  <span class="main">⟹</span> ah_update <span class="free">h</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span><span class="free">U</span><span class="main">)</span> <span class="free">M</span> <span class="main">≤</span> ah_update <span class="free">h'</span> <span class="main">(</span><span class="free">E</span><span class="main">,</span><span class="free">U'</span><span class="main">)</span> <span class="free">M'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_def le_fun_def <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'b</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTS">
<div class="head">
<h1>Theory LTS</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Labelled transition systems
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Labeled transition systems›</span></span>
<span class="keyword1"><span class="command">theory</span></span> LTS
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:LTS}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Labeled transition systems (LTS) provide a model of a state transition system with named transitions.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An LTS is modeled as a ternary relation between start configuration, transition label and end configuration›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> LTS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transitive reflexive closure›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">trcl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> LTS <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'a</span> list<span class="main">)</span> LTS"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">t</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">trcl</span> <span class="free">t</span>"</span></span>
  <span class="main">|</span> cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">t</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">trcl</span> <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">trcl</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties of transitive reflexive closure›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_empty_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trcl.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_empty_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trcl.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trcl.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trcl_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trcl.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_uncons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">#</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ch</span> <span class="main">.</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span><span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trcl.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_uncons_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_one_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trcl_unconsE<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> split<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_pair_unconsE<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> split<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">sh</span> <span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">sh</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">sh</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trcl_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">c</span> <span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">w1</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span><span class="main">;</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">w2</span><span class="main">,</span><span class="free">c''</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">,</span><span class="free">c''</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="free">c'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>    
  
<span class="keyword1"><span class="command">lemma</span></span> trcl_unconcat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">c</span> <span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ch</span> <span class="main">.</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">w1</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w1</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">a</span><span class="main">#</span><span class="main">(</span><span class="skolem">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">)</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* Auto/fast/blast do not get the point _#(_@_) = (_#_)@_ in next step, so making it explicit *)</span>
  <span class="keyword1"><span class="command">with</span></span> trcl_uncons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">chh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">∈</span><span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">chh</span><span class="main">,</span><span class="skolem">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> IHP <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">chh</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">ch</span><span class="main">,</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">w1</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">ch</span><span class="main">,</span><span class="free">w2</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Appending of elements to paths"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_rev_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">T</span><span class="main">;</span> <span class="main">(</span><span class="free">ch</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_concat <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trcl_single<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_rev_uncons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">T</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ch</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">T</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_unconcat<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_rev_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty snoc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">[]</span> <span class="bound">c</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">c</span> <span class="bound">w</span> <span class="bound">c'</span> <span class="bound">e</span> <span class="bound">c''</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">c'</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="bound">c''</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">w</span> <span class="bound">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">w</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span> <span class="bound">c''</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c</span> <span class="free">w</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_rev_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">⟦</span><span class="free">w</span><span class="main">=</span><span class="main">[]</span><span class="main">;</span> <span class="bound">c</span><span class="main">=</span><span class="bound">c'</span><span class="main">⟧</span><span class="main">⟹</span><span class="free">P</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">ch</span> <span class="bound">e</span> <span class="bound">wh</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="bound">wh</span><span class="main">@</span><span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">;</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">wh</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> <span class="main">(</span><span class="bound">ch</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟧</span><span class="main">⟹</span><span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trcl_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">ch</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span><span class="main">;</span> <span class="main">(</span><span class="free">ch</span><span class="main">,</span><span class="free">f</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="main">[</span><span class="free">e</span><span class="main">,</span><span class="free">f</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Transitivity reasoning setup"</span></span>
<span class="keyword1"><span class="command">declare</span></span> trcl_cons2<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>    <span class="comment1">― ‹It's important that this is declared before <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] trcl_concat<span class="antiquote">}</span></span>, because we want <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] trcl_concat<span class="antiquote">}</span></span> to be tried first by the transitivity reasoner›</span>
<span class="keyword1"><span class="command">declare</span></span> cons<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> trcl_concat<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> trcl_rev_cons<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Monotonicity"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">B</span> <span class="main">⟹</span> trcl <span class="bound">A</span> <span class="main">⊆</span> trcl <span class="bound">B</span>"</span></span> <span class="comment1">(* FIXME: Why can't this be declared as [mono] or [mono_set] ? *)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trcl.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> trcl_inter_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="main">(</span><span class="free">S</span><span class="main">∩</span><span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>trcl <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="main">(</span><span class="free">S</span><span class="main">∩</span><span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>trcl <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="main">(</span><span class="free">S</span><span class="main">∩</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> trcl_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">∩</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="main">(</span><span class="free">S</span><span class="main">∩</span><span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> trcl_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">∩</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>trcl <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Special lemmas for reasoning about states that are pairs"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> trcl_pair_induct <span class="main">=</span> trcl.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xc1</span><span class="main">,</span><span class="free">xc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xa1</span><span class="main">,</span><span class="free">xa2</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_format</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty cons<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> trcl_rev_pair_induct <span class="main">=</span> trcl_rev_induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xc1</span><span class="main">,</span><span class="free">xc2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xa1</span><span class="main">,</span><span class="free">xa2</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">split_format</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty snoc<span class="main">]</span>

<span class="comment1">(*lemma trcl_pair_induct[induct set]: 
  "⟦((xc1,xc2), xb, (xa1,xa2)) ∈ trcl t; ⋀c1 c2. P c1 c2 [] c1 c2; ⋀a c1 c2 c1' c2' c1'' c2'' w. ⟦((c1,c2), a, (c1',c2')) ∈ t; ((c1',c2'), w, (c1'',c2'')) ∈ trcl t; P c1' c2' w c1'' c2''⟧ ⟹ P c1 c2 (a # w) c1'' c2''⟧ 
  ⟹ P xc1 xc2 xb xa1 xa2" 
  using trcl.induct[of "(xc1,xc2)" xb "(xa1,xa2)" t "λc w c'. let (c1,c2)=c in let (c1',c2')=c' in P c1 c2 w c1' c2'"] by auto
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Invariants"</span></span>
<span class="comment1">(* TODO: Do we really need this ? Is this formulation usable ? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> trcl_prop_trans<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> empty steps<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">S</span><span class="main">;</span> 
    <span class="main">⟦</span><span class="free">c</span><span class="main">=</span><span class="free">c'</span><span class="main">;</span> <span class="free">w</span><span class="main">=</span><span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>  
    <span class="main">⟦</span><span class="free">c</span><span class="main">∈</span>Domain <span class="free">S</span><span class="main">;</span> <span class="free">c'</span><span class="main">∈</span>Range <span class="main">(</span>Range <span class="free">S</span><span class="main">)</span><span class="main">⟧</span><span class="main">⟹</span><span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> trcl_rev_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trcl.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ThreadTracking">
<div class="head">
<h1>Theory ThreadTracking</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Thread Tracking
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Thread Tracking"</span></span>
<span class="keyword1"><span class="command">theory</span></span> ThreadTracking
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <a href="LTS.html">LTS</a> <a href="Misc.html">Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:ThreadTracking}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory defines some general notion of an interleaving semantics. It defines how to extend a semantics specified on a single thread and a context to a semantic on multisets of threads.
  The context is needed in order to keep track of synchronization.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Semantic on multiset configuration"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The interleaving semantics is defined on a multiset of stacks. The thread to make the next step is nondeterministically chosen from all threads ready to make steps.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">gtr</span> <span class="free"><span class="bound"><span class="entity">gtrs</span></span></span> <span class="main">==</span> <span class="main">{</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">c</span> <span class="bound">e</span> <span class="bound">s'</span> <span class="bound">c'</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">gtrs</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gtrI_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> gtr_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> gtrI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">gtrs</span> 
  <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">gtrs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gtrI_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gtrE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">T</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span> <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span>add_mset <span class="bound">s</span> <span class="bound">ce</span><span class="main">;</span> <span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> gtr_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gtr_empty_conf_s<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∉</span>gtr <span class="free">S</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">∉</span>gtr <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> gtrE<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> gtr_empty_conf1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">{#}</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c'</span><span class="main">=</span><span class="main">{#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> gtr_empty_conf2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span><span class="main">=</span><span class="main">{#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gtr_find_thread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span> <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c</span><span class="main">=</span>add_mset <span class="bound">s</span> <span class="bound">ce</span><span class="main">;</span> <span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> gtr_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gtr_step_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc other<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">ce</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s'</span> <span class="bound">ce'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">cc</span> <span class="bound">ss</span> <span class="bound">ss'</span> <span class="bound">ce'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">ce</span><span class="main">=</span>add_mset <span class="bound">ss</span> <span class="bound">cc</span><span class="main">;</span> <span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">ss'</span> <span class="bound">ce'</span><span class="main">;</span> 
                       <span class="main">(</span><span class="main">(</span><span class="bound">ss</span><span class="main">,</span>add_mset <span class="free">s</span> <span class="bound">cc</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">ss'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtr_find_thread mset_single_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gtr_rev_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> loc other<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">ce'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span>add_mset <span class="bound">s</span> <span class="bound">ce</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span>
    <span class="main">!!</span><span class="bound">cc</span> <span class="bound">ss</span> <span class="bound">ss'</span> <span class="bound">ce</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span>add_mset <span class="bound">ss</span> <span class="bound">ce</span><span class="main">;</span> <span class="free">ce'</span><span class="main">=</span>add_mset <span class="bound">ss'</span> <span class="bound">cc</span><span class="main">;</span> 
                      <span class="main">(</span><span class="main">(</span><span class="bound">ss</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">ss'</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="bound">cc</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtr_find_thread mset_single_cases<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Invariants"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gtr_preserve_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">T</span><span class="main">;</span> 
    <span class="free">P</span> <span class="free">c</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span> <span class="bound">s'</span> <span class="bound">c'</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> gtr_def<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> gtr_preserve<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">T</span><span class="main">)</span><span class="main">;</span> 
    <span class="free">P</span> <span class="free">c</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span> <span class="bound">s'</span> <span class="bound">c'</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="improper">c'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtr_preserve_s<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Context preservation assumption"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now assume that the original semantics does not modify threads in the context, i.e. it may only add new threads to the context and use the context to obtain monitor information, but not change any
  existing thread in the context. This assumption is valid for our semantics, where the context is just needed to determine the set of allocated monitors. It allows us to generally derive some further properties of
  such semantics.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> env_no_step <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gtrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">×</span><span class="tfree">'s</span> multiset<span class="main">)</span><span class="main">,</span><span class="tfree">'l</span><span class="main">)</span> LTS"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> env_no_step_s<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main">,</span> <span class="operator">case_names</span> csp<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span><span class="main">;</span> <span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>

<span class="comment1">― ‹The property of not changing existing threads in the context transfers to paths›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> env_no_step<span class="main">)</span> env_no_step<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main">,</span> <span class="operator">case_names</span> csp<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">gtrs</span><span class="main">;</span> 
    <span class="main">!!</span> <span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">gtrs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
    <span class="keyword1"><span class="command">from</span></span> env_no_step_s<span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csph</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">csp'</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">csp'</span><span class="main">+</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="free">gtrs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma can be used to make a case distinction how a step operated on a given thread in the end configuration:
    \begin{description}
      \item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>loc›</span></span></span></span>] The thread made the step
      \item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>spawn›</span></span></span></span>] The thread was spawned by the step
      \item[<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>env›</span></span></span></span>] The thread was not involved in the step
    \end{description}
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> env_no_step<span class="main">)</span> rev_cases_p<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main">,</span> <span class="operator">case_names</span> loc spawn env<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">ce'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  LOC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  SPAWN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ss</span> <span class="bound">ss'</span> <span class="bound">ce</span> <span class="bound">csp</span><span class="main">.</span> 
            <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span>add_mset <span class="bound">ss</span> <span class="bound">ce</span><span class="main">;</span> <span class="free">ce'</span><span class="main">=</span>add_mset <span class="bound">ss'</span> <span class="main">(</span><span class="bound">csp</span><span class="main">+</span><span class="bound">ce</span><span class="main">)</span><span class="main">;</span> 
              <span class="main">(</span><span class="main">(</span><span class="bound">ss</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">ss'</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="main">(</span><span class="bound">csp</span><span class="main">+</span><span class="bound">ce</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> 
           <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ENV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ss</span> <span class="bound">ss'</span> <span class="bound">ce</span> <span class="bound">csp</span><span class="main">.</span> 
            <span class="main">⟦</span> <span class="free">c</span><span class="main">=</span>add_mset <span class="bound">ss</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="bound">ce</span><span class="main">)</span><span class="main">;</span> <span class="free">ce'</span><span class="main">=</span>add_mset <span class="bound">ss'</span> <span class="main">(</span><span class="bound">csp</span><span class="main">+</span><span class="bound">ce</span><span class="main">)</span><span class="main">;</span> 
              <span class="main">(</span><span class="main">(</span><span class="bound">ss</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">ss'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="main">(</span>add_mset <span class="free">s'</span> <span class="bound">ce</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span> <span class="main">⟧</span> 
           <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gtr_rev_cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> STEP<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> LOC <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> CASE<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">cc</span> <span class="skolem">ss</span> <span class="skolem">ss'</span> <span class="skolem">ce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> CASE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ce'</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">ss'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">cc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">ss'</span><span class="main">,</span> <span class="main">{#</span><span class="free">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">cc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">gtrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> env_no_step_s<span class="main">[</span><span class="operator">OF</span> CASE'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s'</span> <span class="skolem">cc</span> <span class="main">=</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_unplusm_dist_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
    <span class="keyword1"><span class="command">with</span></span> CASE' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ce'</span><span class="main">=</span><span class="main">{#</span><span class="skolem">ss'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">-</span><span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CC<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">cc</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">-</span><span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CASE'<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> CASE<span class="main">(</span>2<span class="main">)</span> SPAWN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
    <span class="keyword1"><span class="command">from</span></span> CC<span class="main">(</span>1<span class="main">)</span> CASE'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span>add_mset <span class="skolem">ss</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="main">(</span><span class="skolem">ce</span> <span class="main">-</span> <span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CC<span class="main">(</span>2<span class="main">)</span> CASE'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ce'</span><span class="main">=</span>add_mset <span class="skolem">ss'</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ce</span><span class="main">-</span><span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CC<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">s'</span> <span class="skolem">cc</span> <span class="main">=</span> <span class="skolem">csp</span><span class="main">+</span><span class="main">(</span>add_mset <span class="free">s'</span> <span class="main">(</span><span class="skolem">ce</span><span class="main">-</span><span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CASE'<span class="main">(</span>3<span class="main">)</span> CASE<span class="main">(</span>3<span class="main">)</span> CC<span class="main">(</span>1<span class="main">)</span> ENV <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Explicit local context"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:ThreadTracking:exp_local}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the multiset semantics, a single thread has no identity. This may become a problem when reasoning about a fixed thread during an execution. For example, in our constraint-system-based approach
  the operational characterization of the least solution of the constraint system requires to state properties of the steps of the initial thread in some execution. With the multiset semantics, we are unable 
  to identify those steps among all steps.

  There are many solutions to this problem, for example, using thread ids either as part of the thread's configuration or as part of the whole configuration by using 
  lists of stacks or maps from ids to stacks as configuration datatype. 

  In the following we present a special solution that is strong enough to suit our purposes but not meant as a general solution. 

  Instead of identifying every single thread uniquely, we only distinguish one thread as the {\em local} thread. The other
  threads are {\em environment} threads. We then attach to every step the information whether it was on the local or on some environment thread. 

  We call this semantics {\em loc/env}-semantics in contrast to the {\em multiset}-semantics of the last section.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lifted step datatype"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> el_step <span class="main">=</span> LOC <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> ENV <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">loc</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">==</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">e</span> <span class="keyword1">of</span> LOC <span class="bound">a</span> <span class="main">⇒</span> True <span class="main">|</span> ENV <span class="bound">a</span> <span class="main">⇒</span> False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">==</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">e</span> <span class="keyword1">of</span> LOC <span class="bound">a</span> <span class="main">⇒</span> False <span class="main">|</span> ENV <span class="bound">a</span> <span class="main">⇒</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_rem_s</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">==</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> LOC <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span> <span class="main">|</span> ENV <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard simplification lemmas›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> loc_env_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"loc <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
  <span class="quoted"><span class="quoted">"env <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def env_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> loc_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"loc <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> LOC <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">|</span> ENV <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> loc_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"loc <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> LOC <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">|</span> ENV <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span><span class="main">@</span>loc <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> loc_unconc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"loc <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> loc <span class="free">a</span> <span class="main">@</span> loc <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> env_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> LOC <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> ENV <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> env_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"env <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> LOC <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> ENV <span class="bound">e</span> <span class="main">⇒</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> env <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> env_unconc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> env <span class="free">a</span> <span class="main">@</span> env <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following simplification lemmas are for converting between paths of the multiset- and loc/env-semantics›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> le_rem_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"le_rem_s <span class="main">(</span>LOC <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
  <span class="quoted"><span class="quoted">"le_rem_s <span class="main">(</span>ENV <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> le_rem_s_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command">lemma</span></span> le_rem_id_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"le_rem_s<span class="main">∘</span>LOC <span class="main">=</span> id"</span></span> 
  <span class="quoted"><span class="quoted">"le_rem_s<span class="main">∘</span>ENV <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> le_rem_id_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"map le_rem_s <span class="main">(</span>map LOC <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span> 
  <span class="quoted"><span class="quoted">"map le_rem_s <span class="main">(</span>map ENV <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> env_map_env <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env <span class="main">(</span>map ENV <span class="free">w</span><span class="main">)</span> <span class="main">=</span> map ENV <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> env_map_loc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"env <span class="main">(</span>map LOC <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> loc_map_env <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"loc <span class="main">(</span>map ENV <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> loc_map_loc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"loc <span class="main">(</span>map LOC <span class="free">w</span><span class="main">)</span> <span class="main">=</span> map LOC <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> loc_def<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Definition of the loc/env-semantics"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> el_conf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span> multiset<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">gtrp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> el_conf<span class="main">,</span><span class="tfree">'l</span><span class="main">)</span> LTS <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> el_conf<span class="main">,</span><span class="tfree">'l</span> el_step<span class="main">)</span> LTS"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  gtrp_loc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>LOC <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrp</span> <span class="free">S</span>"</span></span>
  <span class="main">|</span> gtrp_env<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>add_mset <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span>add_mset <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">S</span>
               <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">,</span>add_mset <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>ENV <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">,</span>add_mset <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrp</span> <span class="free">S</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Relation between multiset- and loc/env-semantics"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gtrp2gtr_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>gtrp <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span>le_rem_s <span class="free">e</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">T</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gtrp.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrI_s<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">e</span> <span class="skolem">ss</span> <span class="skolem">ss'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span>add_mset <span class="free">s</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">ss'</span><span class="main">,</span>add_mset <span class="free">s</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="skolem">ss</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span>add_mset <span class="skolem">ss'</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> gtr <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrI_s<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">s</span> <span class="main">(</span>add_mset <span class="skolem">ss</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> add_mset <span class="free">s</span> <span class="main">(</span>add_mset <span class="skolem">ss'</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> gtr <span class="free">T</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> gtrp2gtr<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">T</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span>map le_rem_s <span class="free">w</span><span class="main">,</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">T</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gtrp2gtr_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> env_no_step<span class="main">)</span> gtr2gtrp_s<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main">,</span> <span class="operator">case_names</span> gtrp<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s'</span> <span class="bound">ce'</span> <span class="bound">ee</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">;</span> <span class="free">e</span><span class="main">=</span>le_rem_s <span class="bound">ee</span><span class="main">;</span> 
                          <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">ee</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>gtrp <span class="free">gtrs</span><span class="main">⟧</span> 
                         <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> A 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gtr_step_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>loc <span class="skolem">s'</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LOC <span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>gtrp <span class="free">gtrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp_loc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> loc<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> CASE<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>other <span class="skolem">cc</span> <span class="skolem">ss</span> <span class="skolem">ss'</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> env_no_step_s<span class="main">[</span><span class="operator">OF</span> other<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> CE'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce'</span><span class="main">=</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="skolem">cc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> other<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span>add_mset <span class="free">s</span> <span class="skolem">cc</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">ss'</span><span class="main">,</span>add_mset <span class="free">s</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">cc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">gtrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gtrp_env<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> other<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> ENV <span class="free">e</span><span class="main">,</span> <span class="free">s</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">ss'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">cc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> gtrp <span class="free">gtrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> other CE'FMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">ss'</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">cc</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> CASE<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> env_no_step<span class="main">)</span> gtr2gtrp<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main">,</span> <span class="operator">case_names</span> gtrp<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">gtrs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s'</span> <span class="bound">ce'</span> <span class="bound">ww</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">;</span> <span class="free">w</span><span class="main">=</span>map le_rem_s <span class="bound">ww</span><span class="main">;</span> 
                           <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">ww</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">gtrs</span><span class="main">)</span><span class="main">⟧</span> 
                          <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">gtrs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span> <span class="bound">ce'</span> <span class="bound">ww</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span>add_mset <span class="bound">s'</span> <span class="bound">ce'</span> <span class="main">∧</span> <span class="free">w</span><span class="main">=</span>map le_rem_s <span class="bound">ww</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">ww</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">gtrs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="skolem">s</span> <span class="skolem">c</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">∈</span>gtr <span class="free">gtrs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ch</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtr <span class="free">gtrs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> gtr2gtrp_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="skolem"><span class="skolem">ee</span></span> <span class="keyword2"><span class="keyword">where</span></span> FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> add_mset <span class="skolem">sh</span>  <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> le_rem_s <span class="skolem">ee</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">ceh</span><span class="main">)</span> <span class="main">∈</span> gtrp <span class="free">gtrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> FS<span class="main">(</span>1<span class="main">)</span> SPLIT<span class="main">(</span>2<span class="main">)</span> Cons.hyps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span>add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span>map le_rem_s <span class="skolem">ww</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span><span class="skolem">ww</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">gtrs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">gtrs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">=</span> map le_rem_s <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> A CASE <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Invariants"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gtrp_preserve_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>gtrp <span class="free">T</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> PRES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span> <span class="bound">s'</span> <span class="bound">c'</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span><span class="main">⟧</span> 
                            <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> gtr_preserve_s<span class="main">[</span><span class="operator">OF</span> gtrp2gtr_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">,</span> <span class="operator">OF</span> INIT<span class="main">]</span> PRES <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gtrp_preserve<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>gtrp <span class="free">T</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> PRES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span> <span class="bound">s'</span> <span class="bound">c'</span> <span class="bound">e</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">T</span><span class="main">⟧</span> 
                            <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> gtr_preserve<span class="main">[</span><span class="operator">OF</span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span><span class="main">,</span> <span class="operator">OF</span> INIT<span class="main">]</span> PRES <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Flowgraph">
<div class="head">
<h1>Theory Flowgraph</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Flowgraphs
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Flowgraphs"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Flowgraph
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Misc.html">Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Flowgraph}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We use a flowgraph-based program model that extends the one we used previously \cite{LM07}. 
  A program is represented as an edge annotated graph and a set of procedures. The nodes of the graph are partitioned by the procedures, i.e. every node belongs to exactly one procedure. There are no edges
  between nodes of different procedures. Every procedure has a distinguished entry and return node and a set of monitors it synchronizes on. Additionally, the program has a distinguished {\em main} procedure.
  The edges are annotated with statements. A statement is either a base statement, a procedure call or a thread creation (spawn). Procedure calls and thread creations refer to the called procedure or to the initial procedure
  of the spawned thread, respectively.

  We require that the main procedure and any initial procedure of a spawned thread does not to synchronize on any monitors. This avoids that spawning of a procedure together with entering a monitor is available in our 
  model as an atomic step, which would be an unrealistic assumption for practical problems. Technically, our model would become strictly more powerful without this assumption.


  If we allowed this, our model would become strictly more powerful, 
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> edgeAnnot <span class="main">=</span> Base <span class="tfree"><span class="quoted"><span class="tfree">'ba</span></span></span> <span class="main">|</span> Call <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span> <span class="main">|</span> Spawn <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> edge <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> edgeAnnot <span class="main">×</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> flowgraph_rec <span class="main">=</span>
  edges <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> edge set"</span></span> <span class="comment1">― ‹Set of annotated edges›</span>
  main <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span>"</span></span> <span class="comment1">― ‹Main procedure›</span>
  entry <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="comment1">― ‹Maps a procedure to its entry point›</span>
  return <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="comment1">― ‹Maps a procedure to its return point›</span>
  mon <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'m</span> set"</span></span> <span class="comment1">― ‹Maps procedures to the set of monitors they allocate›</span>
  proc_of <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'p</span>"</span></span> <span class="comment1">― ‹Maps a node to the procedure it is contained in›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">initialproc</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">=</span>main <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> main_is_initial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> initialproc_def<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> flowgraph <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>
  <span class="comment1">(* Type annotation unnecessary, but perhaps makes it more readable
     for the unaware reader ;) *)</span>
  <span class="comment1">― ‹Edges are inside procedures only›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> edges_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">⟹</span> proc_of <span class="free">fg</span> <span class="free">u</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="free">v</span>"</span></span> 
  <span class="comment1">― ‹The entry point of a procedure must be in that procedure›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> entry_valid<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
  <span class="comment1">― ‹The return point of a procedure must be in that procedure›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> return_valid<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">(</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
  <span class="comment1">― ‹Initial procedures do not synchronize on any monitors›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial_no_mon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="free">p</span> <span class="main">⟹</span> mon <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Basic properties"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> spawn_no_mon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> Spawn <span class="free">p</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span> <span class="main">⟹</span> mon <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> initial_no_mon <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> initialproc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> main_no_mon<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> initial_no_mon <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> initialproc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> entry_return_same_proc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"entry <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> return <span class="free">fg</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="main">(</span>return <span class="free">fg</span> <span class="free">p'</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> entry_entry_same_proc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"entry <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> entry <span class="free">fg</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p'</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> return_return_same_proc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"return <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> return <span class="free">fg</span> <span class="free">p'</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">=</span><span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">(</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p'</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Extra assumptions for flowgraphs"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:Flowgraph:extra_asm}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In order to simplify the definition of our restricted schedules (cf. Section~\ref{thy:Normalization}), we make some extra constraints on flowgraphs. 
  Note that these are no real restrictions, as we can always rewrite flowgraphs to match these constraints, preserving the set of conflicts. We leave it to future work to consider such a rewriting formally. 

  The background of this restrictions is that we want to start an execution of a thread with a procedure call that never returns. This will allow easier technical treatment in Section~\ref{thy:Normalization}. Here we enforce this
  semantic restrictions by syntactic properties of the flowgraph.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The return node of a procedure is called {\em isolated}, if it has no incoming edges and is different from the entry node. A procedure with an isolated return node will never return. 
  See Section~\ref{sec:Normalization:eflowgraph} for a proof of this.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">isolated_ret</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">==</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="bound">l</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">l</span><span class="main">,</span>return <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span> <span class="main">∧</span> entry <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> return <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following syntactic restrictions guarantee that each thread's execution starts with a non-returning call. See Section~\ref{sec:Normalization:eflowgraph} for a proof of this.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> eflowgraph <span class="main">=</span> flowgraph <span class="main">+</span>
  <span class="comment1">― ‹Initial procedure's entry node isn't equal to its return node›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial_no_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="free">p</span> <span class="main">⟹</span> entry <span class="free">fg</span> <span class="free">p</span> <span class="main">≠</span> return <span class="free">fg</span> <span class="free">p</span>"</span></span> 
  <span class="comment1">― ‹The only outgoing edges of initial procedures' entry nodes are call edges to procedures with isolated return node›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> initial_call_no_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>initialproc <span class="free">fg</span> <span class="free">p</span><span class="main">;</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">,</span><span class="free">l</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> <span class="free">l</span><span class="main">=</span>Call <span class="bound">p'</span> <span class="main">∧</span> isolated_ret <span class="free">fg</span> <span class="bound">p'</span>"</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Example Flowgraph›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:Flowgraph:ex_flowgraph}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section contains a check that there exists a (non-trivial) flowgraph, i.e. that the assumptions made in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>flowgraph›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eflowgraph›</span></span></span></span> 
  locales are consistent and have at least one non-trivial model.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">example_fg</span> <span class="main">==</span> <span class="main">⦇</span> 
    edges <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span>Call <span class="main">1</span><span class="main">,</span><span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span>Spawn <span class="main">0</span><span class="main">,</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
             <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span>Call <span class="main">0</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> 
    main <span class="main">=</span> <span class="main">0</span><span class="main">,</span> 
    entry <span class="main">=</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span> 
    return <span class="main">=</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> 
    mon <span class="main">=</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">,</span> 
    proc_of<span class="main">=</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_eflowgraph<span class="main">:</span> <span class="quoted"><span class="quoted">"eflowgraph example_fg"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> example_fg_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initialproc_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initialproc_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initialproc_def isolated_ret_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Semantics">
<div class="head">
<h1>Theory Semantics</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Operational Semantics
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Operational Semantics"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Flowgraph.html">Flowgraph</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <a href="LTS.html">LTS</a> <a href="Interleave.html">Interleave</a> <a href="ThreadTracking.html">ThreadTracking</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Semantics}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Configurations and labels"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The state of a single thread is described by a stack of control nodes. The top node is the current control node and the nodes deeper in the stack are stored return addresses. 
  The configuration of a whole program is described by a multiset of stacks. 

  Note that we model stacks as lists here, the first element being the top element.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'n</span> conf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span> list<span class="main">)</span> multiset"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A step is labeled according to the executed edge. Additionally, we introduce a label for a procedure return step, that has no corresponding edge. 
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> label <span class="main">=</span> LBase <span class="tfree"><span class="quoted"><span class="tfree">'ba</span></span></span> <span class="main">|</span> LCall <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span> <span class="main">|</span> LRet <span class="main">|</span> LSpawn <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monitors›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following defines the monitors of nodes, stacks, configurations, step labels and paths (sequences of step labels)
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="comment1">― ‹The monitors of a node are the monitors the procedure of the node synchronizes on›</span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_n</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">==</span> mon <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>proc_of <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="comment1">― ‹The monitors of a stack are the monitors of all its nodes›</span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_s</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">{</span> mon_n <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">n</span> <span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="comment1">― ‹The monitors of a configuration are the monitors of all its stacks›</span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_c</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">{</span> mon_s <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">s</span> <span class="main">|</span> <span class="bound">s</span> <span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span>"</span></span>

<span class="comment1">― ‹The monitors of a step label are the monitors of procedures that are called by this step›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mon_e</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> label <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_e</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>LCall <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span> mon <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">p</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mon_e_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="main">(</span>LBase <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="main">(</span>LCall <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="main">(</span>LRet<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="main">(</span>LSpawn <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_e_def<span class="main">)</span>

<span class="comment1">― ‹The monitors of a path are the monitors of all procedures that are called on the path›</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mon_w</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">{</span> mon_e <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">e</span> <span class="main">|</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mon_s_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="main">`</span> proc_of <span class="free">fg</span> <span class="main">`</span> set <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def mon_n_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_c_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="main">`</span> set_mset <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def set_mset_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_w_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">==</span> <span class="main">⋃</span> <span class="main">(</span>mon_e <span class="free">fg</span> <span class="main">`</span> set <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_w_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_reflection<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_sI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">n</span><span class="main">∈</span>set <span class="free">s</span><span class="main">;</span> <span class="free">m</span><span class="main">∈</span>mon_n <span class="free">fg</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">∈</span>mon_s <span class="free">fg</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_sD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">∈</span>mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">n</span><span class="main">∈</span>set <span class="free">s</span><span class="main">.</span> <span class="free">m</span><span class="main">∈</span>mon_n <span class="free">fg</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_n_same_proc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="free">n</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="free">n'</span> <span class="main">⟹</span> mon_n <span class="free">fg</span> <span class="free">n</span> <span class="main">=</span> mon_n <span class="free">fg</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_s_same_proc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="main">`</span> set <span class="free">s</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="main">`</span> set <span class="free">s'</span> <span class="main">⟹</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">=</span> mon_s <span class="free">fg</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_alt<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> mon_of_entry<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> entry_valid<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> mon_of_ret<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="main">(</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_valid<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_c_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">=</span> mon_s <span class="free">fg</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_s_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">=</span> mon_n <span class="free">fg</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_s_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_c_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">{#}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_s_unconc<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="main">(</span><span class="free">a</span><span class="main">@</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> mon_s <span class="free">fg</span> <span class="free">a</span> <span class="main">∪</span> mon_s <span class="free">fg</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_s_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">=</span> mon_n <span class="free">fg</span> <span class="free">a</span> <span class="main">∪</span> mon_s <span class="free">fg</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mon_s_unconc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">a</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_c_union_conc<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="free">a</span> <span class="main">∪</span> mon_c <span class="free">fg</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_c_add_mset_unconc<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> mon_s <span class="free">fg</span> <span class="free">x</span> <span class="main">∪</span> mon_c <span class="free">fg</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> mon_c_unconc <span class="main">=</span> mon_c_union_conc mon_c_add_mset_unconc

<span class="keyword1"><span class="command">lemma</span></span> mon_cI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">∈#</span> <span class="free">c</span><span class="main">;</span> <span class="free">m</span><span class="main">∈</span>mon_s <span class="free">fg</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">∈</span>mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_cD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span><span class="main">∈</span>mon_c <span class="free">fg</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">m</span><span class="main">∈</span>mon_s <span class="free">fg</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_s_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">s</span> <span class="main">⊆</span> set <span class="free">s'</span> <span class="main">⟹</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_s_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_c_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">⊆#</span><span class="free">c'</span> <span class="main">⟹</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_subset_eqD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_w_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_w_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_w_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> mon_e <span class="free">fg</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_w_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_w_unconc<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">(</span><span class="free">wa</span><span class="main">@</span><span class="free">wb</span><span class="main">)</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="free">wa</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_w_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_w_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mon_w_unconc<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> wa<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">e</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_w_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≼</span><span class="free">w'</span> <span class="main">⟹</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">⊆</span> mon_w <span class="free">fg</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Valid configurations›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:Semantics:validity}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call a configuration {\em valid} if each monitor is owned by at most one thread.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">==</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">{#</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟶</span> mon_s <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">s</span> <span class="main">∩</span> mon_s <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="bound">s'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_empty<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">{#}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_single<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> valid_def subset_mset_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_split1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">c'</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c</span> <span class="main">∧</span> valid <span class="free">fg</span> <span class="free">c'</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_le_incr_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mon_cD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="improper">s</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="improper">sa</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">c</span><span class="main">+</span><span class="free">c'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> valid_split2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">fg</span> <span class="free">c</span><span class="main">;</span> valid <span class="free">fg</span> <span class="free">c'</span><span class="main">;</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mset_2dist2_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mon_cI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_union_conc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">c'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>valid <span class="free">fg</span> <span class="free">c</span> <span class="main">∧</span> valid <span class="free">fg</span> <span class="free">c'</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_split1 valid_split2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_mset_conc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">x</span> <span class="free">c'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>valid <span class="free">fg</span> <span class="free">c'</span> <span class="main">∧</span> mon_s <span class="free">fg</span> <span class="free">x</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> valid_union_conc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mon_s_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> valid_unconc <span class="main">=</span> valid_union_conc valid_add_mset_conc

<span class="keyword1"><span class="command">lemma</span></span> valid_no_mon<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> mon_c_mono<span class="main">[</span><span class="operator">OF</span> B<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">s'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Configurations at control points›</span></span>

<span class="comment1">― ‹A stack is {\em at} <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> if its top node is from the set <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">atU_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> set <span class="main">⇒</span> <span class="tfree">'n</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atU_s</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">[]</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atU_s</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atU_s_decomp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atU_s <span class="free">U</span> <span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>atU_s <span class="free">U</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">s</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> atU_s <span class="free">U</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">― ‹A configuration is {\em at} <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> if it contains a stack that is at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atU</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">==</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> atU_s <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atU_fmt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>atU <span class="free">U</span> <span class="free">c</span><span class="main">;</span> <span class="main">!!</span><span class="bound">ui</span> <span class="bound">r</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">ui</span><span class="main">#</span><span class="bound">r</span> <span class="main">∈#</span> <span class="free">c</span><span class="main">;</span> <span class="bound">ui</span><span class="main">∈</span><span class="free">U</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> atU_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> atU_union_cases<span class="main">[</span><span class="operator">case_names</span> left right<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    atU <span class="free">U</span> <span class="main">(</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span><span class="main">;</span> 
    atU <span class="free">U</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    atU <span class="free">U</span> <span class="free">c2</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atU_def<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atU_add<span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="free">c</span> <span class="main">⟹</span> atU <span class="free">U</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span> <span class="main">∧</span> atU <span class="free">U</span> <span class="main">(</span><span class="free">ce</span><span class="main">+</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atU_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atU_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>atU <span class="free">U</span> <span class="free">c1</span> <span class="main">∨</span> atU <span class="free">U</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atU_add <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> atU_union_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atU_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atU <span class="free">U</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atU_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> atU_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">=</span> atU_s <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atU_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> atU_single_top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">{#</span><span class="free">u</span><span class="main">#</span><span class="free">r</span><span class="main">#}</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span><span class="main">∈</span><span class="free">U</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="comment1">(* This is also done by atU_single, atU_s.simps *)</span>

<span class="keyword1"><span class="command">lemma</span></span> atU_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="free">c</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>atU_s <span class="free">U</span> <span class="free">c</span> <span class="main">∨</span> atU <span class="free">U</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">]</span> atU_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atU_xchange_stack<span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">r</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">r'</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹A configuration is {\em simultaneously at} <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">V</span></span><span class="antiquote">}</span></span> if it contains a stack at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> and another one at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">V</span></span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">atUV</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">==</span> <span class="main">∃</span><span class="bound">su</span> <span class="bound">sv</span><span class="main">.</span> <span class="main">{#</span><span class="bound">su</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="bound">sv</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> atU_s <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="bound">su</span> <span class="main">∧</span> atU_s <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">sv</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atUV_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atUV <span class="free">U</span> <span class="free">V</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atUV_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> atUV_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>atUV <span class="free">U</span> <span class="free">V</span> <span class="main">{#</span><span class="free">s</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atUV_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atUV_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span>
    <span class="main">(</span>atUV <span class="free">U</span> <span class="free">V</span> <span class="free">c1</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span>atUV <span class="free">U</span> <span class="free">V</span> <span class="free">c2</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span>atU <span class="free">U</span> <span class="free">c1</span> <span class="main">∧</span> atU <span class="free">V</span> <span class="free">c2</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span>atU <span class="free">V</span> <span class="free">c1</span> <span class="main">∧</span> atU <span class="free">U</span> <span class="free">c2</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> atUV_def atU_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_2dist2_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mset_le_incr_right <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_le_mono_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> union_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_le_mono_add_single<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> atUV_add_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span>add_mset <span class="free">c</span> <span class="free">c2</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span>
    <span class="main">(</span>atUV <span class="free">U</span> <span class="free">V</span> <span class="free">c2</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span>atU <span class="free">U</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span> <span class="main">∧</span> atU <span class="free">V</span> <span class="free">c2</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span>atU <span class="free">V</span> <span class="main">{#</span><span class="free">c</span><span class="main">#}</span> <span class="main">∧</span> atU <span class="free">U</span> <span class="free">c2</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> atUV_union
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atUV_union_cases<span class="main">[</span><span class="operator">case_names</span> left right lr rl<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span><span class="main">;</span> 
    atUV <span class="free">U</span> <span class="free">V</span> <span class="free">c1</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    atUV <span class="free">U</span> <span class="free">V</span> <span class="free">c2</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">⟦</span>atU <span class="free">U</span> <span class="free">c1</span><span class="main">;</span> atU <span class="free">V</span> <span class="free">c2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">⟦</span>atU <span class="free">V</span> <span class="free">c1</span><span class="main">;</span> atU <span class="free">U</span> <span class="free">c2</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operational semantics›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Semantic reference point"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define our semantic reference point. We assess correctness and completeness of analyses relative to this reference point.›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">refpoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> 
                 <span class="main">(</span><span class="tfree">'n</span> conf <span class="main">×</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> label <span class="main">×</span> <span class="tfree">'n</span> conf<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹A base edge transforms the top node of one stack and leaves the other stacks untouched.›</span>
  refpoint_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Base <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">#}</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>LBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">refpoint</span> <span class="free">fg</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹A call edge transforms the top node of a stack and then pushes the entry node of the called procedure onto that stack. 
      It can only be executed if all monitors the called procedure synchronizes on are available. Reentrant monitors are modeled here by
      checking availability of monitors just against the other stacks, not against the stack of the thread that executes the call. The other stacks are left untouched.›</span>
  refpoint_call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">#}</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">;</span> 
                    mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>LCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> add_mset <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">refpoint</span> <span class="free">fg</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹A return step pops a return node from a stack. There is no corresponding flowgraph edge for a return step. The other stacks are left untouched.›</span>
  refpoint_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span>return <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">#}</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="main">(</span>return <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>LRet<span class="main">,</span><span class="main">(</span>add_mset <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">refpoint</span> <span class="free">fg</span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹A spawn edge transforms the top node of a stack and adds a new stack to the environment, with the entry node of the spawned procedure at the top and no stored return addresses. The other stacks are also left untouched.›</span>
  refpoint_spawn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Spawn <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>LSpawn <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> add_mset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>add_mset <span class="main">[</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">refpoint</span> <span class="free">fg</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Instead of working directly with the reference point semantics, we define the operational semantics of flowgraphs by describing how a single stack is transformed in a context of environment threads, 
  and then use the theory developed in Section~\ref{thy:ThreadTracking} to derive an interleaving semantics. 
  Note that this semantics is also defined for invalid configurations (cf. Section~\ref{sec:Semantics:validity}). In Section~\ref{sec:Semantics:valid_preserve} we will show that it preserves validity
  of a configuration, and in Section~\ref{sec:Semantics: refpoint_eq} we show that it is equivalent 
  to the reference point semantics on valid configurations.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">trss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> 
             <span class="main">(</span><span class="main">(</span><span class="tfree">'n</span> list <span class="main">*</span> <span class="tfree">'n</span> conf<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> label <span class="main">*</span> <span class="main">(</span><span class="tfree">'n</span> list <span class="main">*</span> <span class="tfree">'n</span> conf<span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    trss_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Base <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">⟧</span> <span class="main">⟹</span> 
      <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span> LBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> <span class="free">trss</span> <span class="free">fg</span>"</span></span>
  <span class="main">|</span> trss_call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>LCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">trss</span> <span class="free">fg</span>"</span></span>
  <span class="main">|</span> trss_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>return <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>LRet<span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">trss</span> <span class="free">fg</span>"</span></span>
  <span class="main">|</span> trss_spawn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Spawn <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>LSpawn <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>add_mset <span class="main">[</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">trss</span> <span class="free">fg</span>"</span></span>

<span class="comment1">(* Not needed
lemma trss_base': "⟦(u,Base a,v)∈edges fg; s=u#r; s'=v#r; e=LBase a⟧ ⟹ ((s,c), e, (s',c) ) ∈ trss fg"
  by (simp add: trss_base)
lemma trss_call': "⟦(u,Call p,v)∈edges fg; mon fg p ∩ mon_c fg c = {}; s=u#r; e=LCall p; s'=(entry fg p)#v#r⟧ ⟹ ((s,c),e, (s',c)) ∈ trss fg"
  by (simp add: trss_call)
lemma trss_ret': "⟦ s=(return fg p)#r; e=LRet ⟧ ⟹ ((s,c),e,(r,c)) ∈ trss fg"
  by (simp add: trss_ret)
lemma trss_spawn': "⟦ (u,Spawn p,v)∈edges fg; s=u#r; e=LSpawn p; s'=v#r; c'={#[entry fg p]#}+c⟧ ⟹ ((s,c),e,(s',c')) ∈ trss fg"
  by (simp add: trss_spawn)
*)</span>

<span class="comment1">― ‹The interleaving semantics is generated using the general techniques from Section~\ref{thy:ThreadTracking}›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">==</span> gtr <span class="main">(</span>trss <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹We also generate the loc/env-semantics›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trp</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">==</span> gtrp <span class="main">(</span>trss <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Basic properties"</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Validity"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span><span class="quoted"><span class="plain_text">‹\label{sec:Semantics:valid_preserve}›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_valid_preserve_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc mon_c_unconc<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mon_n_same_proc edges_part<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_valid_preserve<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s'</span><span class="main">#}</span><span class="main">+</span><span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_valid_preserve_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> tr_valid_preserve_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span><span class="main">;</span> valid <span class="free">fg</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gtr_preserve_s<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"valid <span class="free"><span class="free"><span class="free">fg</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_valid_preserve_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> tr_valid_preserve<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> valid <span class="free">fg</span> <span class="free">c</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gtr_preserve<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"valid <span class="free"><span class="free"><span class="free">fg</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_valid_preserve_s<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trp_valid_preserve_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trp <span class="free">fg</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gtrp_preserve_s<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"valid <span class="free"><span class="free"><span class="free">fg</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_valid_preserve_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trp_valid_preserve<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gtrp_preserve<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"valid <span class="free"><span class="free"><span class="free">fg</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_valid_preserve_s<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Equivalence to reference point"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:Semantics: refpoint_eq}›</span></span>
<span class="comment1">― ‹The equivalence between the semantics that we derived using the techniques from Section~\ref{thy:ThreadTracking} and the semantic reference point is shown nearly automatically.›</span>
<span class="keyword1"><span class="command">lemma</span></span> refpoint_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>refpoint <span class="free">fg</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> refpoint.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrI_s trss.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc add_mset_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> gtrE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refpoint.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> add_mset_commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> refpoint_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>refpoint <span class="free">fg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>refpoint <span class="free">fg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refpoint_eq_s tr_valid_preserve_s<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>refpoint <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refpoint_eq_s tr_valid_preserve_s<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>refpoint <span class="free">fg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Case distinctions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_c_cases_s<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> no_spawn spawn<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> 
    <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">e</span><span class="main">=</span>LSpawn <span class="bound">p</span><span class="main">;</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> 
               hd <span class="free">s</span><span class="main">=</span><span class="bound">u</span><span class="main">;</span> hd <span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">;</span> <span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span> entry <span class="free">fg</span> <span class="bound">p</span> <span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trss_c_fmt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="bound">csp</span><span class="main">=</span><span class="main">{#}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">e</span><span class="main">=</span>LSpawn <span class="bound">p</span> <span class="main">∧</span> <span class="bound">csp</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span> entry <span class="free">fg</span> <span class="bound">p</span> <span class="main">]</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss_c_cases_s<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_c'_split_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span><span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span><span class="main">;</span> mon_c <span class="free">fg</span> <span class="bound">csp</span><span class="main">=</span><span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trss_c_cases_s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#}</span><span class="main">+</span><span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_c_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> c_case<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="bound">c</span><span class="main">;</span> <span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="bound">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> 
                                               <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> 
                                               initialproc <span class="free">fg</span> <span class="bound">p</span><span class="main">⟧</span> 
            <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">note</span></span> A<span class="main">=</span>this 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#}</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">csp</span>
    <span class="keyword3"><span class="command">assume</span></span> C'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> CSPFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> SPLIT1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trss_c_cases_s<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> C'FMT CSPFMT IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> EFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LSpawn <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> C'FMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">)</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">from</span></span> EFMT SPLIT1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="skolem">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CSPFMT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> initialproc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> mset_un_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> c_of_initial_no_mon<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">csp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> A initial_no_mon<span class="main">)</span>
  
  <span class="comment1">(* WARNING: Don't declare this [simp], as c=c' will cause a simplifier loop *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_c_no_mon_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> A 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule_tac</span> trss_c_cases_s<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="free">c</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> EFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">=</span>LSpawn <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> EFMT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>Spawn <span class="skolem">p</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> spawn_no_mon <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> C'FMT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
        
  <span class="comment1">(* WARNING: Don't declare this [simp], as c=c' will cause a simplifier loop *)</span>
  <span class="comment1">(* FIXME: Dirty proof, not very robust *)</span>
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_c_no_mon<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss_c_cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">csp</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>mon_c <span class="free">fg</span> <span class="skolem">csp</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈#</span> <span class="skolem">csp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>mon_s <span class="free">fg</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_c_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">csp</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>Spawn <span class="skolem">p</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_spawn_no_mon_step<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LSpawn <span class="free">p</span><span class="main">,</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟹</span> mon <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trss_no_empty_s<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trss_no_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">s'</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> A 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">s</span><span class="main">=</span><span class="main">[]</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">s'</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> trs_step_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> NO_SPAWN SPAWN<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A_NO_SPAWN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span> <span class="bound">s'</span> <span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> 
      <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">;</span> <span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_SPAWN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">ce</span> <span class="bound">s'</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span>LSpawn <span class="bound">p</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> 
      <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">;</span> 
      <span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">;</span> 
      <span class="free">e</span><span class="main">=</span>LSpawn <span class="bound">p</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule_tac</span> gtr_find_thread<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">ce</span> <span class="skolem">s'</span> <span class="skolem">ce'</span> 
    <span class="keyword3"><span class="command">assume</span></span> FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> add_mset <span class="skolem">s</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss_c_cases_s<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> no_spawn <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> FMT B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> A_NO_SPAWN<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>spawn <span class="skolem">p</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> FMT B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> A_SPAWN<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Advanced properties"</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Stack composition / decomposition"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trss_stack_comp_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trss_stack_comp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">from</span></span> trss_stack_comp_s<span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sh</span> <span class="main">@</span> <span class="free">r</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_stack_decomp_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> <span class="free">s</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">sp'</span><span class="main">.</span> <span class="free">s'</span><span class="main">=</span><span class="bound">sp'</span><span class="main">@</span><span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="bound">sp'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trss_find_return<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
                  <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="comment1">― ‹If <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="main">[]</span>"</span><span class="antiquote">}</span></span>, the proposition follows trivially›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹For <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="main">[]</span>"</span><span class="antiquote">}</span></span>, we use induction by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> IM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> <span class="bound">s</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">ch</span><span class="main">.</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LRet"</span></span>
      <span class="keyword1"><span class="command">with</span></span> SPLIT1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> EDGE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">@</span><span class="free">r</span><span class="main">=</span>return <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">sh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> SHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span>return <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">ss</span><span class="main">@</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> CC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> SHFMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span><span class="main">=</span><span class="bound">ss</span><span class="main">@</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> CC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">=</span><span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> CASE SHFMT EDGE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">=</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">@</span><span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_ret<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SPLIT2 SHFMT CC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span><span class="main">=</span><span class="bound">ss</span><span class="main">@</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">≠</span>LRet"</span></span>
      <span class="keyword1"><span class="command">with</span></span> SPLIT1 IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span><span class="main">=</span><span class="bound">ss</span><span class="main">@</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_Cons_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> <span class="skolem">sh</span><span class="main">=</span><span class="bound">ss</span><span class="main">@</span><span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">ss</span><span class="main">@</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="free">r</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this CASE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="skolem"><span class="skolem">ch'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">wa</span><span class="main">@</span><span class="skolem">wb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ch'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="skolem">ch'</span><span class="main">)</span><span class="main">,</span><span class="skolem">wb</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CASE SPLIT1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">@</span><span class="free">r</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> trss_stack_decomp_s<span class="main">[</span><span class="operator">OF</span> this IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ss</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> IHAPP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ch'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> trcl.cons<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">=</span><span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">@</span><span class="skolem">wb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> IM<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(* TODO: Try backward induction proof … is this simpler ? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> trss_return_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">#</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
    <span class="main">!!</span> <span class="bound">s'</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">r'</span><span class="main">=</span><span class="bound">s'</span><span class="main">@</span><span class="bound">u'</span><span class="main">#</span><span class="bound">r</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">@</span><span class="main">[</span><span class="bound">u'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> 
    <span class="main">!!</span> <span class="bound">wa</span> <span class="bound">wb</span> <span class="bound">ch</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="bound">wb</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
                   <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ba</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LBase <span class="skolem">ba</span> <span class="main">∨</span> <span class="skolem">e</span><span class="main">=</span>LSpawn <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s'</span> <span class="skolem">u'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
      <span class="keyword1"><span class="command">with</span></span> E<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">@</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> CC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">wa</span> <span class="skolem">wb</span> <span class="skolem">ct</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
      <span class="keyword1"><span class="command">with</span></span> E<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">@</span><span class="skolem">wb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span> CC<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LRet"</span></span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LCall <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> SHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span>entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">w</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">st</span> <span class="skolem">ut</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
      <span class="keyword1"><span class="command">from</span></span> trss_stack_comp<span class="main">[</span><span class="operator">OF</span> CC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">(</span><span class="skolem">st</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ut</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> SHFMT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">,</span> <span class="main">(</span><span class="skolem">st</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ut</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> CC<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">wa</span> <span class="skolem">wb</span> <span class="skolem">ct</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
      <span class="keyword1"><span class="command">from</span></span> trss_stack_comp<span class="main">[</span><span class="operator">OF</span> CC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wa</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> SHFMT <span class="keyword1"><span class="command">have</span></span> PREPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> CC <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">wb</span><span class="main">≤</span>length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> CC<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> L<span class="main"><span class="main">,</span></span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s''</span> <span class="skolem">u''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CCC<span class="main">=</span>this <span class="keyword1"><span class="command">from</span></span> trcl_concat<span class="main">[</span><span class="operator">OF</span> PREPATH CCC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> CC<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s''</span><span class="main">@</span><span class="main">[</span><span class="skolem">u''</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> CCC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">wba</span> <span class="skolem">wbb</span> <span class="skolem">c''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CCC<span class="main">=</span>this <span class="keyword1"><span class="command">from</span></span> trcl_concat<span class="main">[</span><span class="operator">OF</span> PREPATH CCC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> CC<span class="main">(</span>1<span class="main">)</span> CCC<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">@</span><span class="skolem">wba</span><span class="main">)</span><span class="main">@</span><span class="skolem">wbb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">wa</span> <span class="main">@</span> <span class="skolem">wba</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">c''</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this CCC<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_find_call<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">v</span> <span class="bound">r'</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">r'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> <span class="bound">r'</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">rh</span> <span class="bound">ch</span> <span class="bound">p</span> <span class="bound">wa</span> <span class="bound">wb</span><span class="main">.</span> 
        <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="main">(</span>LCall <span class="bound">p</span><span class="main">)</span><span class="main">#</span><span class="bound">wb</span> <span class="main">∧</span> 
        proc_of <span class="free">fg</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="bound">rh</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">(</span><span class="bound">rh</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span>LCall <span class="bound">p</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">)</span><span class="main">#</span><span class="bound">r'</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">w</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">rh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">rh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">rh</span><span class="main">=</span><span class="bound">u</span><span class="main">#</span><span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> RHFMT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rh</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> edges_part<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">r'</span></span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">,</span> <span class="operator">OF</span> _ SPLIT1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="skolem"><span class="skolem">ct</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">wa</span> <span class="main">@</span> LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wb</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">rt</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">rt</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> entry <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span>  
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">wa</span> <span class="main">@</span> LCall <span class="skolem">p</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">wb</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">rh</span><span class="main">=</span><span class="bound">u</span><span class="main">#</span><span class="skolem">r'</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?case</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> trss.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SPLIT2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> <span class="comment1">― ‹Cases for base- and spawn edge are discharged automatically›</span>
      <span class="comment1">― ‹Case: call-edge›</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ca</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">vv</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> SPLIT1 SPLIT2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹Case: return edge›</span>
    <span class="keyword3"><span class="command">case</span></span> CC<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">ca</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rh</span><span class="main">=</span><span class="main">(</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">)</span><span class="main">#</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">#</span><span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">,</span> <span class="operator">OF</span> _ SPLIT1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="skolem"><span class="skolem">ct</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">wa</span> <span class="main">@</span> LCall <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">wb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wa</span><span class="main">,</span> <span class="skolem">rt</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">rt</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">q</span><span class="main">,</span> entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">,</span> <span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> RTFMT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rt</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PROC_OF_U<span class="main">:</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> edges_part<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> LENWA<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">wa</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> LENWA IHAPP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhh</span></span> <span class="skolem"><span class="skolem">chh</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">waa</span></span> <span class="skolem"><span class="skolem">wab</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      IHAPP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wa</span><span class="main">=</span><span class="skolem">waa</span><span class="main">@</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wab</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">waa</span><span class="main">,</span><span class="main">(</span><span class="skolem">rhh</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">rhh</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wab</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> IHAPP IHAPP' PROC_OF_U <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">=</span><span class="skolem">waa</span><span class="main">@</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="main">(</span><span class="skolem">wab</span><span class="main">@</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">wb</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="skolem">chh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wab</span><span class="main">@</span><span class="main">(</span>LCall <span class="skolem">q</span><span class="main">)</span><span class="main">#</span><span class="skolem">wb</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> IHAPP'<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">q</span><span class="main">,</span> entry <span class="free">fg</span> <span class="skolem">q</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ct</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> trss_stack_comp<span class="main">[</span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">,</span><span class="skolem">wb</span><span class="main">,</span><span class="main">(</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> CC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_ret<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP' CC
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹This lemma is better suited for application in soundness proofs of constraint systems than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] flowgraph.trss_find_call<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_find_call'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">#</span><span class="main">[</span><span class="free">u'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">uh</span> <span class="bound">ch</span> <span class="bound">wa</span> <span class="bound">wb</span><span class="main">.</span> <span class="main">⟦</span>
      <span class="free">w</span><span class="main">=</span><span class="bound">wa</span><span class="main">@</span><span class="main">(</span>LCall <span class="free">p</span><span class="main">)</span><span class="main">#</span><span class="bound">wb</span><span class="main">;</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="bound">uh</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">uh</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span>LCall <span class="free">p</span><span class="main">,</span><span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">)</span><span class="main">#</span><span class="main">[</span><span class="free">u'</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">uh</span><span class="main">,</span>Call <span class="free">p</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trss_find_call<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="keyword2"><span class="keyword">where</span></span> FC<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">wa</span> <span class="main">@</span> LCall <span class="free">p</span> <span class="main">#</span> <span class="skolem">wb</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">sp</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wa</span><span class="main">,</span> <span class="skolem">rh</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">rh</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> LCall <span class="free">p</span><span class="main">,</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">,</span> <span class="free">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">,</span> <span class="main">[</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> FC<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> ADD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rh</span><span class="main">=</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span>Call <span class="free">p</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> EX <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_bot_proc_const<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s'</span> <span class="bound">u'</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">@</span><span class="main">[</span><span class="bound">u'</span><span class="main">]</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> 
    <span class="main">⟹</span> proc_of <span class="free">fg</span> <span class="free">u</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="bound">u'</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">@</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ssh</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> SHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">ssh</span><span class="main">@</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_rev_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ssh</span></span> <span class="quoted"><span class="skolem">uh</span></span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">]</span> SPLIT1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="free">u</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="skolem">uh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> SPLIT2 SHFMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">uh</span> <span class="main">=</span> proc_of <span class="free">fg</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ssh</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edges_part<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Specialized version of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] flowgraph.trss_bot_proc_const<span class="antiquote">}</span></span>that comes in handy for precision proofs of constraint systems›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_er_path_proc_const<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">q</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trss_bot_proc_const<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"entry <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"return <span class="free">fg</span> <span class="free">q</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_2empty_to_2return<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> <span class="free">s</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">w'</span> <span class="bound">p</span><span class="main">.</span> <span class="free">w</span><span class="main">=</span><span class="bound">w'</span><span class="main">@</span><span class="main">[</span>LRet<span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="bound">w'</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> WD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">=</span><span class="skolem">w'</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_rev_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LRet"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SPLIT<span class="main">(</span>1<span class="main">)</span> WD <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> trss_2return_to_2empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">@</span><span class="main">[</span>LRet<span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">,</span>LRet<span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_cons <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Adding threads"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trss_env_increasing_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟹</span> <span class="free">c</span><span class="main">⊆#</span><span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> trss_env_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span><span class="main">⊆#</span><span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_env_increasing_s order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Conversion between environment and monitor restrictions"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> trss_mon_e_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟹</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> trss.cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_mon_w_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_mon_e_no_ctx <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trss_c_no_mon_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_modify_context_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">cn</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="bound">cn</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">cn</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> trss.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> trss_modify_context<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∀</span><span class="bound">cn</span><span class="main">.</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="bound">cn</span> <span class="main">=</span> <span class="main">{}</span> 
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
                 <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">cn</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cn</span>
    <span class="keyword3"><span class="command">assume</span></span> MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> trss_modify_context_s<span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> MON <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csph</span></span> <span class="keyword2"><span class="keyword">where</span></span> S1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="skolem">csph</span> <span class="main">+</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csph</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">cn</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">csph</span> <span class="main">+</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> MON <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> S1 S2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc mon_c_unconc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="bound">csp</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">cn</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="bound">csp</span> <span class="main">+</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_add_context_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc mon_c_unconc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trss_add_context<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> MM<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="skolem">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> trcl.cons<span class="main">[</span><span class="operator">OF</span> trss_add_context_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> MM<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> MM<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> trss_drop_context_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">∧</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> trss.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">ce</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trss_drop_context<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_c_fmt_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> CHFMT trss_drop_context_s SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="skolem">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CHFMT IHP<span class="main">(</span>1<span class="main">)</span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_xchange_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span><span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trss_drop_context_s<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> DC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">csp</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> trss_add_context_s<span class="main">[</span><span class="operator">OF</span> DC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> trss_xchange_context<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span><span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trss_drop_context<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> DC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">csp</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> trss_add_context<span class="main">[</span><span class="operator">OF</span> DC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_drop_all_context_s<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> dropped<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss_c_cases_s<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> no_spawn <span class="keyword1"><span class="command">with</span></span> trss_xchange_context_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> A C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>spawn <span class="skolem">p</span> <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> trss_xchange_context_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> A C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trss_drop_all_context<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">,</span> <span class="operator">case_names</span> dropped<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss_c_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>c_case <span class="skolem">csp</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> trss_xchange_context<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="skolem">csp</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">]</span> A C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tr_add_context_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span><span class="main">;</span> mon_e <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gtrE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrI_s <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_add_context_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tr_add_context<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> mon_w <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">ce</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">ce</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">ce</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">c'</span> <span class="skolem">w</span> <span class="skolem">c''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">from</span></span> tr_add_context_s<span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ce</span></span><span class="main">]</span> IHP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span> <span class="main">+</span> <span class="free">ce</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="free">ce</span><span class="main">)</span> <span class="main">∈</span> tr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c'</span> <span class="main">+</span> <span class="free">ce</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">c''</span> <span class="main">+</span> <span class="free">ce</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Normalization">
<div class="head">
<h1>Theory Normalization</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Normalized Paths
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Normalized Paths"</span></span>
<span class="keyword1"><span class="command">theory</span></span> Normalization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="ThreadTracking.html">ThreadTracking</a> <a href="Semantics.html">Semantics</a> <a href="ConsInterleave.html">ConsInterleave</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:Normalization}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The idea of normalized paths is to consider particular schedules only. While the original semantics allows a context switch to occur after every single step, we now define a semantics that allows context switches only before
  non-returning calls or after a thread has reached its final stack. We then show that this semantics is able to reach the same set of configurations as the original semantics.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Semantic properties of restricted flowgraphs"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:Normalization:eflowgraph}›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It makes the formalization smoother, if we assume that every thread's execution begins with a non-returning call. For this purpose, we defined syntactic restrictions on flowgraphs already 
  (cf. Section~\ref{sec:Flowgraph:extra_asm}). We now show that these restrictions have the desired semantic effect.›</span></span>  

<span class="comment1">― ‹Procedures with isolated return nodes will never return›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> iso_ret_no_ret<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⟦</span> 
    isolated_ret <span class="free">fg</span> <span class="free">p</span><span class="main">;</span> 
    proc_of <span class="free">fg</span> <span class="bound">u</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span> 
    <span class="bound">u</span> <span class="main">≠</span> return <span class="free">fg</span> <span class="free">p</span><span class="main">;</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SPLIT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> LRet <span class="keyword1"><span class="command">with</span></span> SPLIT1 IHP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> LBase <span class="keyword1"><span class="command">with</span></span> SPLIT1 IHP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">≠</span>return <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edges_part isolated_ret_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP SPLIT2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LSpawn <span class="skolem">q</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> SPLIT1 IHP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">≠</span>return <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edges_part isolated_ret_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP SPLIT2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LCall <span class="skolem">q</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> SPLIT1 IHP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">uh</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">uh</span><span class="main">≠</span>return <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> edges_part isolated_ret_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT2 <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> trss_return_cases<span class="main">[</span><span class="operator">OF</span> B<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">ct</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">w1</span><span class="main">@</span><span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w2</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="free">p'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> C<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> IHP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> C<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹The first step of an initial procedure is a call›</span>  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> initial_starts_with_call<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> initialproc <span class="free">fg</span> <span class="free">p</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p'</span><span class="main">.</span> <span class="free">e</span><span class="main">=</span>LCall <span class="bound">p'</span> <span class="main">∧</span> isolated_ret <span class="free">fg</span> <span class="bound">p'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> initial_call_no_ret initial_no_ret entry_return_same_proc<span class="main">)</span>

<span class="comment1">― ‹There are no same-level paths starting from the entry node of an initial procedure›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> no_sl_from_initial<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="free">p</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> initial_starts_with_call<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> CE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LCall <span class="skolem">p'</span>"</span></span> <span class="quoted"><span class="quoted">"isolated_ret <span class="free">fg</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span>entry <span class="free">fg</span> <span class="skolem">p'</span><span class="main">#</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p'</span><span class="main">#</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">ct</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">wa</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> trss_return_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wa'</span></span> <span class="skolem"><span class="skolem">p''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">wa'</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">p''</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_2empty_to_2return<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> iso_ret_no_ret<span class="main">[</span><span class="operator">OF</span> CE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ _ this<span class="main">]</span> CE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> isolated_ret_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="comment1">― ‹There are no same-level or returning paths starting from the entry node of an initial procedure›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> no_retsl_from_initial<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
             <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="free">p</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">r'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
             <span class="quoted"><span class="quoted">"length <span class="free">r'</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> trss_2empty_to_2return<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">=</span><span class="skolem">w'</span><span class="main">@</span><span class="main">[</span>LRet<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"entry <span class="free">fg</span> <span class="free">p</span> <span class="main">=</span> return <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_empty_cons entry_return_same_proc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>2<span class="main">)</span> initial_no_ret <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">from</span></span> no_sl_from_initial<span class="main">[</span><span class="operator">OF</span> this A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> B<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">rr</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span><span class="main">=</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> no_sl_from_initial<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> A<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definition of normalized paths"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In order to describe the restricted schedules, we define an operational semantics that performs an atomically scheduled sequence of steps in one step, called a {\em macrostep}. 
  Context switches may occur after macrosteps only. We call this the {\em normalized semantics} and a sequence of macrosteps a {\em normalized path}.  

  Since we ensured that every path starts with a non-returning call, we can define a macrostep as an initial call followed by a same-level path\footnote{Same-level paths are paths with balanced calls and returns. 
  The stack-level at the beginning of their execution is the same as at the end, and during the execution, the stack never falls below the initial level.} of the called procedure. This has the effect that context switches are
  either performed before a non-returning call (if the thread makes a further macrostep in the future) or after the thread has reached its final configuration. 

  As for the original semantics, we first define the normalized semantics on a single thread with a context and then use the theory developed in Section~\ref{thy:ThreadTracking} to derive interleaving semantics on multisets and 
  configurations with an explicit local thread (loc/env-semantics, cf. Section~\ref{sec:ThreadTracking:exp_local}). 
›</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">ntrs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> 
             <span class="main">(</span><span class="main">(</span><span class="tfree">'n</span> list <span class="main">×</span> <span class="tfree">'n</span> conf<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">)</span> label list <span class="main">×</span> <span class="main">(</span><span class="tfree">'n</span> list <span class="main">×</span> <span class="tfree">'n</span> conf<span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹A macrostep transforms one thread by first calling a procedure and then doing a same-level path›</span>
  ntrs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">,</span>LCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span><span class="main">;</span> 
               <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 
             <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">,</span>LCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ce'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">ntrs</span> <span class="free">fg</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ntr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ntr</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">==</span> gtr <span class="main">(</span>ntrs <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ntrp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ntrp</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">==</span> gtrp <span class="main">(</span>ntrs <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ntrs<span class="main">:</span> env_no_step <span class="quoted"><span class="quoted">"ntrs <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_no_step.intro<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ntrs.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> trss_c_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Representation property for reachable configurations"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we show that a configuration is reachable if and only if it is reachable via a normalized path.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first direction is to show that a normalized path is also a path. This follows from the definitions. Note that we first show that a single macrostep corresponds to a path and then
  generalize the result to sequences of macrosteps›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ntrs_is_trss_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> ntrs.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> entry <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> trss_stack_comp<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_is_trss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>foldl <span class="main">(@)</span> <span class="main">[]</span> <span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">from</span></span> trcl_concat<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> foldl_conc_empty_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntr_is_tr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gtrE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_is_trss_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrI<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> ntr_is_tr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span>foldl <span class="main">(@)</span> <span class="main">[]</span> <span class="free">ww</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">c</span> <span class="skolem">ee</span> <span class="skolem">c'</span> <span class="skolem">ww</span> <span class="skolem">c''</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">from</span></span> trcl_concat<span class="main">[</span><span class="operator">OF</span> ntr_is_tr_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> foldl_conc_empty_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ee</span></span> <span class="quoted"><span class="skolem">ww</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The other direction requires to prove that for each path reaching a configuration there is also a normalized path reaching the same configuration. 
  We need an auxiliary lemma for this proof, that is a kind of append rule: {\em Given a normalized path reaching some configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and a same level or returning path from some 
  stack in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can derive a normalized path to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> modified according to the same-level path}. We cannot simply append the same-level or returning path
  as a macrostep, because it does not start with a non-returning call. Instead, we will have to append it to some macrostep in the normalized path, i.e. move it ,,left'' into the normalized
  path.
›</span></span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Intuitively, we can describe the concept of the proof as follows:
  Due to the restrictions we made on flowgraphs, a same-level or returning path cannot be the first steps on a thread. 
  Hence there is a last macrostep that was executed on the thread. When this macrostep was executed, all threads held less monitors then they do at the end of the execution, because
  the set of monitors held by every single thread is increasing during the execution of a normalized path. Thus we can append the same-level or returning path to the last macrostep
  on that thread. As a same-level or returning path does not allocate any monitors, the following macrosteps remain executable. If we have a same-level path, appending it to a macrostep
  yields a valid macrostep again and we are done. Appending a returning path to a macrostep yields a same-level path. In this case we inductively repeat our argument. 

  The actual proof is strictly inductive; it either appends the same-level path to the {\em last} macrostep or inductively repeats the argument.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> ntr_sl_move_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ce</span> <span class="bound">u</span> <span class="bound">r</span> <span class="bound">w</span> <span class="bound">r'</span> <span class="bound">ce'</span><span class="main">.</span>  
  <span class="main">⟦</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">{#</span> <span class="bound">u</span><span class="main">#</span><span class="bound">r</span> <span class="main">#}</span><span class="main">+</span><span class="bound">ce</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="bound">ce</span><span class="main">)</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    initialproc <span class="free">fg</span> <span class="free">p</span><span class="main">;</span> 
    length <span class="bound">r'</span> <span class="main">≤</span> <span class="main">1</span><span class="main">;</span> <span class="bound">w</span><span class="main">≠</span><span class="main">[]</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ww'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="bound">ww'</span><span class="main">,</span><span class="main">{#</span> <span class="bound">r'</span><span class="main">@</span><span class="bound">r</span> <span class="main">#}</span><span class="main">+</span><span class="bound">ce'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">=</span>entry <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="comment1">― ‹If the normalized path is empty, we get a contradiction, because there is no same-level path from the initial configuration of a thread›</span>
  <span class="keyword1"><span class="command">with</span></span> CC<span class="main">(</span>2<span class="main">)</span> no_retsl_from_initial<span class="main">[</span><span class="operator">OF</span> CC<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> _ CC<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ee</span> <span class="skolem">ww</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this 
  <span class="comment1">― ‹In the induction step, we extract the last macrostep›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">ww</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ch</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span> 
  <span class="comment1">― ‹The last macrostep first executes a call and then a same-level path›</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">wws</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="skolem"><span class="skolem">rh</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="skolem"><span class="skolem">uh'</span></span> <span class="skolem"><span class="skolem">vt</span></span> <span class="skolem"><span class="skolem">cet</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    STEPFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">=</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">wws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span>add_mset <span class="main">(</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span><span class="main">)</span> <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">)</span> <span class="skolem">ce</span> <span class="main">=</span> add_mset <span class="main">(</span><span class="skolem">vt</span><span class="main">#</span><span class="skolem">uh'</span><span class="main">#</span><span class="skolem">rh</span><span class="main">)</span> <span class="skolem">cet</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">q</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="skolem">uh'</span><span class="main">#</span><span class="skolem">rh</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wws</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">vt</span><span class="main">]</span><span class="main">,</span><span class="skolem">cet</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrE ntrs.cases<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="comment1">― ‹Make a case distinction whether the last step was executed on the same thread as the sl/ret-path or not›</span>
  <span class="keyword1"><span class="command">from</span></span> STEPFMT<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_single_cases'<span class="main">)</span> 
    <span class="comment1">― ‹If the sl/ret path was executed on the same thread as the last macrostep›</span>
    <span class="keyword3"><span class="command">case</span></span> loc <span class="keyword1"><span class="command">note</span></span> CASE<span class="main">=</span>this <span class="keyword1"><span class="command">hence</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">=</span><span class="skolem">vt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span><span class="skolem">uh'</span><span class="main">#</span><span class="skolem">rh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce</span><span class="main">=</span><span class="skolem">cet</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">― ‹we append it to the last macrostep.›</span>
    <span class="keyword1"><span class="command">with</span></span> STEPFMT<span class="main">(</span>5<span class="main">)</span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> NEWPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wws</span><span class="main">@</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trcl_concat<span class="main">)</span>
    <span class="comment1">― ‹We then distinguish whether we appended a same-level or a returning path›</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span>
      <span class="comment1">― ‹If we appended a same-level path›</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v'</span><span class="main">)</span> <span class="comment1">― ‹Same-level path›</span> <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> CC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span><span class="main">=</span><span class="main">[</span><span class="skolem">v'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="comment1">― ‹The macrostep still ends with a same-level path›</span>
      <span class="keyword1"><span class="command">with</span></span> NEWPATH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wws</span><span class="main">@</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="comment1">― ‹and thus remains a valid macrostep›</span>
      <span class="keyword1"><span class="command">from</span></span> gtrI_s<span class="main">[</span><span class="operator">OF</span> ntrs_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> STEPFMT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="main">(</span><span class="skolem">uh</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">)</span> <span class="skolem">ceh</span><span class="main">,</span> LCall <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">wws</span><span class="main">@</span><span class="skolem">w</span><span class="main">,</span> add_mset <span class="main">(</span><span class="skolem">v'</span> <span class="main">#</span> <span class="skolem">uh'</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">)</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="comment1">― ‹that we can append to the prefix of the normalized path to get our proposition›</span>
      <span class="keyword1"><span class="command">with</span></span> STEPFMT<span class="main">(</span>2<span class="main">)</span> SPLIT<span class="main">(</span>1<span class="main">)</span> CC C'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">ww</span><span class="main">@</span><span class="main">[</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">wws</span><span class="main">@</span><span class="skolem">w</span><span class="main">]</span><span class="main">,</span><span class="main">{#</span> <span class="skolem">r'</span><span class="main">@</span><span class="skolem">r</span> <span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trcl_rev_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹If we appended a returning path›</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this
      <span class="comment1">― ‹The macrostep now ends with a returning path, and thus gets a same-level path›</span>
      <span class="keyword1"><span class="command">have</span></span> NEWSL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">wws</span> <span class="main">@</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span><span class="skolem">uh'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> STEPFMT<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">uh</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">q</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">uh'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> trss_stack_comp<span class="main">[</span><span class="operator">OF</span> NEWPATH<span class="main">]</span> CC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">uh'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">,</span><span class="skolem">wws</span><span class="main">@</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">uh'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">― ‹Hence we can apply the induction hypothesis and get the proposition›</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ NEWSL<span class="main">]</span> SPLIT STEPFMT<span class="main">(</span>2<span class="main">)</span> IHP<span class="main">(</span>4<span class="main">)</span> CC C'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹If the sl/ret path was executed on a different thread than the last macrostep›</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>env <span class="skolem">cc</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> CASE<span class="main">=</span>this
    <span class="comment1">― ‹we first look at the context after the last macrostep. It consists of the threads that already have been there and the threads that have been spawned by the last macrostep›</span>
    <span class="keyword1"><span class="command">from</span></span> STEPFMT<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cspt</span></span> <span class="keyword2"><span class="keyword">where</span></span> CETFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cet</span><span class="main">=</span><span class="skolem">cspt</span><span class="main">+</span><span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">cspt</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> initialproc_def<span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> trss_c_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="comment1">― ‹The spawned threads do not hold any monitors yet›</span>
    <span class="keyword1"><span class="command">hence</span></span> CSPT_NO_MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cspt</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_of_initial_no_mon<span class="main">)</span>
    <span class="comment1">― ‹We now distinguish whether the sl/ret path is executed on a thread that was just spawned or on a thread that was already there›</span>
    <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>1<span class="main">)</span> CETFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">∈#</span> <span class="skolem">cspt</span><span class="main">+</span><span class="skolem">ceh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_un_cases<span class="main"><span class="main">[</span></span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword">set</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="comment1">― ‹The sl/ret path cannot have been executed on a freshly spawned thread due to the restrictions we made on the flowgraph›</span>
      <span class="keyword3"><span class="command">case</span></span> left <span class="comment1">― ‹Thread was spawned›</span> <span class="keyword1"><span class="command">with</span></span> CETFMT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">=</span>entry <span class="free">fg</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"initialproc <span class="free">fg</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> no_retsl_from_initial <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹Hence let's assume the sl/ret path is executed on a thread that was already there before the last macrostep›</span>
      <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">note</span></span> CC<span class="main">=</span>this 
      <span class="comment1">― ‹We can write the configuration before the last macrostep in a way that one sees the thread that executed the sl/ret path›</span>
      <span class="keyword1"><span class="command">hence</span></span> CEHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ceh</span><span class="main">=</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span> <span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span> <span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> CEHFMT STEPFMT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="main">{#</span> <span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span> <span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">― ‹There are not more monitors than after the last macrostep›</span>
      <span class="keyword1"><span class="command">have</span></span> MON_CE<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span> <span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span> <span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span> <span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">uh</span> <span class="main">⊆</span> mon_n <span class="free">fg</span> <span class="skolem">uh'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> STEPFMT<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mon_n_same_proc edges_part<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">cc</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>3<span class="main">)</span> CETFMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cc</span><span class="main">=</span><span class="main">(</span><span class="skolem">cspt</span><span class="main">+</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">-</span><span class="main">{#</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> CC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cc</span> <span class="main">=</span> <span class="skolem">cspt</span><span class="main">+</span><span class="main">(</span><span class="skolem">ceh</span><span class="main">-</span><span class="main">{#</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> CSPT_NO_MON <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">― ‹The same-level path preserves the threads in its environment and the threads that it creates hold no monitors›</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp'</span></span> <span class="keyword2"><span class="keyword">where</span></span> CE'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce'</span><span class="main">=</span><span class="skolem">csp'</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> trss_c_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> c_of_initial_no_mon<span class="main">)</span>
      <span class="comment1">― ‹We can execute the sl/ret-path also from the configuration before the last step›</span>
      <span class="keyword1"><span class="command">from</span></span> trss_xchange_context<span class="main">[</span><span class="operator">OF</span> _ MON_CE<span class="main">]</span> IHP<span class="main">(</span>3<span class="main">)</span> CE'FMT <span class="keyword1"><span class="command">have</span></span> NSL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">uh</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">uh</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="comment1">― ‹And with the induction hypothesis we get a normalized path›</span>
      <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ NSL IHP<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> SPLIT<span class="main">(</span>1<span class="main">)</span> CHFMT <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww'</span></span> <span class="keyword2"><span class="keyword">where</span></span> NNPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">ww'</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">uh</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="comment1">― ‹We now show that the last macrostep can also be executed from the new configuration, after the sl/ret path has been executed (on another thread)›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">uh</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">vt</span> <span class="main">#</span> <span class="skolem">uh'</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">cspt</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntr <span class="free">fg</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="comment1">― ‹This is because the sl/ret path has not allocated any monitors›</span>
        <span class="keyword1"><span class="command">have</span></span> MON_CEH<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">ceh</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> trss_bot_proc_const<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">ce</span></span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">ce'</span></span><span class="main">]</span> mon_n_same_proc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">r'</span> <span class="main">⊆</span> mon_n <span class="free">fg</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CEHFMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">― ‹Need to state this explicitly because of recursive simp rule <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> CEHFMT<span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CE'FMT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_s_unconc<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="comment1">― ‹And we can reassemble the macrostep within the new context›</span>
        <span class="keyword1"><span class="command">note</span></span> trss_xchange_context_s<span class="main">[</span><span class="operator">OF</span> _ MON_CEH<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> csp<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> STEPFMT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> trss_xchange_context<span class="main">[</span><span class="operator">OF</span> _ MON_CEH<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">wws</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">vt</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">cspt</span></span><span class="main">]</span> STEPFMT<span class="main">(</span>5<span class="main">)</span> CETFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wws</span><span class="main">,</span> <span class="main">[</span><span class="skolem">vt</span><span class="main">]</span><span class="main">,</span> <span class="skolem">cspt</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> STEPFMT<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">rh</span><span class="main">,</span><span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">vt</span><span class="main">#</span><span class="skolem">uh'</span><span class="main">#</span><span class="skolem">rh</span><span class="main">,</span><span class="skolem">cspt</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ntrs.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gtrI_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">― ‹Finally we append the last macrostep to the normalized paths we obtained by the induction hypothesis›</span>
      <span class="keyword1"><span class="command">from</span></span> trcl_rev_cons<span class="main">[</span><span class="operator">OF</span> NNPATH this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">ww'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ee</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">vt</span> <span class="main">#</span> <span class="skolem">uh'</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">cspt</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="comment1">― ‹And show that we got the right configuration›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CC CETFMT CASE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> CASE<span class="main">(</span>2<span class="main">)</span> CE'FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">vt</span> <span class="main">#</span> <span class="skolem">uh'</span> <span class="main">#</span> <span class="skolem">rh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">cspt</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ceh</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span> <span class="skolem">r'</span><span class="main">@</span><span class="skolem">r</span> <span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we can prove: {\em Any reachable configuration can also be reached by a normalized path}.
  With <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] eflowgraph.ntr_sl_move_left<span class="antiquote"><span class="antiquote">}</span></span></span></span> we can easily show this lemma
  With <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] eflowgraph.ntr_sl_move_left<span class="antiquote"><span class="antiquote">}</span></span></span></span> we can easily show this   by induction on the reaching path. For the empty path, the proposition follows trivially.
  Else we consider the last step. If it is a call, we can execute it as a macrostep and get the proposition. Otherwise the last step is a same-level (Base, Spawn) or returning (Ret) path of length 1, and
  we can append it to the normalized path using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] eflowgraph.ntr_sl_move_left<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> normalize<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="free">cstart</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="free">cstart</span><span class="main">=</span><span class="main">{#</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span> <span class="main">#}</span><span class="main">;</span> 
    initialproc <span class="free">fg</span> <span class="free">p</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span> <span class="main">#}</span><span class="main">,</span><span class="bound">w'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹The lemma is shown by induction on the reaching path›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_rev_induct<span class="main">)</span> 
  <span class="comment1">― ‹The empty case is trivial, as the empty path is also a valid normalized path›</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">cstart</span> <span class="skolem">w</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="comment1">― ‹In the inductive case, we can assume that we have an already normalized path and need to append a last step›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span> <span class="main">#}</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">∈</span>tr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹We make explicit the thread on that this last step was executed›</span>
  <span class="keyword1"><span class="command">from</span></span> gtr_find_thread<span class="main">[</span><span class="operator">OF</span> IHP'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="keyword2"><span class="keyword">where</span></span> TSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> add_mset <span class="skolem">s</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="comment1">― ‹The proof is done by a case distinction whether the last step was a call or not›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="comment1">― ‹Last step was a procedure call›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LCall <span class="skolem">q</span>"</span></span> 
    <span class="comment1">― ‹As it is the last step, the procedure call will not return and thus is a valid macrostep›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span>LCall <span class="skolem">q</span> <span class="main">#</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> TSTEP CASE <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.intros gtrI_s trss.intros<span class="main">)</span>
    <span class="comment1">― ‹That can be appended to the initial normalized path›</span>
    <span class="keyword1"><span class="command">from</span></span> trcl_rev_cons<span class="main">[</span><span class="operator">OF</span> IHP'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="comment1">― ‹Last step was no procedure call›</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LBase <span class="skolem">a</span> <span class="main">∨</span> <span class="skolem">e</span><span class="main">=</span>LSpawn <span class="skolem">q</span> <span class="main">∨</span> <span class="skolem">e</span><span class="main">=</span>LRet"</span></span> 
    <span class="comment1">― ‹Then it is a same-level or returning path›</span>
    <span class="keyword1"><span class="command">with</span></span> TSTEP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> SLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">=</span><span class="skolem">r'</span><span class="main">@</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r'</span><span class="main">≤</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">ce</span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.intros<span class="main">)</span> 
     <span class="comment1">― ‹That can be appended to the normalized path using the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> ntr_sl_move_left<span class="antiquote">}</span></span> - lemma›</span>
    <span class="keyword1"><span class="command">from</span></span> ntr_sl_move_left<span class="main">[</span><span class="operator">OF</span> _ SLR<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> IHP<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> SLR<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> IHP'<span class="main">(</span>1<span class="main">)</span> TSTEP<span class="main">(</span>1<span class="main">)</span> SLR<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">ww'</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> SLR<span class="main">(</span>2<span class="main">)</span> TSTEP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As the main result of this section we get: {\em A configuration is reachable if and only if it is also reachable via a normalized path}:›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> ntr_repr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"    <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> initialproc_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> normalize ntr_is_tr<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of normalized path›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Like a usual path, also a macrostep modifies one thread, spawns some threads and preserves the state of all the other threads. The spawned threads do not make any steps, thus they stay in their initial configurations.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ntrs_c_cases_s<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span><span class="main">;</span> <span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="bound">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> 
                                         <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> 
                                         initialproc <span class="free">fg</span> <span class="bound">p</span> 
           <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_is_trss_s <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss_c_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_c_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">csp</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span><span class="main">;</span> <span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="bound">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> 
                                         <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> 
                                         initialproc <span class="free">fg</span> <span class="bound">p</span> 
           <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_is_trss <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss_c_cases<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Validity›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Like usual paths, also normalized paths preserve validity of the configurations.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_valid_preserve_s <span class="main">=</span> trss_valid_preserve<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss_s<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_valid_preserve_s <span class="main">=</span> tr_valid_preserve<span class="main">[</span><span class="operator">OF</span> ntr_is_tr_s<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_valid_preserve <span class="main">=</span> trss_valid_preserve<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_valid_preserve <span class="main">=</span> tr_valid_preserve<span class="main">[</span><span class="operator">OF</span> ntr_is_tr<span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_valid_preserve_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ntr_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> gtrp2gtr_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> V<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span> 
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_valid_preserve<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ntr_valid_preserve<span class="main">[</span><span class="operator">OF</span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> V<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitors›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following defines the set of monitors used by a normalized path and shows its basic properties:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mon_ww</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">ww</span></span></span> <span class="main">==</span> foldl <span class="main">(∪)</span> <span class="main">{}</span> <span class="main">(</span>map <span class="main">(</span>mon_w <span class="free"><span class="bound"><span class="entity">fg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ww</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mon_loc</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">ww</span></span></span> <span class="main">==</span> mon_ww <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>map le_rem_s <span class="main">(</span>loc <span class="free"><span class="bound"><span class="entity">ww</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mon_env</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">ww</span></span></span> <span class="main">==</span> mon_ww <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>map le_rem_s <span class="main">(</span>env <span class="free"><span class="bound"><span class="entity">ww</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mon_ww_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ww_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_ww_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span><span class="free">ee</span><span class="main">#</span><span class="free">ww</span><span class="main">)</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="free">ee</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">ww</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ww_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_un_empty_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">ee</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_ww_unconc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span><span class="free">ww1</span><span class="main">@</span><span class="free">ww2</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">ww1</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">ww2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww1</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_env_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">e</span> <span class="keyword1">of</span> LOC <span class="bound">a</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> ENV <span class="bound">a</span> <span class="main">⇒</span> mon_w <span class="free">fg</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> 
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">e</span> <span class="keyword1">of</span> LOC <span class="bound">a</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> ENV <span class="bound">a</span> <span class="main">⇒</span> mon_w <span class="free">fg</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_unconc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span><span class="free">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">)</span> <span class="main">=</span> mon_env <span class="free">fg</span> <span class="free">w1</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_unconc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_loc_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">e</span> <span class="keyword1">of</span> ENV <span class="bound">a</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> LOC <span class="bound">a</span> <span class="main">⇒</span> mon_w <span class="free">fg</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_uncons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">e</span> <span class="keyword1">of</span> ENV <span class="bound">a</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> LOC <span class="bound">a</span> <span class="main">⇒</span> mon_w <span class="free">fg</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∪</span> mon_loc <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_unconc<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span><span class="free">w1</span><span class="main">@</span><span class="free">w2</span><span class="main">)</span> <span class="main">=</span> mon_loc <span class="free">fg</span> <span class="free">w1</span> <span class="main">∪</span> mon_loc <span class="free">fg</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_unconc<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> mon_ww_of_foldl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="main">(</span>foldl <span class="main">(@)</span> <span class="main">[]</span> <span class="free">ww</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">ww</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ww_def<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_conc_empty_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> foldl_un_empty_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mon_ww_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≼</span><span class="free">w'</span> <span class="main">⟹</span> mon_ww <span class="free">fg</span> <span class="free">w</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: Find some general statement about the property that monitors are computed element-wise and pslit this lemma and move the essential part to ConsInterleave.thy. Maybe the essential part is cil_set ?*)</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_ww_cil<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> mon_ww <span class="free">fg</span> <span class="free">w</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">w1</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_cil<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">=</span> mon_loc <span class="free">fg</span> <span class="free">w1</span> <span class="main">∪</span> mon_loc <span class="free">fg</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_cil<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">w1</span>⊗<span class="hidden">⇘</span><sub><span class="free">α</span></sub><span class="hidden">⇙</span><span class="free">w2</span> <span class="main">⟹</span> mon_env <span class="free">fg</span> <span class="free">w</span> <span class="main">=</span> mon_env <span class="free">fg</span> <span class="free">w1</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="free">w2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_ww_of_le_rem<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_env_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≼</span><span class="free">w'</span> <span class="main">⟹</span> mon_env <span class="free">fg</span> <span class="free">w</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_ileq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≼</span><span class="free">w'</span> <span class="main">⟹</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_list_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_loc_map_loc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>map LOC <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_map_env<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>map ENV <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_loc_map_env<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>map ENV <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> mon_env_map_loc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>map LOC <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">― ‹As monitors are syntactically bound to procedures, and each macrostep starts with a non-returning call, the set of monitors allocated during the execution of a normalized path is monotonically increasing›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_mon_increasing_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span> 
  <span class="main">⟹</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="free">s'</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ntrs.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trss_c_no_mon<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="improper">u</span> <span class="main">=</span> mon_n <span class="free">fg</span> <span class="improper">u'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mon_n_same_proc edges_part<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_mon_increasing_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span> <span class="main">⟹</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gtrE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_mon_increasing_s <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>

<span class="comment1">(* FIXME: Quick&amp;dirty proof *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_increasing_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span> 
  <span class="main">⟹</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="free">s'</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> gtrp.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_mon_increasing_s <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_mon_increasing_s <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_mon_increasing_s <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ntrs_c_cases_s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_increasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> 
  <span class="main">⟹</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="free">s'</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_rev_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrp_mon_increasing_s<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Modifying the context›</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_c_no_mon_s <span class="main">=</span> trss_c_no_mon<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss_s<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_c_no_mon <span class="main">=</span> trss_c_no_mon<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss<span class="main">]</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Also like a usual path, a normalized step must not use any monitors that are allocated by other threads›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_mon_e_no_ctx <span class="main">=</span> trss_mon_w_no_ctx<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss_s<span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_mon_w_no_ctx<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> trss_mon_w_no_ctx<span class="main">[</span><span class="operator">OF</span> ntrs_is_trss<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_env_e_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>ENV <span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span> <span class="main">⟹</span> mon_w <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrp.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_mon_e_no_ctx <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_loc_e_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LOC <span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span> <span class="main">⟹</span> mon_w <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrp.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_mon_e_no_ctx<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_env_w_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> mon_env <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_rev_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> mon_env_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrp_mon_env_e_no_ctx ntrp_mon_increasing <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_unconc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_loc_w_no_ctx<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">⟹</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_rev_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> mon_loc_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrp_mon_loc_e_no_ctx ntrp_mon_increasing <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_unconc<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next lemmas are rules how to add or remove threads while preserving the executability of a path
›</span></span>

<span class="comment1">(* TODO: There are far too many {ntrs,ntrp}_{add,drop,replace,modify,xchange}_context - lemmas, try to give them a good sructure, find the most general cases and derive the other ones from these cases *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_modify_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">ee</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span><span class="main">=</span><span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.cases<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> trss_modify_context_s<span class="main">[</span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> S trss_modify_context<span class="main">[</span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_modify_context<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∀</span><span class="bound">cn</span><span class="main">.</span> mon_ww <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="bound">cn</span> <span class="main">=</span> <span class="main">{}</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="free">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="free">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
              <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="bound">cn</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">s</span> <span class="skolem">c</span> <span class="skolem">e</span> <span class="skolem">sh</span> <span class="skolem">ch</span> <span class="skolem">w</span> <span class="skolem">s'</span> <span class="skolem">c'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cn</span>
    <span class="keyword3"><span class="command">assume</span></span> MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ntrs_modify_context_s<span class="main">[</span><span class="operator">OF</span> IHP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> MON <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csph</span></span> <span class="keyword2"><span class="keyword">where</span></span> S1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="skolem">csph</span> <span class="main">+</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csph</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">cn</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">csph</span> <span class="main">+</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> MON <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> S2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> S1 S2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc mon_c_unconc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="bound">csp</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">csp</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">cn</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="bound">csp</span> <span class="main">+</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> ntrs_xchange_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs.cases<span class="main">[</span><span class="operator">OF</span> A<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ee</span> <span class="main">=</span> LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">csp</span> <span class="main">+</span> <span class="skolem">ce</span> <span class="main">=</span> <span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> entry <span class="free">fg</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">u'</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">csp</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_step<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> trss_xchange_context_s<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> csp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> B<span class="main"><span class="main">]</span></span> trss_xchange_context<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> B<span class="main"><span class="main">]</span></span><span class="main">]</span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_replace_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">crn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">cr</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_c_cases_s<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">+</span><span class="free">cr</span> <span class="main">=</span> <span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_xchange_context_s<span class="main">[</span><span class="operator">OF</span> _ MON<span class="main">]</span> A G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> F <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_xchange_context<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">cn</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    mon_c <span class="free">fg</span> <span class="bound">cn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="bound">c</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">csp</span><span class="main">.</span> 
    <span class="bound">c'</span><span class="main">=</span><span class="bound">csp</span><span class="main">+</span><span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">cn</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">csp</span><span class="main">+</span><span class="bound">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">note</span></span> CASE<span class="main">=</span>this
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ee</span> <span class="skolem">ww</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_c_cases_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csph</span></span> <span class="keyword2"><span class="keyword">where</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">csph</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> ntrs_xchange_context_s SPLIT<span class="main">(</span>1<span class="main">)</span> IHP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">from</span></span> c_of_initial_no_mon CHFMT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> CSPH_NO_MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csph</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>3<span class="main">)</span> CHFMT <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IHP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">,</span><span class="skolem">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">csph</span><span class="main">+</span><span class="skolem">cn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> SND
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">cn</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">csph</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CHFMT<span class="main">(</span>1<span class="main">)</span> C'FMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">csph</span><span class="main">)</span><span class="main">+</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_replace_context<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">crn</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="free">cr</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_c_cases<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">+</span><span class="free">cr</span> <span class="main">=</span> <span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> MON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_xchange_context<span class="main">[</span><span class="operator">OF</span> A MON<span class="main">]</span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">crn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> F <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_add_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cn</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> gtrE<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="keyword2"><span class="keyword">where</span></span> NTRS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> add_mset <span class="skolem">s</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> B <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">ce</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_modify_context_s<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> M<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ce</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> NTRS <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrI_s<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_add_context<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> mon_ww <span class="free">fg</span> <span class="free">w</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">cn</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntr_add_context_s<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_add_context_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="free">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> ntrs_modify_context_s<span class="main">[</span><span class="operator">OF</span> A<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">+</span><span class="free">cn</span>"</span></span><span class="main">]</span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_add_context_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span><span class="main">;</span> mon_w <span class="free">fg</span> <span class="main">(</span>le_rem_s <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> gtrp.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_add_context_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrp.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_add_context<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="free">cn</span> <span class="main">=</span> <span class="main">{}</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">+</span><span class="free">cn</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrp_add_context_s<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Altering the local stack›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_stack_comp_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> A
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_stack_comp trss_stack_comp_s <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_step<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_stack_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trcl.cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ntrs_stack_comp_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_stack_comp_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="free">r</span> <span class="main">∩</span> mon_env <span class="free">fg</span> <span class="main">[</span><span class="free">ee</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> A 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gtrp.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> gtrp_loc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>LOC <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_stack_comp_s<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp.gtrp_loc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> gtrp_env <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sm</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">sm'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="skolem">sm</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="skolem">sm'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>ENV <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sm</span><span class="main">,</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sm'</span><span class="main">,</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_modify_context_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span>"</span></span><span class="main">]</span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> B CASE<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    ADD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce'</span> <span class="main">=</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sm</span><span class="main">,</span> <span class="main">{#</span><span class="free">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sm'</span><span class="main">,</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_s_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ADD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span><span class="main">=</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ce</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce'</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sm</span><span class="main">,</span> <span class="main">{#</span><span class="free">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sm'</span><span class="main">,</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span> <span class="main">@</span> <span class="free">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp.gtrp_env<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_stack_comp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> mon_s <span class="free">fg</span> <span class="free">r</span> <span class="main">∩</span> mon_env <span class="free">fg</span> <span class="free">ww</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trcl.cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ntrp_stack_comp_s<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_stack_top_decomp_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">v</span> <span class="bound">u'</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">#</span><span class="bound">u'</span><span class="main">#</span><span class="free">r</span><span class="main">;</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="bound">v</span><span class="main">,</span><span class="bound">u'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span><span class="main">;</span> 
      <span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="bound">p</span><span class="main">,</span><span class="bound">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> 
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ntrs.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> ntrs_step <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_stack_decomp_s<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">u</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> SDC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.ntrs_step<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SDC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="skolem">p</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> EX<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_stack_decomp_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">v</span> <span class="bound">u'</span> <span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> 
      <span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">#</span><span class="bound">u'</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">;</span> 
      <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">u'</span><span class="main">#</span><span class="free">s</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span><span class="main">;</span> 
      <span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="bound">p</span><span class="main">,</span><span class="bound">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ntrs_stack_top_decomp_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> EX<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ntrs_stack_comp_s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrs_stack_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">c</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">#</span><span class="bound">s</span><span class="main">@</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">v</span> <span class="bound">rr</span><span class="main">.</span> <span class="main">⟦</span><span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">@</span><span class="bound">r</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">#</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_unconsE<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>split <span class="skolem">sh</span> <span class="skolem">ch</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs_stack_decomp_s<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vh</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">vh</span><span class="main">#</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">s</span><span class="main">@</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">vh</span><span class="main">#</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Call <span class="skolem">p</span><span class="main">,</span> <span class="skolem">uh</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> F<span class="main">(</span>1<span class="main">)</span> split<span class="main">(</span>2<span class="main">)</span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">vh</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">uh</span><span class="main">#</span><span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">@</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">vh</span><span class="main">#</span><span class="skolem">uh</span><span class="main">#</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrs <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> trcl.cons<span class="main">[</span><span class="operator">OF</span> F<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> S<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> S<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">lemma</span></span> ntrp_stack_decomp_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> EX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">v</span> <span class="bound">rr</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">@</span><span class="free">r</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">ee</span><span class="main">,</span><span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> A 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gtrp.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> gtrp_loc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> EX <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_stack_decomp_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gtrp.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> gtrp_env <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">ss'</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ee</span><span class="main">=</span>ENV <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="skolem">ss'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span><span class="skolem">ce</span><span class="main">+</span><span class="main">{#</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">ss'</span><span class="main">,</span><span class="skolem">ce'</span><span class="main">+</span><span class="main">{#</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">@</span><span class="free">r</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_replace_context_s<span class="main">[</span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> crn<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">u</span><span class="main">#</span><span class="free">s</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="main">{#</span><span class="free">u</span> <span class="main">#</span> <span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ss'</span><span class="main">,</span> <span class="main">{#</span><span class="free">u</span> <span class="main">#</span> <span class="free">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_s_unconc union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">P</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> EX<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp.gtrp_env<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ntrp_stack_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">c</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">#</span><span class="bound">s</span><span class="main">@</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">v</span> <span class="bound">rr</span><span class="main">.</span> <span class="main">⟦</span><span class="free">s'</span><span class="main">=</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">@</span><span class="bound">r</span><span class="main">;</span> <span class="main">(</span><span class="main">(</span><span class="bound">u</span><span class="main">#</span><span class="bound">s</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">,</span><span class="free">ww</span><span class="main">,</span><span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="bound">rr</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ww</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trcl_pair_unconsE<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>split <span class="skolem">sh</span> <span class="skolem">ch</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ntrp_stack_decomp_s<span class="main">[</span><span class="operator">OF</span> split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vh</span></span> <span class="skolem"><span class="skolem">rrh</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">=</span> <span class="skolem">vh</span><span class="main">#</span><span class="skolem">rrh</span><span class="main">@</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">vh</span><span class="main">#</span><span class="skolem">rrh</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> F<span class="main">(</span>1<span class="main">)</span> split<span class="main">(</span>2<span class="main">)</span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">vh</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rrh</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">@</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">vh</span><span class="main">#</span><span class="skolem">rrh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> trcl.cons<span class="main">[</span><span class="operator">OF</span> F<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> S<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> S<span class="main">(</span>1<span class="main">)</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to monitor consistent interleaving›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we describe the relation of the consistent interleaving operator (cf. Section~\ref{thy:ConsInterleave}) and the macrostep-semantics.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction function for normalized paths›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We first need to define an abstraction function that maps a macrostep on a pair of entered and passed monitors, as required by the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊗<span class="hidden">⇘</span><sub>α</sub><span class="hidden">⇙</span>›</span></span></span></span>-operator: 
  
  A step on a normalized paths enters the monitors of the first called procedure and passes the monitors that occur in the following same-level path.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">αn</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">==</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">=</span><span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>mon_e <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span> mon_w <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* TODO: We could also use a primrec here, this would generate simps- (and induct-) lemmas automatically *)</span>
<span class="keyword1"><span class="command">lemma</span></span> αn_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"αn <span class="free">fg</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"αn <span class="free">fg</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mon_e <span class="free">fg</span> <span class="free">e</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> αn_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹We also need an abstraction function for normalized loc/env-paths›</span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">αnl</span> <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">==</span> αn <span class="free"><span class="bound"><span class="entity">fg</span></span></span> <span class="main">(</span>le_rem_s <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> αnl_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"αnl <span class="free">fg</span> <span class="main">==</span> αn <span class="free">fg</span> <span class="main">∘</span> le_rem_s"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_reflection<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ext<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αnl_def<span class="main">)</span>

<span class="comment1">― ‹These are some ad-hoc simplifications, with the aim at converting <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"αnl"</span><span class="antiquote">}</span></span> back to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"αn"</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> αnl_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"αnl <span class="free">fg</span> <span class="main">(</span>ENV <span class="free">x</span><span class="main">)</span> <span class="main">=</span> αn <span class="free">fg</span> <span class="free">x</span>"</span></span> 
  <span class="quoted"><span class="quoted">"αnl <span class="free">fg</span> <span class="main">(</span>LOC <span class="free">x</span><span class="main">)</span> <span class="main">=</span> αn <span class="free">fg</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> αnl_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> αnl_simps1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">∘</span> ENV <span class="main">=</span> αn <span class="free">fg</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">∘</span> LOC <span class="main">=</span> αn <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> αnl_def' comp_def<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> αn_αnl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">∘</span> le_rem_s <span class="main">=</span> αnl <span class="free">fg</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> αnl_def'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">lemma</span></span> αn_fst_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">w</span><span class="main">)</span> <span class="main">∪</span> snd <span class="main">(</span>αn <span class="free">fg</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mon_pl_of_αnl<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> el_step.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now derive specialized introduction lemmas for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊗<span class="hidden">⇘</span><sub>αn fg</sub><span class="hidden">⇙</span>›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cil_αn_cons_helper<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="free">wb</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="free">wb</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mon_pl_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">wb</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> mon_ww_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldl_un_empty_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cil_αnl_cons_helper<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="free">wb</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="free">wb</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl cil_αn_cons_helper<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> cil_αn_cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="free">wb</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">e</span><span class="main">#</span><span class="free">w</span> <span class="main">∈</span> <span class="free">e</span><span class="main">#</span><span class="free">wa</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="free">wb</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cil_αn_cons_helper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cil_αn_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="free">wb</span><span class="main">;</span> fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">e</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="free">wa</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">e</span><span class="main">#</span><span class="free">w</span> <span class="main">∈</span> <span class="free">wa</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="free">e</span><span class="main">#</span><span class="free">wb</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cil_αn_cons_helper<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Monitors"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_mon_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="free">s'</span> <span class="main">=</span> mon_s <span class="free">fg</span> <span class="free">s</span> <span class="main">∪</span> fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> DET<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">=</span><span class="skolem">v</span><span class="main">#</span><span class="skolem">u'</span><span class="main">#</span><span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.cases<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> mon_n <span class="free">fg</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mon_n_same_proc edges_part<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> trss_bot_proc_const<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> DET<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> DET<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_n_def αn_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrs_called_mon<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="free">s'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ntrs_mon_s<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_mon_s<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span> <span class="main">⟹</span> mon_c <span class="free">fg</span> <span class="free">c'</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">∪</span> fst <span class="main">(</span>αn <span class="free">fg</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gtrE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc ntrs_c_no_mon_s ntrs_mon_s<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_mon_s<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c</span><span class="main">)</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s'</span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> mon_c <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">c</span><span class="main">)</span> <span class="main">∪</span> fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ntr_mon_s<span class="main">[</span><span class="operator">OF</span> gtrp2gtr_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> αnl_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Interleaving theorem›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we show that the consistent interleaving operator describes the intuition behind interleavability of normalized paths. We show:
  {\em Two paths are simultaneously executable if and only if they are consistently interleavable and the monitors of the initial configurations are compatible}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The split lemma splits an execution from a context of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ca</span></span><span class="main"><span class="main">+</span></span><span class="free"><span class="free">cb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into two interleavable executions from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ca</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">cb</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> respectively.
  While further down we prove this lemma for loc/env-path, which is more general but also more complicated, we start with the proof for paths of the multiset-semantics
  for illustrating the idea.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_split<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ca</span> <span class="bound">cb</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="bound">ca</span><span class="main">+</span><span class="bound">cb</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="bound">ca</span><span class="main">+</span><span class="bound">cb</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">ca'</span> <span class="bound">cb'</span> <span class="bound">wa</span> <span class="bound">wb</span><span class="main">.</span> 
  <span class="free">c'</span><span class="main">=</span><span class="bound">ca'</span><span class="main">+</span><span class="bound">cb'</span> <span class="main">∧</span> 
  <span class="free">w</span><span class="main">∈</span><span class="main">(</span><span class="bound">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="bound">wb</span><span class="main">)</span> <span class="main">∧</span> 
  mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
  mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
  <span class="main">(</span><span class="bound">ca</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="bound">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cb</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="bound">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="comment1">― ‹The proof is done by induction on the path›</span>
   <span class="comment1">― ‹If the path is empty, the lemma is trivial›</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ca</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">cb</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IHP<span class="main">=</span>this
   <span class="comment1">― ‹We split a non-empty paths after the first (macro) step›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">+</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ch</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="comment1">― ‹Pick the stack that made the first step›</span>
  <span class="keyword1"><span class="command">from</span></span> gtrE<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="keyword2"><span class="keyword">where</span></span> NTRS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ca</span><span class="main">+</span><span class="skolem">cb</span><span class="main">=</span>add_mset <span class="skolem">s</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span>add_mset <span class="skolem">sh</span> <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ce</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="comment1">― ‹And separate the threads that where spawned during the first step from the ones that where already there›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> CEHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ceh</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs_c_cases_s <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> c_of_initial_no_mon<span class="main">)</span> 

  <span class="comment1">― ‹Needed later: The first macrostep uses no monitors already owned by threads that where already there›</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MONED<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_w <span class="free">fg</span> <span class="skolem">e</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span> 
  <span class="comment1">― ‹Needed later: The intermediate configuration is valid›</span>
  <span class="keyword1"><span class="command">from</span></span> ntr_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> IHP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> CHVALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 

  <span class="comment1">― ‹We make a case distinction whether the thread that made the first step was in the left or right part of the initial configuration›</span>
  <span class="keyword1"><span class="command">from</span></span> NTRS<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_unplusm_dist_cases<span class="main">)</span> 
    <span class="comment1">― ‹The first step was on a thread in the left part of the initial configuration›</span>
    <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">note</span></span> CASE<span class="main">=</span>this 
    <span class="comment1">― ‹We can write the intermediate configuration so that it is suited for the induction hypothesis›</span>
    <span class="keyword1"><span class="command">with</span></span> CEHFMT NTRS <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="skolem">cb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span> 
    <span class="comment1">― ‹and by the induction hypothesis, we split the path from the intermediate configuration›</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>1<span class="main">)</span> SPLIT<span class="main">(</span>2<span class="main">)</span> CHVALID <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ca'</span></span> <span class="skolem"><span class="skolem">cb'</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">ca'</span><span class="main">+</span><span class="skolem">cb'</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="skolem">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">wb</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wa</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">wa</span><span class="main">,</span><span class="skolem">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">wb</span><span class="main">,</span><span class="skolem">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="comment1">― ‹It remains to show that we can execute the first step with the right part of the configuration removed›</span>
    <span class="keyword1"><span class="command">have</span></span> FIRSTSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ntrs_xchange_context_s NTRS<span class="main">(</span>3<span class="main">)</span> CEHFMT CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">ca</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> gtrI_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">,</span><span class="skolem">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="comment1">― ‹and that we can prepend the first step to the interleaving›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">wb</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntrs_called_mon<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> cil_αn_cons1<span class="main">[</span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="comment1">― ‹and that the monitors of the initial context does not interfere›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntr_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> FIRSTSTEP<span class="main">]</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> MONED CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> mon_w <span class="free">fg</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ntr_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> FIRSTSTEP<span class="main">]</span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wa</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹The other case, that is if the first step was made on a thread in the right part of the configuration, is shown completely analogously›</span>
    <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">note</span></span> CASE<span class="main">=</span>this 
    <span class="keyword1"><span class="command">with</span></span> CEHFMT NTRS <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">ca</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IHP<span class="main">(</span>1<span class="main">)</span> SPLIT<span class="main">(</span>2<span class="main">)</span> CHVALID <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ca'</span></span> <span class="skolem"><span class="skolem">cb'</span></span> <span class="skolem"><span class="skolem">wa</span></span> <span class="skolem"><span class="skolem">wb</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="skolem">ca'</span><span class="main">+</span><span class="skolem">cb'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="skolem">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">wb</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wa</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span><span class="skolem">wa</span><span class="main">,</span><span class="skolem">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">wb</span><span class="main">,</span><span class="skolem">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> FIRSTSTEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span> <span class="main">⊆</span> mon_c <span class="free">fg</span> <span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ntrs_xchange_context_s NTRS<span class="main">(</span>3<span class="main">)</span> CEHFMT CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">cb</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> gtrI_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> IHAPP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> PA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wb</span><span class="main">,</span><span class="skolem">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">wa</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">wb</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntrs_called_mon<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="skolem">wa</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span> 
      <span class="keyword1"><span class="command">from</span></span> cil_αn_cons2<span class="main">[</span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntr_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> FIRSTSTEP<span class="main">]</span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> MONED CASE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> mon_w <span class="free">fg</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ntr_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> FIRSTSTEP<span class="main">]</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is a more general version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] flowgraph.ntr_split<span class="antiquote"><span class="antiquote">}</span></span></span></span> for the semantics with a distinguished local thread. The proof follows exactly the same ideas, but is more complex.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_split<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="main">!!</span><span class="bound">s</span> <span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">s'</span> <span class="bound">c'</span><span class="main">.</span> 
  <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c1</span><span class="main">+</span><span class="bound">c2</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">c1</span><span class="main">+</span><span class="bound">c2</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w1</span> <span class="bound">w2</span> <span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> 
        <span class="free">w</span> <span class="main">∈</span> <span class="bound">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map ENV <span class="bound">w2</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="bound">c'</span><span class="main">=</span><span class="bound">c1'</span><span class="main">+</span><span class="bound">c2'</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">c1</span><span class="main">)</span><span class="main">,</span><span class="bound">w1</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c1'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="bound">c2</span><span class="main">,</span><span class="bound">w2</span><span class="main">,</span><span class="bound">c2'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
        mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="bound">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="bound">c2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
        mon_ww <span class="free">fg</span> <span class="bound">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ee</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c1</span><span class="main">+</span><span class="skolem">c2</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gtrp.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> gtrp_loc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">=</span>LOC <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c1</span><span class="main">+</span><span class="skolem">c2</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs_c_cases_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">c1</span><span class="main">)</span><span class="main">+</span><span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> c_of_initial_no_mon <span class="keyword1"><span class="command">have</span></span> CSPNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ntr_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> gtrI_s<span class="main">,</span> <span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> CHFMT <span class="keyword1"><span class="command">have</span></span> VALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">c1</span><span class="main">)</span><span class="main">+</span><span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ VALID<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">c'</span></span><span class="main">]</span> CHFMT<span class="main">(</span>1<span class="main">)</span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">c2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">#</span><span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">ee</span><span class="main">#</span><span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ntrp_mon_env_w_no_ctx<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> mon_env_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="main">(</span>env <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="main">(</span>env <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* TODO: This proof should be shorter and more straightforward *)</span>
        <span class="keyword1"><span class="command">from</span></span> cil_subset_il IHAPP<span class="main">(</span>1<span class="main">)</span> ileq_interleave <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map ENV <span class="skolem">w2</span> <span class="main">≼</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> le_list_filter<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"env <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span> <span class="main">≼</span> env <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map ENV <span class="skolem">w2</span> <span class="main">≼</span> env <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> env_def<span class="main">)</span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> le_list_map<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">le_rem_s</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">≼</span> map le_rem_s <span class="main">(</span>env <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mon_ww_ileq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> ntrs_mon_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">w1</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">c1'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntrs_xchange_context_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span><span class="main">+</span><span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">csp</span>"</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span>"</span></span><span class="main">]</span> CASE<span class="main">(</span>2<span class="main">)</span> CHFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp.gtrp_loc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>1<span class="main">)</span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">c2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ntrs_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> CHFMT<span class="main">(</span>1<span class="main">)</span> IHAPP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gtrp_env <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">ssh</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">=</span>ENV <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span><span class="main">+</span><span class="skolem">c2</span><span class="main">=</span>add_mset <span class="skolem">ss</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span>add_mset <span class="skolem">ssh</span> <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span>add_mset <span class="skolem">s</span> <span class="skolem">ce</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">ssh</span><span class="main">,</span>add_mset <span class="skolem">s</span> <span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs_c_cases_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp</span></span> <span class="keyword2"><span class="keyword">where</span></span> HFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">s</span> <span class="skolem">ceh</span> <span class="main">=</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="main">(</span>add_mset <span class="skolem">s</span> <span class="skolem">ce</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">csp</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> union_left_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="skolem">ceh</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">csp</span><span class="main">+</span><span class="skolem">ce</span>"</span></span><span class="main">]</span> HFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> CEHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ceh</span><span class="main">=</span><span class="skolem">csp</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HFMT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> CHNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> c_of_initial_no_mon<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_unplusm_dist_cases<span class="main">)</span>
      <span class="comment1">― ‹Made an env-step in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">c1</span></span><span class="antiquote">}</span></span>, this is considered the ,,left'' part. Apply induction hypothesis with original(!) local thread and the spawned threads on the left side›</span>
      <span class="keyword3"><span class="command">case</span></span> left 
      <span class="keyword1"><span class="command">with</span></span> HFMT<span class="main">(</span>1<span class="main">)</span> CASE<span class="main">(</span>4<span class="main">)</span> CEHFMT <span class="keyword1"><span class="command">have</span></span> CHFMT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> VALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> ntr_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> gtrI_s<span class="main">,</span> <span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_assoc add_mset_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> left CEHFMT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac add_mset_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ VALID<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">c'</span></span><span class="main">]</span> CHFMT' SPLIT<span class="main">(</span>2<span class="main">)</span> CASE<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="skolem">c2'</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">c2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">w1</span><span class="main">)</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cil_cons1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">ssh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ntrs_mon_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="skolem">ssh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">have</span></span> SS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> left HFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span><span class="main">=</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ceh</span> <span class="main">=</span> <span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>5<span class="main">)</span> ntrs_xchange_context_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">+</span><span class="skolem">c2</span>"</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">ssh</span></span> <span class="quoted"><span class="skolem">csp</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> add_mset <span class="skolem">s</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ssh</span><span class="main">,</span> add_mset <span class="skolem">s</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gtrp.gtrp_env<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> left<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> trcl.cons<span class="main">[</span><span class="operator">OF</span> this IHAPP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> left CASE<span class="main">(</span>1<span class="main">)</span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">c2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> ntrp_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> SS<span class="main">]</span> IHAPP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹Made an env-step in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">c2</span></span><span class="antiquote">}</span></span>. This is considered the right part. Induction hypothesis is applied with original local thread and the spawned threads on the right side›</span> 
      <span class="keyword3"><span class="command">case</span></span> right 
      <span class="keyword1"><span class="command">with</span></span> HFMT<span class="main">(</span>1<span class="main">)</span> CASE<span class="main">(</span>4<span class="main">)</span> CEHFMT <span class="keyword1"><span class="command">have</span></span> CHFMT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">c1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> VALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="skolem">csp</span><span class="main">+</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> ntr_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> gtrI_s<span class="main">,</span> <span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>2<span class="main">)</span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ceh</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac add_mset_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> right CEHFMT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac add_mset_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ VALID<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">c'</span></span><span class="main">]</span> CHFMT' SPLIT<span class="main">(</span>2<span class="main">)</span> CASE<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="skolem">c2'</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">c1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CASE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cil_cons2<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">ssh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ntrs_mon_s<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">⊆</span> mon_s <span class="free">fg</span> <span class="skolem">ssh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> αnl_def'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="main">(</span>ENV <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">have</span></span> SS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">csp</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">ssh</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> right HFMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span><span class="main">=</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c1</span><span class="main">+</span><span class="main">(</span><span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ceh</span> <span class="main">=</span> <span class="skolem">csp</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c1</span><span class="main">+</span><span class="main">(</span><span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> CASE<span class="main">(</span>5<span class="main">)</span> ntrs_xchange_context_s<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c1</span><span class="main">+</span><span class="main">(</span><span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">ssh</span></span> <span class="quoted"><span class="skolem">csp</span></span> <span class="quoted"><span class="free">fg</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span><span class="main">-</span><span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ssh</span><span class="main">,</span> <span class="skolem">csp</span><span class="main">+</span> <span class="main">(</span><span class="skolem">c2</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">ss</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc union_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> gtrI_s<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> right<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> trcl.cons<span class="main">[</span><span class="operator">OF</span> this IHAPP<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> ntr_mon_increasing_s<span class="main">[</span><span class="operator">OF</span> SS<span class="main">]</span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">c2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">from</span></span> ntrs_mon_e_no_ctx<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> right IHAPP<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Just a check that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] "flowgraph.ntrp_split"<span class="antiquote">}</span></span> is really a generalization of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] "flowgraph.ntr_split"<span class="antiquote">}</span></span>:›</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_split'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> VALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ca'</span> <span class="bound">cb'</span> <span class="bound">wa</span> <span class="bound">wb</span><span class="main">.</span> 
    <span class="free">c'</span><span class="main">=</span><span class="bound">ca'</span><span class="main">+</span><span class="bound">cb'</span> <span class="main">∧</span> 
    <span class="free">w</span><span class="main">∈</span><span class="main">(</span><span class="bound">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="bound">wb</span><span class="main">)</span> <span class="main">∧</span> 
    mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">ca</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="bound">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">cb</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="bound">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A VALID <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ntr_split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The unsplit lemma combines two interleavable executions. For illustration purposes, we first prove the less general version for multiset-configurations.
  The general version for loc/env-configurations is shown later.›</span></span>   
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_unsplit<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="free">wb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ca</span><span class="main">,</span><span class="free">wa</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cb</span><span class="main">,</span><span class="free">wb</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
  <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">wa</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹We have to generalize and rewrite the goal, in order to apply Isabelle's induction method›</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ca</span> <span class="bound">cb</span><span class="main">.</span> <span class="main">(</span><span class="bound">ca</span><span class="main">,</span><span class="free">wa</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cb</span><span class="main">,</span><span class="free">wb</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">wa</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="bound">ca</span><span class="main">+</span><span class="bound">cb</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹We prove the generalized goal by induction over the structure of consistent interleaving›</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span> 
    <span class="comment1">― ‹If both words are empty, the proposition is trivial›</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹The first macrostep of the combined path was taken from the left operand of the interleaving›</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w1'</span> <span class="skolem">w2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ca</span> <span class="skolem">cb</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="skolem">w1'</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ca</span> <span class="bound">cb</span><span class="main">.</span>
           <span class="main">⟦</span><span class="main">(</span><span class="bound">ca</span><span class="main">,</span> <span class="skolem">w1'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
           <span class="main">(</span><span class="bound">cb</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
           mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
           mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="bound">ca</span> <span class="main">+</span> <span class="bound">cb</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w1'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="comment1">― ‹Split the left path after the first step›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cah</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">cah</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cah</span><span class="main">,</span><span class="skolem">w1'</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
      <span class="comment1">― ‹and combine the first step of the left path with the initial right context›</span>
      <span class="keyword1"><span class="command">from</span></span> ntr_add_context_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">cb</span></span><span class="main">]</span> I<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">cah</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">)</span> <span class="main">∈</span> ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">also</span></span>
      <span class="comment1">― ‹The rest of the path is combined by using the induction hypothesis›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cah</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
        <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>2<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> ntr_mon_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON_CAH<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cah</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main">)</span> 
        <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> MON_CB<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cah</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w1'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> I<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> MON_CAH MON_CB<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹The first macrostep of the combined path was taken from the right path -- this case is done completely analogous›</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w2'</span> <span class="skolem">w1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ca</span> <span class="skolem">cb</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">w2'</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αn <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ca</span> <span class="bound">cb</span><span class="main">.</span>
           <span class="main">⟦</span><span class="main">(</span><span class="bound">ca</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
           <span class="main">(</span><span class="bound">cb</span><span class="main">,</span> <span class="skolem">w2'</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
           mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
           mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="bound">ca</span> <span class="main">+</span> <span class="bound">cb</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span> <span class="skolem">e</span><span class="main">#</span><span class="skolem">w2'</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">w2'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cbh</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">cbh</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cbh</span><span class="main">,</span><span class="skolem">w2'</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ntr_add_context_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ca</span></span><span class="main">]</span> I<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cbh</span><span class="main">)</span> <span class="main">∈</span> ntr <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cbh</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>2<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> ntr_mon_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON_CBH<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cbh</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> MON_CA<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cbh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> I<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> MON_CA MON_CBH<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_unsplit<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map ENV <span class="free">wb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ca</span><span class="main">)</span><span class="main">,</span><span class="free">wa</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cb</span><span class="main">,</span><span class="free">wb</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
  <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="free">wa</span><span class="main">)</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">wb'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">wa</span>⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">wb'</span> <span class="main">⟹</span> 
      <span class="main">∀</span><span class="bound">s</span> <span class="bound">ca</span> <span class="bound">cb</span> <span class="bound">wb</span><span class="main">.</span> <span class="skolem">wb'</span><span class="main">=</span>map ENV <span class="bound">wb</span> <span class="main">∧</span> 
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ca</span><span class="main">)</span><span class="main">,</span><span class="free">wa</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">cb</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">∧</span> mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="free">wa</span><span class="main">)</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟶</span> 
      <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ca</span><span class="main">+</span><span class="bound">cb</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cil_set_induct_fixα<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">e</span> <span class="skolem">w'</span> <span class="skolem">w1'</span> <span class="skolem">w2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">ca</span> <span class="skolem">cb</span> <span class="skolem">wb</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="skolem">w1'</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">ca</span> <span class="bound">cb</span> <span class="bound">wb</span><span class="main">.</span> <span class="main">⟦</span>
            <span class="skolem">w2</span> <span class="main">=</span> map ENV <span class="bound">wb</span><span class="main">;</span>
            <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ca</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1'</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
            <span class="main">(</span><span class="bound">cb</span><span class="main">,</span> <span class="bound">wb</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
            mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span> <span class="main">+</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
            mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span> <span class="main">+</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>
          <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ca</span> <span class="main">+</span> <span class="bound">cb</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> map ENV <span class="skolem">wb</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ca</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w1'</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">cah</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ca</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">cah</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">cah</span><span class="main">)</span><span class="main">,</span><span class="skolem">w1'</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ntrp_add_context_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">cb</span></span><span class="main">]</span> I<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">cah</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">cah</span><span class="main">+</span><span class="skolem">cb</span><span class="main">)</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> ntrp_mon_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> I<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">cah</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rename_tac</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">a</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αn_cons_helper<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="comment1">(* FIXME: Ughly apply-script style proof *)</span>
          <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>8<span class="main">)</span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">cah</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">ee</span> <span class="skolem">w'</span> <span class="skolem">w2'</span> <span class="skolem">w1</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">ca</span> <span class="skolem">cb</span> <span class="skolem">wb</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="skolem">w2'</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">ee</span><span class="main">)</span> <span class="main">∩</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span> <span class="bound">ca</span> <span class="bound">cb</span> <span class="bound">wb</span><span class="main">.</span> <span class="main">⟦</span>
            <span class="skolem">w2'</span> <span class="main">=</span> map ENV <span class="bound">wb</span><span class="main">;</span>
            <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ca</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
            <span class="main">(</span><span class="bound">cb</span><span class="main">,</span> <span class="bound">wb</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span>
            mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span> <span class="main">+</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span>
            mon_c <span class="free">fg</span> <span class="bound">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span> <span class="main">+</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>
          <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ca</span> <span class="main">+</span> <span class="bound">cb</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span> <span class="main">+</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">#</span><span class="skolem">w2'</span> <span class="main">=</span> map ENV <span class="skolem">wb</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ca</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="free">s'</span><span class="main">,</span> <span class="free">ca'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span> <span class="skolem">wb</span><span class="main">,</span> <span class="free">cb'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">wb'</span></span> <span class="keyword2"><span class="keyword">where</span></span> EE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wb</span><span class="main">=</span><span class="skolem">e</span><span class="main">#</span><span class="skolem">wb'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">=</span>ENV <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2'</span><span class="main">=</span>map ENV <span class="skolem">wb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wb</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> I<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cbh</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cb</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="skolem">cbh</span><span class="main">)</span><span class="main">∈</span>ntr <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cbh</span><span class="main">,</span><span class="skolem">wb'</span><span class="main">,</span><span class="free">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cb</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ee</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ca</span> <span class="main">+</span> <span class="skolem">cbh</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> gtrE<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sb</span></span> <span class="skolem"><span class="skolem">ceb</span></span> <span class="skolem"><span class="skolem">sbh</span></span> <span class="skolem"><span class="skolem">cebh</span></span> <span class="keyword2"><span class="keyword">where</span></span> NTRS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cb</span> <span class="main">=</span> add_mset <span class="skolem">sb</span> <span class="skolem">ceb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cbh</span> <span class="main">=</span> add_mset <span class="skolem">sbh</span> <span class="skolem">cebh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sb</span><span class="main">,</span> <span class="skolem">ceb</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sbh</span><span class="main">,</span> <span class="skolem">cebh</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> ntrs_add_context_s<span class="main">[</span><span class="operator">OF</span> NTRS<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ca</span>"</span></span><span class="main">]</span> EE<span class="main">(</span>1<span class="main">)</span> I<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sb</span><span class="main">,</span> add_mset <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ca</span><span class="main">+</span><span class="skolem">ceb</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">sbh</span><span class="main">,</span> add_mset <span class="skolem">s</span> <span class="main">(</span><span class="skolem">ca</span><span class="main">+</span><span class="skolem">cebh</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> gtrp_env<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> NTRS<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> EE<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ca</span><span class="main">+</span><span class="skolem">cbh</span><span class="main">)</span><span class="main">,</span><span class="skolem">w'</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">ca'</span><span class="main">+</span><span class="free">cb'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> I<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> ntr_mon_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> I<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span> EE<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cbh</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αnl_cons_helper<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_αnl_cons_helper<span class="main">)</span> <span class="comment1">(* FIXME: Ughly apply-script style proof *)</span>
          <span class="keyword1"><span class="command">from</span></span> I<span class="main">(</span>7<span class="main">)</span> 1 EE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ca</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cbh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wb'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> I<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> A B <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And finally we get the desired theorem: {\em Two paths are simultaneously executable if and only if they are consistently interleavable and the monitors of the initial configurations are compatible}.
Note that we have to assume a valid starting configuration.›</span></span>  
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_interleave<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="free">ca</span><span class="main">+</span><span class="free">cb</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∃</span><span class="bound">ca'</span> <span class="bound">cb'</span> <span class="bound">wa</span> <span class="bound">wb</span><span class="main">.</span> 
    <span class="free">c'</span><span class="main">=</span><span class="bound">ca'</span><span class="main">+</span><span class="bound">cb'</span> <span class="main">∧</span> 
    <span class="free">w</span><span class="main">∈</span><span class="main">(</span><span class="bound">wa</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="bound">wb</span><span class="main">)</span> <span class="main">∧</span> 
    mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    mon_c <span class="free">fg</span> <span class="free">cb</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">ca</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">wa</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">ca</span><span class="main">,</span><span class="bound">wa</span><span class="main">,</span><span class="bound">ca'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">cb</span><span class="main">,</span><span class="bound">wb</span><span class="main">,</span><span class="bound">cb'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntr_split ntr_unsplit<span class="main">)</span>

<span class="comment1">― ‹Here is the corresponding version for executions with an explicit local thread›</span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntrp_interleave<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c1</span><span class="main">+</span><span class="free">c2</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∃</span><span class="bound">w1</span> <span class="bound">w2</span> <span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> 
    <span class="free">w</span> <span class="main">∈</span> <span class="bound">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map ENV <span class="bound">w2</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="free">c'</span><span class="main">=</span><span class="bound">c1'</span><span class="main">+</span><span class="bound">c2'</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">c1</span><span class="main">)</span><span class="main">,</span><span class="bound">w1</span><span class="main">,</span><span class="main">(</span><span class="free">s'</span><span class="main">,</span><span class="bound">c1'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free">c2</span><span class="main">,</span><span class="bound">w2</span><span class="main">,</span><span class="bound">c2'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="bound">w1</span><span class="main">)</span> <span class="main">∩</span> 
    mon_c <span class="free">fg</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    mon_ww <span class="free">fg</span> <span class="bound">w2</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="free">s</span><span class="main">#}</span><span class="main">+</span><span class="free">c1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ntrp_split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrp_unsplit <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc
      mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next is a corollary of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] flowgraph.ntrp_unsplit<span class="antiquote"><span class="antiquote">}</span></span></span></span>, allowing us to convert a path to loc/env semantics by adding a local stack that does not make any steps.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr2ntrp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
    <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    mon_c <span class="free">fg</span> <span class="main">(</span>add_mset <span class="free">s</span> <span class="free">cl</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="free">c</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="free">w</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cl</span><span class="main">+</span><span class="free">c</span><span class="main">)</span><span class="main">,</span>map ENV <span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">cl</span><span class="main">+</span><span class="free">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ntrp_unsplit<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> wa<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Reverse splitting"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section establishes a theorem that allows us to find the thread in the original configuration that created some distinguished thread in the final configuration.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_reverse_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">w</span> <span class="bound">s'</span> <span class="bound">ce'</span><span class="main">.</span> <span class="main">⟦</span> 
  <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
  valid <span class="free">fg</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">∃</span><span class="bound">s</span> <span class="bound">ce</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="bound">ce1'</span> <span class="bound">ce2'</span><span class="main">.</span> 
    <span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce</span> <span class="main">∧</span> 
    <span class="bound">ce'</span><span class="main">=</span><span class="bound">ce1'</span><span class="main">+</span><span class="bound">ce2'</span> <span class="main">∧</span> 
    <span class="bound">w</span><span class="main">∈</span><span class="bound">w1</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="bound">w2</span> <span class="main">∧</span> 
    mon_s <span class="free">fg</span> <span class="bound">s</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="bound">ce</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    mon_c <span class="free">fg</span> <span class="bound">ce</span> <span class="main">∩</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="bound">s</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="bound">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">,</span><span class="bound">w1</span><span class="main">,</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">ce1'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="bound">ce</span><span class="main">,</span><span class="bound">w2</span><span class="main">,</span><span class="bound">ce2'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="comment1">― ‹The proof works by induction on the initial configuration. Note that configurations consist of finitely many threads only›</span>
<span class="comment1">― ‹FIXME: An induction over the size (rather then over the adding of some fixed element) may lead to a smoother proof here›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multiset_induct'<span class="main">)</span> 
  <span class="comment1">― ‹If the initial configuration is empty, we immediately get a contradiction›</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹The initial configuration has the form <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"{#s#}+ce"</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">ce</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="comment1">― ‹We split the path by this initial configuration›</span>
  <span class="keyword1"><span class="command">from</span></span> ntr_split<span class="main">[</span><span class="operator">OF</span> add.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ce1'</span></span> <span class="skolem"><span class="skolem">ce2'</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span><span class="main">=</span><span class="skolem">ce1'</span><span class="main">+</span><span class="skolem">ce2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w2</span>"</span></span> 
    <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ce</span> <span class="main">∩</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="skolem">s</span><span class="main">∪</span>mon_ww <span class="free">fg</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ce</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="skolem">ce1'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ce</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="skolem">ce2'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="comment1">― ‹And then check whether splitting off <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span> was the right choice›</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_unplusm_dist_cases<span class="main">)</span> 
    <span class="comment1">― ‹Our choice was correct, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s'</span></span><span class="antiquote">}</span></span> is generated by some descendant of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span>"›</span>
    <span class="keyword3"><span class="command">case</span></span> left 
    <span class="keyword1"><span class="command">with</span></span> SPLIT <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹Our choice was not correct, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s'</span></span><span class="antiquote">}</span></span> is generated by some descendant of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">ce</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword3"><span class="command">case</span></span> right <span class="keyword1"><span class="command">with</span></span> SPLIT<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ce</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">ce2'</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="comment1">― ‹In this case we apply the induction hypothesis to the path from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">ce</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">from</span></span> add.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> VALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">s</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ce</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> add.hyps<span class="main">[</span><span class="operator">OF</span> C VALID<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="skolem"><span class="skolem">cet</span></span> <span class="skolem"><span class="skolem">w21</span></span> <span class="skolem"><span class="skolem">w22</span></span> <span class="skolem"><span class="skolem">ce21'</span></span> <span class="skolem"><span class="skolem">ce22'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      IHAPP<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">ce</span><span class="main">=</span><span class="main">{#</span><span class="skolem">st</span><span class="main">#}</span><span class="main">+</span><span class="skolem">cet</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">ce2'</span><span class="main">-</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">ce21'</span><span class="main">+</span><span class="skolem">ce22'</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span><span class="skolem">w21</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w22</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">st</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">cet</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w22</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">cet</span> <span class="main">∩</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="skolem">st</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w21</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">st</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w21</span><span class="main">,</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce21'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cet</span><span class="main">,</span><span class="skolem">w22</span><span class="main">,</span><span class="skolem">ce22'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    
    <span class="comment1">― ‹And finally we add the path from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">s</span></span><span class="antiquote">}</span></span> again. This requires some monitor sorting and the associativity of the consistent interleaving operator.›</span>
    <span class="keyword1"><span class="command">from</span></span> cil_assoc2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">w1</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quoted"><span class="skolem">w22</span></span> <span class="quoted"><span class="skolem">w21</span></span><span class="main">]</span> SPLIT<span class="main">(</span>2<span class="main">)</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wl</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASSOC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="skolem">w21</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">wl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wl</span><span class="main">∈</span><span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w22</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cil_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CASSOC IHAPP<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> SPLIT<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> COMBINE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="skolem">s</span> <span class="skolem">cet</span><span class="main">,</span> <span class="skolem">wl</span><span class="main">,</span> <span class="skolem">ce1'</span> <span class="main">+</span> <span class="skolem">ce22'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ntr_unsplit<span class="main">[</span><span class="operator">OF</span> CASSOC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> SPLIT<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> IHAPP<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_cil Int_Un_distrib2<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CASSOC IHAPP<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> SPLIT<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">st</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">cet</span><span class="main">)</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">wl</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">cet</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="skolem">st</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w21</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_cil<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> right IHAPP<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span><span class="main">=</span><span class="main">{#</span><span class="skolem">st</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">cet</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce'</span><span class="main">=</span><span class="skolem">ce21'</span><span class="main">+</span><span class="main">(</span><span class="skolem">ce1'</span><span class="main">+</span><span class="skolem">ce22'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>6<span class="main">)</span> CASSOC<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ConstraintSystems">
<div class="head">
<h1>Theory ConstraintSystems</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Constraint Systems
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Constraint Systems"</span></span>
<span class="keyword1"><span class="command">theory</span></span> ConstraintSystems
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="AcquisitionHistory.html">AcquisitionHistory</a> <a href="Normalization.html">Normalization</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:ConstraintSystems}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we develop a constraint-system-based characterization of our analysis. 
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Constraint systems are widely used in static program analysis. There least solution describes the desired analysis information. In its generic form, a constraint system $R$ is a set of inequations over
  a complete lattice $(L,\sqsubseteq)$ and a set of variables $V$. An inequation has the form $ R[v] \sqsupseteq {\sf rhs}$, where $R[v]\in V$ and ${\sf rhs}$ is a monotonic function over the variables. 
  Note that for program analysis, there is usually one variable per control point. The variables are then named $R[v]$, where $v$ is a control point.
  By standard fixed-point theory, those constraint systems have a least solution. Outside the constraint system definition $R[v]$ usually refers to a component of that least solution.

  Usually a constraint system is generated from the program. For example, a constraint generation pattern could be the following:
  $$
    \begin{array}{lcl}
      \multicolumn{3}{l}{\mbox{for $(u,{\sf Call}~q,v)\in E$:}} \\ 
        S^k[v] &amp; \supseteq &amp; \{({\sf mon}(q)\cup M\cup M',\tilde P) \mid (M,P)\in S^k[u] \wedge (M',P')\in S^k[{\sf r}_q] \\&amp;&amp;\wedge~\tilde P \le P \uplus P' \wedge |\tilde P| \le 2 \} \\
    \end{array}
  $$

  For some parameter $k$ and a flowgraph with nodes $N$ and edges $E$, this generates a constraint system over the variables $\{ S^k[v] \mid v\in N \}$. One constraint is generated for each call edge. While we use
  a powerset lattice here, we can in general use any complete lattice. However, all the constraint systems needed for our conflict analysis are defined over powerset lattices $(\mathcal P('a), \subseteq)$ for some type $'a$. 
  This admits a convenient formalization in Isabelle/HOL using inductively defined sets. We inductively define a relation between variables\footnote{Variables are identified by control nodes here} and the elements of their values 
  in the least solution, i.e. the set $\{ (v,x) \mid x\in R[v] \}$. For example, the constraint generator pattern from above would become the following introduction rule in the inductive definition of the set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S_cs fg k›</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> [display] <span class="raw_text"><span class="raw_text">"⟦(u,Call q,v)∈edges fg; (u,M,P)∈S_cs fg k; 
              (return fg q,Ms,Ps)∈S_cs fg k; P'⊆#P+Ps; size P' ≤ k ⟧ 
             ⟹ (v,mon fg q ∪ M ∪ Ms,P')∈S_cs fg k"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  The main advantage of this approach is that one gets a concise formalization by using Isabelle's standard machinery, the main disadvantage is that this approach only works for powerset lattices ordered by $\subseteq$.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Same-level paths"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a constraint system that collects abstract information about same-level paths. In particular, we collect the set of used monitors and all multi-subsets of spawned threads 
  that are not bigger than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> elements, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a parameter that can be freely chosen. 
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An element <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(u,M,P)∈S_cs fg k›</span></span></span></span> means that there is a same-level path from the entry node of the procedure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, that uses the monitors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and spawns at least the threads in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">S_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> nat <span class="main">⇒</span> 
             <span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'m</span> set <span class="main">×</span> <span class="tfree">'p</span> multiset<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span> <span class="entity">k</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    S_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span>"</span></span> 
  <span class="main">|</span> S_base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Base <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span>"</span></span> 
  <span class="main">|</span> S_call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span><span class="main">;</span> 
              <span class="main">(</span>return <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ms</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">⊆#</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">;</span> size <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟧</span>
             <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span>mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ms</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span>"</span></span> 
  <span class="main">|</span> S_spawn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Spawn <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span><span class="main">;</span> 
               <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">⊆#</span><span class="main">{#</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">#}</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span> size <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">≤</span> <span class="free">k</span><span class="main">⟧</span>
             <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">S_cs</span> <span class="free">fg</span> <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The intuition underlying this constraint system is the following: The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_init<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint describes that the procedures entry node can be reached with the empty path, that has no monitors and spawns no procedures. 
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_base<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint describes that executing a base edge does not use monitors or spawn threads, so each path reaching the start node of the base edge also induces a path reaching the end node of the base edge
  with the same set of monitors and the same set of spawned threads. 
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_call<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint models the effect of a procedure call. If there is a path to the start node of a call edge and a same-level path through the procedure, this also induces a path to the end
  node of the call edge. This path uses the monitors of both path and spawns the threads that are spawned on both paths. Since we only record a limited subset of the spawned threads, we have to choose which of the 
  threads are recorded.
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_spawn<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint models the effect of a spawn edge. A path to the start node of the spawn edge induces a path to the end node that uses the same set of monitors and spawns the threads of the initial path
  plus the one spawned by the spawn edge. We again have to choose which of these threads are recorded.

›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness and Precision›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Soundness of the constraint system <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>S_cs›</span></span></span></span> means, that every same-level path has a corresponding entry in the constraint system.

  As usual the soundness proof works by induction over the length of execution paths. The base case (empty path) trivially follows from the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] S_init<span class="antiquote"><span class="antiquote">}</span></span></span></span> constraint. In the inductive case,
  we consider the edge that induces the last step of the path; for a return step, this is the corresponding call edge (cf. Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] flowgraph.trss_find_call'<span class="antiquote"><span class="antiquote">}</span></span></span></span>). With the induction hypothesis, we get
  the soundness for the (shorter) prefix of the path, and depending on the last step we can choose a constraint that implies soundness for the whole path.  
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> S_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">c'</span> <span class="bound">P</span><span class="main">.</span> 
  <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span><span class="main">;</span> 
    size <span class="bound">P</span><span class="main">≤</span><span class="free">k</span><span class="main">;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="bound">P</span> <span class="main">⊆#</span> <span class="bound">c'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span>mon_w <span class="free">fg</span> <span class="free">w</span><span class="main">,</span><span class="bound">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_rev_induct<span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_init<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">w</span> <span class="skolem">e</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">e</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_rev_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> SPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> trss_base <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LBase <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>Base <span class="skolem">a</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">with</span></span> snoc.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">c'</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_e <span class="free">fg</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S_base<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> trss_ret <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LRet"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">#</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> SPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> trss_find_call'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ut</span></span> <span class="skolem"><span class="skolem">ct</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> FC<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">w1</span><span class="main">@</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">w2</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">ut</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">ut</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">q</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ut</span><span class="main">,</span>Call <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">ct</span><span class="main">)</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> trss_drop_all_context<span class="main">[</span><span class="operator">OF</span> FC<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp'</span></span> <span class="keyword2"><span class="keyword">where</span></span> SLP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="skolem">ct</span><span class="main">+</span><span class="skolem">csp'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> FC<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">w1</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w2</span> <span class="main">≤</span> length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mset_map_split_orig_le SLP<span class="main">(</span>1<span class="main">)</span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="keyword2"><span class="keyword">where</span></span> PSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="skolem">P1</span><span class="main">+</span><span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P1</span> <span class="main">⊆#</span> <span class="skolem">ct</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P2</span> <span class="main">⊆#</span> <span class="skolem">csp'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> PSIZE<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">P1</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P2</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> snoc.hyps<span class="main">[</span><span class="operator">OF</span> LEN<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> FC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> PSIZE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> PSPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> snoc.hyps<span class="main">[</span><span class="operator">OF</span> LEN<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> SLP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> PSIZE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> PSPLIT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ut</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">P1</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> S_call<span class="main">[</span><span class="operator">OF</span> FC<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> IHAPP subset_mset.eq_refl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> PSPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> FC<span class="main">(</span>1<span class="main">)</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc Un_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> trss_spawn <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span>LSpawn <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span><span class="main">=</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>Spawn <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mset_map_split_orig_le CASE<span class="main">(</span>3<span class="main">)</span> snoc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="keyword2"><span class="keyword">where</span></span> PSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="skolem">P1</span><span class="main">+</span><span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P1</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P2</span> <span class="main">⊆#</span> <span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> PSIZE<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">P2</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> snoc.hyps<span class="main">[</span><span class="operator">OF</span> _ _ PSIZE PSPLIT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> SPLIT<span class="main">(</span>1<span class="main">)</span> CASE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span>mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span><span class="skolem">P2</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> PCOND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span><span class="main">+</span><span class="skolem">P2</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> PSPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P1</span><span class="main">⊆#</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_le_single_cases mset_map_single_rightE<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> PSPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> S_spawn<span class="main">[</span><span class="operator">OF</span> CASE<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> IHAPP PCOND snoc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> CASE<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Precision means that all entries appearing in the smallest solution of the constraint system are justified by some path in the operational characterization.
  For proving precision, one usually shows that a family of sets derived as an abstraction from the operational characterization solves all constraints.

  In our formalization of constraint systems as inductive sets this amounts to constructing for each constraint a justifying path for the entries described on the conclusion side of the implication -- under the assumption
  that corresponding paths exists for the entries mentioned in the antecedent.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> S_precise<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">c'</span> <span class="bound">w</span><span class="main">.</span> 
        <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
        size <span class="free">P</span><span class="main">≤</span><span class="free">k</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="bound">c'</span> <span class="main">∧</span>
        <span class="free">M</span><span class="main">=</span>mon_w <span class="free">fg</span> <span class="bound">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_cs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_init <span class="skolem">p</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_base <span class="skolem">u</span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">⊆#</span> <span class="skolem">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> S_base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">,</span>LBase <span class="skolem">a</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_base<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span>LBase <span class="skolem">a</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span><span class="main">=</span>mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span>LBase <span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_call <span class="skolem">u</span> <span class="skolem">q</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">Ms</span> <span class="skolem">Ps</span> <span class="skolem">P'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">csp1</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> REACHING_PATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">csp1</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">⊆#</span> <span class="skolem">csp1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> S_call <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csp2</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> SL_PATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="skolem">csp2</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">Ps</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">Ps</span> <span class="main">⊆#</span> <span class="skolem">csp2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ms</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trss_er_path_proc_const<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_c_no_mon<span class="main">[</span><span class="operator">OF</span> REACHING_PATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> trss_c_no_mon<span class="main">[</span><span class="operator">OF</span> SL_PATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> NOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">csp2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">@</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">w2</span><span class="main">@</span><span class="main">[</span>LRet<span class="main">]</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> REACHING_PATH<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> trss_call<span class="main">[</span><span class="operator">OF</span> S_call<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> NOMON <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">q</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> trss_add_context<span class="main">[</span><span class="operator">OF</span> trss_stack_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SL_PATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> NOMON <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">)</span><span class="main">,</span><span class="skolem">w2</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>return <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span><span class="main">)</span><span class="main">,</span>LRet<span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trss_ret<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> REACHING_PATH<span class="main">(</span>4<span class="main">)</span> SL_PATH<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">q</span> <span class="main">∪</span> <span class="skolem">M</span> <span class="main">∪</span> <span class="skolem">Ms</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">w1</span><span class="main">@</span>LCall <span class="skolem">q</span><span class="main">#</span><span class="skolem">w2</span><span class="main">@</span><span class="main">[</span>LRet<span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="main">(</span><span class="skolem">P'</span><span class="main">)</span> <span class="main">⊆#</span> <span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`#</span> <span class="skolem">P'</span> <span class="main">⊆#</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> image_mset_subseteq_mono<span class="main">[</span><span class="operator">OF</span> S_call<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`#</span> <span class="skolem">P'</span> <span class="main">⊆#</span> <span class="var">?f</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">+</span> <span class="var">?f</span> <span class="main">`#</span> <span class="skolem">Ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">OF</span> REACHING_PATH<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> SL_PATH<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> <span class="skolem">csp1</span><span class="main">+</span><span class="skolem">csp2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> S_call<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_spawn <span class="skolem">u</span> <span class="skolem">q</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">⊆#</span> <span class="skolem">c'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> IHAPP<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> S_spawn<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">,</span>LSpawn <span class="skolem">q</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span>add_mset <span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trss_spawn<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span>LSpawn <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> add_mset <span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span><span class="main">=</span>mon_w <span class="free">fg</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span>LSpawn <span class="skolem">q</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_w_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P'</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`#</span> <span class="main">_</span> <span class="main">⊆#</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> image_mset_subseteq_mono<span class="main">[</span><span class="operator">OF</span> S_spawn<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`#</span> <span class="skolem">P'</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?f</span> <span class="main">`#</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mset_subset_eq_mono_add<span class="main">[</span><span class="operator">OF</span> _ IHAPP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IHAPP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> S_spawn<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Finally we can state the soundness and precision as a single theorem›</span>  
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> S_sound_precise<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">c'</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    size <span class="free">P</span><span class="main">≤</span><span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">M</span><span class="main">=</span>mon_w <span class="free">fg</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_sound S_precise <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we present specialized soundness and precision lemmas, that reason over a macrostep (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ntrp <span class="free"><span class="free">fg</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) rather than a same-level path (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"trcl <span class="main"><span class="main">(</span></span>trss <span class="free"><span class="free">fg</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). They are tailored for the
  use in the soundness and precision proofs of the other constraint systems.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> S_sound_ntrp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">eel</span><span class="main">,</span><span class="main">(</span><span class="free">sh</span><span class="main">,</span><span class="free">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  CASE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">p</span> <span class="bound">u'</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="main">⟦</span>
    <span class="free">eel</span><span class="main">=</span>LOC <span class="main">(</span>LCall <span class="bound">p</span><span class="main">#</span><span class="bound">w</span><span class="main">)</span><span class="main">;</span> 
    <span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="bound">p</span><span class="main">,</span><span class="bound">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> 
    <span class="free">sh</span><span class="main">=</span><span class="main">[</span><span class="bound">v</span><span class="main">,</span><span class="bound">u'</span><span class="main">]</span><span class="main">;</span> 
    proc_of <span class="free">fg</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">p</span><span class="main">;</span> 
    mon_c <span class="free">fg</span> <span class="free">ch</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> 
                     <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> 
                     initialproc <span class="free">fg</span> <span class="bound">p</span><span class="main">;</span> 
    <span class="main">!!</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="bound">P</span> <span class="main">⊆#</span> <span class="free">ch</span> <span class="main">⟹</span>
                    <span class="main">(</span><span class="bound">v</span><span class="main">,</span>mon_w <span class="free">fg</span> <span class="bound">w</span><span class="main">,</span><span class="bound">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">(</span>size <span class="bound">P</span><span class="main">)</span>
  <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">Q</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ee</span></span> <span class="keyword2"><span class="keyword">where</span></span> EE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eel</span><span class="main">=</span>LOC <span class="skolem">ee</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="free">sh</span><span class="main">,</span><span class="free">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> gtrp.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="free">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ntrs_c_cases_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> EE<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> c_of_initial_no_mon <span class="keyword1"><span class="command">have</span></span> CHNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="free">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EE<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> FIRSTSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span><span class="main">=</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">,</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trss <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sh</span><span class="main">=</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="free">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ntrs.cases<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FIRSTSPLIT <span class="keyword1"><span class="command">have</span></span> EDGE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="skolem">p</span><span class="main">,</span><span class="skolem">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trss.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_bot_proc_const<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> FIRSTSPLIT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> PROC_OF_V<span class="main">:</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="bound">P</span> <span class="main">⊆#</span> <span class="free">ch</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span>mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span><span class="bound">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">(</span>size <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">⊆#</span> <span class="free">ch</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> S_sound<span class="main">[</span><span class="operator">OF</span> FIRSTSPLIT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> EE<span class="main">(</span>1<span class="main">)</span> FIRSTSPLIT<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> EDGE PROC_OF_V CHNOMON CHFMT <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> CASE<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> S_precise_ntrp<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
              P<span class="main">:</span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="free">v</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
           EDGE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span>Call <span class="free">p</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="bound">ch</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LOC <span class="main">(</span>LCall <span class="free">p</span><span class="main">#</span><span class="bound">w</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">,</span><span class="free">u'</span><span class="main">]</span><span class="main">,</span><span class="bound">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span> <span class="main">∧</span> 
    size <span class="free">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> 
    <span class="free">M</span><span class="main">=</span>mon_w <span class="free">fg</span> <span class="bound">w</span> <span class="main">∧</span> 
    mon_n <span class="free">fg</span> <span class="free">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="free">p</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="bound">ch</span> <span class="main">∧</span>
    mon_c <span class="free">fg</span> <span class="bound">ch</span><span class="main">=</span><span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> P S_precise<span class="main">[</span><span class="operator">OF</span> ENTRY<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> trss_bot_proc_const<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wsl</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    SLPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wsl</span><span class="main">,</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="free">P</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="free">P</span> <span class="main">⊆#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> trss_bot_proc_const<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON_V<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="free">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_c_cases<span class="main">[</span><span class="operator">OF</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> c_of_initial_no_mon <span class="keyword1"><span class="command">have</span></span> CHNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹From the constraints prerequisites, we can construct the first step›</span>
  <span class="keyword1"><span class="command">have</span></span> FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LCall <span class="free">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">,</span><span class="free">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ntrs_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> EDGE <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LCall <span class="free">p</span><span class="main">,</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="free">p</span><span class="main">,</span> <span class="free">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_call<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> FSP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LOC <span class="main">(</span>LCall <span class="free">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="free">v</span><span class="main">,</span><span class="free">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp_loc<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> FSP SLPATH<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> CHNOMON MON_V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Single reaching path"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we define a constraint system that collects abstract information of paths reaching a control node at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  The path starts with a single initial thread. The collected information are the monitors used by the steps of the initial thread, 
  the monitors used by steps of other threads and the acquisition history of the path. To distinguish the steps of the initial thread 
  from steps of other threads, we use the loc/env-semantics (cf. Section~\ref{sec:ThreadTracking:exp_local}).
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Constraint system"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">Ml</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">Me</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">h</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">RU_cs</span></span> <span class="free"><span class="free">fg</span></span> <span class="free"><span class="free">U</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponds to a path from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{#</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">#}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to some configuration at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  that uses monitors from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Ml</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the steps of the initial thread, monitors from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Me</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the steps of other threads and
  has acquisition history <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 

  Here, the correspondence between paths and entries included into the inductively defined set is not perfect but strong enough for our purposes:
  While each constraint system entry corresponds to a path, not each path corresponds to a constraint system entry. But for each path reaching a configuration at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we find
  an entry with less or equal monitors and an acquisition history less or equal to the acquisition history of the path. 
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">RU_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> <span class="tfree">'n</span> set <span class="main">⇒</span> 
              <span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'m</span> set <span class="main">×</span> <span class="tfree">'m</span> set <span class="main">×</span> <span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'m</span> set<span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span> <span class="entity">U</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    RU_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">∈</span><span class="free">U</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">{}</span><span class="main">)</span><span class="main">∈</span><span class="free">RU_cs</span> <span class="free">fg</span> <span class="free">U</span>"</span></span>
  <span class="main">|</span> RU_call<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">0</span><span class="main">;</span> 
                <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RU_cs</span> <span class="free">fg</span> <span class="free">U</span><span class="main">;</span> mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span> ah_update <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">)</span> 
        <span class="main">∈</span> <span class="free">RU_cs</span> <span class="free">fg</span> <span class="free">U</span>"</span></span>
  <span class="main">|</span> RU_spawn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">1</span><span class="main">;</span> 
                 <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RU_cs</span> <span class="free">fg</span> <span class="free">U</span><span class="main">;</span> 
                 <span class="main">(</span>mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span> ah_update <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">∈</span> <span class="free">RU_cs</span> <span class="free">fg</span> <span class="free">U</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The constraint system works by tracking only a single thread. Initially, there is just one thread, and from this thread we reach a configuration at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. After a macrostep, we have the
  transformed initial thread and some spawned threads. The key idea is, that the actual node <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached by just one of these threads. The steps of the other threads are useless
  for reaching <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Because of the nice properties of normalized paths, we can simply prune those steps from the path.

  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_init<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint reflects that we can reach a control node from itself with the empty path. 
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_call<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint describes the case that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from the initial thread, and the 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_spawn<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint describes the case that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from one of the spawned threads. In the two latter cases, we 
  have to check whether prepending the macrostep to the reaching path is allowed or not due to monitor restrictions. In the call case, the procedure 
  of the initial node must not own monitors that are used in the environment steps of the appended reaching path (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mon_n fg u ∩ Me = {}›</span></span></span></span>). 
  As we only test disjointness with the set of monitors used by the environment, reentrant monitors can be handled. 
  In the spawn case, we have to check disjointness with both, the monitors of local and environment steps of the
  reaching path from the spawned thread, because from the perspective of the initial thread, all these steps are environment steps (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(mon_n fg u ∪ mon fg p) ∩ (Ml ∪ Me)={}›</span></span></span></span>). 
  Note that in the call case, we do not need to explicitly check that the monitors used by the environment are disjoint from the monitors acquired by the called procedure because this already follows from the existence
  of a reaching path, as the starting point of this path already holds all these monitors. 

  However, in the spawn case, we have to check for both the monitors of the start node and of the called procedure to be compatible with
  the already known reaching path from the entry node of the spawned thread.
›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Soundness and precision"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma intuitively states:
  {\em If we can reach a configuration that is at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from some start configuration, then there is a single thread in the start configuration that 
  can reach a configuration at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with a subword of the original path}. 

  The proof follows from Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] flowgraph.ntr_reverse_split<span class="antiquote"><span class="antiquote">}</span></span></span></span> rather directly.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> ntr_reverse_split_atU<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          A<span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">w'</span> <span class="bound">c1'</span><span class="main">.</span> 
           <span class="bound">s</span> <span class="main">∈#</span> <span class="free">c</span> <span class="main">∧</span> <span class="bound">w'</span><span class="main">≼</span><span class="free">w</span> <span class="main">∧</span> <span class="bound">c1'</span> <span class="main">⊆#</span> <span class="free">c'</span> <span class="main">∧</span>
           atU <span class="free">U</span> <span class="bound">c1'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s</span><span class="main">#}</span><span class="main">,</span><span class="bound">w'</span><span class="main">,</span><span class="bound">c1'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ui</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">=</span><span class="main">{#</span><span class="skolem">ui</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ui</span><span class="main">∈</span><span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> atU_fmt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_contains_eq<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ntr_reverse_split<span class="main">[</span><span class="operator">OF</span> _ V<span class="main">]</span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ce</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">ce1'</span></span> <span class="skolem"><span class="skolem">ce2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce'</span><span class="main">=</span><span class="skolem">ce1'</span><span class="main">+</span><span class="skolem">ce2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">s</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">ui</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ce1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> C'FMT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈#</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">≼</span><span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">ui</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce1'</span> <span class="main">⊆#</span> <span class="free">c'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">ui</span><span class="main">#</span><span class="skolem">r</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce1'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cil_ileq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> RSPLIT<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next lemma shows the soundness of the RU constraint system.

  The proof works by induction over the length of the reaching path. For the empty path, the proposition follows by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_init<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint. 
  For a non-empty path, we consider the first step.
  It has transformed the initial thread and may have spawned some other threads. From the resulting configuration, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached. 
  Due to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "flowgraph.ntr_split"<span class="antiquote"><span class="antiquote">}</span></span></span></span> we get two interleavable paths from the rest of the original path, one from the transformed initial thread and one from the spawned threads. 
  We then distinguish two cases: if the first path reaches <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>, the proposition follows by the induction hypothesis and the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_call<span class="antiquote"><span class="antiquote">}</span></span></span></span> constraint. 
  
  Otherwise, we use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "flowgraph.ntr_reverse_split_atU"<span class="antiquote"><span class="antiquote">}</span></span></span></span> to identify the thread that actually reaches <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> among all the spawned threads. Then we 
  apply the induction hypothesis to the path of that thread and prepend the first step using the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] RU_spawn<span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint.
  
  The main complexity of the proof script below results from fiddling with the monitors and converting between the multiset-and loc/env-semantics. 
  Also the arguments to show that the acquisition histories are sound approximations require some space.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> RU_sound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">s'</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="bound">s'</span> <span class="bound">c'</span><span class="main">)</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Ml</span> <span class="bound">Me</span> <span class="bound">h</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">Ml</span><span class="main">,</span><span class="bound">Me</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span> <span class="main">∧</span> 
    <span class="bound">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">∧</span> 
    <span class="bound">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="free">w</span> <span class="main">∧</span> 
    <span class="bound">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹The proof works by induction over the length of the reaching path›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_induct<span class="main">)</span> 
  <span class="comment1">― ‹For a reaching path of length zero, the proposition follows immediately by the constraint <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] RU_init<span class="antiquote">}</span></span>›</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RU_init<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">eel</span> <span class="skolem">wwl</span><span class="main">)</span> 
  <span class="comment1">― ‹For a non-empty path, we regard the first step and the rest of the path›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">eel</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">wwl</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="comment1">― ‹The first step consists of an initial call and a same-level path›</span>
    FS_FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eel</span> <span class="main">=</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Call <span class="skolem">p</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="comment1">― ‹The only environment threads after the first step are the threads that where spawned by the first step›</span>
    <span class="keyword2"><span class="keyword">and</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span>Spawn <span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span>
    <span class="comment1">― ‹For the same-level path, we find a corresponding entry in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"S_cs"</span><span class="antiquote">}</span></span>-constraint system›</span>
    <span class="keyword2"><span class="keyword">and</span></span> S_ENTRY_PAT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="bound">P</span> <span class="main">⊆#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">(</span>size <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S_sound_ntrp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> HVALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sh</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">ch</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">― ‹We split the remaining path by the local thread and the spawned threads, getting two interleavable paths, one from the local thread and one from the spawned threads›</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?c1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ntrp_valid_preserve_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    LESPLIT<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">wwl</span><span class="main">∈</span><span class="skolem">w1</span>⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="skolem">w2</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="skolem">c2'</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ch</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹We make a case distinction whether <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> was reached from the local thread or from the spawned threads›</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> LESPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c1'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> atU_union_cases<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> left <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> was reached from the local thread›</span>
    <span class="keyword1"><span class="command">from</span></span> cil_ileq<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ILEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">≼</span><span class="skolem">wwl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">w1</span> <span class="main">≤</span> length <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_list_length<span class="main">)</span>
    <span class="comment1">― ‹We can cut off the bottom stack symbol from the reaching path (as always possible for normalized paths)›</span>
    <span class="keyword1"><span class="command">from</span></span> FS_FMT<span class="main">(</span>3<span class="main">)</span> LESPLIT<span class="main">(</span>3<span class="main">)</span> ntrp_stack_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">c1'</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> DECOMP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">=</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">@</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">,</span><span class="skolem">c1'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">― ‹This does not affect the configuration being at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">from</span></span> atU_xchange_stack left DECOMP<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ATU<span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">)</span> <span class="skolem">c1'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="comment1">― ‹Then we can apply the induction hypothesis to get a constraint system entry for the path›</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> LEN DECOMP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ATU<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">Ml</span><span class="main">,</span><span class="skolem">Me</span><span class="main">,</span><span class="skolem">h</span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="comment1">― ‹Next, we have to apply the constraint <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] RU_call<span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">from</span></span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> MON_U_ME<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∩</span> <span class="skolem">Me</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntrp_mon_env_w_no_ctx<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">wwl</span> <span class="main">∩</span> mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> mon_env_ileq<span class="main">[</span><span class="operator">OF</span> ILEQ<span class="main">]</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> RU_call<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> S_ENTRY IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> MON_U_ME<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">,</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="comment1">― ‹Then we assemble the rest of the proposition, that are the monitor restrictions and the acquisition history restriction›</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_loc_ileq<span class="main">[</span><span class="operator">OF</span> ILEQ<span class="main">]</span> IHAPP<span class="main">(</span>2<span class="main">)</span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_env_ileq<span class="main">[</span><span class="operator">OF</span> ILEQ<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">≤</span> ah_update <span class="main">(</span>αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">eel</span><span class="main">)</span> <span class="main">(</span>mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ah_update_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> αah_ileq<span class="main">[</span><span class="operator">OF</span> le_list_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ILEQ<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> αnl <span class="free">fg</span> <span class="skolem">eel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">⊆</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_of_αnl<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mon_pl_ileq<span class="main">[</span><span class="operator">OF</span> le_list_map<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ILEQ<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">⊆</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> right <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> was reached from the spawned threads›</span>
    <span class="keyword1"><span class="command">from</span></span> cil_ileq<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> le_list_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map ENV <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wwl</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ILEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"map ENV <span class="skolem">w2</span><span class="main">≼</span><span class="skolem">wwl</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LEN<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">w2</span> <span class="main">≤</span> length <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HVALID <span class="keyword1"><span class="command">have</span></span> CHVALID<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">fg</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">sh</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span>
      <span class="comment1">― ‹We first identify the actual thread from that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> was reached›</span>
    <span class="keyword1"><span class="command">from</span></span> ntr_reverse_split_atU<span class="main">[</span><span class="operator">OF</span> CHVALID<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> right LESPLIT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="skolem"><span class="skolem">cr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wr</span><span class="main">≼</span><span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cr'</span><span class="main">⊆#</span><span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="skolem">cr'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">wr</span><span class="main">,</span><span class="skolem">cr'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> CHFMT<span class="main">)</span>
      <span class="comment1">― ‹In order to apply the induction hypothesis, we have to convert the reaching path to loc/env semantics›</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> RI<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr'</span></span> <span class="skolem"><span class="skolem">cre'</span></span> <span class="skolem"><span class="skolem">wwr</span></span> <span class="keyword2"><span class="keyword">where</span></span> RI_NTRP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cr'</span><span class="main">=</span>add_mset <span class="skolem">sr'</span> <span class="skolem">cre'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wr</span><span class="main">=</span>map le_rem_s <span class="skolem">wwr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">wwr</span><span class="main">,</span><span class="main">(</span><span class="skolem">sr'</span><span class="main">,</span><span class="skolem">cre'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> LEN le_list_length<span class="main">[</span><span class="operator">OF</span> RI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> RI_NTRP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> LEN'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">wwr</span> <span class="main">≤</span> length <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">― ‹The induction hypothesis yields a constraint system entry›</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> LEN' RI_NTRP<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> RI_NTRP<span class="main">(</span>1<span class="main">)</span> RI<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">wwr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">wwr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="comment1">― ‹We also have an entry in the same-level path constraint system that contains the thread from that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">U</span></span><span class="antiquote">}</span></span> was reached›</span>
    <span class="keyword1"><span class="command">from</span></span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> RI<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="comment1">― ‹Before we can apply the  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] RU_spawn<span class="antiquote">}</span></span>-constraint, we have to analyze the monitors›</span>
    <span class="keyword1"><span class="command">have</span></span> MON_MLE_ENV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">wwr</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="skolem">wwr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mon_ww_of_le_rem<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> RI_NTRP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mon_ww <span class="free">fg</span> <span class="skolem">wr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mon_env_ileq<span class="main">[</span><span class="operator">OF</span> ILEQ<span class="main">]</span> mon_ww_ileq<span class="main">[</span><span class="operator">OF</span> RI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> MON_UP_MLE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntrp_mon_env_w_no_ctx<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> FS_FMT<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> edges_part<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> mon_env <span class="free">fg</span> <span class="skolem">wwl</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> MON_MLE_ENV <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹Finally we can apply the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] RU_spawn<span class="antiquote">}</span></span>-constraint that yields us an entry for the reaching path from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">u</span></span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">from</span></span> RU_spawn<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> S_ENTRY _ IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> MON_UP_MLE<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">,</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="comment1">― ‹Next we have to assemble the rest of the proposition›</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> MON_MLE_ENV <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span><span class="skolem">eel</span><span class="main">#</span><span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹Only the proposition about the acquisition histories needs some more work›</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> MAP_HELPER<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwr</span> <span class="main">≼</span> map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> RI_NTRP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwr</span> <span class="main">=</span> map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">wr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> le_list_map<span class="main">[</span><span class="operator">OF</span> RI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≼</span> map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> le_list_map<span class="main">[</span><span class="operator">OF</span> ILEQ<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≼</span> map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">≤</span> ah_update <span class="main">(</span>αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>αnl <span class="free">fg</span> <span class="skolem">eel</span><span class="main">)</span> <span class="main">(</span>mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ah_update_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> αah_ileq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MAP_HELPER<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> αnl <span class="free">fg</span> <span class="skolem">eel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> mon_pl_ileq<span class="main">[</span><span class="operator">OF</span> MAP_HELPER<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">⊆</span> mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">wwl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_of_αnl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we prove a statement about the precision of the least solution. As in the precision proof of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"S_cs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> constraint system, we construct a path for the entry on the conclusion side of each constraint, assuming
  that there already exists paths for the entries mentioned in the antecedent.

  We show that each entry in the least solution corresponds exactly to some executable path, and is not just an under-approximation of a path; while for the soundness direction, we could only show that every executable path is 
  under-approximated. The reason for this is that in effect, the constraint system prunes the steps of threads that are not needed to reach the control point. However, each pruned path is executable. 
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> RU_precise<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">Ml</span><span class="main">,</span><span class="free">Me</span><span class="main">,</span><span class="free">h</span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span> <span class="bound">s'</span> <span class="bound">c'</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">c'</span><span class="main">)</span> <span class="main">∧</span> 
    mon_loc <span class="free">fg</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">Ml</span> <span class="main">∧</span> 
    mon_env <span class="free">fg</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">Me</span> <span class="main">∧</span> 
    αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="bound">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RU_cs.induct<span class="main">)</span>
  <span class="comment1">― ‹The <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"RU_init"</span><span class="antiquote">}</span></span> constraint is trivially covered by the empty path›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RU_init <span class="skolem">u</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Call constraint›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RU_call <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">Ml</span> <span class="skolem">Me</span> <span class="skolem">h</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RU_call.hyps<span class="main">(</span>2<span class="main">)</span> S_precise<span class="main">[</span><span class="operator">OF</span> RU_call.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> trss_bot_proc_const<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wsl</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    SLPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wsl</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> trss_c_cases<span class="main">[</span><span class="operator">OF</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> c_of_initial_no_mon <span class="keyword1"><span class="command">have</span></span> CHNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="comment1">― ‹From the constraints prerequisites, we can construct the first step›</span>
  <span class="keyword1"><span class="command">have</span></span> FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ntrs_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> RU_call.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_call<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> FSP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp_loc<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> 
    <span class="comment1">― ‹The rest of the path comes from the induction hypothesis, after adding the rest of the threads to the context›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ntrp_add_context<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ntrp_stack_comp<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> IHAPP<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">u'</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cn<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ch</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> RU_call.hyps<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">u'</span> <span class="main">∩</span> mon_env <span class="free">fg</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_n_def edges_part<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CHNOMON <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="comment1">― ‹It is straightforward to show that the new path satisfies the required properties for its monitors and acquisition history›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span> <span class="skolem">s'</span><span class="main">@</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span> <span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c'</span><span class="main">+</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span> <span class="main">∪</span> <span class="skolem">Ml</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SLPATH<span class="main">(</span>2<span class="main">)</span> IHAPP<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ah_update <span class="main">(</span>αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">(</span>mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SLPATH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_of_αnl<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_of_αnl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Spawn constraint›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RU_spawn <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">q</span> <span class="skolem">Ml</span> <span class="skolem">Me</span> <span class="skolem">h</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RU_spawn.hyps<span class="main">(</span>2<span class="main">)</span> S_precise<span class="main">[</span><span class="operator">OF</span> RU_spawn.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> trss_bot_proc_const<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wsl</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    SLPATH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wsl</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>trss <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="skolem">P</span> <span class="main">⊆#</span> <span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> RU_spawn.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">che</span></span> <span class="keyword2"><span class="keyword">where</span></span> PFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span> <span class="main">=</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mset_size_le1_cases mset_le_addE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trss_c_cases<span class="main">[</span><span class="operator">OF</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> c_of_initial_no_mon <span class="keyword1"><span class="command">have</span></span> CHNOMON<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrs <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ntrs_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> RU_spawn.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LCall <span class="skolem">p</span><span class="main">,</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> trss <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trss_call<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> SLPATH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> FSP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span><span class="main">#</span><span class="skolem">wsl</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gtrp_loc<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RU_spawn.hyps<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">∪</span> mon_n <span class="free">fg</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∩</span> mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_n_def edges_part<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ntr2ntrp<span class="main">[</span><span class="operator">OF</span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">che</span></span><span class="main">]</span> PFMT<span class="main">(</span>2<span class="main">)</span> CHNOMON <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac mon_c_unconc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">che</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SLPATH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ah_update <span class="main">(</span>αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">(</span>mon_pl <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ah_update_cons o_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ah_update <span class="skolem">h</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SLPATH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">wsl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IHAPP<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_pl <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_pl_of_αnl αn_αnl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Simultaneously reaching path"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we define a constraint system that collects abstract information for paths starting at a single control node and reaching two program points simultaneously, one from a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and one from a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Constraint system"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">Ml</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">Me</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">RUV_cs</span></span> <span class="free"><span class="free">fg</span></span> <span class="free"><span class="free">U</span></span> <span class="free"><span class="free">V</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means, that there is a path from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{#</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">#}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to some configuration that is simultaneously at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  That path uses monitors from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Ml</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the first thread and monitors from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Me</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the other threads.
›</span></span>
<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">RUV_cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'ba</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> flowgraph_rec_scheme <span class="main">⇒</span> 
             <span class="tfree">'n</span> set <span class="main">⇒</span> <span class="tfree">'n</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'m</span> set <span class="main">×</span> <span class="tfree">'m</span> set<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">fg</span> <span class="entity">U</span> <span class="entity">V</span>
<span class="keyword2"><span class="keyword">where</span></span>
    RUV_call<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">0</span><span class="main">;</span> 
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span><span class="main">;</span> mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span>
  <span class="main">|</span> RUV_spawn<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">1</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span> 
         <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span><span class="main">;</span> 
         <span class="main">(</span>mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span>
  <span class="main">|</span> RUV_split_le<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">1</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span> 
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span><span class="main">;</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">V</span><span class="main">;</span> 
         <span class="main">(</span>mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">[*]</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml'</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span>
  <span class="main">|</span> RUV_split_el<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="main">1</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span> 
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">V</span><span class="main">;</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span><span class="main">;</span> 
         <span class="main">(</span>mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">[*]</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Me</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Ml'</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span>
  <span class="main">|</span> RUV_split_ee<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span>Call <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span><span class="main">∈</span>edges <span class="free">fg</span><span class="main">;</span> proc_of <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">∈</span>S_cs <span class="free">fg</span> <span class="numeral">2</span><span class="main">;</span> 
         <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">#}</span> <span class="main">⊆#</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">;</span>
         <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">U</span><span class="main">;</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">∈</span>RU_cs <span class="free">fg</span> <span class="free">V</span><span class="main">;</span> 
         <span class="main">(</span>mon_n <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">[*]</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> mon <span class="free">fg</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Ml</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Ml'</span></span></span><span class="main">∪</span><span class="free"><span class="bound"><span class="entity">Me'</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">RUV_cs</span> <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The idea underlying this constraint system is similar to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">RU_cs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint system for reaching a single node set. 
  Initially, we just track one thread. After a macrostep, we have a configuration consisting of the transformed initial thread and the spawned threads.
  From this configuration, we reach two nodes simultaneously, one in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and one in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Each of these nodes is reached by just a single thread. The constraint system
  contains one constraint for each case how these threads are related to the initial and the spawned threads:

  \begin{description}
    \item[RUV\_call] Both, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are reached from the initial thread.
    \item[RUV\_spawn] Both, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are reached from a single spawned thread.
    \item[RUV\_split\_le] <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from the initial thread, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from a spawned thread.
    \item[RUV\_split\_el] <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from the initial thread, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is reached from a spawned thread.
    \item[RUV\_split\_ee] Both, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">V</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are reached from different spawned threads.
  \end{description}

  In the latter three cases, we have to analyze the interleaving of two paths each reaching a single control node. This is done via the acquisition history
  information that we collected in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">RU_cs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>-constraint system.

  Note that we do not need an initializing constraint for the empty path, as a single configuration cannot simultaneously be at two control nodes.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness and precision›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> RUV_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">u</span> <span class="bound">s'</span> <span class="bound">c'</span><span class="main">.</span> 
  <span class="main">⟦</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="free">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span><span class="main">;</span> atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">c'</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Ml</span> <span class="bound">Me</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">Ml</span><span class="main">,</span><span class="bound">Me</span><span class="main">)</span><span class="main">∈</span>RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span> <span class="main">∧</span> 
    <span class="bound">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="free">w</span> <span class="main">∧</span> 
    <span class="bound">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="free">w</span>"</span></span>
<span class="comment1">― ‹The soundness proof is done by induction over the length of the reaching path›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_compl_induct<span class="main">)</span>
  <span class="comment1">― ‹In case of the empty path, a contradiction follows because a single-thread configuration cannot simultaneously be at two control nodes›</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ee</span> <span class="skolem">ww</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">ee</span><span class="main">,</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span><span class="skolem">ch</span><span class="main">)</span><span class="main">,</span><span class="skolem">ww</span><span class="main">,</span><span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trcl_uncons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?c1.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ntrp_valid_preserve_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    LESPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ww</span> <span class="main">∈</span> <span class="skolem">w1</span> ⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span> map ENV <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">sh</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ch</span><span class="main">,</span> <span class="skolem">w2</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="main">(</span>map le_rem_s <span class="skolem">w1</span><span class="main">)</span> <span class="main">∩</span> mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">∩</span> mon_s <span class="free">fg</span> <span class="skolem">sh</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    FS_FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ee</span> <span class="main">=</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Call <span class="skolem">p</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"proc_of <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> CHFMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> Spawn <span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> edges <span class="free">fg</span> <span class="main">∧</span> initialproc <span class="free">fg</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S_ENTRY_PAT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="bound">p</span><span class="main">]</span><span class="main">)</span> <span class="main">`#</span> <span class="bound">P</span> <span class="main">⊆#</span> <span class="skolem">ch</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="bound">P</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">(</span>size <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S_sound_ntrp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_mon_env_w_no_ctx<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> FS_FMT<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> edges_part<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON_PU<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww</span> <span class="main">∩</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_n <span class="free">fg</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cil_ileq<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mon_loc_ileq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">ww</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> mon_env_ileq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">ww</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON1_LEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">w1</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">w1</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cil_ileq<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mon_env_ileq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map ENV <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="skolem">ww</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON2_LEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w2</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> LESPLIT<span class="main">(</span>3<span class="main">)</span> FS_FMT<span class="main">(</span>3<span class="main">)</span> ntrp_stack_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">c1'</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> DECOMP_LOC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">=</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">@</span><span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">w1</span><span class="main">,</span><span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span><span class="main">,</span><span class="skolem">c1'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> LESPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c1'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> atUV_union_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> left <span class="keyword1"><span class="command">with</span></span> DECOMP_LOC<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ATUV<span class="main">:</span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span> <span class="skolem">v'</span><span class="main">#</span><span class="skolem">rr</span> <span class="main">#}</span><span class="main">+</span><span class="skolem">c1'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ DECOMP_LOC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ATUV<span class="main">]</span> cil_length<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> RUV_call<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> S_ENTRY_PAT<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>3<span class="main">)</span> MON_PU MON1_LEQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> IHAPP<span class="main">(</span>2<span class="main">)</span> MON1_LEQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>3<span class="main">)</span> MON1_LEQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> right <span class="comment1">― ‹Both nodes are reached from the spawned threads, we have to further distinguish whether both nodes are reached from the same thread or from different threads›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R_STACKS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"atU_s <span class="free">U</span> <span class="skolem">s1'</span>"</span></span> <span class="quoted"><span class="quoted">"atU_s <span class="free">V</span> <span class="skolem">s2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> atUV_def<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ce2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C2'FMT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2'</span><span class="main">=</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_subset_eq_exists_conv union_ac<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="skolem"><span class="skolem">w21</span></span> <span class="skolem"><span class="skolem">w22</span></span> <span class="skolem"><span class="skolem">ce21'</span></span> <span class="skolem"><span class="skolem">ce22'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      REVSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">s2'</span> <span class="skolem">ce2'</span> <span class="main">=</span> <span class="skolem">ce21'</span><span class="main">+</span><span class="skolem">ce22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span><span class="skolem">w21</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w22</span>"</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">q</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w22</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∩</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">q</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w21</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w21</span><span class="main">,</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce21'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ceh</span><span class="main">,</span><span class="skolem">w22</span><span class="main">,</span><span class="skolem">ce22'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ntr_reverse_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ch</span></span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quoted"><span class="skolem">s1'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce2'</span>"</span></span><span class="main">]</span> ntrp_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> C2'FMT LESPLIT<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">seh</span></span> <span class="skolem"><span class="skolem">ceh</span></span> <span class="skolem"><span class="skolem">w21</span></span> <span class="skolem"><span class="skolem">w22</span></span> <span class="skolem"><span class="skolem">ce21'</span></span> <span class="skolem"><span class="skolem">ce22'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">{#</span><span class="skolem">seh</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce2'</span> <span class="main">=</span> <span class="skolem">ce21'</span><span class="main">+</span><span class="skolem">ce22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span><span class="skolem">w21</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w22</span>"</span></span> <span class="quoted"><span class="quoted">"mon_s <span class="free">fg</span> <span class="skolem">seh</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w22</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∩</span> <span class="main">(</span>mon_s <span class="free">fg</span> <span class="skolem">seh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w21</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">seh</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w21</span><span class="main">,</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce21'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ceh</span><span class="main">,</span><span class="skolem">w22</span><span class="main">,</span><span class="skolem">ce22'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> CHFMT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">seh</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">seh</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch</span><span class="main">=</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">s2'</span> <span class="skolem">ce2'</span> <span class="main">=</span> <span class="skolem">ce21'</span><span class="main">+</span><span class="skolem">ce22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span><span class="skolem">w21</span>⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="skolem">w22</span>"</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">q</span> <span class="main">∩</span> <span class="main">(</span>mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w22</span><span class="main">)</span><span class="main">=</span><span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ceh</span> <span class="main">∩</span> <span class="main">(</span>mon <span class="free">fg</span> <span class="skolem">q</span> <span class="main">∪</span> mon_ww <span class="free">fg</span> <span class="skolem">w21</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w21</span><span class="main">,</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce21'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ceh</span><span class="main">,</span><span class="skolem">w22</span><span class="main">,</span><span class="skolem">ce22'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
        <span class="comment1">― ‹For applying the induction hypothesis, it will be handy to have the reaching path in loc/env format:›</span>
    <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sq'</span></span> <span class="skolem"><span class="skolem">csp_q</span></span> <span class="skolem"><span class="skolem">ww21</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      R_CONV<span class="main">:</span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">s1'</span> <span class="skolem">ce21'</span> <span class="main">=</span> add_mset <span class="skolem">sq'</span> <span class="skolem">csp_q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w21</span> <span class="main">=</span> map le_rem_s <span class="skolem">ww21</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww21</span><span class="main">,</span> <span class="skolem">sq'</span><span class="main">,</span> <span class="skolem">csp_q</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">from</span></span> cil_ileq<span class="main">[</span><span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> mon_ww_ileq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w21</span></span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> mon_ww_ileq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w22</span></span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> MON2N_LEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w21</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w22</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> REVSPLIT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mset_unplusm_dist_cases<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> left' right'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left' <span class="comment1">― ‹Both nodes are reached from the same thread›</span>
      <span class="keyword1"><span class="command">have</span></span> ATUV<span class="main">:</span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">sq'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">csp_q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> right C2'FMT R_STACKS<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> left'<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R_CONV<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_mset_add_single atUV_union atU_add_mset union_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">OF</span> _ R_CONV<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ATUV<span class="main">]</span> cil_length<span class="main">[</span><span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> cil_length<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="keyword2"><span class="keyword">where</span></span> IHAPP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww21</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww21</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> REVSPLIT<span class="main">(</span>1<span class="main">)</span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> MON_COND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_ww <span class="free">fg</span> <span class="skolem">w21</span> <span class="main">=</span> mon_loc <span class="free">fg</span> <span class="skolem">ww21</span> <span class="main">∪</span> mon_env <span class="free">fg</span> <span class="skolem">ww21</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> MON2N_LEQ<span class="main">(</span>1<span class="main">)</span> MON_PU MON2_LEQ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> RUV_spawn<span class="main">[</span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> FS_FMT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> S_ENTRY _ IHAPP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> MON_COND<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IHAPP<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> R_CONV<span class="main">(</span>2<span class="main">)</span> MON2N_LEQ<span class="main">(</span>1<span class="main">)</span> MON2_LEQ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* TODO: Clean up monitor arguments *)</span>
      <span class="keyword3"><span class="command">case</span></span> right' <span class="comment1">― ‹The nodes are reached from different threads›</span>
      <span class="keyword1"><span class="command">from</span></span> R_STACKS<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ATUV<span class="main">:</span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span>add_mset <span class="skolem">sq'</span> <span class="skolem">csp_q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="skolem">ce22'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">-</span><span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> R_CONV<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> right'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="comment1">― ‹We have to reverse-split the second path again, to extract the second interesting thread›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">w22'</span></span> <span class="skolem"><span class="skolem">ce22e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> REVSPLIT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w22'</span><span class="main">≼</span><span class="skolem">w22</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce22e'</span> <span class="main">⊆#</span> <span class="skolem">ce22'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="skolem">ce22e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w22'</span><span class="main">,</span><span class="skolem">ce22e'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> ntr_reverse_split_atU<span class="main">[</span><span class="operator">OF</span> _ ATUV<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> REVSPLIT<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> ntrp_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> REVSPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sq''</span></span> <span class="skolem"><span class="skolem">w22'</span></span> <span class="skolem"><span class="skolem">ce22e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sq''</span> <span class="main">∈#</span> <span class="skolem">ceh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w22'</span><span class="main">≼</span><span class="skolem">w22</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ce22e'</span> <span class="main">⊆#</span> <span class="skolem">ce22'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="skolem">ce22e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="skolem">sq''</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w22'</span><span class="main">,</span><span class="skolem">ce22e'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> CHFMT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sq''</span></span><span class="main">]</span> REVSPLIT<span class="main">(</span>1<span class="main">)</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sq''</span><span class="main">=</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> REVSPLIT'<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sq''</span></span> <span class="skolem"><span class="skolem">ce22ee'</span></span> <span class="skolem"><span class="skolem">ww22'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R_CONV'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ce22e'</span> <span class="main">=</span> add_mset <span class="skolem">sq''</span> <span class="skolem">ce22ee'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w22'</span><span class="main">=</span>map le_rem_s <span class="skolem">ww22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="skolem">ww22'</span><span class="main">,</span><span class="main">(</span><span class="skolem">sq''</span><span class="main">,</span><span class="skolem">ce22ee'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="comment1">― ‹From the soundness of the RU-constraint system, we get the corresponding entries›</span>
      <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> R_CONV<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ATUV<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> RU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww21</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww21</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww21</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> R_CONV'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> REVSPLIT'<span class="main">(</span>4<span class="main">)</span> R_CONV'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml'</span></span> <span class="skolem"><span class="skolem">Me'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">,</span> <span class="skolem">Ml'</span><span class="main">,</span> <span class="skolem">Me'</span><span class="main">,</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml'</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww22'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww22'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">from</span></span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> REVSPLIT<span class="main">(</span>1<span class="main">)</span> REVSPLIT'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numerals<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RUV_split_ee<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> S_ENTRY _ RU<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> RV<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> MON_PU MON2_LEQ MON2N_LEQ R_CONV<span class="main">(</span>2<span class="main">)</span> R_CONV'<span class="main">(</span>2<span class="main">)</span> mon_ww_ileq<span class="main">[</span><span class="operator">OF</span> REVSPLIT'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> RU<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> RV<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> ah_interleavable1<span class="main">[</span><span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w21</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w22</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">[*]</span> <span class="skolem">h'</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule_tac</span> ah_leq_il<span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> RU<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww21</span> <span class="main">≼</span> map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w21</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww21</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w21</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> αah_ileq<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w21</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">note</span></span> RV<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww22'</span> <span class="main">≼</span> map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w22</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R_CONV'<span class="main">(</span>2<span class="main">)</span> REVSPLIT'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> le_list_map map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww22'</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w22</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> αah_ileq<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w22</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span><span class="main">#</span><span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RV<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> RU<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> mon_ww_ileq<span class="main">[</span><span class="operator">OF</span> REVSPLIT'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> MON2N_LEQ R_CONV<span class="main">(</span>2<span class="main">)</span> R_CONV'<span class="main">(</span>2<span class="main">)</span> MON2_LEQ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> lr <span class="comment1">― ‹The first node is reached from the local thread, the second one from a spawned thread›</span>
    <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> DECOMP_LOC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> lr<span class="main">(</span>1<span class="main">)</span> DECOMP_LOC<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> RU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml'</span></span> <span class="skolem"><span class="skolem">Me'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">,</span> <span class="skolem">Ml'</span><span class="main">,</span> <span class="skolem">Me'</span><span class="main">,</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="comment1">― ‹We have to extract the interesting thread from the spawned threads in order to get an entry in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">RU</span> <span class="free">fg</span> <span class="free">V</span>"</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">w2'</span></span> <span class="skolem"><span class="skolem">c2i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> REVSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2'</span><span class="main">≼</span><span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2i'</span> <span class="main">⊆#</span> <span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="skolem">c2i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w2'</span><span class="main">,</span><span class="skolem">c2i'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ntr_reverse_split_atU<span class="main">[</span><span class="operator">OF</span> _ lr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> LESPLIT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> ntrp_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> CHFMT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2i'</span></span> <span class="skolem"><span class="skolem">c2ie'</span></span> <span class="skolem"><span class="skolem">ww2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R_CONV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2i'</span><span class="main">=</span>add_mset <span class="skolem">s2i'</span> <span class="skolem">c2ie'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2'</span><span class="main">=</span>map le_rem_s <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww2'</span><span class="main">,</span> <span class="skolem">s2i'</span><span class="main">,</span> <span class="skolem">c2ie'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> R_CONV<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> REVSPLIT<span class="main">(</span>4<span class="main">)</span> R_CONV<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml'</span></span> <span class="skolem"><span class="skolem">Me'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">,</span> <span class="skolem">Ml'</span><span class="main">,</span> <span class="skolem">Me'</span><span class="main">,</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml'</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww2'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww2'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_ww_ileq<span class="main">[</span><span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2'</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> REVSPLIT<span class="main">(</span>2<span class="main">)</span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> le_list_map map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> αah_ileq <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> predicate2I<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that REVSPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> RV<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RUV_split_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> S_ENTRY _ RU<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> RV<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> MON_PU MON1_LEQ MON2_LEQ RU<span class="main">(</span>3<span class="main">)</span> RV<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> ah_interleavable1<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">[*]</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RU<span class="main">(</span>4<span class="main">)</span> RV<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ah_leq_il<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> MON1_LEQ RU<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> MON1_LEQ MON2_LEQ RU<span class="main">(</span>3<span class="main">)</span> RV<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rl <span class="comment1">― ‹The second node is reached from the local thread, the first one from a spawned thread. This case is symmetric to the previous one›</span>
    <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> DECOMP_LOC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">V</span></span><span class="main">]</span> rl<span class="main">(</span>1<span class="main">)</span> DECOMP_LOC<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> RV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml'</span></span> <span class="skolem"><span class="skolem">Me'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">,</span> <span class="skolem">Ml'</span><span class="main">,</span> <span class="skolem">Me'</span><span class="main">,</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="comment1">― ‹We have to extract the interesting thread from the spawned threads in order to get an entry in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">RU</span> <span class="free">fg</span> <span class="free">V</span>"</span><span class="antiquote">}</span></span>›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">w2'</span></span> <span class="skolem"><span class="skolem">c2i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> REVSPLIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span> <span class="main">∈#</span> <span class="skolem">ch</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2'</span><span class="main">≼</span><span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2i'</span> <span class="main">⊆#</span> <span class="skolem">c2'</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="skolem">c2i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="skolem">w2'</span><span class="main">,</span><span class="skolem">c2i'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ntr_reverse_split_atU<span class="main">[</span><span class="operator">OF</span> _ rl<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> LESPLIT<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> ntrp_valid_preserve_s<span class="main">[</span><span class="operator">OF</span> SPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> CHFMT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_unconc<span class="main">)</span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s2i'</span></span> <span class="skolem"><span class="skolem">c2ie'</span></span> <span class="skolem"><span class="skolem">ww2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> R_CONV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c2i'</span><span class="main">=</span>add_mset <span class="skolem">s2i'</span> <span class="skolem">c2ie'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2'</span><span class="main">=</span>map le_rem_s <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww2'</span><span class="main">,</span> <span class="skolem">s2i'</span><span class="main">,</span> <span class="skolem">c2ie'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> RU_sound<span class="main">[</span><span class="operator">OF</span> R_CONV<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> REVSPLIT<span class="main">(</span>4<span class="main">)</span> R_CONV<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml'</span></span> <span class="skolem"><span class="skolem">Me'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">,</span> <span class="skolem">Ml'</span><span class="main">,</span> <span class="skolem">Me'</span><span class="main">,</span> <span class="skolem">h'</span><span class="main">)</span> <span class="main">∈</span> RU_cs <span class="free">fg</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ml'</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="skolem">ww2'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww2'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww2'</span> <span class="main">⊆</span> mon_ww <span class="free">fg</span> <span class="skolem">w2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_ww_ileq<span class="main">[</span><span class="operator">OF</span> REVSPLIT<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2'</span><span class="main">)</span> <span class="main">≤</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> REVSPLIT<span class="main">(</span>2<span class="main">)</span> R_CONV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> le_list_map map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> αah_ileq <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> predicate2I<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that REVSPLIT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> S_ENTRY_PAT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> RU<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> S_ENTRY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> mon_w <span class="free">fg</span> <span class="skolem">w</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> S_cs <span class="free">fg</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> RUV_split_el<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FS_FMT<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> S_ENTRY _ RV<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> RU<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> MON_PU MON1_LEQ MON2_LEQ RV<span class="main">(</span>3<span class="main">)</span> RU<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mon_n <span class="free">fg</span> <span class="skolem">u</span> <span class="main">∪</span> mon <span class="free">fg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> ah_interleavable1<span class="main">[</span><span class="operator">OF</span> LESPLIT<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">[*]</span> αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="skolem">w2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">[*]</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RV<span class="main">(</span>4<span class="main">)</span> RU<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ah_leq_il<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> mon_w <span class="free">fg</span> <span class="skolem">w</span> <span class="main">∪</span> <span class="skolem">Ml</span> <span class="main">⊆</span> mon_loc <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS_FMT<span class="main">(</span>1<span class="main">)</span> MON1_LEQ RV<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span> <span class="main">⊆</span> mon_env <span class="free">fg</span> <span class="main">(</span><span class="skolem">ee</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> MON1_LEQ MON2_LEQ RV<span class="main">(</span>3<span class="main">)</span> RU<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> flowgraph<span class="main">)</span> RUV_precise<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">Ml</span><span class="main">,</span><span class="free">Me</span><span class="main">)</span><span class="main">∈</span>RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span> <span class="bound">s'</span> <span class="bound">c'</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> 
    atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="bound">s'</span><span class="main">#}</span><span class="main">+</span><span class="bound">c'</span><span class="main">)</span> <span class="main">∧</span> 
    mon_loc <span class="free">fg</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">Ml</span> <span class="main">∧</span> 
    mon_env <span class="free">fg</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">Me</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> RUV_cs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RUV_call <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">Ml</span> <span class="skolem">Me</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> S_precise_ntrp<span class="main">[</span><span class="operator">OF</span> RUV_call<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span>  <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="skolem">ch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> FS<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">ch</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ntrp_add_context<span class="main">[</span><span class="operator">OF</span> ntrp_stack_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ch</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> FS<span class="main">(</span>5<span class="main">)</span> IH<span class="main">(</span>4<span class="main">)</span> RUV_call.hyps<span class="main">(</span>6<span class="main">)</span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> edges_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUV_call.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c'</span> <span class="main">+</span> <span class="skolem">ch</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c'</span><span class="main">+</span><span class="skolem">ch</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span> <span class="main">∪</span> <span class="skolem">Ml</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">)</span> FS<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RUV_spawn <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">q</span> <span class="skolem">Ml</span> <span class="skolem">Me</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> S_precise_ntrp<span class="main">[</span><span class="operator">OF</span> RUV_spawn<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_size1elem<span class="main">[</span><span class="operator">OF</span> _ RUV_spawn<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">che</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">che</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span> <span class="main">+</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">che</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ntr2ntrp<span class="main">[</span><span class="operator">OF</span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">che</span></span><span class="main">]</span> IH<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> RUV_spawn<span class="main">(</span>7<span class="main">)</span> FS<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> edges_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUV_spawn<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_of_le_rem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span><span class="skolem">che</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">che</span><span class="main">+</span><span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RUV_split_le <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">q</span> <span class="skolem">Ml</span> <span class="skolem">Me</span> <span class="skolem">h</span> <span class="skolem">Ml'</span> <span class="skolem">Me'</span> <span class="skolem">h'</span><span class="main">)</span>
  <span class="comment1">― ‹Get paths from precision results›</span>
  <span class="keyword1"><span class="command">from</span></span> S_precise_ntrp<span class="main">[</span><span class="operator">OF</span> RUV_split_le<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_size1elem<span class="main">[</span><span class="operator">OF</span> _ RUV_split_le<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">che</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">che</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_le<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww1</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww1</span><span class="main">,</span> <span class="skolem">s1'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_le<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww2</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww2</span><span class="main">,</span> <span class="skolem">s2'</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Ml'</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Me'</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹Get combined path from the acquisition history interleavability, need to remap loc/env-steps in second path›</span>
  <span class="keyword1"><span class="command">from</span></span> P2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1<span class="main">(</span>5<span class="main">)</span> RUV_split_le<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="keyword2"><span class="keyword">where</span></span> IL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ww</span><span class="main">∈</span><span class="skolem">ww1</span>⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="main">(</span>map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ah_interleavable2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="comment1">― ‹Use the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] ntrp_unsplit<span class="antiquote">}</span></span>-theorem to combine the executions›</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_unsplit<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ca<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span><span class="operator">OF</span> IL P1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s1'</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> RUV_split_le<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_of_le_rem P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_add_context<span class="main">[</span><span class="operator">OF</span> ntrp_stack_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">che</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> edges_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUV_split_le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> mon_loc_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> mon_env_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> FS<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> RUV_split_le<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc P1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> FS<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>2<span class="main">)</span> P2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span> <span class="main">∪</span> <span class="skolem">Ml</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>3<span class="main">)</span> P1<span class="main">(</span>3<span class="main">)</span> mon_loc_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>4<span class="main">)</span> P2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> mon_env_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RUV_split_el <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">q</span> <span class="skolem">Ml</span> <span class="skolem">Me</span> <span class="skolem">h</span> <span class="skolem">Ml'</span> <span class="skolem">Me'</span> <span class="skolem">h'</span><span class="main">)</span> <span class="comment1">― ‹This is the symmetric case to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"RUV_split_le"</span><span class="antiquote">}</span></span>, it is proved completely analogously, just need to swap <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">U</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">V</span><span class="antiquote">}</span></span>.›</span>
  <span class="comment1">― ‹Get paths from precision results›</span>
  <span class="keyword1"><span class="command">from</span></span> S_precise_ntrp<span class="main">[</span><span class="operator">OF</span> RUV_split_el<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_size1elem<span class="main">[</span><span class="operator">OF</span> _ RUV_split_el<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">che</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">che</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_el<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww1</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww1</span><span class="main">,</span> <span class="skolem">s1'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_el<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww2</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww2</span><span class="main">,</span> <span class="skolem">s2'</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Ml'</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Me'</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">― ‹Get combined path from the acquisition history interleavability, need to remap loc/env-steps in second path›</span>
  <span class="keyword1"><span class="command">from</span></span> P2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1<span class="main">(</span>5<span class="main">)</span> RUV_split_el<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="keyword2"><span class="keyword">where</span></span> IL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ww</span><span class="main">∈</span><span class="skolem">ww1</span>⊗<span class="hidden">⇘</span><sub>αnl <span class="free">fg</span></sub><span class="hidden">⇙</span><span class="main">(</span>map ENV <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ah_interleavable2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="comment1">― ‹Use the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] ntrp_unsplit<span class="antiquote">}</span></span>-theorem to combine the executions›</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_unsplit<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ca<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span><span class="operator">OF</span> IL P1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s1'</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> RUV_split_el<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_of_le_rem P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntrp_add_context<span class="main">[</span><span class="operator">OF</span> ntrp_stack_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">che</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> edges_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUV_split_el<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> mon_loc_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> mon_env_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> FS<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> RUV_split_el<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc P1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> FS<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>2<span class="main">)</span> P2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span> <span class="main">∪</span> <span class="skolem">Ml</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>3<span class="main">)</span> P1<span class="main">(</span>3<span class="main">)</span> mon_loc_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>4<span class="main">)</span> P2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> mon_env_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_ww_of_le_rem <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RUV_split_ee <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u'</span> <span class="skolem">v</span> <span class="skolem">M</span> <span class="skolem">P</span> <span class="skolem">q</span> <span class="skolem">q'</span> <span class="skolem">Ml</span> <span class="skolem">Me</span> <span class="skolem">h</span> <span class="skolem">Ml'</span> <span class="skolem">Me'</span> <span class="skolem">h'</span><span class="main">)</span>
  <span class="comment1">― ‹Get paths from precision results›</span>
  <span class="keyword1"><span class="command">from</span></span> S_precise_ntrp<span class="main">[</span><span class="operator">OF</span> RUV_split_ee<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> mset_size2elem<span class="main">[</span><span class="operator">OF</span> _ RUV_split_ee<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">che</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    FS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">che</span><span class="main">)</span> <span class="main">∈</span> ntrp <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span><span class="main">=</span><span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="skolem">q'</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mon_w <span class="free">fg</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"mon_n <span class="free">fg</span> <span class="skolem">v</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"mon_c <span class="free">fg</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="skolem">che</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mset_le_addE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_ee<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww1</span></span> <span class="skolem"><span class="skolem">s1'</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww1</span><span class="main">,</span> <span class="skolem">s1'</span><span class="main">,</span> <span class="skolem">c1'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">U</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Ml</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww1</span> <span class="main">=</span> <span class="skolem">Me</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RU_precise<span class="main">[</span><span class="operator">OF</span> RUV_split_ee<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww2</span></span> <span class="skolem"><span class="skolem">s2'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ww2</span><span class="main">,</span> <span class="skolem">s2'</span><span class="main">,</span> <span class="skolem">c2'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atU <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Ml'</span>"</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="skolem">ww2</span> <span class="main">=</span> <span class="skolem">Me'</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αnl <span class="free">fg</span><span class="main">)</span> <span class="skolem">ww2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">― ‹Get interleaved paths, project away loc/env information first›</span>
  <span class="keyword1"><span class="command">from</span></span> P1<span class="main">(</span>5<span class="main">)</span> P2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">ww1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="quoted">"αah <span class="main">(</span>map <span class="main">(</span>αn <span class="free">fg</span><span class="main">)</span> <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> αn_αnl o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> RUV_split_ee<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="keyword2"><span class="keyword">where</span></span> IL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ww</span> <span class="main">∈</span> <span class="main">(</span>map le_rem_s <span class="skolem">ww1</span><span class="main">)</span> ⊗<span class="hidden">⇘</span><sub>αn <span class="free">fg</span></sub><span class="hidden">⇙</span> <span class="main">(</span>map le_rem_s <span class="skolem">ww2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ah_interleavable2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
  <span class="comment1">― ‹Use the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] ntr_unsplit<span class="antiquote">}</span></span>-theorem to combine the executions›</span>
  <span class="keyword1"><span class="command">from</span></span> ntr_unsplit<span class="main">[</span><span class="operator">OF</span> IL gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> gtrp2gtr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> PC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc<span class="main">)</span>
  <span class="comment1">― ‹Prepend first step›</span>
  <span class="keyword1"><span class="command">from</span></span> ntr2ntrp<span class="main">[</span><span class="operator">OF</span> PC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">u'</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">che</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q</span><span class="main">]</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="skolem">q'</span><span class="main">]</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> map ENV <span class="skolem">ww</span><span class="main">,</span> <span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RUV_split_ee<span class="main">(</span>7<span class="main">)</span> FS<span class="main">(</span>5<span class="main">)</span> mon_ww_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> FS<span class="main">(</span>4<span class="main">)</span> mon_n_same_proc<span class="main">[</span><span class="operator">OF</span> edges_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RUV_split_ee<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mon_c_unconc mon_ww_of_le_rem P1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> FS<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="skolem">ww</span><span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">,</span> <span class="skolem">che</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">u'</span><span class="main">]</span><span class="main">#}</span><span class="main">+</span><span class="main">(</span><span class="skolem">che</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s1'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c1'</span> <span class="main">+</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s2'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c2'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>2<span class="main">)</span> P2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_loc <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> mon <span class="free">fg</span> <span class="skolem">p</span> <span class="main">∪</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> FS<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mon_env <span class="free">fg</span> <span class="main">(</span>LOC <span class="main">(</span>LCall <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">#</span> map ENV <span class="skolem">ww</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ml</span> <span class="main">∪</span> <span class="skolem">Me</span> <span class="main">∪</span> <span class="skolem">Ml'</span> <span class="main">∪</span> <span class="skolem">Me'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon_ww_cil<span class="main">[</span><span class="operator">OF</span> IL<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">fg</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> P2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> mon_ww_of_le_rem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="MainResult">
<div class="head">
<h1>Theory MainResult</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Conflict analysis/Main Result
    Author:      Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
    Maintainer:  Peter Lammich &lt;peter.lammich@uni-muenster.de&gt;
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Main Result"</span></span>
<span class="keyword1"><span class="command">theory</span></span> MainResult
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ConstraintSystems.html">ConstraintSystems</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{thy:MainResult}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹At this point everything is available to prove the main result of this project: 
  {\em The constraint system <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">RUV_cs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> precisely characterizes simultaneously reachable control nodes w.r.t. to our
  semantic reference point.}

  The ,,trusted base'' of this proof, that are all definitions a reader that trusts the Isabelle prover must additionally trust, is the following:
  \begin{itemize}
    \item The flowgraph and the assumptions made on it in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>flowgraph›</span></span></span></span>- and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eflowgraph›</span></span></span></span>-locales. Note that we show in Section~\ref{sec:Flowgraph:ex_flowgraph} 
      that there is at least one non-trivial model of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>eflowgraph›</span></span></span></span>.
    \item The reference point semantics (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">refpoint</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) and the transitive closure operator (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">trcl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).
    \item The definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">atUV</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
    \item All dependencies of the above definitions in the Isabelle standard libraries.
  \end{itemize}
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> eflowgraph<span class="main">)</span> RUV_is_sim_reach<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">w</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span><span class="bound">w</span><span class="main">,</span><span class="bound">c'</span><span class="main">)</span><span class="main">∈</span>trcl <span class="main">(</span>refpoint <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> atUV <span class="free">U</span> <span class="free">V</span> <span class="bound">c'</span><span class="main">)</span> 
    <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Ml</span> <span class="bound">Me</span><span class="main">.</span> <span class="main">(</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">,</span><span class="bound">Ml</span><span class="main">,</span><span class="bound">Me</span><span class="main">)</span><span class="main">∈</span>RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span><span class="main">)</span>"</span></span> 
<span class="comment1">― ‹The proof uses the soundness and precision theorems wrt. to normalized paths (<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] flowgraph.RUV_sound<span class="antiquote">}</span></span>, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] flowgraph.RUV_precise<span class="antiquote">}</span></span>) as well as the normalization result, 
  i.e. that every reachable configuration is also reachable using a normalized path (<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] eflowgraph.normalize<span class="antiquote">}</span></span>) and, vice versa, that every normalized path is also a usual path (<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] ntr_is_tr<span class="antiquote">}</span></span>). 
  Finally the conversion between our working semantics and the semantic reference point is exploited (<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] flowgraph.refpoint_eq<span class="antiquote">}</span></span>).›</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refpoint_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> normalize<span class="main">[</span><span class="operator">OF</span> C<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"main <span class="free">fg</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ww</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="skolem">ww</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ntrs.gtr2gtrp<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">ce'</span></span> <span class="skolem"><span class="skolem">wwl</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span><span class="main">=</span>add_mset <span class="skolem">s'</span> <span class="skolem">ce'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ww</span> <span class="main">=</span> map le_rem_s <span class="skolem">wwl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wwl</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">ce'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">ce'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> RUV_sound<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ml</span></span> <span class="skolem"><span class="skolem">Me</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Ml</span><span class="main">,</span> <span class="skolem">Me</span><span class="main">)</span> <span class="main">∈</span> RUV_cs <span class="free">fg</span> <span class="free">U</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> RUV_precise<span class="main">[</span><span class="operator">OF</span> C<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wwl</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="main">{#}</span><span class="main">)</span><span class="main">,</span> <span class="skolem">wwl</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> <span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntrp <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atUV <span class="free">U</span> <span class="free">V</span> <span class="main">(</span><span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span> <span class="main">+</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> gtrp2gtr<span class="main">[</span><span class="operator">OF</span> P<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span> <span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span> <span class="main">#}</span><span class="main">,</span> map le_rem_s <span class="skolem">wwl</span><span class="main">,</span> <span class="main">{#</span><span class="skolem">s'</span><span class="main">#}</span><span class="main">+</span><span class="skolem">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>ntr <span class="free">fg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ntr_is_tr<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> P<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="bound">c'</span><span class="main">.</span> <span class="main">(</span><span class="main">{#</span><span class="main">[</span>entry <span class="free">fg</span> <span class="main">(</span>main <span class="free">fg</span><span class="main">)</span><span class="main">]</span><span class="main">#}</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">c'</span><span class="main">)</span> <span class="main">∈</span> trcl <span class="main">(</span>tr <span class="free">fg</span><span class="main">)</span> <span class="main">∧</span> atUV <span class="free">U</span> <span class="free">V</span> <span class="bound">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refpoint_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>