<div id="TwoSquares">
<div class="head">
<h1>Theory TwoSquares</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      TwoSquares.thy
    Authors:    Roelof Oosterhuis, 2007  Rijksuniversiteit Groningen
                Jaime Mendizabal Roche, 2016
*)</span>

<span class="keyword1"><span class="command">theory</span></span> TwoSquares
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sum2sq_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum2sq_nat</span> <span class="free">a</span> <span class="free">b</span> <span class="main">≡</span> <span class="free">a</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="free">b</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_sum2sq_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum2sq_nat</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: move this lemma to the distribution (?). (It is used also in QuadForm and FourSquares) *)</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-best_division_abs"><span class="command">lemma</span></span> best_division_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="bound">k</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_div_mult_eq <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h pos_mod_sign a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h pos_mod_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> a False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sum2sq_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum2sq_int</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="bound">b</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_sum2sq_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_int</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> sum2sq_int<span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-sum2sq_int_nat_eq"><span class="command">lemma</span></span> sum2sq_int_nat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sum2sq_nat</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> sum2sq_int <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum2sq_nat_def sum2sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-is_sum2sq_int_nat_eq"><span class="command">lemma</span></span> is_sum2sq_int_nat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span> <span class="main">=</span> is_sum2sq_int <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def is_sum2sq_int_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum2sq_nat</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> int <span class="free">n</span> <span class="main">=</span> sum2sq_int <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum2sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> int <span class="free">n</span> <span class="main">=</span> sum2sq_int <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> sum2sq_int <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> sum2sq_int <span class="main">(</span>int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main">)</span><span class="main">,</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum2sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> int <span class="main">(</span><span class="free">sum2sq_nat</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main">)</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum2sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum2sq_nat</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-product_two_squares_aux"><span class="command">lemma</span></span> product_two_squares_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"sum2sq_int<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> sum2sq_int<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> sum2sq_int<span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">c</span> <span class="main">-</span> <span class="free">b</span><span class="main">*</span><span class="free">d</span><span class="main">,</span> <span class="free">a</span><span class="main">*</span><span class="free">d</span> <span class="main">+</span> <span class="free">b</span><span class="main">*</span><span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square sum2sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-product_two_squares_int"><span class="command">lemma</span></span> product_two_squares_int<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sum2sq_int <span class="free">m</span> <span class="main">⟹</span> is_sum2sq_int <span class="free">n</span> <span class="main">⟹</span> is_sum2sq_int <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum2sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> product_two_squares_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-product_two_squares_nat"><span class="command">lemma</span></span> product_two_squares_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">is_sum2sq_nat</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> product_two_squares_int is_sum2sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-sots1_aux"><span class="command">lemma</span></span> sots1_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_sum2sq_nat</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">^</span><span class="numeral">2</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def sum2sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ab_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> h1 odd_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a'</span> <span class="main">*</span> <span class="var">?g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b'</span> <span class="main">*</span> <span class="var">?g</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a'</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd_coprime_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd_add h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">*</span> <span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd_div_mult_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span> <span class="main">*</span> <span class="var">?g</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b'</span> <span class="main">*</span> <span class="var">?g</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h1 <span class="keyword1"><span class="command">using</span></span> h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">=</span> <span class="var">?g</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?p</span> <span class="var">?g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?p</span> <span class="main">(</span><span class="var">?g</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="var">?mul</span> <span class="main">+</span> <span class="var">?mul</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">using</span></span> h2 assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_mult_distrib<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?p</span> <span class="main">(</span><span class="var">?g</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> h4 odd_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>multiplicity <span class="var">?p</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ab_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h4 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prime_elem_multiplicity_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_dvd_imp_multiplicity_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h6 dvd_add_right_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> prime_dvd_power_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> h3<span class="main">(</span>3<span class="main">)</span> coprime_common_divisor_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="skolem">b'</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> not_prime_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">a'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square prime_dvd_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="var">?p</span> <span class="skolem">a'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_imp_coprime<span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> prime_imp_coprime_nat
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h7 dvd_0_right<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ainv</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">*</span> <span class="skolem">ainv</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">*</span> <span class="skolem">aux</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bezout_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a'</span> <span class="main">*</span> <span class="skolem">ainv</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_to_1'_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> cong_mult <span class="main">[</span><span class="operator">OF</span> this this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> h11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">=</span> <span class="skolem">ainv</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> cong_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bdiva</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ainv</span> <span class="main">*</span> <span class="skolem">b'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">ainv</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h6 cong_dvd_modulus_nat cong_mult_self_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> cong_add <span class="main">[</span><span class="operator">OF</span> h11 this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">ainv</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">b'</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> add_mult_distrib2 <span class="keyword1"><span class="command">using</span></span> cong_add_lcancel_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ainv</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a'</span><span class="main">^</span><span class="numeral">2</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> h8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="var">?bdiva</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prime_dvd_power_nat_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span><span class="main">1</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_add_rcancel_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this h8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_sym cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_0_1_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?p</span> <span class="keyword1">dvd</span> <span class="var">?bdiva</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> h9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="var">?p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> fermat_theorem <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="var"><span class="quoted"><span class="var">?bdiva</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">≥</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> h11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h8 cong_pow <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bdiva</span> <span class="main">^</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">(</span><span class="var">?bdiva</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h8 cong_add_lcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_add_rcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">+</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h8 cong_add_lcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">4</span><span class="main">)</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">^</span><span class="free">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> h12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> h13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">*</span><span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_scalar_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">+</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> add_mult_distrib2 power_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span><span class="main">+</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h13 <span class="keyword1"><span class="command">unfolding</span></span> nat_mult_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="var">?bdiva</span><span class="main">^</span><span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h11 h12 cong_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?bdiva</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h8 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cong_dvd_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-sots1"><span class="command">lemma</span></span> sots1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> even <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sots1_aux assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-aux_lemma"><span class="command">lemma</span></span> aux_lemma<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="free">c</span><span class="main">*</span><span class="bound">k</span> <span class="main">+</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">c</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def mod_if<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_le_nat assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-Legendre_1mod4"><span class="command">lemma</span></span> Legendre_1mod4<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?p</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="var">?p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">simp_all</span> 
  <span class="keyword1"><span class="command">hence</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> euler_criterion<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> nat <span class="free">k</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?L</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">1</span><span class="main">-</span><span class="var">?L</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_iff_dvd_diff dvd_minus_iff<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="main">1</span> <span class="main">∨</span> <span class="var">?L</span><span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="var">?L</span><span class="main">=</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Legendre_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">∨</span> <span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">∨</span> <span class="var">?p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> p2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-qf1_prime_exists"><span class="command">lemma</span></span> qf1_prime_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="var">?p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Legendre_1mod4<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> QuadRes <span class="var">?p</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Legendre_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"QuadRes <span class="var">?p</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> QuadRes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> s1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> nat <span class="main">¦</span><span class="skolem">s1</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="skolem">s2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> s1' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>int <span class="main">(</span><span class="skolem">s2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_int_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s0p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="var">?p</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">s2</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_less_unique_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="skolem">s2</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_sym cong_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s2 <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_trans cong_add_rcancel_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> <span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_altdef_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="var">?p</span><span class="main">*</span><span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">=</span> <span class="free">sum2sq_nat</span> <span class="skolem">s</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum2sq_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> qf1pt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sum2sq_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t_l_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="var">?p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="var">?p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?p</span><span class="main">*</span><span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult_less_mono2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?p</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="var">?p</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> s0p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> <span class="var">?p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> s0p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?p</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power2_eq_square diff_mult_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> prime_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> tpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&lt;</span> <span class="var">?p</span><span class="main">*</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zmult_zless_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zero_le_power2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tn</span></span> <span class="keyword2"><span class="keyword">where</span></span> tn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tn</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">+</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="comment1">― ‹So, $Q~n =$ there exist $x,y$ such that $x^2+y^2 =(p*(1+ int(n)))$›</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> nQ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?Q</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">tn</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?p</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="var">?Q</span> <span class="skolem">tn</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tn</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_descent0<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">from</span></span> nQ1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?p</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="var">?Q</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>smaller <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?p</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> int <span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_sum2sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum2sq_int_def sum2sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span>int <span class="var">?p</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>int <span class="main">(</span><span class="main">1</span><span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> n0 <span class="keyword1"><span class="command">have</span></span> n1pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> rv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">v</span><span class="main">¦</span> <span class="main">≤</span> <span class="var">?n1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> best_division_abs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> n1pos <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> sw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">-</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">w</span><span class="main">¦</span> <span class="main">≤</span> <span class="var">?n1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule_tac</span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> best_division_abs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="var">?C</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">from</span></span> rv sw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span><span class="main">-</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span><span class="main">*</span><span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?n1</span><span class="main">*</span><span class="var">?p</span> <span class="main">-</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">r</span><span class="main">)</span> <span class="main">-</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span><span class="main">*</span><span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">r</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> power_mult_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">r</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span><span class="main">*</span><span class="skolem">s</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power_mult_distrib distrib_left <span class="dynamic"><span class="dynamic">ac_simps</span></span>
              left_diff_distrib right_diff_distrib power2_eq_square<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="keyword2"><span class="keyword">where</span></span> m1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="var">?n1</span><span class="main">*</span><span class="skolem">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">&lt;</span> <span class="var">?n1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">m1</span> <span class="main">&lt;</span> <span class="var">?n1</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">-</span><span class="skolem">m1</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="var">?n1</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="var">?n1</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="var">?n1</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?n1</span><span class="main">*</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zmult_zless_mono2<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="var">?n1</span><span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> hlp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">v</span><span class="main">¦</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">w</span><span class="main">¦</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> m1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="var">?n1</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">v</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">w</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> rv hlp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">w</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> power_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> int <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sw hlp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> power_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> int <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="skolem">m1</span><span class="main">*</span><span class="numeral">4</span> <span class="main">≤</span> <span class="var">?n1</span><span class="main">*</span><span class="var">?n1</span><span class="main">*</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="var">?n1</span><span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> right_diff_distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> contr <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span> <span class="main">+</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> m1 xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">*</span><span class="var">?C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">v</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> rv sw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span><span class="main">+</span><span class="skolem">v</span><span class="main">)</span><span class="main">*</span><span class="skolem">v</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span><span class="main">+</span><span class="skolem">w</span><span class="main">)</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="var">?n1</span><span class="main">+</span><span class="skolem">v</span><span class="main">)</span><span class="main">*</span><span class="skolem">w</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="var">?n1</span><span class="main">+</span><span class="skolem">w</span><span class="main">)</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span> <span class="main">-</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> m1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span><span class="main">)</span> <span class="main">-</span> <span class="var">?n1</span><span class="main">*</span><span class="main">(</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="var">?n1</span><span class="main">)</span><span class="main">*</span><span class="var">?C</span> <span class="main">=</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span> <span class="main">+</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> m1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span> <span class="main">+</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span> <span class="main">+</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> power2_eq_square<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">v</span><span class="main">+</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">w</span><span class="main">+</span><span class="skolem">m1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">r</span><span class="main">*</span><span class="skolem">w</span><span class="main">-</span><span class="skolem">s</span><span class="main">*</span><span class="skolem">v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> qf1pm1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sum2sq_int <span class="main">(</span><span class="main">(</span>int <span class="var">?p</span><span class="main">)</span><span class="main">*</span><span class="skolem">m1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum2sq_int_def sum2sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> m1pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_power2_eq_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">with</span></span> rv sw <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> dvd_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_add<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="var">?n1</span><span class="main">*</span><span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zdvd_mult_cancel<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="var">?n1</span> <span class="keyword1">dvd</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="var">?n1</span> <span class="main">=</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
            <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> nQ1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">*</span><span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> vwpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">with</span></span> m1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">m1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">with</span></span> n1pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">*</span><span class="skolem">m1</span> <span class="main">&lt;</span> <span class="var">?n1</span><span class="main">*</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zmult_zless_mono2<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> m1 vwpos <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> int<span class="main">(</span><span class="main">(</span>nat <span class="skolem">m1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">with</span></span> qf1pm1 <span class="keyword1"><span class="command">have</span></span> Qm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="main">(</span>nat <span class="skolem">m1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_sum2sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mm</span></span> <span class="keyword2"><span class="keyword">where</span></span> tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mm</span> <span class="main">=</span> <span class="main">(</span>nat <span class="skolem">m1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="skolem">mm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mm</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tmp mn m1pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> int <span class="skolem">mm</span> <span class="main">&lt;</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="var">?p</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tn tpos t_l_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> qf1pt <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-fermat_two_squares"><span class="command">lemma</span></span> fermat_two_squares<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">[</span><span class="free">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="numeral">2</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def sum2sq_nat_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> prime_odd_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[</span><span class="free">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[</span><span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 cong_dvd_iff <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> cong_dvd_modulus_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">p</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">&lt;</span><span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> cong_less_unique_nat zero_less_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> h1 h2 h3 h4 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≠</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">≠</span><span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">≠</span><span class="numeral">3</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">&lt;</span><span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> this h4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aux_lemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qf1_prime_exists assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-sots2"><span class="command">lemma</span></span> sots2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> even <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> f<span class="main">:</span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def sum2sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">0</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def sum2sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_divisor_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> m_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> h1 <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_less_m_mult_n<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> prime_gt_Suc_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">kp</span><span class="main">+</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aux_lemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 True m_nz 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> multiplicity_eq_zero_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_dvd_imp_multiplicity_0<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> h1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_prime<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1
          <span class="keyword1"><span class="command">using</span></span> prime_elem_multiplicity_mult_distrib <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> m_nz prime_gt_0_nat
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> h3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> h4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvdE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> h1 <span class="keyword1"><span class="command">have</span></span> h5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dual_order.strict_trans h1 h2 h4 nat_mult_less_cancel1 prime_gt_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">kq</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">⟹</span> even <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">kq</span><span class="main">::</span><span class="quoted">nat</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> h7<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="main">(</span><span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> multiplicity_prime_power<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">kq</span></span><span class="main">]</span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> h5
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> p h1 h4 m_nz 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">=</span>
                    Suc <span class="main">(</span>Suc <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="skolem">m'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_mult_distrib<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">≠</span><span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> a2 h4 m_nz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="skolem">n</span> <span class="main">=</span> 
                                  multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="skolem">m'</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> h5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_mult_distrib<span class="main">)</span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> a2 h1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="main">(</span><span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_distinct_prime_power<span class="main">)</span> <span class="operator">simp_all</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="skolem">n</span> <span class="main">=</span> multiplicity <span class="var">?q</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">kq</span></span><span class="main">]</span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 h6<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">0</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="main">(</span><span class="skolem">p</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_sum2sq_nat_def sum2sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> product_two_squares_nat h5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[</span><span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">kq</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">kq</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⟹</span> even <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">kq</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">kq</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="skolem">kq</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a1 cong_add_rcancel_0_nat <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span>"</span></span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="numeral">4</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">≠</span><span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> h1 a2 m_nz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="main">…</span> <span class="main">=</span> 
                                  multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">+</span> multiplicity <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">kq</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_mult_distrib<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> a2 h1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_multiplicity_other<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="var">?q</span> <span class="skolem">n</span> <span class="main">=</span> multiplicity <span class="var">?q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">kq</span></span><span class="main">]</span> a2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>multiplicity <span class="var">?q</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 h2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fermat_two_squares a1 h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> product_two_squares_nat h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_two_squares<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> even <span class="main">(</span>multiplicity <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> sots2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="TwoSquares-k_mod_eq"><span class="command">lemma</span></span> k_mod_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">4</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">3</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_add_rcancel_0_nat cong_mult_self_left<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> prime <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> aux_lemma <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_two_squares'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">⟶</span> even <span class="main">(</span>multiplicity <span class="bound">p</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_of_two_squares k_mod_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_two_squares_prime<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum2sq_nat</span> <span class="free">p</span> <span class="main">=</span> <span class="main">[</span><span class="free">p</span><span class="main">≠</span><span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">p</span><span class="main">=</span><span class="numeral">3</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">4</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">is_sum2sq_nat</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms True sum_of_two_squares' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fermat_two_squares assms<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FourSquares">
<div class="head">
<h1>Theory FourSquares</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      FourSquares.thy
    Author:     Roelof Oosterhuis, 2007  Rijksuniversiteit Groningen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lagrange's four-square theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FourSquares
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Number_Theory.html">HOL-Number_Theory.Number_Theory</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sum4sq_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum4sq_nat</span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="main">≡</span> <span class="free">a</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="free">b</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="free">c</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="free">d</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_sum4sq_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="free">n</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum4sq_nat</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: move this lemma to the distribution (?). (It is used also in QuadForm and TwoSquares) *)</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-best_division_abs"><span class="command">lemma</span></span> best_division_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">::</span>int<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="bound">k</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_mult_mod_eq <span class="dynamic"><span class="dynamic">algebra_simps</span></span> k_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h pos_mod_sign a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="free">n</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> h pos_mod_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> a False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Shows that all nonnegative integers can be written as the sum of four squares. The proof consists of the following steps:
\begin{itemize}\item For every prime $p=2n+1$ the two sets of residue classes $$\{x^2 \bmod p\mid 0\le x\le n\} ~{\rm and}~ \{-1-y^2 \bmod p \mid 0 \le y \le n\}$$ both contain $n+1$ different elements and therefore they must have at least one element in common.
\item Hence there exist $x,y$ such that $x^2+y^2+1^2+0^2$ is a multiple of $p$.
\item The next step is to show, by an infinite descent, that $p$ itself can be written as the sum of four squares.
\item Finally, using the multiplicity of this form, the same holds for all positive numbers.
\end{itemize}›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sum4sq_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">×</span> int <span class="main">×</span> int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum4sq_int</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="bound">b</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="bound">c</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="bound">d</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_sum4sq_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_int</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-mult_sum4sq_int"><span class="command">lemma</span></span> mult_sum4sq_int<span class="main">:</span> <span class="quoted"><span class="quoted">"sum4sq_int<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">d</span><span class="main">)</span> <span class="main">*</span> sum4sq_int<span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="free">q</span><span class="main">,</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  sum4sq_int<span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">p</span><span class="main">+</span><span class="free">b</span><span class="main">*</span><span class="free">q</span><span class="main">+</span><span class="free">c</span><span class="main">*</span><span class="free">r</span><span class="main">+</span><span class="free">d</span><span class="main">*</span><span class="free">s</span><span class="main">,</span> <span class="free">a</span><span class="main">*</span><span class="free">q</span><span class="main">-</span><span class="free">b</span><span class="main">*</span><span class="free">p</span><span class="main">-</span><span class="free">c</span><span class="main">*</span><span class="free">s</span><span class="main">+</span><span class="free">d</span><span class="main">*</span><span class="free">r</span><span class="main">,</span>
         <span class="free">a</span><span class="main">*</span><span class="free">r</span><span class="main">+</span><span class="free">b</span><span class="main">*</span><span class="free">s</span><span class="main">-</span><span class="free">c</span><span class="main">*</span><span class="free">p</span><span class="main">-</span><span class="free">d</span><span class="main">*</span><span class="free">q</span><span class="main">,</span> <span class="free">a</span><span class="main">*</span><span class="free">s</span><span class="main">-</span><span class="free">b</span><span class="main">*</span><span class="free">r</span><span class="main">+</span><span class="free">c</span><span class="main">*</span><span class="free">q</span><span class="main">-</span><span class="free">d</span><span class="main">*</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> sum4sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-sum4sq_int_nat_eq"><span class="command">lemma</span></span> sum4sq_int_nat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sum4sq_nat</span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="main">=</span> sum4sq_int <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum4sq_nat_def sum4sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-is_sum4sq_int_nat_eq"><span class="command">lemma</span></span> is_sum4sq_int_nat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="free">n</span> <span class="main">=</span> is_sum4sq_int <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_sum4sq_nat_def is_sum4sq_int_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum4sq_nat</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> int <span class="free">n</span> <span class="main">=</span> sum4sq_int <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum4sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> int <span class="free">n</span> <span class="main">=</span> sum4sq_int <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> sum4sq_int <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> sum4sq_int <span class="main">(</span>int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main">)</span><span class="main">,</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span><span class="main">)</span><span class="main">,</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">c</span><span class="main">¦</span><span class="main">)</span><span class="main">,</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">d</span><span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum4sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">n</span> <span class="main">=</span> int <span class="main">(</span><span class="free">sum4sq_nat</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span><span class="main">)</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span><span class="main">)</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">c</span><span class="main">¦</span><span class="main">)</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">d</span><span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum4sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> <span class="free">sum4sq_nat</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-is_mult_sum4sq_int"><span class="command">lemma</span></span> is_mult_sum4sq_int<span class="main">:</span> <span class="quoted"><span class="quoted">"is_sum4sq_int <span class="free">x</span> <span class="main">⟹</span> is_sum4sq_int <span class="free">y</span> <span class="main">⟹</span> is_sum4sq_int <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum4sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult_sum4sq_int<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-is_mult_sum4sq_nat"><span class="command">lemma</span></span> is_mult_sum4sq_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">is_sum4sq_nat</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">is_sum4sq_nat</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_mult_sum4sq_int is_sum4sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-mult_oddprime_is_sum4sq"><span class="command">lemma</span></span> mult_oddprime_is_sum4sq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> prime <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span><span class="main">;</span> odd <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span><span class="main">&lt;</span><span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span><span class="main">&lt;</span><span class="free">p</span> <span class="main">∧</span> is_sum4sq_int <span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_int_nat_transfer prime_nat_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oddE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> p1 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?D</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">`</span> <span class="var">?D</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> finC<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> finD<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> p0 <span class="keyword1"><span class="command">have</span></span> AsubC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BsubC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_mod_conj<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finC <span class="keyword1"><span class="command">have</span></span> finA<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finB<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> AsubC BsubC <span class="keyword1"><span class="command">have</span></span> AunBsubC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span> <span class="main">⊆</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Un_least<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> p0 <span class="keyword1"><span class="command">have</span></span> cardC<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?C</span> <span class="main">=</span> nat <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_atLeastZeroLessThan_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> n0 <span class="keyword1"><span class="command">have</span></span> cardD<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?D</span> <span class="main">=</span> <span class="main">1</span><span class="main">+</span> nat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> cardA<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> card <span class="var">?D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?D</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yn<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> xyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_iff_dvd_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> p0 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_dvd_multD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> xn yn n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x0 y0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹both are zero›</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> xn y0 n p0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x0 yn n p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">-</span><span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_minus_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> finD <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_on_iff_eq_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> cardB<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?B</span> <span class="main">=</span> card <span class="var">?D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?g</span> <span class="var">?D</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yn<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> xyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> p0 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_dvd_multD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> xn yn n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> x0 y0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹both are zero›</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> xn y0 n p0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x0 yn n p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">y</span><span class="main">-</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zdvd_not_zless<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">-</span><span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_minus_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> finD <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inj_on_iff_eq_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∩</span> <span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> ABdisj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∩</span> <span class="var">?B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> cardA cardB cardD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span>nat <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> finA finB ABdisj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> finC AunBsubC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> cardC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nat <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span>nat <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> nat <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?D</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="var">?D</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">=</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">]</span><span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cong_iff_dvd_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">=</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> sum4sq_int<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_def eq_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_sum4sq_int <span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum4sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> sum4sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">*</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zmult_zless_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">y</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&gt;</span> <span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">*</span><span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> zmult_zless_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&gt;</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_right mult_1_left<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> n0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">&gt;</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> n0 n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-zprime_is_sum4sq"><span class="command">lemma</span></span> zprime_is_sum4sq<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> is_sum4sq_int <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sum4sq_int_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="main">=</span><span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prp<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nat <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&lt;</span> nat <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> prp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_odd_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="free">p</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> even_nat_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> <span class="main">0</span><span class="main">&lt;</span><span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span><span class="main">&lt;</span><span class="free">p</span> <span class="main">∧</span> is_sum4sq_int <span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_oddprime_is_sum4sq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> pt_sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">t</span><span class="main">&lt;</span><span class="free">p</span> <span class="main">∧</span> <span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> is_sum4sq_int_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Qt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">t</span><span class="main">&lt;</span><span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a1</span> <span class="bound">a2</span> <span class="bound">a3</span> <span class="bound">a4</span><span class="main">.</span> <span class="free">p</span><span class="main">*</span><span class="skolem">t</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">,</span><span class="bound">a3</span><span class="main">,</span><span class="bound">a4</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> nQ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?Q</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?Q</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_descent0_measure<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span>nat <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nat <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">x</span><span class="main">=</span>sum4sq_int<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> nQ1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> nat <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> <span class="var">?Q</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="skolem"><span class="skolem">a3</span></span> <span class="skolem"><span class="skolem">a4</span></span> <span class="keyword2"><span class="keyword">where</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">&lt;</span><span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">&lt;</span><span class="free">p</span> <span class="main">∧</span> <span class="free">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a3</span><span class="main">,</span><span class="skolem">a4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> nat <span class="bound">y</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> nat <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> evx<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> ev1234<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a4</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b1</span> <span class="bound">b2</span> <span class="bound">b3</span> <span class="bound">b4</span><span class="main">.</span> <span class="free">p</span><span class="main">*</span><span class="skolem">x</span><span class="main">=</span>sum4sq_int<span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">b2</span><span class="main">,</span><span class="bound">b3</span><span class="main">,</span><span class="bound">b4</span><span class="main">)</span> <span class="main">∧</span> even <span class="main">(</span><span class="bound">b1</span><span class="main">+</span><span class="bound">b2</span><span class="main">)</span> <span class="main">∧</span> even <span class="main">(</span><span class="bound">b3</span><span class="main">+</span><span class="bound">b4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> ev12<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> ev1234 ass <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> odd12<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> ev1234 <span class="keyword1"><span class="command">have</span></span> odd34<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a4</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> ev1<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> odd12 <span class="keyword1"><span class="command">have</span></span> odd2<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a3</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> odd2 odd34 ev1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="main">(</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a4</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> odd34 odd2 ev1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> odd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="main">(</span><span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> odd12 <span class="keyword1"><span class="command">have</span></span> ev2<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a4</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a3</span><span class="main">)</span><span class="main">=</span><span class="free">p</span><span class="main">*</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> odd34 odd1 ev2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="main">(</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a3</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a4</span><span class="main">)</span><span class="main">=</span><span class="free">p</span><span class="main">*</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> odd34 odd1 ev2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">b3</span></span> <span class="skolem"><span class="skolem">b4</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">b1</span><span class="main">,</span><span class="skolem">b2</span><span class="main">,</span><span class="skolem">b3</span><span class="main">,</span><span class="skolem">b4</span><span class="main">)</span> <span class="main">∧</span> even <span class="main">(</span><span class="skolem">b1</span><span class="main">+</span><span class="skolem">b2</span><span class="main">)</span> <span class="main">∧</span> even <span class="main">(</span><span class="skolem">b3</span><span class="main">+</span><span class="skolem">b4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c3</span></span> <span class="keyword2"><span class="keyword">where</span></span> c13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">+</span><span class="skolem">b2</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">c1</span> <span class="main">∧</span> <span class="skolem">b3</span><span class="main">+</span><span class="skolem">b4</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">c3</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> evenE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">+</span><span class="skolem">b2</span>"</span></span><span class="main">]</span> evenE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b3</span><span class="main">+</span><span class="skolem">b4</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="skolem">b1</span><span class="main">-</span><span class="skolem">b2</span><span class="main">)</span> <span class="main">∧</span> even <span class="main">(</span><span class="skolem">b3</span><span class="main">-</span><span class="skolem">b4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">c4</span></span> <span class="keyword2"><span class="keyword">where</span></span> c24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">-</span><span class="skolem">b2</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">c2</span> <span class="main">∧</span> <span class="skolem">b3</span><span class="main">-</span><span class="skolem">b4</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">c4</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> evenE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">-</span><span class="skolem">b2</span>"</span></span><span class="main">]</span> evenE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b3</span><span class="main">-</span><span class="skolem">b4</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">from</span></span> evx <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> evenE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b1</span> <span class="main">-</span> <span class="skolem">b2</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">b4</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b3</span> <span class="main">-</span> <span class="skolem">b4</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> c13 c24 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="skolem">c1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c4</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">c1</span><span class="main">,</span><span class="skolem">c2</span><span class="main">,</span><span class="skolem">c3</span><span class="main">,</span><span class="skolem">c4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span>nat <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span>nat <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> xodd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c1</span> <span class="bound">c2</span> <span class="bound">c3</span> <span class="bound">c4</span><span class="main">.</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">a1</span><span class="main">-</span><span class="bound">c1</span><span class="main">*</span><span class="skolem">x</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">a2</span><span class="main">-</span><span class="bound">c2</span><span class="main">*</span><span class="skolem">x</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">a3</span><span class="main">-</span><span class="bound">c3</span><span class="main">*</span><span class="skolem">x</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">a4</span><span class="main">-</span><span class="bound">c4</span><span class="main">*</span><span class="skolem">x</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> best_division_abs<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">b3</span></span> <span class="skolem"><span class="skolem">c3</span></span> <span class="skolem"><span class="skolem">b4</span></span> <span class="skolem"><span class="skolem">c4</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          bc_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> <span class="skolem">a1</span><span class="main">-</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">=</span> <span class="skolem">a2</span><span class="main">-</span><span class="skolem">c2</span><span class="main">*</span><span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">b3</span> <span class="main">=</span> <span class="skolem">a3</span><span class="main">-</span><span class="skolem">c3</span><span class="main">*</span><span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">b4</span> <span class="main">=</span> <span class="skolem">a4</span><span class="main">-</span><span class="skolem">c4</span><span class="main">*</span><span class="skolem">x</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b1</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b2</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b3</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b4</span><span class="main">¦</span><span class="main">≤</span><span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b1</span><span class="main">¦</span><span class="main">≠</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b2</span><span class="main">¦</span><span class="main">≠</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b3</span><span class="main">¦</span><span class="main">≠</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b4</span><span class="main">¦</span><span class="main">≠</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xodd <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> bc_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b1</span><span class="main">¦</span><span class="main">&lt;</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b2</span><span class="main">¦</span><span class="main">&lt;</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b3</span><span class="main">¦</span><span class="main">&lt;</span><span class="skolem">x</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b4</span><span class="main">¦</span><span class="main">&lt;</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c4</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">from</span></span> bc_def ass <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="free">p</span><span class="main">*</span><span class="skolem">x</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">a1</span><span class="main">*</span><span class="skolem">c1</span><span class="main">+</span><span class="skolem">a2</span><span class="main">*</span><span class="skolem">c2</span><span class="main">+</span><span class="skolem">a3</span><span class="main">*</span><span class="skolem">c3</span><span class="main">+</span><span class="skolem">a4</span><span class="main">*</span><span class="skolem">c4</span><span class="main">)</span><span class="main">*</span><span class="skolem">x</span> <span class="main">+</span> <span class="var">?C</span><span class="main">*</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sum4sq_int_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">a1</span><span class="main">*</span><span class="skolem">c1</span><span class="main">+</span><span class="skolem">a2</span><span class="main">*</span><span class="skolem">c2</span><span class="main">+</span><span class="skolem">a3</span><span class="main">*</span><span class="skolem">c3</span><span class="main">+</span><span class="skolem">a4</span><span class="main">*</span><span class="skolem">c4</span><span class="main">)</span> <span class="main">+</span> <span class="var">?C</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> power2_eq_square
              distrib_left right_diff_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">a2</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">+</span> <span class="skolem">a3</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">a4</span><span class="main">*</span><span class="skolem">b4</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="skolem">a2</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="skolem">a3</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">+</span> <span class="skolem">a4</span><span class="main">*</span><span class="skolem">b3</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">a2</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="skolem">a3</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="skolem">a4</span><span class="main">*</span><span class="skolem">b2</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A4</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="skolem">a2</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">a3</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="skolem">a4</span><span class="main">*</span><span class="skolem">b1</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum4sq_int<span class="main">(</span><span class="var">?A1</span><span class="main">,</span><span class="var">?A2</span><span class="main">,</span><span class="var">?A3</span><span class="main">,</span><span class="var">?A4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A1</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A2</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A3</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A4</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> bc_def <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="var">?A1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">+</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">+</span><span class="skolem">c2</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b3</span><span class="main">+</span><span class="skolem">c3</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b4</span><span class="main">+</span><span class="skolem">c4</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b4</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">c1</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">+</span> <span class="skolem">c3</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">c4</span><span class="main">*</span><span class="skolem">b4</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> bc_def <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="var">?A2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">+</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">+</span><span class="skolem">c2</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b3</span><span class="main">+</span><span class="skolem">c3</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b4</span><span class="main">+</span><span class="skolem">c4</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b3</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="skolem">c2</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="skolem">c3</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">+</span> <span class="skolem">c4</span><span class="main">*</span><span class="skolem">b3</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> bc_def <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="var">?A3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">+</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">+</span><span class="skolem">c2</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b3</span><span class="main">+</span><span class="skolem">c3</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b4</span><span class="main">+</span><span class="skolem">c4</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">c2</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="skolem">c3</span><span class="main">*</span><span class="skolem">b1</span> <span class="main">-</span> <span class="skolem">c4</span><span class="main">*</span><span class="skolem">b2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> bc_def <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="var">?A4</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">+</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b2</span><span class="main">+</span><span class="skolem">c2</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b3</span><span class="main">+</span><span class="skolem">c3</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">b4</span><span class="main">+</span><span class="skolem">c4</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="skolem">b1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">c1</span><span class="main">*</span><span class="skolem">b4</span> <span class="main">-</span> <span class="skolem">c2</span><span class="main">*</span><span class="skolem">b3</span> <span class="main">+</span> <span class="skolem">c3</span><span class="main">*</span><span class="skolem">b2</span> <span class="main">-</span> <span class="skolem">c4</span><span class="main">*</span><span class="skolem">b1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left right_diff_distrib <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="var">?A4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d1</span></span> <span class="skolem"><span class="skolem">d2</span></span> <span class="skolem"><span class="skolem">d3</span></span> <span class="skolem"><span class="skolem">d4</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="var">?A1</span><span class="main">=</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">d1</span> <span class="main">∧</span> <span class="var">?A2</span><span class="main">=</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">d2</span> <span class="main">∧</span> <span class="var">?A3</span><span class="main">=</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">d3</span> <span class="main">∧</span> <span class="var">?A4</span><span class="main">=</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">d4</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum4sq_int<span class="main">(</span><span class="skolem">d1</span><span class="main">,</span><span class="skolem">d2</span><span class="main">,</span><span class="skolem">d3</span><span class="main">,</span><span class="skolem">d4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="var">?D</span> <span class="main">=</span> <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum4sq_int_def power_mult_distrib distrib_left<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum4sq_int<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">a3</span><span class="main">,</span><span class="skolem">a4</span><span class="main">)</span><span class="main">*</span>sum4sq_int<span class="main">(</span><span class="skolem">b1</span><span class="main">,</span><span class="skolem">b2</span><span class="main">,</span><span class="skolem">b3</span><span class="main">,</span><span class="skolem">b4</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mult_sum4sq_int<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> y ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="var">?D</span> <span class="main">-</span> <span class="free">p</span><span class="main">*</span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">*</span><span class="skolem">y</span> <span class="main">=</span> <span class="var">?D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> y_l_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b1</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b2</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span>
            <span class="numeral">4</span><span class="main">*</span><span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b3</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b4</span><span class="main">¦</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> bc_abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> power_strict_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">b</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square right_diff_distrib<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> zero_less_mult_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> b2pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="var">?B</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> b2pos <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="var">?B</span><span class="main">-</span><span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="var">?B</span><span class="main">-</span><span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="var">?B</span><span class="main">-</span><span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="var">?B</span><span class="main">-</span><span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> b2pos <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">b1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b4</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b3</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">b4</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> bc_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a1</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a2</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a3</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a4</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">a4</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">a1</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a2</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a3</span><span class="main">^</span><span class="numeral">2</span><span class="main">+</span><span class="skolem">a4</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_add<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">*</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum4sq_int_def<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">*</span><span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">x</span><span class="main">*</span><span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="skolem">x</span> <span class="keyword1">dvd</span> nat <span class="free">p</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_dvd_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass prp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">∧</span> prime <span class="main">(</span>nat <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">*</span><span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> zero_less_mult_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> y_l_x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span>nat <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y_l_x ass <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> nat <span class="bound">y</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> nat <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">¬</span> <span class="var">?Q</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Qt <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_sum4sq_int <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_sum4sq_int_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="FourSquares-prime_is_sum4sq"><span class="command">lemma</span></span> prime_is_sum4sq<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟹</span> <span class="free">is_sum4sq_nat</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zprime_is_sum4sq is_sum4sq_int_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> sum_of_four_squares<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="free">sum4sq_nat</span> <span class="main">0</span> <span class="main">0</span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">sum4sq_nat</span> <span class="main">1</span> <span class="main">0</span> <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum4sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_sum4sq_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_factor_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n_less_m_mult_n<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> prime_gt_Suc_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_sum4sq_nat</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 prime_is_sum4sq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dec is_mult_sum4sq_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>