<div id="PerfectBasics">
<div class="head">
<h1>Theory PerfectBasics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Basics needed›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PerfectBasics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Primes.html">HOL-Computational_Algebra.Primes</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Algebra/Exponent.html">HOL-Algebra.Exponent</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="PerfectBasics-exp_is_max_div"><span class="command">lemma</span></span> exp_is_max_div<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> m0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicity_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span>Suc <span class="main">(</span>multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> dvd_div_iff_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> m0 p <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> power_dvd_iff_le_multiplicity<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PerfectBasics-coprime_multiplicity"><span class="command">lemma</span></span> coprime_multiplicity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">p</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="free">p</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_refl prime_imp_coprime<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_prime_1 prime_nat_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">^</span> multiplicity <span class="free">p</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_is_max_div<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> simplify_sum_of_powers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>  <span class="main">=</span> <span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="free">x</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span>  <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_mult_distrib nat_mult_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>    <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span>Suc <span class="main">0</span> <span class="main">..</span> Suc <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>  <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.shift_bounds_cl_Suc_ivl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span>Suc <span class="main">0</span> <span class="main">..</span> <span class="free">n</span><span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span><span class="main">+</span><span class="free">x</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span>Suc <span class="main">0</span> <span class="main">..</span> <span class="free">n</span><span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.union_disjoint diff_add_inverse sum.atLeast_Suc_atMost<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sigma">
<div class="head">
<h1>Theory Sigma</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Sum of divisors function›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sigma
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PerfectBasics.html">PerfectBasics</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">divisors</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">n</span> <span class="main">.</span> <span class="bound">n</span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sigma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sigma</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∑</span> <span class="main">(</span>divisors<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Sigma-divisors_eq_dvd"><span class="command">lemma</span></span> divisors_eq_dvd<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">∈</span> divisors<span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisors_def<span class="main">)</span>

<span class="keyword1" id="Sigma-finite_divisors"><span class="command">lemma</span></span> finite_divisors <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>divisors <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms divisors_def<span class="main">)</span>

<span class="keyword1" id="Sigma-divs_of_zero_UNIV"><span class="command">lemma</span></span> divs_of_zero_UNIV<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"divisors<span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisors_def<span class="main">)</span>

<span class="keyword1" id="Sigma-sigma0"><span class="command">lemma</span></span> sigma0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sigma-sigma1"><span class="command">lemma</span></span> sigma1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_eq_Suc0_iff<span class="main">)</span>

<span class="keyword1" id="Sigma-prime_divisors"><span class="command">lemma</span></span> prime_divisors<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟷</span> divisors <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="free">p</span><span class="main">&gt;</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisors_def prime_nat_iff<span class="main">)</span>

<span class="keyword1" id="Sigma-prime_imp_sigma"><span class="command">lemma</span></span> prime_imp_sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">p</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⟹</span> sigma<span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">p</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">∧</span> divisors<span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_divisors<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">&gt;</span><span class="main">1</span> <span class="main">∧</span> sigma<span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> divisors_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-sigma_third_divisor"><span class="command">lemma</span></span> sigma_third_divisor<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span><span class="free">a</span><span class="main">+</span><span class="free">n</span> <span class="main">≤</span> sigma<span class="main">(</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">}</span> <span class="main">≤</span> divisors <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">n</span><span class="main">}</span> <span class="main">≤</span> sigma <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> finite_divisors order.strict_trans1 sum_mono2 zero_le<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> prime_iff_sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span> <span class="main">⟷</span> sigma<span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_linear sigma1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≠</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">+</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sigma_third_divisor <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> L One_nat_def Suc_lessD Suc_lessI <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> dvd_imp_le <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>›</span></span> less_le plus_1_eq_Suc that<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"divisors <span class="free">n</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divisors_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute prime_divisors<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> prime_divisors <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Sigma-dvd_prime_power_iff"><span class="command">lemma</span></span> dvd_prime_power_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">p</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> divides_primepow_nat prime <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_imp_power_dvd<span class="main">)</span>

<span class="keyword1" id="Sigma-rewrite_sum_of_powers"><span class="command">lemma</span></span> rewrite_sum_of_powers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">::</span>nat<span class="main">)</span><span class="main">&gt;</span><span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span> <span class="main">(</span><span class="main">(^)</span> <span class="free">p</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">..</span> <span class="free">n</span> <span class="main">.</span> <span class="free">p</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_def p power_inject_exp sum.reindex_cong<span class="main">)</span>

<span class="keyword1" id="Sigma-sum_of_powers_int"><span class="command">lemma</span></span> sum_of_powers_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span>int<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast0AtMost lessThan_Suc_atMost power_diff_1_eq<span class="main">)</span> 

<span class="keyword1" id="Sigma-sum_of_powers_nat"><span class="command">lemma</span></span> sum_of_powers_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> int <span class="main">(</span><span class="free">x</span> <span class="main">^</span> Suc <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_of_powers_int <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> of_nat_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">theorem</span></span> sigma_primepower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sigma<span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">e</span> <span class="main">.</span> <span class="free">p</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms divisors_def dvd_prime_power_iff prime_nat_iff rewrite_sum_of_powers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span>sigma<span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="main">(</span><span class="free">e</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_of_powers_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> sigma_prime_power_two<span class="main">:</span> <span class="quoted"><span class="quoted">"sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sigma_primepower two_is_prime_nat<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-prodsums_eq_sumprods"><span class="command">lemma</span></span> prodsums_eq_sumprods<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">p</span><span class="main">^</span><span class="bound">k</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> sigma <span class="free">m</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">p</span><span class="main">^</span><span class="bound">k</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">|</span><span class="bound">k</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">b</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coprime_imp_coprime<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dvd_trans that<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">|</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> <span class="bound">f</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_mult_sum_if_inj <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_inj_if_coprime_nat<span class="main"><span class="main">]</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sigma-div_decomp_comp"><span class="command">lemma</span></span> div_decomp_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">*</span><span class="free">n</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">∧</span> <span class="bound">b</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">c</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> division_decomp mult_dvd_mono<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> sigma_semimultiplicative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sigma <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> sigma <span class="free">m</span> <span class="main">=</span> sigma <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> cop <span class="keyword1"><span class="command">have</span></span> cop2<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">p</span><span class="main">^</span><span class="bound">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> sigma <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divisors_def dvd_prime_power_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">{</span><span class="free">p</span><span class="main">^</span><span class="bound">f</span><span class="main">*</span><span class="bound">b</span><span class="main">|</span> <span class="bound">f</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">f</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> <span class="bound">b</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prodsums_eq_sumprods prime_nat_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">{</span><span class="bound">a</span><span class="main">*</span><span class="bound">b</span><span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">.</span> <span class="bound">a</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> le_imp_power_dvd divides_primepow_nat p<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">*</span><span class="free">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cop2 div_decomp_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisors_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Perfect">
<div class="head">
<h1>Theory Perfect</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Perfect Number Theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Perfect
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Sigma.html">Sigma</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>  <span class="entity">perfect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">perfect</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> sigma <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> perfect_number_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> even<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> perfect<span class="main">:</span> <span class="quoted"><span class="quoted">"perfect <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">n</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> prime <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>                                         
  <span class="keyword1"><span class="command">from</span></span> perfect <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perfect_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"multiplicity <span class="numeral">2</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">^</span><span class="var">?n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?np</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> even m0 <span class="keyword1"><span class="command">have</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&gt;=</span> <span class="main">1</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicity_geI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="var">?n</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="var">?n</span><span class="main">*</span><span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dvd_mult_div_cancel<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> m0 <span class="keyword1"><span class="command">have</span></span> mdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span><span class="var">?n</span><span class="main">*</span><span class="var">?A</span> <span class="main">∧</span> coprime <span class="numeral">2</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiplicity_decompose <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> m0 <span class="keyword1"><span class="command">have</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_0_less_mult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> perfect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">m</span><span class="main">=</span>sigma<span class="main">(</span><span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perfect_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="var">?A</span><span class="main">=</span>sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="var">?n</span><span class="main">*</span><span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="var">?A</span><span class="main">=</span>sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="var">?n</span><span class="main">)</span><span class="main">*</span>sigma<span class="main">(</span><span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_semimultiplicative<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> formula<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="var">?A</span><span class="main">=</span><span class="main">(</span><span class="var">?np</span><span class="main">)</span><span class="main">*</span>sigma<span class="main">(</span><span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sigma_prime_power_two<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> n1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&gt;=</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power_increasing<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nplarger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">&gt;=</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">div</span> <span class="var">?np</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> formula <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span> <span class="keyword1">dvd</span> <span class="var">?A</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span> <span class="keyword1">dvd</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_diff_one_left_nat <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>multiplicity <span class="numeral">2</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_dvd_mult_left_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">*</span><span class="var">?B</span> <span class="main">=</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> a0 <span class="keyword1"><span class="command">have</span></span>  b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr0I mult_is_0<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nplarger a0 <span class="keyword1"><span class="command">have</span></span> bsmallera<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">&lt;</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> b0 bsmallera <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">&lt;</span><span class="var">?B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span><span class="main">&lt;</span><span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">:</span> divisors <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> divisors_eq_dvd dvd_triv_right<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span><span class="var">?B</span><span class="main">+</span><span class="var">?A</span> <span class="main">≤</span> sigma <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sigma_third_divisor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> nplarger <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="var">?A</span><span class="main">+</span><span class="var">?B</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?np</span><span class="main">*</span><span class="main">(</span>sigma <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> nat_mult_le_cancel1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">+</span><span class="var">?A</span><span class="main">*</span><span class="var">?np</span> <span class="main">+</span> <span class="var">?A</span><span class="main">*</span><span class="main">1</span> <span class="main">≤</span> <span class="var">?np</span><span class="main">*</span><span class="main">(</span>sigma <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">+</span><span class="var">?A</span><span class="main">*</span><span class="main">(</span><span class="var">?np</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?np</span><span class="main">*</span><span class="main">(</span>sigma <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>add_mult_distrib2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nplarger <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?np</span><span class="main">*</span><span class="main">(</span>sigma <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> formula <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> bdef <span class="keyword1"><span class="command">have</span></span> adef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span><span class="main">=</span><span class="var">?np</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> formula <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?np</span><span class="main">*</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?np</span> <span class="main">*</span> sigma<span class="main">(</span><span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nplarger adef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">+</span> <span class="main">1</span><span class="main">=</span>sigma<span class="main">(</span><span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_iff_sigma<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mdef adef <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="var">?n</span> <span class="main">*</span> <span class="var">?np</span> <span class="main">∧</span> prime <span class="var">?np</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Euclid_book9_prop36<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"perfect <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> perfect_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">n</span> <span class="main">&gt;</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≠</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p primes_coprime_nat two_is_prime_nat<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"sigma <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sigma_semimultiplicative two_is_prime_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_imp_sigma<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_prime_power_two<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sigma<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span><span class="main">*</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="numeral">2</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>