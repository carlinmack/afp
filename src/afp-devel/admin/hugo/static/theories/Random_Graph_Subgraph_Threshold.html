<div id="Ugraph_Misc">
<div class="head">
<h1>Theory Ugraph_Misc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Miscellaneous and contributed lemmas›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ugraph_Misc
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
  <a href="../Girth_Chromatic/Girth_Chromatic_Misc.html">Girth_Chromatic.Girth_Chromatic_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Ugraph_Misc-sum_square"><span class="command">lemma</span></span> sum_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>monoid_mult<span class="main">,</span> semiring_0<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_product power2_eq_square<span class="main">)</span>

<span class="keyword1" id="Ugraph_Misc-sum_split"><span class="command">lemma</span></span> sum_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">p</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">p</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">p</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.If_cases Int_def<span class="main">)</span>

<span class="keyword1" id="Ugraph_Misc-sum_split2"><span class="command">lemma</span></span> sum_split2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">Q</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">Q</span> <span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum.If_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∩</span> Collect <span class="free">Q</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∩</span> <span class="main">-</span> Collect <span class="free">Q</span> <span class="main">=</span>  <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∩</span> Collect <span class="free">Q</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">g</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∩</span> <span class="main">-</span> Collect <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span><span class="main">}</span> <span class="main">+</span> sum <span class="free">g</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-sum_upper"><span class="command">lemma</span></span> sum_upper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_comm_monoid_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">I</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> add.comm_neutral add_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-sum_lower"><span class="command">lemma</span></span> sum_lower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_comm_monoid_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> sum <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_mono2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-sum_lower_or_eq"><span class="command">lemma</span></span> sum_lower_or_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> ordered_comm_monoid_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_mono2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">I</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-sum_left_div_distrib"><span class="command">lemma</span></span> sum_left_div_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="free">I</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="free">f</span> <span class="free">I</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_distrib_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="free">f</span> <span class="free">I</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-powr_mono3"><span class="command">lemma</span></span> powr_mono3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">powr</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">powr</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-card_union"><span class="command">lemma</span></span> card_union<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span> <span class="main">+</span> card <span class="free">B</span> <span class="main">-</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_Un_Int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> diff_add_inverse2<span class="main">)</span>

<span class="keyword1" id="Ugraph_Misc-card_1_element"><span class="command">lemma</span></span> card_1_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">E</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms card_ge_0_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">a</span> <span class="var">?E'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card.insert_remove <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?E'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?E'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-card_2_elements"><span class="command">lemma</span></span> card_2_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">E</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms card_ge_0_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="skolem">a</span> <span class="var">?E'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card.insert_remove <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">E</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> card <span class="var">?E'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?E'</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_1_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?E'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-bij_lift"><span class="command">lemma</span></span> bij_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span> <span class="main">(</span><span class="operator">metis</span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inv_into_image_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Pow <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_Pow_surj<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-card_inj_subs"><span class="command">lemma</span></span> card_inj_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> card <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_image subset_inj_on<span class="main">)</span>

<span class="keyword1" id="Ugraph_Misc-image_comp_cong"><span class="command">lemma</span></span> image_comp_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">less_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≪</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Ugraph_Misc-LIMSEQ_power_zero"><span class="command">lemma</span></span> LIMSEQ_power_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⇢</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>  <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_eq_0_iff tendsto_power<span class="main">)</span>

  <span class="keyword1" id="Ugraph_Misc-LIMSEQ_cong"><span class="command">lemma</span></span> LIMSEQ_cong<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⇢</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⇢</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_sandwich<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> h <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">print_statement</span></span> Lim_transform_eventually


  <span class="keyword1" id="Ugraph_Misc-LIMSEQ_le_zero"><span class="command">lemma</span></span> LIMSEQ_le_zero<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_sandwich<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tendsto_const assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Ugraph_Misc-LIMSEQ_const_mult"><span class="command">lemma</span></span> LIMSEQ_const_mult<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⇢</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Ugraph_Misc-LIMSEQ_const_div"><span class="command">lemma</span></span> LIMSEQ_const_div<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⇢</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">a</span> <span class="main">/</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LIMSEQ_const_mult<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">c</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Ugraph_Misc-quot_bounds"><span class="command">lemma</span></span> quot_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y'</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">y'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">/</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x'</span> <span class="main">/</span> <span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">/</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x'</span> <span class="main">/</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">*</span> <span class="free">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">/</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x'</span> <span class="main">/</span> <span class="free">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-less_fun_bounds"><span class="command">lemma</span></span> less_fun_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≪</span> <span class="free">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">g'</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">g</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">g'</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≪</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> real_tendsto_sandwich<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">f'</span> <span class="bound">n</span> <span class="main">/</span> <span class="free">g'</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> quot_bounds<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Ugraph_Misc-less_fun_const_quot"><span class="command">lemma</span></span> less_fun_const_quot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≪</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">b</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_const_div<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LIMSEQ_const_mult<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> eventually_sequentiallyI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Lim_transform_eventually<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-partition_set_of_intersecting_sets_by_card"><span class="command">lemma</span></span> partition_set_of_intersecting_sets_by_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>card <span class="free">A</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">B</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>card <span class="free">A</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">B</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span>

<span class="keyword1" id="Ugraph_Misc-card_set_of_intersecting_sets_by_card"><span class="command">lemma</span></span> card_set_of_intersecting_sets_by_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> card <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∧</span> card <span class="bound">B</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>card <span class="free">A</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>card <span class="free">I</span> <span class="main">-</span> card <span class="free">A</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> finite_A <span class="main">=</span> finite_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∧</span> card <span class="bound">B</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="bound">K</span><span class="main">.</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">K</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?lhs</span> <span class="main">=</span> card <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">B'</span><span class="main">)</span><span class="main">.</span> <span class="bound">K</span> <span class="main">∪</span> <span class="bound">B'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?rhs</span> <span class="main">=</span> <span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?rhs</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">K</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∪</span> <span class="skolem">B'</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">B</span> <span class="main">=</span> card <span class="skolem">K</span> <span class="main">+</span> card <span class="skolem">B'</span> <span class="main">-</span> card <span class="main">(</span><span class="skolem">K</span> <span class="main">∩</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_union finite_A finite_subset finite_Diff<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∩</span> <span class="skolem">B'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">K</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?K</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B finite_A assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute card_Diff_subset_Int finite_Un inf.left_idem le_iff_inf sup_absorb2<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?K</span><span class="main">,</span> <span class="var">?B'</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="var">?K</span><span class="main">,</span> <span class="var">?B'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?rhs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">K</span></span> <span class="main">|</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">K</span> <span class="main">=</span> <span class="free">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_SigmaI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">K</span><span class="main">.</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">K</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Pow <span class="free">A</span>"</span></span><span class="main"><span class="main">]</span></span> finite_A<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> card <span class="skolem">K</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">K</span><span class="main">.</span> <span class="bound">K</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">K</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">*</span> card <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">-</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>card <span class="free">A</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>card <span class="main">(</span><span class="free">I</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> n_subsets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_A<span class="main"><span class="main">]</span></span> n_subsets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Diff<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>card <span class="free">A</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>card <span class="free">I</span> <span class="main">-</span> card <span class="free">A</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_A assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-card_dep_pair_set"><span class="command">lemma</span></span> card_dep_pair_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">a</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∧</span> card <span class="bound">b</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">a</span></span> <span class="main">|</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">a</span> <span class="main">=</span> <span class="free">n</span><span class="main">.</span> card <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> Sigma <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">a</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">⊆</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∧</span> card <span class="bound">b</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Sigma <span class="var">?A</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Sigma <span class="var">?A</span> <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">a</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> card <span class="main">(</span><span class="var">?B</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_SigmaI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Collect_subsets<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?B</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> finite_Collect_subsets<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> card <span class="bound">a</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?B</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="free">g</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> n_subsets<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Sigma <span class="var">?A</span> <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> S<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-prod_cancel_nat"><span class="command">lemma</span></span> prod_cancel_nat<span class="main">:</span>
  <span class="comment1">― ‹Contributed by Manuel Eberl›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="free">A</span> <span class="main">/</span> prod <span class="free">f</span> <span class="free">B</span> <span class="main">=</span> prod <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span> <span class="main">=</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prod.subset_diff<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?C</span> <span class="main">*</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Misc-prod_id_cancel_nat"><span class="command">lemma</span></span> prod_id_cancel_nat<span class="main">:</span>
  <span class="comment1">― ‹Contributed by Manuel Eberl›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">A</span> <span class="main">/</span> <span class="main">∏</span><span class="free">B</span> <span class="main">=</span> <span class="main">∏</span><span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_cancel_nat<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> integrable_squareD<span class="main">:</span>
  <span class="comment1">― ‹Contributed by Johannes Hölzl›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> max <span class="main">1</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ always_eventually<span class="main"><span class="main">[</span></span><span class="operator">OF</span> allI<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">X</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> norm <span class="main">(</span>max <span class="main">1</span> <span class="main">(</span><span class="main">(</span><span class="free">X</span> <span class="skolem">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> abs_le_square_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="skolem">x</span>"</span></span><span class="main">]</span> power_increasing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">X</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prob_Lemmas">
<div class="head">
<h1>Theory Prob_Lemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Prob_Lemmas
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
  <a href="../Girth_Chromatic/Girth_Chromatic.html">Girth_Chromatic.Girth_Chromatic</a>
  <a href="Ugraph_Misc.html">Ugraph_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Lemmas about probabilities›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In this section, auxiliary lemmas for computing bounds on expectation and probabilites
of random variables are set up.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Indicator variables and valid probability values›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rind</span> <span class="main">≡</span> indicator"</span></span>

<span class="keyword1" id="Prob_Lemmas-product_indicator"><span class="command">lemma</span></span> product_indicator<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rind <span class="free">A</span> <span class="free">x</span> <span class="main">*</span> rind <span class="free">B</span> <span class="free">x</span> <span class="main">=</span> rind <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> indicator_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We call a real number `valid' iff it is in the range 0 to 1, inclusively, and additionally
`nonzero' iff it is neither 0 nor 1.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_prob</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≡</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nonzero_prob</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≡</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">⇒</span></span> real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a `valid probability function' iff each value in the image
is valid, and similarly for `nonzero'.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_prob_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> valid_prob <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nonzero_prob_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> nonzero_prob <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prob_Lemmas-nonzero_fun_is_valid_fun"><span class="command">lemma</span></span> nonzero_fun_is_valid_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"nonzero_prob_fun <span class="free">f</span> <span class="main">⟹</span> valid_prob_fun <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Expectation and variance›</span></span>

<span class="keyword1"><span class="command">context</span></span> prob_space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that there is already a notion of independent sets (see <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">indep_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), but we use
the following -- simpler -- definition:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">indep</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> prob <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> prob <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> prob <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The probability of an indicator variable is equal to its expectation:›</span></span>

<span class="keyword1" id="Prob_Lemmas-expectation_indicator"><span class="command">lemma</span></span> expectation_indicator<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> events <span class="main">⟹</span> expectation <span class="main">(</span>rind <span class="free">A</span><span class="main">)</span> <span class="main">=</span> prob <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For a non-negative random variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the Markov inequality gives the following
upper bound: \[ \Pr[X \ge a] \le \frac{\Ex[X]}{a} \]›</span></span>

<span class="keyword1" id="Prob_Lemmas-markov_inequality"><span class="command">lemma</span></span> markov_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">X</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> <span class="free">X</span> <span class="bound">a</span><span class="main">}</span> <span class="main">≤</span> expectation <span class="free">X</span> <span class="main">/</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹proof adapted from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] edge_space.Markov_inequality<span class="antiquote">}</span></span>, but generalized to arbitrary
       <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">prob_space</span><span class="antiquote">}</span></span>s›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x</span> <span class="main">∂</span><span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_eq_integral<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nn_integral_Markov_inequality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"space <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nn_integral_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> emeasure_eq_measure ennreal_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$\Var[X] = \Ex[X^2] - \Ex[X]^2 $›</span></span>

<span class="keyword1" id="Prob_Lemmas-variance_expectation"><span class="command">lemma</span></span> variance_expectation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span> <span class="main">-</span> expectation <span class="free">X</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?integrable</span></span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"variance <span class="free">X</span> <span class="main">=</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>expectation <span class="free">X</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?variance</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> integrable_squareD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span> <span class="main">-</span> expectation <span class="free">X</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>expectation <span class="free">X</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">x</span> <span class="main">*</span> expectation <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> power2_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"variance <span class="free">X</span> <span class="main">=</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">X</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>expectation <span class="free">X</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">X</span> <span class="bound">x</span> <span class="main">*</span> expectation <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="var"><span class="quoted"><span class="var">?integrable</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> integral_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int assms prob_space<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?variance</span></span></span> <span class="var"><span class="quoted"><span class="var">?integrable</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int power2_eq_square<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A corollary from the Markov inequality is Chebyshev's inequality, which gives an upper
bound for the deviation of a random variable from its expectation:
\[ \Pr[\left| Y - \Ex[Y] \right| \ge s] \le \frac{\Var[X]}{a^2} \]›</span></span>

<span class="keyword1" id="Prob_Lemmas-chebyshev_inequality"><span class="command">lemma</span></span> chebyshev_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_borel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">Y</span> <span class="bound">a</span> <span class="main">-</span> expectation <span class="free">Y</span><span class="main">¦</span><span class="main">}</span> <span class="main">≤</span> variance <span class="free">Y</span> <span class="main">/</span> <span class="free">s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">a</span> <span class="main">-</span> expectation <span class="free">Y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≤</span> <span class="var">?X</span> <span class="bound">a</span><span class="main">}</span> <span class="main">≤</span> variance <span class="free">Y</span> <span class="main">/</span> <span class="free">s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> markov_inequality variance_expectation<span class="main">[</span><span class="operator">OF</span> Y_int Y_borel<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="var">?t</span> <span class="main">≤</span> <span class="var">?X</span> <span class="bound">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">Y</span> <span class="bound">a</span> <span class="main">-</span> expectation <span class="free">Y</span><span class="main">¦</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs_le_square_iff s_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Hence, we can derive an upper bound for the probability that a random variable is $0$.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> chebyshev_prob_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Y_borel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> μ_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"expectation <span class="free">Y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>expectation <span class="free">Y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"expectation <span class="free">Y</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">Y</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="var">?s</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">Y</span> <span class="bound">a</span> <span class="main">-</span> <span class="var">?s</span><span class="main">¦</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Y_borel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_measure_mono borel_measurable_diff borel_measurable_abs borel_measurable_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> variance <span class="free">Y</span> <span class="main">/</span> <span class="var">?s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> chebyshev_inequality<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>expectation <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="var">?s</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="var">?s</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Y_int Y_borel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> variance_expectation<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">Y</span> <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="var">?s</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> μ_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Sets of indicator variables›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\label{sec:delta}
This section introduces some inequalities about expectation and other values related to the sum of
a set of random indicators.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> prob_space_with_indicators <span class="main">=</span> prob_space <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">`</span> <span class="free">I</span> <span class="main">⊆</span> events"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> prob_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We call the underlying sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for each <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and the corresponding
indicator variables <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">X</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The sum is denoted by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and its expectation by
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">μ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> rind <span class="main">(</span><span class="free">A</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> X <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">=</span> expectation Y"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the lecture notes, the following two relations are called $\sim$ and $\nsim$,
respectively. Note that they are not the opposite of each other.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ineq_indep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ineq_indep</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> indep <span class="main">(</span><span class="free">A</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ineq_dep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ineq_dep</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="main">¬</span>indep <span class="main">(</span><span class="free">A</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_dep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prob_Lemmas-Δ_zero"><span class="command">lemma</span></span> Δ_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> indep <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_dep <span class="skolem">i</span> <span class="bound">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_dep <span class="skolem">i</span> <span class="bound">j</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum.empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">*</span> card <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prob_Lemmas-A_events"><span class="command">lemma</span></span> A_events<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">A</span> <span class="free">i</span> <span class="main">∈</span> events"</span></span>
<span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prob_Lemmas-expectation_X_Y"><span class="command">lemma</span></span> expectation_X_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"μ <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> expectation <span class="main">(</span>X <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> μ_def Y_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> X_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_top<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Prob_Lemmas-expectation_X_non_zero"><span class="command">lemma</span></span> expectation_X_non_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> expectation <span class="main">(</span>X <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">using</span></span> prob_non_zero expectation_indicator <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> μ_non_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> μ"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> expectation_X_Y
<span class="keyword1"><span class="command">using</span></span> expectation_X_non_zero
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_lower finite_I
         <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expectation_indicator X_def<span class="main">)</span>

<span class="keyword1" id="Prob_Lemmas-Δ"><span class="command">lemma</span></span> Δ<span class="hidden">⇩</span><sub>d</sub>_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Δ<span class="hidden">⇩</span><sub>d</sub>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>d</sub>_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> μ_sq_non_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zero_less_power<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Prob_Lemmas-Y_square_unfold"><span class="command">lemma</span></span> Y_square_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Y <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> rind <span class="main">(</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff Y_def X_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_square product_indicator<span class="main">)</span>

<span class="keyword1" id="Prob_Lemmas-integrable_Y_sq"><span class="command">lemma</span></span> integrable_Y_sq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"integrable <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>Y <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Y_square_unfold
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sets.Int less_top<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Prob_Lemmas-measurable_Y"><span class="command">lemma</span></span> measurable_Y<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Y <span class="main">∈</span> borel_measurable <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Y_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prob_Lemmas-expectation_Y_Δ"><span class="command">lemma</span></span> expectation_Y_Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Y <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ei</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> expectation <span class="main">(</span>rind <span class="main">(</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Y <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Y_square_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_top<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_split<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_I<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?lhs</span> <span class="main">+</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> μ"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="skolem">i</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="skolem">i</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> expectation <span class="main">(</span>rind <span class="main">(</span><span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?ei</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> expectation <span class="main">(</span>rind <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> μ"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> expectation_X_Y X_def <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> μ"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> Δ<span class="hidden">⇩</span><sub>a</sub>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="skolem">j</span> <span class="main">∈</span> events"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ei</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> prob <span class="main">(</span><span class="free">A</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> expectation_indicator<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>a</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">+</span> <span class="var">?rhs</span> <span class="main">=</span> μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prob_Lemmas-Δ_expectation_X"><span class="command">lemma</span></span> Δ_expectation_X<span class="main">:</span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>a</sub> <span class="main">≤</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free">A</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ie</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> indep <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>a</sub> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="var">?ie</span> <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>a</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_indep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_dep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_split2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_I<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_indep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?lhs</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_right_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_indep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_indep <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p'</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> indep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="var">?p'</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">j</span></span> <span class="main">|</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> ineq_indep <span class="skolem">i</span> <span class="bound">j</span><span class="main">.</span> <span class="var">?p'</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="var">?p'</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_upper<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_I<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_le_mult_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> prob <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sum_square<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> expectation <span class="main">(</span>X <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">using</span></span> expectation_indicator A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> expectation_X_Y<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> μ<span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prob_Lemmas-prob_μ_Δ"><span class="command">lemma</span></span> prob_μ_Δ<span class="hidden">⇩</span><sub>a</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> Y <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub> <span class="main">/</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> Y <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>Y <span class="bound">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> μ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chebyshev_prob_zero<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> μ_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub><span class="main">)</span> <span class="main">/</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> expectation_Y_Δ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub> <span class="main">/</span> μ<span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> add_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prob_Lemmas-prob_μ_Δ"><span class="command">lemma</span></span> prob_μ_Δ<span class="hidden">⇩</span><sub>d</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> Y <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span>μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub><span class="main">/</span>μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> Y <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span>μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub><span class="main">/</span>μ<span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> prob_μ_Δ<span class="hidden">⇩</span><sub>a</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>μ <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>a</sub><span class="main">/</span>μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>μ <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>μ<span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub><span class="main">)</span><span class="main">/</span>μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divide_right_mono<span class="main">[</span><span class="operator">OF</span> Δ_expectation_X<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span>μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub><span class="main">/</span>μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> μ_sq_non_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ugraph_Lemmas">
<div class="head">
<h1>Theory Ugraph_Lemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Lemmas about undirected graphs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ugraph_Lemmas
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Prob_Lemmas.html">Prob_Lemmas</a>
  <a href="../Girth_Chromatic/Girth_Chromatic.html">Girth_Chromatic.Girth_Chromatic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The complete graph is a graph where all possible edges are present. It is wellformed by
definition.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">complete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> ugraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">complete</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> all_edges <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-complete_wellformed"><span class="command">lemma</span></span> complete_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span>complete <span class="free">V</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> complete_def uwellformed_def all_edges_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the set of vertices is finite, the set of edges in the complete graph is finite.›</span></span>

<span class="keyword1" id="Ugraph_Lemmas-all_edges_finite"><span class="command">lemma</span></span> all_edges_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span> <span class="main">⟹</span> finite <span class="main">(</span>all_edges <span class="free">V</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> all_edges_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> complete_finite_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span> <span class="main">⟹</span> finite <span class="main">(</span>uedges <span class="main">(</span>complete <span class="free">V</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> complete_def <span class="keyword1"><span class="command">using</span></span> all_edges_finite
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The sets of possible edges of disjoint sets of vertices are disjoint.›</span></span>

<span class="keyword1" id="Ugraph_Lemmas-all_edges_disjoint"><span class="command">lemma</span></span> all_edges_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> all_edges <span class="free">S</span> <span class="main">∩</span> all_edges <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> all_edges_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A graph is called `finite' if its set of edges and its set of vertices are finite.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">finite_graph</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> finite <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The complete graph is finite.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> complete_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span> <span class="main">⟹</span> finite_graph <span class="main">(</span>complete <span class="free">V</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> complete_finite_edges <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def complete_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A graph is called `nonempty' if it contains at least one vertex and at least one edge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nonempty_graph</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> uverts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A random graph is both wellformed and finite.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> edge_space<span class="main">)</span> wellformed_and_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> Pow S_edges"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span>edge_ugraph <span class="free">E</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span>edge_ugraph <span class="free">E</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="main">(</span>edge_ugraph <span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> edge_ugraph_def S_verts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uedges <span class="main">(</span>edge_ugraph <span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> edge_ugraph_def S_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> all_edges_finite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span>edge_ugraph <span class="free">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complete_wellformed <span class="keyword1"><span class="command">unfolding</span></span> edge_ugraph_def S_edges_def complete_def uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The probability for a random graph to have $e$ edges is $p ^ e$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> edge_space<span class="main">)</span> cylinder_empty_prob<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> S_edges <span class="main">⟹</span> prob <span class="main">(</span>cylinder S_edges <span class="free">A</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span>card <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cylinder_prob <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Subgraphs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subgraph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subgraph</span> <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> uverts <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="main">⊆</span> uverts <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> uedges <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="main">⊆</span> uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_refl"><span class="command">lemma</span></span> subgraph_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_trans"><span class="command">lemma</span></span> subgraph_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G''</span> <span class="free">G'</span> <span class="main">⟹</span> subgraph <span class="free">G'</span> <span class="free">G</span> <span class="main">⟹</span> subgraph <span class="free">G''</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_antisym"><span class="command">lemma</span></span> subgraph_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G</span> <span class="free">G'</span> <span class="main">⟹</span> subgraph <span class="free">G'</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Product_Type.prod_eqI<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_complete"><span class="command">lemma</span></span> subgraph_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G</span> <span class="main">(</span>complete <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> uedges <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">e</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">e</span> <span class="main">⟹</span> <span class="bound">u</span> <span class="main">∈</span> uverts <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_2_elements<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> mk_uedge <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> uverts <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> uverts <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> all_edges <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> all_edges_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> complete_def subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> wellformed_all_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span> <span class="main">⟹</span> uedges <span class="free">G</span> <span class="main">⊆</span> all_edges <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subgraph_complete subgraph_def complete_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_finite"><span class="command">lemma</span></span> subgraph_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite_graph <span class="free">G</span><span class="main">;</span> subgraph <span class="free">G'</span> <span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> finite_graph <span class="free">G'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def subgraph_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rev_finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> wellformed_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subgraph_finite<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"complete <span class="main"><span class="main">(</span></span>uverts <span class="free"><span class="free">G</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G</span> <span class="main">(</span>complete <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subgraph_complete<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uedges <span class="main">(</span>complete <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complete_finite_edges<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span>complete <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def complete_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subgraphs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subgraphs</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">G'</span><span class="main">.</span> subgraph <span class="bound">G'</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonempty_subgraphs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nonempty_subgraphs</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">G'</span><span class="main">.</span> uwellformed <span class="bound">G'</span> <span class="main">∧</span> subgraph <span class="bound">G'</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> nonempty_graph <span class="bound">G'</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraphs_finite"><span class="command">lemma</span></span> subgraphs_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>subgraphs <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subgraphs <span class="free">G</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">E'</span><span class="main">)</span><span class="main">.</span> <span class="bound">V'</span> <span class="main">⊆</span> uverts <span class="free">G</span> <span class="main">∧</span> <span class="bound">E'</span> <span class="main">⊆</span> uedges <span class="free">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraphs_def subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uedges <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> nonempty_subgraphs_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span> <span class="main">⟹</span> finite <span class="main">(</span>nonempty_subgraphs <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> subgraphs_finite
<span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def subgraphs_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Induced subgraphs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">induced_subgraph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"uvert set <span class="main">⇒</span> ugraph <span class="main">⇒</span> ugraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">induced_subgraph</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∩</span> all_edges <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-induced_is_subgraph"><span class="command">lemma</span></span> induced_is_subgraph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> uverts <span class="free">G</span> <span class="main">⟹</span> subgraph <span class="main">(</span>induced_subgraph <span class="free">V</span> <span class="free">G</span><span class="main">)</span> <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> uverts <span class="free">G</span> <span class="main">⟹</span> subgraph <span class="main">(</span>induced_subgraph <span class="free">V</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span>complete <span class="free">V</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_def induced_subgraph_def complete_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Ugraph_Lemmas-induced_wellformed"><span class="command">lemma</span></span> induced_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span> <span class="main">⟹</span> <span class="free">V</span> <span class="main">⊆</span> uverts <span class="free">G</span> <span class="main">⟹</span> uwellformed <span class="main">(</span>induced_subgraph <span class="free">V</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def induced_subgraph_def all_edges_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_union_induced"><span class="command">lemma</span></span> subgraph_union_induced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uverts <span class="free">H<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uverts <span class="free">H<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">H<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">H<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">H<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>induced_subgraph <span class="free">S</span> <span class="free">G</span><span class="main">)</span> <span class="main">∧</span> subgraph <span class="free">H<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>induced_subgraph <span class="free">T</span> <span class="free">G</span><span class="main">)</span> <span class="main">⟷</span>
         subgraph <span class="main">(</span>uverts <span class="free">H<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> uverts <span class="free">H<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> uedges <span class="free">H<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∪</span> uedges <span class="free">H<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> induced_subgraph_def subgraph_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">using</span></span> all_edges_mono <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> all_edges_mono <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> wellformed_all_edges<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> wellformed_all_edges<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> all_edges_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> all_edges_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> edge_space<span class="main">)</span> induced_subgraph_prob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uverts <span class="free">H</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> S_verts"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> subgraph <span class="free">H</span> <span class="main">(</span>induced_subgraph <span class="free">V</span> <span class="main">(</span>edge_ugraph <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"prob <span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="var">?A</span> <span class="main">=</span> prob <span class="main">(</span>cylinder S_edges <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cylinder_def space_eq subgraph_def induced_subgraph_def edge_ugraph_def S_edges_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Collect_cong<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> Pow_iff all_edges_mono fst_conv inf_absorb1 inf_bot_left le_inf_iff snd_conv wellformed_all_edges<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">p</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cylinder_empty_prob<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="free">H</span> <span class="main">⊆</span> all_edges <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_all_edges<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_edges <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> all_edges S_verts"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_edges_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uedges <span class="free">H</span> <span class="main">⊆</span> S_edges"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> S_edges_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Graph isomorphism›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We define graph isomorphism slightly different than in the literature. The usual definition
is that two graphs are isomorphic iff there exists a bijection between the vertex sets which
preserves the adjacency. However, this complicates many proofs.

Instead, we define the intuitive mapping operation on graphs. An isomorphism between two graphs
arises if there is a suitable mapping function from the first to the second graph. Later, we show
that this operation can be inverted.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_ugraph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> ugraph <span class="main">⇒</span> ugraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">map_ugraph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isomorphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">isomorphism</span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> bij_betw <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> map_ugraph <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">isomorphic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≃</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> uwellformed <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> uwellformed <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> isomorphism <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">G<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-map_ugraph_id"><span class="command">lemma</span></span> map_ugraph_id<span class="main">:</span> <span class="quoted"><span class="quoted">"map_ugraph id <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fun_eq_iff
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ugraph_Lemmas-map_ugraph_trans"><span class="command">lemma</span></span> map_ugraph_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"map_ugraph <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_ugraph <span class="free">g</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>map_ugraph <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff image_image<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-map_ugraph_wellformed"><span class="command">lemma</span></span> map_ugraph_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span> uedges <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>uedges <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps snd_conv surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> uedges <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">e</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">⊆</span> uverts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">e'</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_inj_subs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="skolem">e'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> uverts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> e<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> uverts <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">∈</span> uverts <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps fst_conv surjective_pairing<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-map_ugraph_finite"><span class="command">lemma</span></span> map_ugraph_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span> <span class="main">⟹</span> finite_graph <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI fst_conv map_ugraph.simps snd_conv surjective_pairing<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-map_ugraph_preserves_sub"><span class="command">lemma</span></span> map_ugraph_preserves_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>map_ugraph <span class="free">f</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps fst_conv snd_conv surjective_pairing<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_refl"><span class="command">lemma</span></span> isomorphic_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">≃</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_id id_def map_ugraph_id<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_trans"><span class="command">lemma</span></span> isomorphic_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> map_ugraph <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> map_ugraph <span class="skolem">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_comp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> map_ugraph <span class="var">?f</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ugraph_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_sym"><span class="command">lemma</span></span> isomorphic_sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"isomorphism <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> map_ugraph <span class="skolem">f</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv_into <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bij'<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?f'</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_inv_into<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="var">?f'</span> <span class="main">`</span> uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij' <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="var">?f'</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> id <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="var">?f'</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊆</span> uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"id <span class="skolem">a</span> <span class="main">=</span> inv_into <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">a</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> id_def bij bij_betw_imp_inj_on inv_into_image_cancel<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="var">?f'</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="var">?f'</span> <span class="main">`</span> <span class="bound">e</span><span class="main">)</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bij map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps prod.collapse snd_eqD<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isomorphism <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="var">?f'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps split_pairs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> isomorphism <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_cards"><span class="command">lemma</span></span> isomorphic_cards<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span>"</span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"card <span class="main">(</span>uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>uedges <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?E</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> map_ugraph <span class="skolem">f</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">`</span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="var">?g</span> <span class="main">(</span>Pow <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pow <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_lift<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> Pow <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?g</span> <span class="main">`</span> uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>uedges <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_inj_subs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map map_ugraph.simps snd_conv surjective_pairing<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Isomorphic subgraphs›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The somewhat sloppy term `isomorphic subgraph' denotes a subgraph which is isomorphic to a
fixed other graph. For example, saying that a graph contains a triangle usually means that it
contains \emph{any} triangle, not the specific triangle with the nodes $1$, $2$ and $3$. Hence, such
a graph would have a triangle as an isomorphic subgraph.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subgraph_isomorphic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> ugraph <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊑</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> uwellformed <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">G''</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="main">≃</span> <span class="bound">G''</span> <span class="main">∧</span> subgraph <span class="bound">G''</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_is_subgraph_isomorphic"><span class="command">lemma</span></span> subgraph_is_subgraph_isomorphic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> uwellformed <span class="free">G'</span><span class="main">;</span> uwellformed <span class="free">G</span><span class="main">;</span> subgraph <span class="free">G'</span> <span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">G'</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isomorphic_refl<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_is_subgraph_isomorphic"><span class="command">lemma</span></span> isomorphic_is_subgraph_isomorphic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subgraph_refl<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_isomorphic_refl"><span class="command">lemma</span></span> subgraph_isomorphic_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isomorphic_refl subgraph_refl<span class="main">)</span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_isomorphic_pre_iso_closed"><span class="command">lemma</span></span> subgraph_isomorphic_pre_iso_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≃</span> <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isomorphic_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">G''</span><span class="main">.</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="bound">G''</span> <span class="main">∧</span> subgraph <span class="bound">G''</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_isomorphic_pre_subgraph_closed"><span class="command">lemma</span></span> subgraph_isomorphic_pre_subgraph_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≃</span> <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>uverts <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> map_ugraph <span class="skolem">f</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_ugraph <span class="skolem">f</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> uverts <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="var">?G<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_ugraph_wellformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="var">?G<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps fst_conv surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="var">?G<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="comment1">(* Yes, I will TOTALLY understand that step tomorrow. *)</span>
    <span class="keyword1"><span class="command">using</span></span> subgraph_trans<span class="main">[</span><span class="operator">OF</span> map_ugraph_preserves_sub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> bij<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹subgraph <span class="skolem">G<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">G''</span><span class="main">.</span> <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="bound">G''</span> <span class="main">∧</span> subgraph <span class="bound">G''</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> subgraph_isomorphic_pre_closed <span class="main">=</span> subgraph_isomorphic_pre_subgraph_closed subgraph_isomorphic_pre_iso_closed

<span class="keyword1" id="Ugraph_Lemmas-subgraph_isomorphic_trans"><span class="command">lemma</span></span> subgraph_isomorphic_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊑</span> <span class="free">G<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="skolem">G</span>"</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subgraph_isomorphic_pre_closed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_isomorphic_post_iso_closed"><span class="command">lemma</span></span> subgraph_isomorphic_post_iso_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">H</span> <span class="main">⊑</span> <span class="free">G</span><span class="main">;</span> <span class="free">G</span> <span class="main">≃</span> <span class="free">G'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">H</span> <span class="main">⊑</span> <span class="free">G'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> isomorphic_is_subgraph_isomorphic subgraph_isomorphic_trans
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> subgraph_isomorphic_post_closed <span class="main">=</span> subgraph_isomorphic_post_iso_closed

<span class="keyword1"><span class="command">lemmas</span></span> subgraph_isomorphic_closed <span class="main">=</span> subgraph_isomorphic_pre_closed subgraph_isomorphic_post_closed

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Density›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The density of a graph is the quotient of the number of edges and the number of vertices of
a graph.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">density</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> card <span class="main">(</span>uedges <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">/</span> card <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The maximum density of a graph is the density of its densest nonempty subgraph.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_density</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">max_density</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> Lattices_Big.Max <span class="main">(</span>density <span class="main">`</span> nonempty_subgraphs <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We prove some obvious results about the maximum density, such as that there is a subgraph
which has the maximum density and that the (maximum) density is preserved by isomorphisms. The
proofs are a bit complicated by the fact that most facts about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Lattices_Big.Max</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> require
non-emptiness of the target set, but we need that anyway to get a value out of it.›</span></span>

<span class="keyword1" id="Ugraph_Lemmas-subgraph_has_max_density"><span class="command">lemma</span></span> subgraph_has_max_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">G'</span><span class="main">.</span> density <span class="bound">G'</span> <span class="main">=</span> max_density <span class="free">G</span> <span class="main">∧</span> subgraph <span class="bound">G'</span> <span class="free">G</span> <span class="main">∧</span> nonempty_graph <span class="bound">G'</span> <span class="main">∧</span> finite_graph <span class="bound">G'</span> <span class="main">∧</span> uwellformed <span class="bound">G'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">∈</span> nonempty_subgraphs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">using</span></span> subgraph_refl assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density <span class="free">G</span> <span class="main">∈</span> density <span class="main">`</span> nonempty_subgraphs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>density <span class="main">`</span> nonempty_subgraphs <span class="free">G</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max_density <span class="free">G</span> <span class="main">∈</span> <span class="main">(</span>density <span class="main">`</span> nonempty_subgraphs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_density_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonempty_subgraphs_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> Max.closed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">using</span></span> subgraph_finite<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-max_density_is_max"><span class="command">lemma</span></span> max_density_is_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">G'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="free">G'</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density <span class="free">G'</span> <span class="main">≤</span> max_density <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> max_density_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>density <span class="main">`</span> nonempty_subgraphs <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonempty_subgraphs_finite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"density <span class="free">G'</span> <span class="main">∈</span> density <span class="main">`</span> nonempty_subgraphs <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-max_density_gr_zero"><span class="command">lemma</span></span> max_density_gr_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> max_density <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>uverts <span class="free">G</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>uedges <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def nonempty_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> density <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="free">G</span> <span class="main">≤</span> max_density <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_density_is_max subgraph_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_density"><span class="command">lemma</span></span> isomorphic_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"density <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> density <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> density_def
<span class="keyword1"><span class="command">using</span></span> isomorphic_cards<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ugraph_Lemmas-isomorphic_max_density"><span class="command">lemma</span></span> isomorphic_max_density<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≃</span> <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_density <span class="free">G<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> max_density <span class="free">G<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹The proof strategy is not completely straightforward. We first show that if two graphs are
       isomorphic, the maximum density of one graph is less or equal than the maximum density of
       the other graph. The reason is that this proof is quite long and the desired result directly
       follows from the symmetry of the isomorphism relation.\footnote{Some famous mathematician
       once said that if you prove that $a \le b$ and $b \le a$, you know \emph{that} these
       numbers are equal, but not \emph{why}. Since many proofs in this work are mostly opaque to
       me, I can live with that.}›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≃</span> <span class="skolem">B</span>"</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> map_ugraph <span class="skolem">f</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span>uverts <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>uverts <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iso <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">― ‹We observe that the set of densities of the subgraphs does not change if we map the
         subgraphs first.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="main">`</span> nonempty_subgraphs <span class="skolem">A</span> <span class="main">=</span> density <span class="main">`</span> <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="main">`</span> nonempty_subgraphs <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_comp_cong<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> nonempty_subgraphs <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"uverts <span class="skolem">G</span> <span class="main">⊆</span> uverts <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="skolem">G</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">(</span>uverts <span class="skolem">G</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_inj_on<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">≃</span> map_ugraph <span class="skolem">f</span> <span class="skolem">G</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def bij_betw_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps fst_conv surjective_pairing map_ugraph_wellformed <span class="quoted"><span class="quoted">‹uwellformed <span class="skolem">G</span>›</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"density <span class="skolem">G</span> <span class="main">=</span> density <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">G</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> isomorphic_density<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="comment1">― ‹Additionally, we show that the operations <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">nonempty_subgraphs</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">map_ugraph</span><span class="antiquote">}</span></span>
         can be swapped without changing the densities. This is an obvious result, because
         <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">map_ugraph</span><span class="antiquote">}</span></span> does not change the structure of a graph. Still, the proof is a bit
         hairy, which is why we only show inclusion in one direction and use symmetry of isomorphism
         later.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> density <span class="main">`</span> nonempty_subgraphs <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G''</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G''</span> <span class="main">∈</span> map_ugraph <span class="skolem">f</span> <span class="main">`</span> nonempty_subgraphs <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G'</span></span> <span class="keyword2"><span class="keyword">where</span></span> G_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G''</span> <span class="main">=</span> map_ugraph <span class="skolem">f</span> <span class="skolem">G'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G'</span> <span class="main">∈</span> nonempty_subgraphs <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> G'<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G'</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="skolem">G'</span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="skolem">G'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">(</span>uverts <span class="skolem">G'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_inj_on<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="skolem">G''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> map_ugraph_wellformed G' G_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="skolem">G''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> G' G_subst <span class="keyword1"><span class="command">unfolding</span></span> nonempty_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_ugraph.simps fst_conv snd_conv surjective_pairing empty_is_image<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">G''</span> <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> map_ugraph_preserves_sub G' G_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G''</span> <span class="main">∈</span> nonempty_subgraphs <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="main">`</span> nonempty_subgraphs <span class="skolem">A</span> <span class="main">⊆</span> density <span class="main">`</span> nonempty_subgraphs <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max_density <span class="skolem">A</span> <span class="main">≤</span> max_density <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> max_density_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> nonempty_subgraphs <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A iso <span class="keyword1"><span class="command">unfolding</span></span> nonempty_subgraphs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subgraph_refl<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"density <span class="main">`</span> nonempty_subgraphs <span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nonempty_subgraphs <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonempty_subgraphs_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_ugraph_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>density <span class="main">`</span> nonempty_subgraphs <span class="main">(</span>map_ugraph <span class="skolem">f</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max_density <span class="skolem">A</span> <span class="main">≤</span> max_density <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> f<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> le<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> isomorphic_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Fixed selectors›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹\label{sec:selector}
In the proof of the main theorem in the lecture notes, the concept of a ``fixed copy'' of a graph is
fundamental.

Let $H$ be a fixed graph. A `fixed selector' is basically a function mapping a set with the same
size as the vertex set of $H$ to a new graph which is isomorphic to $H$ and its vertex set is the
same as the input set.\footnote{We call such a selector \emph{fixed} because its result is
deterministic.}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_fixed_selector</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">V</span><span class="main">.</span> finite <span class="bound">V</span> <span class="main">∧</span> card <span class="main">(</span>uverts <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">=</span> card <span class="bound">V</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≃</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">V</span> <span class="main">∧</span> uverts <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">V</span><span class="main">)</span> <span class="main">=</span> <span class="bound">V</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Obviously, there may be many possible fixed selectors for a given graph. First, we show
that there is always at least one. This is sufficient, because we can always obtain that one and
use its properties without knowing exactly which one we chose.›</span></span>

<span class="keyword1" id="Ugraph_Lemmas-ex_fixed_selector"><span class="command">lemma</span></span> ex_fixed_selector<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"is_fixed_selector <span class="free">H</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="comment1">― ‹I guess this is the only place in the whole work where we make use of a nifty little HOL
       feature called \emph{SOME}, which is basically Hilbert's choice operator. The reason is that
       any bijection between the the vertex set of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span> and the input set gives rise to a
       fixed selector function. In the lecture notes, a specific bijection was defined, but this
       is shorter and more elegant.›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bij</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">V</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">g</span><span class="main">.</span> bij_betw <span class="bound">g</span> <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span> <span class="bound">V</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">V</span><span class="main">.</span> map_ugraph <span class="main">(</span><span class="var">?bij</span> <span class="bound">V</span><span class="main">)</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"uvert set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">V</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">V</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="var">?bij</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_same_card_bij someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"uverts <span class="main">(</span><span class="var">?f</span> <span class="skolem">V</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">V</span> <span class="main">∧</span> uwellformed <span class="main">(</span><span class="var">?f</span> <span class="skolem">V</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_ugraph_wellformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_def map_ugraph.simps fst_conv surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≃</span> <span class="var">?f</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> isomorphism_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> * **
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fixed_selector <span class="free">H</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_fixed_selector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ugraph_Lemmas-fixed_selector_induced_subgraph"><span class="command">lemma</span></span> fixed_selector_induced_subgraph<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fixed_selector <span class="free">H</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> card <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="main">(</span><span class="free">f</span> <span class="free">V</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="free">V</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> uverts <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≃</span> <span class="free">f</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"uverts <span class="main">(</span><span class="free">f</span> <span class="free">V</span><span class="main">)</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_fixed_selector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> isomorphic_is_subgraph_isomorphic<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> post<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">V</span> <span class="main">⊑</span> induced_subgraph <span class="free">V</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subgraph_is_subgraph_isomorphic<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> induced_wellformed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> G V<span class="main"><span class="main">]</span></span> post sub<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subgraph_is_subgraph_isomorphic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> induced_wellformed<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G V induced_is_subgraph<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> V<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊑</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ugraph_Properties">
<div class="head">
<h1>Theory Ugraph_Properties</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Classes and properties of graphs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ugraph_Properties
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Ugraph_Lemmas.html">Ugraph_Lemmas</a>
  <a href="../Girth_Chromatic/Girth_Chromatic.html">Girth_Chromatic.Girth_Chromatic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A ``graph property'' is a set of graphs which is closed under isomorphism.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ugraph_class <span class="main">=</span> <span class="quoted"><span class="quoted">"ugraph set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ugraph_property</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph_class <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ugraph_property</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">G</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">G'</span><span class="main">.</span> <span class="bound">G</span> <span class="main">≃</span> <span class="bound">G'</span> <span class="main">⟶</span> <span class="bound">G'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prob_in_class</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> ugraph_class <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prob_in_class</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> probGn <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> edge_space.edge_ugraph <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">es</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹From now on, we consider random graphs not with fixed edge probabilities but rather with a
probability function depending on the number of vertices. Such a function is called a ``threshold''
for a graph property iff
\begin{itemize}
  \item for asymptotically \emph{larger} probability functions, the probability that a random graph
    is an element of that class tends to \emph{$1$} (``$1$-statement''), and
  \item for asymptotically \emph{smaller} probability functions, the probability that a random graph
    is an element of that class tends to \emph{$0$} (``$0$-statement'').
\end{itemize}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_threshold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph_class <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_threshold</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> ugraph_property <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> nonzero_prob_fun <span class="bound">p</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="bound">p</span> <span class="main">≪</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> prob_in_class <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⇢</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≪</span> <span class="bound">p</span> <span class="main">⟶</span> prob_in_class <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⇢</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Ugraph_Properties-is_thresholdI"><span class="command">lemma</span></span> is_thresholdI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ugraph_property <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> nonzero_prob_fun <span class="bound">p</span><span class="main">;</span> <span class="bound">p</span> <span class="main">≪</span> <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> prob_in_class <span class="bound">p</span> <span class="free">c</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">⟦</span> nonzero_prob_fun <span class="bound">p</span><span class="main">;</span> <span class="free">t</span> <span class="main">≪</span> <span class="bound">p</span> <span class="main">⟧</span> <span class="main">⟹</span> prob_in_class <span class="bound">p</span> <span class="free">c</span> <span class="main">⇢</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_threshold <span class="free">c</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_threshold_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Subgraph_Threshold">
<div class="head">
<h1>Theory Subgraph_Threshold</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹The subgraph threshold theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Subgraph_Threshold
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Ugraph_Properties.html">Ugraph_Properties</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> edge_space<span class="main">)</span> measurable_pred<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Measurable.pred P <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def sets_point_measure space_point_measure subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This section contains the main theorem. For a fixed nonempty graph $H$, we consider the graph
property of `containing an isomorphic subgraph of $H$'. This is obviously a valid property, since
it is closed under isomorphism.

The corresponding threshold function is

  \[ t(n) = n^{-\frac{1}{\rho'(H)}}, \]

where $\rho'$ denotes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">max_density</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subgraph_threshold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ugraph <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subgraph_threshold</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph <span class="free">H</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_threshold <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ugraph_property <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ugraph_property_def <span class="keyword1"><span class="command">using</span></span> subgraph_isomorphic_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>

  <span class="comment1">― ‹To prove the 0-statement, we introduce the subgraph with the maximum density as $H_0$. Note
       that $\rho(H_0) = \rho'(H)$.›</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="hidden">⇩</span><sub>0</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"density <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> max_density <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subgraph_has_max_density assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nonempty_graph_def finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> p_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"nonzero_prob_fun <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_prob_fun <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> nonzero_fun_is_valid_fun<span class="main">)</span>

  <span class="comment1">― ‹Firstly, we follow from the assumption that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">p</span></span><span class="antiquote">}</span></span> is asympotically less than the
       threshold function that the product
       \[ p(n)^{|E(H_0)|} \cdot n^{|V(H_0)|} \]
       tends to $0$.›</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≪</span> subgraph_threshold <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> density <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card <span class="keyword1"><span class="command">unfolding</span></span> density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subgraph_threshold_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_nz<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card<span class="main">(</span>2<span class="main">)</span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tendsto_zero_powrI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="var">?e</span> <span class="main">*</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="var">?v</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_sequentiallyI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p card p_nz powr_powr powr_mult<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>

    <span class="keyword1"><span class="command">interpret</span></span> ES<span class="main">:</span> edge_space <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?graph_of</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ES.edge_ugraph"</span></span>

    <span class="comment1">― ‹After fixing an <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n</span></span><span class="antiquote">}</span></span>, we define a family of random variables $X$ indexed by a set of
         vertices $v$ and a set of edges $e$. Each $X$ is an indicator for the event that $(v, e)$
         is isomorphic to $H_0$ and a subgraph of a random graph. The sum of all these variables
         is denoted by $Y$ and counts the total number of copies of $H_0$ in a random graph.›</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> rind <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space ES.P<span class="main">.</span> subgraph <span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">(</span><span class="var">?graph_of</span> <span class="bound">es</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≃</span> <span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">v</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">⊆</span> all_edges <span class="bound">v</span> <span class="main">∧</span> card <span class="bound">e</span> <span class="main">=</span> <span class="var">?e</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">∑</span><span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="var">?X</span> <span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="bound">es</span>"</span></span>

    <span class="comment1">― ‹Now we prove an upper bound for the probability that a random graph contains a copy of
         <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span>. Observe that in that case, $Y$ takes a value greater or equal than $1$.›</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob_in_class <span class="skolem">p</span> <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="skolem">n</span> <span class="main">=</span> probGn <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="var">?graph_of</span> <span class="bound">es</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> probGn <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="bound">es</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ES.finite_measure_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">es</span>
        <span class="keyword3"><span class="command">assume</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">∈</span> space <span class="main">(</span>MGn <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>

        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊑</span> <span class="var">?graph_of</span> <span class="skolem">es</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊑</span> <span class="var">?graph_of</span> <span class="skolem">es</span>"</span></span> <span class="comment1">― ‹since <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote">}</span></span> is a subgraph of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span>›</span>
          <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subgraph_isomorphic_pre_subgraph_closed<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> H<span class="hidden">⇩</span><sub>0</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">(</span><span class="var">?graph_of</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≃</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> subgraph_isomorphic_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="skolem">es</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_lower_or_eq<span class="main">)</span>
            <span class="comment1">― ‹The only relevant step here is to provide the specific instance of $(v, e)$ such
                 that $X_{(v, e)}$ takes a value greater or equal than $1$. This is trivial, as we
                 already obtained that one above (i.e. <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span></span><span class="antiquote">}</span></span>). The remainder of the proof is
                 just bookkeeping.›</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="var">?X</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">es</span>"</span></span> <span class="comment1">― ‹by definition of $X$›</span>
              <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub>' es <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> <span class="skolem">es</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub>'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def ES.edge_ugraph_def ES.S_verts_def ES.S_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?e</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isomorphic_cards<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">≃</span></span> <span class="skolem"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span></span>›</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> all_edges <span class="main">(</span>uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed_all_edges<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">⊆</span> subgraphs <span class="main">(</span>complete <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> complete_def subgraphs_def subgraph_def <span class="keyword1"><span class="command">using</span></span> all_edges_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>subgraphs <span class="main">(</span>complete <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_finite subgraphs_finite<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

    <span class="comment1">― ‹Applying Markov's inequality leaves us with estimating the expectation of $Y$, which is
         the sum of the individual $X$.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ES.expectation <span class="var">?Y</span> <span class="main">/</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prob_space.markov_inequality<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ES.prob_space_P sum_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ES.expectation <span class="var">?Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> ES.expectation <span class="main">(</span><span class="var">?X</span> <span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integral_sum<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">simp</span>

    <span class="comment1">― ‹Each expectation is bound by $p(n)^{|E(H_0)|}$. For the proof, we ignore the fact that the
         corresponding graph has to be isomorphic to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote">}</span></span>, which only increases the
         probability and thus the expectation. This only leaves us to compute the probability that
         all edges are present, which is given by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] edge_space.cylinder_prob<span class="antiquote">}</span></span>.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="hidden">⇩</span><sub>0</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ES.expectation <span class="main">(</span><span class="var">?X</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">=</span> ES.prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space ES.P<span class="main">.</span> subgraph <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">(</span><span class="var">?graph_of</span> <span class="bound">es</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≃</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ES.expectation_indicator<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ES.sets_eq ES.space_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ES.prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space ES.P<span class="main">.</span> uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> <span class="bound">es</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> subgraph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ES.finite_measure_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ES.sets_eq ES.space_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ES.prob <span class="main">(</span>cylinder ES.S_edges <span class="main">(</span>uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> cylinder_def ES.space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ES.cylinder_empty_prob<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> all_edges <span class="main">(</span>uverts <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> all_edges <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> all_edges_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"uedges <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⊆</span> ES.S_edges"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> ES.S_edges_def ES.S_verts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H<span class="hidden">⇩</span><sub>0</sub>' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ES.expectation <span class="main">(</span><span class="var">?X</span> <span class="skolem">H<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span>
          <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">― ‹Since we have a sum of constant summands, we can rewrite it as a product.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="var">?I</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_constant<span class="main">)</span>

    <span class="comment1">― ‹We have to count the number of possible pairs $(v, e)$. From the definition of the index
         set, note that we first choose $|V(H_0)|$ elements out of a set of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n</span></span><span class="antiquote">}</span></span> vertices and
         then $|E(H_0)|$ elements out of all possible edges over these vertices.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"card <span class="var"><span class="var">?I</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?I</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">v</span></span> <span class="main">|</span> <span class="bound">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">v</span> <span class="main">=</span> <span class="var">?v</span><span class="main">.</span> card <span class="main">(</span>all_edges <span class="bound">v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_dep_pair_set<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">..</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?v</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">all_edges</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset all_edges_finite<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">v</span></span> <span class="main">|</span> <span class="bound">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">v</span> <span class="main">=</span> <span class="var">?v</span><span class="main">.</span> <span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">v</span> <span class="main">=</span> <span class="var">?v</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">v</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>all_edges <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span> <span class="main">=</span> <span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_all_edges finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">v</span> <span class="main">=</span> <span class="var">?v</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_subsets<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?I</span> <span class="main">=</span> <span class="main">…</span>"</span></span>
          <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="comment1">― ‹Here, we use $n^k$ as an upper bound for $\binom n k$.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> binomial_le_pow<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> n<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_le_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="var">?e</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?factor</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?factor</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?e</span> <span class="main">*</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n card<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹nonzero_prob_fun <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_realpow<span class="main">)</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob_in_class <span class="skolem">p</span> <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="var">?factor</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?e</span> <span class="main">*</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="comment1">― ‹The final upper bound is a multiple of the expression which we have proven to tend to $0$
       in the beginning.›</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prob_in_class <span class="skolem">p</span> <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_le_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_mult_right_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit<span class="main"><span class="main">]</span></span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measure_nonneg<span class="main"><span class="main">]</span></span> eventually_sequentiallyI<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> p_threshold<span class="main">:</span> <span class="quoted"><span class="quoted">"subgraph_threshold <span class="free">H</span> <span class="main">≪</span> <span class="skolem">p</span>"</span></span>

  <span class="comment1">― ‹To prove the 1-statement, we obtain a fixed selector <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">f</span></span><span class="antiquote">}</span></span> as defined in section
       \ref{sec:selector}.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fixed_selector <span class="free">H</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_fixed_selector <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uverts <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹We observe that several terms involving $|V(H)|$ are positive.›</span>
  <span class="keyword1"><span class="command">have</span></span> v_e_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="var">?v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="var">?e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty finite <span class="keyword1"><span class="command">unfolding</span></span> nonempty_graph_def finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> vpowv_inv_gr_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹For a given $n$, let $A$ be a family of events indexed by a set $S$. Each $A$ contains the
       graphs whose induced subgraphs over $S$ contain the selected copy of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span> by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">f</span></span><span class="antiquote">}</span></span>
       over $S$.›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space <span class="main">(</span>edge_space.P <span class="bound">n</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> subgraph <span class="main">(</span><span class="skolem">f</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="bound">S</span> <span class="main">(</span>edge_space.edge_ugraph <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> card <span class="bound">S</span> <span class="main">=</span> <span class="var">?v</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> p_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"nonzero_prob_fun <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_prob_fun <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> nonzero_fun_is_valid_fun<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="comment1">― ‹At this point, we can assume almost anything about <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n</span></span><span class="antiquote">}</span></span>: We only have to show that
         a function converges, hence the necessary properties are allowed to be violated for small
         values of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n</span></span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword3"><span class="command">assume</span></span> n_2v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> is_es<span class="main">:</span> <span class="quoted"><span class="quoted">"edge_space <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> edge_space <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">n</span>"</span></span>

    <span class="comment1">― ‹A nice potpourri with some technical facts about <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">S</span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">=</span> card <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≃</span> <span class="skolem">f</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"uverts <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f wellformed_finite <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def is_fixed_selector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>3<span class="main">)</span> 1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wellformed_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_eq_0_iff finite finite_graph_def isomorphic_cards<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nonempty nonempty_graph_def prod.collapse snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> 0 1 2 3
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> I <span class="main">=</span> this

    <span class="comment1">― ‹In the following two blocks, we prove the probabilities of the events $A$ and the
         probability of the intersection of two events $A$. For both cases, we employ the auxiliary
         lemma <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source] edge_space.induced_subgraph_prob<span class="antiquote">}</span></span> which is not very interesting.
         For the latter however, the tricky part is to argue that such an intersection is equivalent
         to the \emph{union} of the desired copies of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span> to be contained in the \emph{union}
         of the induced subgraphs.›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
      <span class="keyword3"><span class="command">assume</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> S' <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> S<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> isomorphic_cards<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> S'<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> S' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_verts_def induced_subgraph_prob<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> prob_A <span class="main">=</span> this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">note</span></span> T <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="comment1">― ‹Note that we do not restrict <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">S</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">T</span></span><span class="antiquote">}</span></span> to be disjoint, since we need the
           general case later to determine when two events are independent. Additionally, it would
           be unneeded at this point.›</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> subgraph <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>edge_ugraph <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> prob <span class="var">?M</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">prob</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> subgraph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="skolem">S</span> <span class="main">(</span>edge_ugraph <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> subgraph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="skolem">T</span> <span class="main">(</span>edge_ugraph <span class="bound">es</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?M</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subgraph_union_induced<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">…</span>"</span></span>
            <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> induced_subgraph_prob<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span><span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> T<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∪</span> <span class="skolem">T</span> <span class="main">⊆</span> S_verts"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S<span class="main">(</span>1<span class="main">)</span> T<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> S_verts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> prob_A_intersect <span class="main">=</span> this

    <span class="comment1">― ‹Another technical detail is that our family of events $A$ are a valid instantiation for
         the ``$\Delta$ lemmas'' from section \ref{sec:delta}.›</span>
    <span class="keyword1"><span class="command">have</span></span> is_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"prob_space_with_indicators P <span class="var">?I</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Pow <span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">..</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">`</span> <span class="var">?I</span> <span class="main">⊆</span> sets P"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sets_eq space_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> prob <span class="main">(</span><span class="var">?A</span> <span class="var">?V</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_A n p_nz<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> prob_space_with_indicators <span class="quoted"><span class="quoted">"P"</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
      <span class="keyword1"><span class="command">.</span></span>

    <span class="comment1">― ‹We proceed by reducing the claim of the 1-statement that the probability tends to $1$ to
         showing that the expectation that the sum of all indicators of the respective events $A$
         tends to $0$. (The actual reduction is done at the end of the proof, we merely collect
         the facts here.)›</span>
    <span class="keyword1"><span class="command">have</span></span> compl_prob<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_ugraph <span class="bound">es</span><span class="main">}</span> <span class="main">=</span> prob_in_class <span class="skolem">p</span> <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prob_compl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> space_eq sets_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">prob</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_ugraph <span class="bound">es</span><span class="main">}</span> <span class="main">≤</span> prob <span class="main">{</span><span class="bound"><span class="bound">es</span></span> <span class="main">∈</span> space P<span class="main">.</span> Y <span class="bound">es</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?compl</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_measure_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">es</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">∈</span> space P"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span>edge_ugraph <span class="skolem">es</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> space_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_and_finite<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_ugraph <span class="skolem">es</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">S</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> uverts <span class="main">(</span>edge_ugraph <span class="skolem">es</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> uverts_edge_ugraph S_verts_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> subgraph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span>induced_subgraph <span class="skolem">S</span> <span class="main">(</span>edge_ugraph <span class="skolem">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> H es <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fixed_selector_induced_subgraph<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"X <span class="skolem">S</span> <span class="skolem">es</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Y <span class="skolem">es</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

    <span class="comment1">― ‹By applying the $\Delta$ lemma, we obtain our central inequality. The rest of the proof
         gives bounds for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">μ</span><span class="antiquote">}</span></span>, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">Δ<span class="hidden">⇩</span><sub>d</sub></span><span class="antiquote">}</span></span> and quotients which occur on the right hand side.›</span>
    <span class="keyword1"><span class="command">hence</span></span> compl_upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?compl</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> μ <span class="main">+</span> Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">/</span> μ<span class="main">^</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> prob_μ_Δ<span class="hidden">⇩</span><sub>d</sub><span class="main">)</span>

    <span class="comment1">― ‹Lower bound for the expectation. We use $\left(\frac n k\right)^k$ as lower bound for
         $\binom n k$.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">/</span> <span class="var">?v</span><span class="main">)</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> binomial_ge_n_over_k_pow_k<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_subsets<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prob_A<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> μ"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expectation_X_Y X_def <span class="keyword1"><span class="command">using</span></span> expectation_indicator <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ex_lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span> <span class="main">≤</span> μ"</span></span>
      <span class="keyword1"><span class="command">.</span></span>

    <span class="comment1">― ‹Upper bound for the inverse expectation. Follows trivially from above.›</span>
    <span class="keyword1"><span class="command">have</span></span> ex_lower_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_pos_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vpowv_inv_gr_z mult_pos_pos<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n nonempty finite <span class="keyword1"><span class="command">unfolding</span></span> nonempty_graph_def finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> μ <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex_lower zero_le_one mult_pos_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> μ_non_zero<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> inv_ex_upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> μ <span class="main">≤</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="comment1">― ‹Recall the definition of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Δ<span class="hidden">⇩</span><sub>d</sub>"</span><span class="antiquote">}</span></span>:
         \[ \Delta_d = \sum\limits_{\substack{S \in I,\, T \in I\\S \neq T\\A_S,\, A_T \text{ not independent}}} \Pr[A_S \cap A_T] \]
         We are going to prove an upper bound for that sum, so we can safely augment the index set
         by replacing it with a neccessary condition.

         The idea is that if the two sets $S$ and $T$ are not independent, their intersection is not
         empty. We prove that by contraposition, i.e. if the intersection is empty, then they are
         independent. This in turn can be shown using some basic properties of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">f</span></span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">*</span> prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prob_A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_even_eq power2_eq_square<span class="main">)</span>

      <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">S</span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var">?I</span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> T <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">T</span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var">?I</span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">assume</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">∈</span> <span class="var">?I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> prob_A_intersect<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> card_Un_disjoint<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wellformed_finite<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> all_edges <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊆</span> all_edges <span class="skolem">T</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> T<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wellformed_all_edges<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_edges <span class="skolem">S</span> <span class="main">∩</span> all_edges <span class="skolem">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> all_edges_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disj<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> isomorphic_cards<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> isomorphic_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> isomorphic_cards<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> isomorphic_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> T<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span>
        <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">from</span></span> * ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"indep <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> indep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> indep <span class="main">=</span> this

    <span class="comment1">― ‹Now we prove an upper bound for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Δ<span class="hidden">⇩</span><sub>d</sub>"</span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">T</span></span> <span class="main">|</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> ineq_dep <span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Δ<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">..</span></span>

    <span class="comment1">― ‹Augmenting the index set as described above.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">T</span></span> <span class="main">|</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> <span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_mono2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indep measure_nonneg<span class="main">)</span>

    <span class="comment1">― ‹So far, we are adding the intersection probabilities over pairs of sets which have a
         nonempty intersection. Since we know that these intersections have at least one element
         (as they are nonempty) and at most $|V(H)|$ elements (by definition of $I$). In this step,
         we will partition this sum by cardinality of the intersections.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">T</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> I<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">T</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="bound">T</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">T</span><span class="main">.</span> card <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_set_of_intersecting_sets_by_card<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="bound">T</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">T</span></span> <span class="main">|</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.UNION_disjoint<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">T</span></span> <span class="main">|</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">.</span> prob <span class="main">(</span><span class="var">?A</span> <span class="bound">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>

    <span class="comment1">― ‹In this step, we compute an upper bound for the intersection probability and argue that
         it only depends on the cardinality of the intersection.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">T</span></span> <span class="main">|</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span> <span class="main">∈</span> <span class="var">?I</span> <span class="main">∧</span> card <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ST_k<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> S <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">S</span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var">?I</span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">note</span></span> T <span class="main">=</span> I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">T</span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∈</span></span></span></span></span></span></span> <span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var"><span class="var">?I</span></span></span></span></span></span></span>›</span></span></span></span></span></span></span></span><span class="main">]</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cST</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>

        <span class="comment1">― ‹We already know the intersection probability.›</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">∈</span> <span class="var">?I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> prob_A_intersect<span class="main">)</span>

        <span class="comment1">― ‹Now, we consider the number of edges shared by the copies of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span> over <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">S</span></span><span class="antiquote">}</span></span>
             and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">T</span></span><span class="antiquote">}</span></span>.›</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span>card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="var">?cST</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> S T <span class="keyword1"><span class="command">unfolding</span></span> finite_graph_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_union<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="var">?e</span> <span class="main">+</span> <span class="var">?e</span> <span class="main">-</span> <span class="var">?cST</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isomorphic_cards<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> S<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> isomorphic_cards<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> T<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> <span class="var">?cST</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> <span class="var">?cST</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_realpow<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span> <span class="main">-</span> real <span class="var">?cST</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> isomorphic_cards<span class="main">[</span><span class="operator">OF</span> S<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> S<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_diff card_mono finite_graph_def inf_le1 mult_le_mono mult_numeral_1 numeral_One one_le_numeral<span class="main">)</span>

        <span class="comment1">― ‹Since the intersection graph is also an isomorphic subgraph of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span>, we know that
             its density has to be less than or equal to the maximum density of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">H</span></span><span class="antiquote">}</span></span>. The proof
             is quite technical.›</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> powr_mono3<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cST</span> <span class="main">=</span> density <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> density_def <span class="keyword1"><span class="command">using</span></span> k ST_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> max_density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="comment1">(* EXTREME METIS!!!1 *)</span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"density <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> density_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">≤</span> max_density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_density_is_max subgraph_refl<span class="main">)</span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"density <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max_density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">.</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"density <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max_density <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> max_density_is_max<span class="main">)</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite_graph <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> T<span class="main">(</span>3<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Int finite_graph_def fst_eqD snd_conv<span class="main">)</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nonempty_graph <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> nonempty_graph_def <span class="keyword1"><span class="command">using</span></span> k ST_k False <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"uwellformed <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> S<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> T<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> uwellformed_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff fst_eqD snd_eqD<span class="main">)</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subgraph <span class="main">(</span><span class="skolem">S</span> <span class="main">∩</span> <span class="skolem">T</span><span class="main">,</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∩</span> uedges <span class="main">(</span><span class="skolem">f</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> S<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD inf_sup_ord<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv subgraph_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isomorphic_max_density<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> G<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">H</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> G<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">S</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cST</span> <span class="main">≤</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> real <span class="var">?cST</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_nz<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prob <span class="main">(</span><span class="var">?A</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="var">?A</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span>
          <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">― ‹Further rewriting the index sets.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">S</span> <span class="main">:</span> <span class="var">?I</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.Sigma<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> card <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">S</span> <span class="main">:</span> <span class="var">?I</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>

    <span class="comment1">― ‹Here, we compute the cardinality of the index sets and use the same upper bounds for
         the binomial coefficients as for the 0-statement.›</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?v</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">S</span> <span class="main">:</span> <span class="var">?I</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">T</span></span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> card <span class="main">(</span><span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?I</span><span class="main">.</span> <span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_set_of_intersecting_sets_by_card<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_subsets<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?v</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_le_pow<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_le_pow<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="var">?v</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n_2v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_le_pow<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="var">?v</span> <span class="main">+</span> <span class="main">(</span><span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_2<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="var">?lhs</span> <span class="main">≤</span> real <span class="var">?rhs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> of_nat_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">*</span> <span class="var">?p</span> <span class="main">≤</span> <span class="var">?rhs</span> <span class="main">*</span> <span class="var">?p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?v</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="var">?p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">*</span> <span class="var">?p</span> <span class="main">≤</span> <span class="main">…</span>"</span></span>
          <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> delta_upper<span class="main">:</span> <span class="quoted"><span class="quoted">"Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?v</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>

    <span class="comment1">― ‹At this point, we have established all neccessary bounds.›</span>
    <span class="keyword1"><span class="command">note</span></span> is_es is_psi compl_prob compl_upper ex_lower ex_lower_pos inv_ex_upper delta_upper
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> facts <span class="main">=</span> this

  <span class="comment1">― ‹Recall our central inequality. We now prove that both summands tend to $0$. This is mainly
       an exercise in bookkeeping and real arithmetics as no intelligent ideas are involved.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_le_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_le_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_sequentiallyI eventually_sequentiallyI<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n p_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_realpow<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span>real <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span>real <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> v_e_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_powr<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="var">?v</span> <span class="main">/</span> <span class="var">?e</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_mult<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="var">?e</span> <span class="main">/</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> powr_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ mult_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> powr_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_imp_neg_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> divide_left_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> n v_e_nz p p_nz
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
              max_density_is_max<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> density_def<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> finite finite nonempty wellformed subgraph_refl<span class="main"><span class="main">]</span></span>
              max_density_gr_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite nonempty wellformed<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> p p_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> subgraph_threshold_def <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span> <span class="bound">n</span> <span class="main">/</span> <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">powr</span> real <span class="main">(</span>card <span class="main">(</span>uedges <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> p_threshold p_nz v_e_nz
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subgraph_threshold_def divide_nonneg_pos <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_zero_powrI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> real <span class="main">(</span><span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_const_mult<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> divide_pos_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ prob_space_with_indicators.μ_non_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> facts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less_fun_bounds<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?num</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?v</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?den</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="var">?v</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>

      <span class="comment1">― ‹We have to show that a sum is asymptotically smaller than a constant term. We do that by
           showing that each summand is asymptotically smaller than the term.›</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?den'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> den'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?den'</span> <span class="main">=</span> <span class="var">?den</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_mult_distrib<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib power_even_eq<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≪</span> <span class="var">?den'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> less_fun_const_quot<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span> <span class="bound">n</span> <span class="main">/</span> <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> p_threshold mult_pos_pos<span class="main">[</span><span class="operator">OF</span> max_density_gr_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite nonempty wellformed<span class="main"><span class="main">]</span></span><span class="main">]</span> p_nz k
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subgraph_threshold_def divide_nonneg_pos <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_zero_powrI<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_sequentiallyI<span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
                <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                      <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> n p_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_realpow<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span>real <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span> <span class="main">-</span> max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> real <span class="skolem"><span class="skolem">k</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span>real <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> max_density_gr_zero<span class="main">[</span><span class="operator">OF</span> finite nonempty wellformed<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_powr<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_powr<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_mult<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus_divide<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> max_density <span class="free">H</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p p_nz<span class="main">)</span>
                <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>subgraph_threshold <span class="free">H</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>max_density <span class="free">H</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> subgraph_threshold_def <span class="keyword1"><span class="command">..</span></span>
                <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
                  <span class="keyword1"><span class="command">.</span></span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?lhs</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="var">?v</span> <span class="main">^</span> <span class="var">?v</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> vpowv_inv_gr_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≪</span> <span class="var">?den</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> den'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span> <span class="main">/</span> <span class="var">?den</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_sum<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span> <span class="main">/</span> <span class="var">?den</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span> <span class="main">/</span> <span class="var">?den</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">/</span> <span class="var">?den</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_left_div_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≪</span> <span class="var">?den</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="var">?v</span><span class="main">.</span> <span class="var">?num</span> <span class="bound">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="var">?den</span> <span class="bound">n</span> <span class="main">≤</span> <span class="main">(</span>prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>5<span class="main">)</span> facts<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ less_imp_le<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub>_nonneg<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prob_space_with_indicators.μ_sq_non_zero<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?den</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> zero_less_power<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span>
      <span class="main">1</span> <span class="main">/</span> prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">+</span>
      prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>
    <span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_0_left<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> tendsto_add<span class="main">)</span>

  <span class="comment1">― ‹By now, we can actually perform the reduction mentioned above.›</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> probGn <span class="skolem">p</span> <span class="bound">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_space.edge_ugraph <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_le_zero<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> probGn <span class="skolem">p</span> <span class="bound">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_space.edge_ugraph <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> measure_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span>
        probGn <span class="skolem">p</span> <span class="bound">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_space.edge_ugraph <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span> <span class="main">≤</span>
          <span class="main">1</span> <span class="main">/</span> prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">+</span>
          prob_space_with_indicators.Δ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>prob_space_with_indicators.μ <span class="main">(</span>MGn <span class="skolem">p</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="var">?A</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> facts<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> probGn <span class="skolem">p</span> <span class="bound">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="free">H</span> <span class="main">⊑</span> edge_space.edge_ugraph <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tendsto_diff<span class="main">[</span><span class="operator">OF</span> tendsto_const<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prob_in_class <span class="skolem">p</span> <span class="main">{</span><span class="bound">G</span><span class="main">.</span> <span class="free">H</span> <span class="main">⊑</span> <span class="bound">G</span><span class="main">}</span> <span class="main">⇢</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> facts<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>