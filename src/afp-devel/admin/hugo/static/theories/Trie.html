<div id="Trie">
<div class="head">
<h1>Theory Trie</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Andreas Lochbihler and Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Trie"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Trie
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/AList.html">HOL-Library.AList</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* A truly generic Trie would be parameterized by the data type for mappings
in each node. For this purpose the mapping type needs to become a bnf.

import "HOL-Library.Mapping"

lift_definition all_mapping :: "('b ⇒ bool) ⇒ ('a, 'b) mapping ⇒ bool"
is "λp m. ∀a b. m a = Some b ⟶ p b" .

lemma all_mapping_cong [fundef_cong]:
  "m = n ⟹ (⋀x y. Mapping.lookup n x = Some y ⟹ p y = q y) ⟹ all_mapping p m = all_mapping q n"
by transfer auto

lift_definition set_mapping :: "('a,'b)mapping ⇒ 'b set" is "λf. Union(set_option ` range f)" .

lift_definition rel_mapping :: "('b ⇒ 'c ⇒ bool) ⇒ ('a,'b)mapping ⇒ ('a,'c)mapping ⇒ bool"
  is "λr. rel_fun (=) (rel_option r)" .

bnf "('a,'b)mapping"
  map: "Mapping.map id"
  sets: set_mapping
  bd: "BNF_Cardinal_Arithmetic.csum (card_of (UNIV::'a set)) natLeq"
  wits: Mapping.empty
  rel: rel_mapping
proof-
  case goal1 show ?case by(rule Mapping.map.id)
next
  case goal2 show ?case by transfer (simp add: fun_eq_iff option.map_comp)
next
  case goal3 thus ?case by transfer (auto simp: fun_eq_iff intro: option.map_cong)
next
  case goal4 thus ?case by transfer (auto simp: fun_eq_iff)
next
  case goal5 thus ?case
    by (simp add: Field_card_of Field_natLeq card_of_card_order_on csum_def)
next
  case goal6 thus ?case
    by (simp add: cinfinite_csum natLeq_cinfinite)
next
  case goal7 thus ?case
    apply transfer
    apply(rule ordLeq_transitive[OF comp_single_set_bd[where fset=set_option and gset=range, of natLeq "BNF_Cardinal_Arithmetic.csum (card_of (UNIV::'d set)) natLeq"]])
    apply (rule natLeq_Card_order)
    apply(rename_tac opt)
    apply(case_tac opt)
    apply (simp add: card_of_empty1 natLeq_Well_order)
    using Card_order_singl_ordLeq Field_natLeq natLeq_Card_order apply fastforce
    apply(rule ordLeq_transitive[OF card_of_image])
    apply (simp add: card_of_Card_order ordLeq_csum1)
    apply(rule cprod_cinfinite_bound)
    apply(rule ordLeq_refl)
    apply (rule Card_order_csum)
    apply (simp add: natLeq_Card_order ordLeq_csum2)
    apply (rule Card_order_csum)
    apply (rule natLeq_Card_order)
    using Cinfinite_csum natLeq_Card_order natLeq_cinfinite by blast
next
  case goal8 thus ?case apply(rule predicate2I) apply transfer
    by(auto simp: option.rel_compp rel_fun_def)
next
  case goal9 show ?case
    unfolding OO_Grp_alt fun_eq_iff
    apply transfer
    apply safe
    apply(rename_tac f g)
    apply(rule_tac x = "λx. case (f x, g x) of (Some u,Some v) ⇒ Some(u,v) | _ ⇒ None" in exI)
    apply(auto simp: fun_eq_iff rel_fun_def elim!: Option.option.rel_cases split: option.splits)
    apply (metis option.rel_inject(2))
    apply (metis rel_option_None1)
    apply(auto simp add: option.rel_map subset_eq intro!: rel_option_reflI split: prod.splits)
    done
next
  case goal10 thus ?case by transfer simp
qed
*)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">=</span>
  Trie <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> option"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">*</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>trie<span class="main">)</span> list"</span></span>

<span class="keyword1" id="Trie-trie_induct"><span class="command">lemma</span></span> trie_induct <span class="main">[</span><span class="operator">case_names</span> Trie<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">vo</span> <span class="bound">kvs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">k</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">kvs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Trie <span class="bound">vo</span> <span class="bound">kvs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction_schema</span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">lexicographic_order</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_trie</span> <span class="main">=</span> Trie None <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_empty_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_empty_trie</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> None <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="tfree">'k</span> list <span class="main">⇒</span> <span class="tfree">'v</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lookup_trie</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lookup_trie</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None <span class="main">|</span>
      Some <span class="bound">st</span> <span class="main">⇒</span> <span class="free">lookup_trie</span> <span class="bound">st</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_with_trie</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> option <span class="main">⇒</span> <span class="tfree">'v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update_with_trie</span> <span class="main">[]</span>     <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>  <span class="main">=</span> Trie <span class="main">(</span>Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">update_with_trie</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span>
  Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>AList.update_with_aux empty_trie <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">update_with_trie</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The function argument <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> update_with_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span>
does not return an optional value because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> could break the invariant
that no empty tries are contained in a trie because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> AList.update_with_aux<span class="antiquote"><span class="antiquote">}</span></span></span></span>
cannot recognise and remove empty tries.
Therefore the delete function is implemented separately rather than via
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> update_with_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Do not use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> update_with_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span> if most of the calls do not change
the entry (because of the garbage this creates); use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lookup_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span> possibly
followed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update_trie›</span></span></span></span>. This shortcoming could be addressed if
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> indicated that the entry is unchanged, eg by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update_trie</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> update_with_trie <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">(</span><span class="main">%</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Trie-update_trie_induct"><span class="command">lemma</span></span> update_trie_induct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">v</span> <span class="bound">ps</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">(</span>Trie <span class="bound">v</span> <span class="bound">ps</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">k</span> <span class="bound">ks</span> <span class="bound">v</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">ks</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">k</span><span class="main">#</span><span class="bound">ks</span><span class="main">)</span> <span class="main">(</span>Trie <span class="bound">v</span> <span class="bound">ps</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">xs</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction_schema</span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">lexicographic_order</span><span class="main">)</span>

<span class="keyword1" id="Trie-update_trie_Nil"><span class="command">lemma</span></span> update_trie_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"update_trie <span class="main">[]</span> <span class="free">v</span> <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Trie <span class="main">(</span>Some <span class="free">v</span><span class="main">)</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_trie_def<span class="main">)</span>

<span class="keyword1" id="Trie-update_trie_Cons"><span class="command">lemma</span></span> update_trie_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"update_trie <span class="main">(</span><span class="free">k</span><span class="main">#</span><span class="free">ks</span><span class="main">)</span> <span class="free">v</span> <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span>
  Trie <span class="free">vo</span> <span class="main">(</span>AList.update_with_aux <span class="main">(</span>Trie None <span class="main">[]</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>update_trie <span class="free">ks</span> <span class="free">v</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_trie_def empty_trie_def<span class="main">)</span>

<span class="comment1">(* A simple implementation of delete; does not shrink the trie!
definition delete_trie :: "'k list ⇒ ('k, 'v) trie ⇒ ('k, 'v) trie" where
"delete_trie ks t = update_with_trie ks (λ_. None) t"
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete_trie</span> <span class="main">[]</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Trie None <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete_trie</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">|</span>
      Some <span class="bound">t</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> <span class="free">delete_trie</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">t</span> 
                <span class="keyword1">in</span> <span class="keyword1">if</span> is_empty_trie <span class="bound">t'</span>
                   <span class="keyword1">then</span> Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="main">(</span>AList.delete_aux <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
                   <span class="keyword1">else</span> Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="main">(</span>AList.update <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">t'</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">all_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> trie <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_trie</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> <span class="free">all_trie</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invar_trie</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invar_trie</span> <span class="main">(</span>Trie <span class="free"><span class="bound"><span class="entity">vo</span></span></span> <span class="free"><span class="bound"><span class="entity">kts</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">kts</span></span></span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">kts</span></span></span><span class="main">.</span> <span class="main">¬</span> is_empty_trie <span class="bound">t</span> <span class="main">∧</span> <span class="free">invar_trie</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Empty trie›</span></span>

<span class="keyword1" id="Trie-invar_empty"><span class="command">lemma</span></span> invar_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie empty_trie"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_trie_def<span class="main">)</span>

<span class="keyword1" id="Trie-is_empty_conv"><span class="command">lemma</span></span> is_empty_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty_trie <span class="free">ts</span> <span class="main">⟷</span> <span class="free">ts</span> <span class="main">=</span> Trie None <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lookup_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Trie-lookup_empty"><span class="command">lemma</span></span> lookup_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup_trie empty_trie <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ks</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup_trie empty_trie <span class="skolem">ks</span> <span class="main">=</span> Map.empty <span class="skolem">ks</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_trie_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_empty'"><span class="command">lemma</span></span> lookup_empty' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>Trie None <span class="main">[]</span><span class="main">)</span> <span class="free">ks</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_empty<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> empty_trie_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trie-lookup_update"><span class="command">lemma</span></span> lookup_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>update_trie <span class="free">ks</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks</span> <span class="main">=</span> <span class="free">ks'</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_trie_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">vo</span> <span class="skolem">ts</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_sym<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">vo</span> <span class="skolem">ts</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_update_with_aux 2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_update'"><span class="command">lemma</span></span> lookup_update'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>update_trie <span class="free">ks</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">ks</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_update<span class="main">)</span>

<span class="keyword1" id="Trie-lookup_eq_Some_iff"><span class="command">lemma</span></span> lookup_eq_Some_iff<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span><span class="main">(</span>Trie <span class="free">vo</span> <span class="free">kvs</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">kvs</span><span class="main">)</span> <span class="free">ks</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="free">ks</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">vo</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">t</span> <span class="bound">ks'</span><span class="main">.</span> <span class="free">ks</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">#</span> <span class="bound">ks'</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">kvs</span> <span class="main">∧</span> lookup_trie <span class="bound">t</span> <span class="bound">ks'</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ks_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Cons
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="free">kvs</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff image_iff Ball_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> map_eq <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> invar <span class="keyword1"><span class="command">have</span></span> dist_kvs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">kvs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> map_of_eq_Some_iff<span class="main">[</span><span class="operator">OF</span> dist_kvs<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> map_eq
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_eq_None_iff"><span class="command">lemma</span></span> lookup_eq_None_iff<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> invar<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span><span class="main">(</span>Trie <span class="free">vo</span> <span class="free">kvs</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'key</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> trie<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">kvs</span><span class="main">)</span> <span class="free">ks</span> <span class="main">=</span> None <span class="main">⟷</span>
    <span class="main">(</span><span class="free">ks</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">vo</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">ks'</span><span class="main">.</span> <span class="free">ks</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">#</span> <span class="bound">ks'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">kvs</span> <span class="main">⟶</span> lookup_trie <span class="bound">t</span> <span class="bound">ks'</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lookup_eq_Some_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">vo</span></span> <span class="quoted"><span class="free">kvs</span></span> <span class="quoted"><span class="free">ks</span></span><span class="main">,</span> <span class="operator">OF</span> invar<span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> weak_map_of_SomeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Trie-update_not_empty"><span class="command">lemma</span></span> update_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="main">(</span>update_trie <span class="free">ks</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> kvs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">kvs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Trie-invar_trie_update"><span class="command">lemma</span></span> invar_trie_update<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> invar_trie <span class="main">(</span>update_trie <span class="free">ks</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_trie_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_update_with_aux update_not_empty <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
 
<span class="keyword1" id="Trie-is_empty_lookup_empty"><span class="command">lemma</span></span> is_empty_lookup_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> is_empty_trie <span class="free">t</span> <span class="main">⟷</span> lookup_trie <span class="free">t</span> <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">kvs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> meta_allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> meta_impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_update_with_trie"><span class="command">lemma</span></span> lookup_update_with_trie<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_trie <span class="main">(</span>update_with_trie <span class="free">ks</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks'</span> <span class="main">=</span> <span class="free">ks</span> <span class="keyword1">then</span> Some<span class="main">(</span><span class="free">f</span><span class="main">(</span>lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_trie_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">=</span> <span class="bound">x</span><span class="main">#</span><span class="bound">zs</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">zs</span> <span class="main">≠</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> neq_Nil_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * map_of_update_with_aux <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> delete_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Trie-delete_eq_empty_lookup_other_fail"><span class="command">lemma</span></span> delete_eq_empty_lookup_other_fail<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> delete_trie <span class="free">ks</span> <span class="free">t</span> <span class="main">=</span> Trie None <span class="main">[]</span><span class="main">;</span> <span class="free">ks'</span> <span class="main">≠</span> <span class="free">ks</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_trie.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">vo</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k'</span> <span class="skolem">ks''</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> Some Cons <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"AList.delete_aux <span class="skolem">k</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k'</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_aux_eq_Nil_conv<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False Some Cons <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> Some <span class="quoted">"2.prems"</span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2.hyps"</span> Let_def is_empty_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">insert</span> Some <span class="quoted">"2.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_delete"><span class="command">lemma</span></span> lookup_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span>
  lookup_trie <span class="main">(</span>delete_trie <span class="free">ks</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks</span> <span class="main">=</span> <span class="free">ks'</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> lookup_trie <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_trie.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_sym <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">vo</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">k'</span> <span class="skolem">ks''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def update_conv' map_of_delete_aux <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_empty_trie <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> Some <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_delete_aux is_empty_conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> delete_eq_empty_lookup_other_fail<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some 2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_conv'<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-lookup_delete'"><span class="command">lemma</span></span> lookup_delete'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> lookup_trie <span class="main">(</span>delete_trie <span class="free">ks</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">ks</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_delete<span class="main">)</span>

<span class="keyword1" id="Trie-invar_trie_delete"><span class="command">lemma</span></span> invar_trie_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> invar_trie <span class="main">(</span>delete_trie <span class="free">ks</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> delete_trie.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">vo</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar_trie <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.prems"</span> Some <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_empty_trie <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span> <span class="skolem">t'</span>
        <span class="keyword3"><span class="command">assume</span></span> k't'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>AList.delete_aux <span class="skolem">k</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>AList.delete_aux <span class="skolem">k</span> <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">ts</span> <span class="skolem">k'</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_of_eq_Some_iff
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_delete_aux 
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="skolem">t'</span> <span class="main">∧</span> invar_trie <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="main">(</span>AList.delete_aux <span class="skolem">k</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True Some <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span> <span class="skolem">t'</span>
        <span class="keyword3"><span class="command">assume</span></span> k't'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>AList.update <span class="skolem">k</span> <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>AList.update <span class="skolem">k</span> <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_update<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>map_of <span class="skolem">ts</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> update_conv <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="skolem">t'</span> <span class="main">∧</span> invar_trie <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> delete_trie <span class="skolem">ks</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹invar_trie <span class="main">(</span>delete_trie <span class="skolem">ks</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> eq distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted">"2.prems"</span> False <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_update<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> update_with_trie<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="comment1">(* FIXME mv *)</span>
<span class="keyword1" id="Trie-nonempty_update_with_aux"><span class="command">lemma</span></span> nonempty_update_with_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"AList.update_with_aux <span class="free">v</span> <span class="free">k</span> <span class="free">f</span> <span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Trie-nonempty_update_with_trie"><span class="command">lemma</span></span> nonempty_update_with_trie<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="main">(</span>update_with_trie <span class="free">ks</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_trie_induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonempty_update_with_aux<span class="main">)</span>

<span class="keyword1" id="Trie-invar_update_with_trie"><span class="command">lemma</span></span> invar_update_with_trie<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> invar_trie <span class="main">(</span>update_with_trie <span class="free">ks</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> update_with_trie.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_update_with_aux nonempty_update_with_trie
     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Domain of a trie›</span></span>

<span class="keyword1" id="Trie-dom_lookup"><span class="command">lemma</span></span> dom_lookup<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span>lookup_trie <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">kts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">∈</span>dom <span class="main">(</span>map_of <span class="free">kts</span><span class="main">)</span><span class="main">.</span> Cons <span class="bound">k</span> <span class="main">`</span> dom <span class="main">(</span>lookup_trie <span class="main">(</span>the <span class="main">(</span>map_of <span class="free">kts</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">vo</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Trie-finite_dom_lookup"><span class="command">lemma</span></span> finite_dom_lookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span><span class="main">∈</span>dom <span class="main">(</span>map_of <span class="skolem">kts</span><span class="main">)</span><span class="main">.</span> Cons <span class="bound">k</span> <span class="main">`</span> dom <span class="main">(</span>lookup_trie <span class="main">(</span>the <span class="main">(</span>map_of <span class="skolem">kts</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finite_UN_I<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span>map_of <span class="skolem">kts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_dom_map_of<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> dom <span class="main">(</span>map_of <span class="skolem">kts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">kts</span>"</span></span> <span class="quoted"><span class="quoted">"map_of <span class="skolem">kts</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span>lookup_trie <span class="main">(</span>the <span class="main">(</span>map_of <span class="skolem">kts</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main">(</span><span class="operator">rule</span> Trie<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Cons <span class="skolem">k</span> <span class="main">`</span> dom <span class="main">(</span>lookup_trie <span class="main">(</span>the <span class="main">(</span>map_of <span class="skolem">kts</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trie-dom_lookup_empty_conv"><span class="command">lemma</span></span> dom_lookup_empty_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> dom <span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> is_empty_trie <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>lookup_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vo</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vo</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> dom <span class="main">(</span>lookup_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kvs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">kvs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">kt</span> <span class="skolem">kvs'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹invar_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">kt</span><span class="main">,</span> snd <span class="skolem">kt</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">kvs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>lookup_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> is_empty_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹invar_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Trie<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> is_empty_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>lookup_trie <span class="main">(</span>snd <span class="skolem">kt</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> dom Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_lookup<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_empty_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_empty_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>lookup_trie <span class="main">(</span>Trie <span class="skolem">vo</span> <span class="skolem">kvs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_empty<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> empty_trie_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Range of a trie›</span></span>

<span class="keyword1" id="Trie-ran_lookup_Trie"><span class="command">lemma</span></span> ran_lookup_Trie<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span>
  ran <span class="main">(</span>lookup_trie <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">:</span> set <span class="free">ps</span><span class="main">.</span> ran<span class="main">(</span>lookup_trie <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def lookup_eq_Some_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.split<span class="main">)</span>

<span class="keyword1" id="Trie-all_trie_eq_ran"><span class="command">lemma</span></span> all_trie_eq_ran<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> all_trie <span class="free">P</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> ran<span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> all_trie.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_lookup_Trie <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tries">
<div class="head">
<h1>Theory Tries</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow  *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Tries (List Version)"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tries
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Trie.html">Trie</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is a specialization of tries where values are lists.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span> list<span class="main">)</span>trie"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lookup_tries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">⇒</span> <span class="tfree">'k</span> list <span class="main">⇒</span> <span class="tfree">'v</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lookup_tries</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lookup_trie <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">vs</span> <span class="main">⇒</span> <span class="bound">vs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_with_tries</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> list <span class="main">⇒</span> <span class="tfree">'v</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tries <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tries"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update_with_tries</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span>
  update_with_trie <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">vo</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">vs</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">vs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_tries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert_tries</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
  update_with_trie <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">vo</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span> <span class="main">|</span> Some <span class="bound">vs</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="bound">vs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inserts_tries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'k</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inserts_tries</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span> fold <span class="main">(</span><span class="main">%</span><span class="bound">v</span><span class="main">.</span> insert_tries <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tries_of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'k</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tries_of_list</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> inserts_tries <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Trie None <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_tries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">set_tries</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Union <span class="main">{</span><span class="bound">gs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">gs</span> <span class="main">=</span> set<span class="main">(</span>lookup_tries <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_tries</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>tries <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_tries</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> all_trie <span class="main">(</span>list_all <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lookup_tries<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Tries-lookup_Nil"><span class="command">lemma</span></span> lookup_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup_tries <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ps</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">vo</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">vs</span> <span class="main">⇒</span> <span class="bound">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def<span class="main">)</span>

<span class="keyword1" id="Tries-lookup_Cons"><span class="command">lemma</span></span> lookup_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup_tries <span class="main">(</span>Trie <span class="free">vo</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">ps</span> <span class="free">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">at</span> <span class="main">⇒</span> lookup_tries <span class="bound">at</span> <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Tries-lookup_empty"><span class="command">lemma</span></span> lookup_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup_tries <span class="main">(</span>Trie None <span class="main">[]</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lookup_update<span class="main">:</span>
 <span class="quoted"><span class="quoted">"lookup_tries <span class="main">(</span>update_trie <span class="free">as</span> <span class="free">vs</span> <span class="free">t</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free">as</span><span class="main">=</span><span class="free">bs</span> <span class="keyword1">then</span> <span class="free">vs</span> <span class="keyword1">else</span> lookup_tries <span class="free">t</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def lookup_update<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lookup_update_with<span class="main">:</span>
 <span class="quoted"><span class="quoted">"lookup_tries <span class="main">(</span>update_with_tries <span class="free">as</span> <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="free">bs</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> <span class="free">as</span><span class="main">=</span><span class="free">bs</span> <span class="keyword1">then</span> <span class="free">f</span><span class="main">(</span>lookup_tries <span class="free">t</span> <span class="free">as</span><span class="main">)</span> <span class="keyword1">else</span> lookup_tries <span class="free">t</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def update_with_tries_def lookup_update_with_trie
  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert_tries<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> inserts_tries<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tries_of_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Tries-invar_insert_tries"><span class="command">lemma</span></span> invar_insert_tries<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> invar_trie<span class="main">(</span>insert_tries <span class="free">as</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_tries_def invar_update_with_trie <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Tries-invar_inserts_tries"><span class="command">lemma</span></span> invar_inserts_tries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar_trie <span class="free">t</span> <span class="main">⟹</span> invar_trie <span class="main">(</span>inserts_tries <span class="free">key</span> <span class="free">xs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_insert_tries inserts_tries_def<span class="main">)</span>

<span class="keyword1" id="Tries-invar_of_list"><span class="command">lemma</span></span> invar_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"invar_trie <span class="main">(</span>tries_of_list <span class="free">key</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tries_of_list_def invar_inserts_tries<span class="main">)</span>

<span class="keyword1" id="Tries-set_lookup_insert_tries"><span class="command">lemma</span></span> set_lookup_insert_tries<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>lookup_tries <span class="main">(</span>insert_tries <span class="free">ks</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">ks'</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">ks'</span> <span class="main">=</span> <span class="free">ks</span> <span class="keyword1">then</span> Set.insert <span class="free">a</span> <span class="main">(</span>set<span class="main">(</span>lookup_tries <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> set<span class="main">(</span>lookup_tries <span class="free">t</span> <span class="free">ks'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tries_def insert_tries_def lookup_update_with_trie set_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="Tries-in_set_lookup_inserts_tries"><span class="command">lemma</span></span> in_set_lookup_inserts_tries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">∈</span> set<span class="main">(</span>lookup_tries <span class="main">(</span>inserts_tries <span class="free">key</span> <span class="free">vs</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">key</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="free">v</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">∪</span> set<span class="main">(</span>lookup_tries <span class="free">t</span> <span class="main">(</span><span class="free">key</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserts_tries_def set_lookup_insert_tries<span class="main">)</span>

<span class="keyword1" id="Tries-in_set_lookup_of_list"><span class="command">lemma</span></span> in_set_lookup_of_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set<span class="main">(</span>lookup_tries <span class="main">(</span>tries_of_list <span class="free">key</span> <span class="free">vs</span><span class="main">)</span> <span class="main">(</span><span class="free">key</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">∈</span> set <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tries_of_list_def in_set_lookup_inserts_tries<span class="main">)</span>

<span class="keyword1" id="Tries-in_set_lookup_inserts_triesD"><span class="command">lemma</span></span> in_set_lookup_inserts_triesD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set<span class="main">(</span>lookup_tries <span class="main">(</span>inserts_tries <span class="free">key</span> <span class="free">vs</span> <span class="free">t</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">∪</span> set<span class="main">(</span>lookup_tries <span class="free">t</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserts_tries_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inserts_tries_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_lookup_insert_tries <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="Tries-in_set_lookup_of_listD"><span class="command">lemma</span></span> in_set_lookup_of_listD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set<span class="main">(</span>lookup_tries <span class="main">(</span>tries_of_list <span class="free">f</span> <span class="free">vs</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> set <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tries_of_list_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_lookup_inserts_triesD<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> set_tries<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Tries-set_tries_eq_ran"><span class="command">lemma</span></span> set_tries_eq_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tries <span class="free">t</span> <span class="main">=</span> Union<span class="main">(</span>set <span class="main">`</span> ran<span class="main">(</span>lookup_trie <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff set_tries_def lookup_tries_def ran_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>

<span class="keyword1" id="Tries-set_tries_empty"><span class="command">lemma</span></span> set_tries_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_tries <span class="main">(</span>Trie None <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_tries_def<span class="main">)</span>

<span class="keyword1" id="Tries-set_tries_insert"><span class="command">lemma</span></span> set_tries_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_tries <span class="main">(</span>insert_tries <span class="free">a</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Set.insert <span class="free">x</span> <span class="main">(</span>set_tries <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_tries_def lookup_update set_lookup_insert_tries<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff<span class="main">)</span>

<span class="keyword1" id="Tries-set_insert_tries"><span class="command">lemma</span></span> set_insert_tries<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_tries <span class="main">(</span>inserts_tries <span class="free">key</span> <span class="free">xs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
   set <span class="free">xs</span> <span class="keyword1">Un</span> set_tries <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inserts_tries_def<span class="main">)</span>

<span class="keyword1" id="Tries-set_tries_of_list"><span class="command">lemma</span></span> set_tries_of_list<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_tries<span class="main">(</span>tries_of_list <span class="free">key</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tries_of_list_def set_insert_tries<span class="main">)</span>

<span class="keyword1" id="Tries-in_set_lookup_set_triesD"><span class="command">lemma</span></span> in_set_lookup_set_triesD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>set <span class="main">(</span>lookup_tries <span class="free">t</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set_tries <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_tries_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>