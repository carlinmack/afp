<div id="Preliminaries">
<div class="head">
<h1>Theory Preliminaries</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Preliminaries
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Lattice_Syntax.html">HOL-Library.Lattice_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Possible modes for variables:›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> Mode <span class="main">=</span> AsmNoRead <span class="main">|</span> AsmNoWrite <span class="main">|</span> GuarNoRead <span class="main">|</span> GuarNoWrite

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider a two-element security lattice:›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> Sec <span class="main">=</span> High <span class="main">|</span> Low

<span class="keyword1"><span class="command">notation</span></span>
  less_eq  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
  less  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊏</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Sec</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> forms a (complete) lattice:›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> Sec <span class="main">::</span> <span class="quoted">complete_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> top_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> High"</span></span>
<span class="keyword1"><span class="command">definition</span></span> sup_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> High <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> High<span class="main">)</span> <span class="keyword1">then</span> High <span class="keyword1">else</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> inf_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> Low<span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> bot_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">=</span> Low"</span></span>
<span class="keyword1"><span class="command">definition</span></span> less_eq_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> less_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d1</span></span></span> <span class="main">=</span> Low <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">d2</span></span></span> <span class="main">=</span> High<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> Sup_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>High <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">then</span> High <span class="keyword1">else</span> Low<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> Inf_Sec_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>Low <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Low <span class="keyword1">else</span> High<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust inf_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust inf_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust inf_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust less_eq_Sec_def sup_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust less_eq_Sec_def sup_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_eq_Sec_def sup_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Inf_Sec_def Sec.exhaust less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Inf_Sec_def Sec.exhaust less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust Sup_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Sup_Sec_def less_eq_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> Inf_Sec_def empty_iff top_Sec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> Sup_Sec_def bot_Sec_def empty_iff<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Memories are mappings from variables to values›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A mode state maps modes to the set of variables for which the
  given mode is set.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'var</span> Mds <span class="main">=</span> <span class="quoted"><span class="quoted">"Mode <span class="main">⇒</span> <span class="tfree">'var</span> set"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Local configurations:›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'com</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> LocalConf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'com</span> <span class="main">×</span> <span class="tfree">'var</span> Mds<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Global configurations:›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'com</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> GlobalConf <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'com</span> <span class="main">×</span> <span class="tfree">'var</span> Mds<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> Mem"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A locale to fix various parametric components in Mantel et. al, and assumptions
  about them:›</span></span>
<span class="keyword1"><span class="command">locale</span></span> sifum_security <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">stop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">some_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">some_val'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> stop_no_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">stop</span><span class="main">,</span> <span class="free">mds</span><span class="main">)</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">)</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span><span class="main">;</span> <span class="main">(</span><span class="free">lc</span><span class="main">,</span> <span class="free">lc''</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">=</span> <span class="free">lc''</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_memory<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'Var</span><span class="main">)</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> different_values<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">some_val</span> <span class="main">≠</span> <span class="free">some_val'</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Security">
<div class="head">
<h1>Theory Security</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition of the SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Security
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Preliminaries.html">Preliminaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_security <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation of Concurrent Programs›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">conf_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span> _<span class="keyword1">,</span> _<span class="keyword1">⟩</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">⟩</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Evaluation of global configurations: *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> GlobalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">meval_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">meval</span>"</span></span> <span class="main">|</span>
  meval_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">meval</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> meval_elim <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> meval"</span></span>

<span class="comment1">(* Syntactic sugar for the reflexive-transitive closure of meval: *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">meval_clos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">→<span class="hidden">⇧</span><sup>*</sup></span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main"><span class="free">→<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conf'</span></span></span><span class="main">)</span> <span class="main">∈</span> meval<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lc_set_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lc_set_var</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">meval_k</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval_k</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meval_k</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span><span class="main">.</span> <span class="free">meval_k</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">c''</span> <span class="main">∧</span> <span class="bound">c''</span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* k steps of evaluation (for global configurations: *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">meval_k_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main"><span class="free">→</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">k</span></span></span> </sub><span class="hidden">⇙</span><span class="free"><span class="bound"><span class="entity">gc'</span></span></span> <span class="main">≡</span> meval_k <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="free"><span class="bound"><span class="entity">gc'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Low-equivalence and Strong Low Bisimulations›</span></span>

<span class="comment1">(* Low-equality between memory states: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">low_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span>"</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">=<span class="hidden">⇧</span><sup>l</sup></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Low-equality modulo a given mode state: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">low_mds_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=</span>ı<span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">=</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="free"><span class="hidden">⇧</span><sup>l</sup></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoRead <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Initial mode state: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">mds<span class="hidden">⇩</span><sub>s</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_mds_eq_def low_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span><span class="main">.</span> <span class="free">mem</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="bound">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def low_eq_def<span class="main">)</span>

<span class="comment1">(* Closedness under globally consistent changes: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closed_glob_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed_glob_consistent</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟶</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">mds</span> AsmNoWrite<span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">mds</span> AsmNoWrite<span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Strong low bisimulations modulo modes: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strong_low_bisim_mm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strong_low_bisim_mm</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">≡</span>
  sym <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">∧</span>
  closed_glob_consistent <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟶</span>
   <span class="main">(</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="bound">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mds'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">mm_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf<span class="main">)</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">mm_equiv_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> 
  <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mm_equiv_abv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">mm_equiv</span>"</span></span> <span class="main">|</span>
  mm_equiv_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> strong_low_bisim_mm <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ℛ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">mm_equiv</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> mm_equiv_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">low_indistinguishable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Com</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">∼</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span>
    <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹SIFUM-Security›</span></span>

<span class="comment1">(* SIFUM-security for commands: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">com_sifum_secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">com_sifum_secure</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∼</span><span class="hidden">⇘</span><sub>mds<span class="hidden">⇩</span><sub>s</sub></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_initial_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Com</span> <span class="main">×</span> <span class="tfree">'Var</span> Mds<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_initial_modes</span> <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">=</span> zip <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">)</span> mds<span class="hidden">⇩</span><sub>s</sub><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_assumptions_on_termination</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">no_assumptions_on_termination</span> <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">mem</span> <span class="bound">mem'</span> <span class="bound">cms'</span><span class="main">.</span>
    <span class="main">(</span>add_initial_modes <span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">,</span> <span class="bound">mem</span><span class="main">)</span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">cms'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">)</span> <span class="main">∧</span>
    list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">stop</span><span class="main">)</span> <span class="main">(</span>map fst <span class="bound">cms'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound">mds'</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="bound">cms'</span><span class="main">)</span><span class="main">.</span> <span class="bound">mds'</span> AsmNoRead <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="bound">mds'</span> AsmNoWrite <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* SIFUM-security for programs: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prog_sifum_secure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prog_sifum_secure</span> <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">=</span>
  <span class="main">(</span>no_assumptions_on_termination <span class="free"><span class="bound"><span class="entity">cmds</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span> <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
     <span class="main">(</span>add_initial_modes <span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="bound">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span>add_initial_modes <span class="free"><span class="bound"><span class="entity">cmds</span></span></span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="bound">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                      map snd <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                      length <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
                      <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
                        <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoRead<span class="main">)</span> <span class="main">⟶</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sound Mode Use›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">doesnt_read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doesnt_read</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span> <span class="bound">mem</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span>
  <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">doesnt_modify</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Com</span> <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">doesnt_modify</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span> <span class="bound">mem</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">⟶</span>
                        <span class="bound">mem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">mem'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Local reachability of local configurations: *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">loc_reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">lc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  refl <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>fst <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="free">lc</span><span class="main">)</span><span class="main">,</span> snd <span class="free">lc</span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span> <span class="main">|</span>
  step <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span><span class="main">;</span>
            <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span><span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span> <span class="main">|</span>
  mem_diff <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span><span class="main">;</span>
                <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> AsmNoWrite<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
              <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem''</span></span></span> <span class="main">⟩</span> <span class="main">∈</span> <span class="free">loc_reach</span> <span class="free">lc</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locally_sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locally_sound_mode_use</span> <span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">⟨</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span> <span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="bound">c'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="bound">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="bound">c'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compatible_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span> Mds<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">compatible_modes</span> <span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">⟶</span>
    <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoRead <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> GuarNoRead<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoWrite <span class="main">⟶</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">mdss</span></span></span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mdss</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> GuarNoWrite<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable_mode_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span> Mds<span class="main">)</span> list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable_mode_states</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">=</span>
  <span class="main">{</span><span class="bound">mdss</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">cms'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">→<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="bound">cms'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">)</span> <span class="main">∧</span> map snd <span class="bound">cms'</span> <span class="main">=</span> <span class="bound">mdss</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">globally_sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">globally_sound_mode_use</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">mdss</span><span class="main">.</span> <span class="bound">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">⟶</span> compatible_modes <span class="bound">mdss</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sound_mode_use</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> GlobalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sound_mode_use</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">cm</span><span class="main">.</span> locally_sound_mode_use <span class="main">(</span><span class="bound">cm</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cms</span></span></span> <span class="main">∧</span>
      globally_sound_mode_use <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* We now show that mm_equiv itself forms a strong low bisimulation modulo modes: *)</span>
<span class="keyword1" id="Security-mm_equiv_sym"><span class="command">lemma</span></span> mm_equiv_sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equivalent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> equivalent <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ℛ_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sym <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ_bisim symE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ_bisim mm_equiv.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Security-low_indistinguishable_sym"><span class="command">lemma</span></span> low_indistinguishable_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span> <span class="free">lc'</span> <span class="main">⟹</span> <span class="free">lc'</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span> <span class="free">lc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mm_equiv_sym low_indistinguishable_def low_mds_eq_def<span class="main">)</span>

<span class="keyword1" id="Security-mm_equiv_glob_consistent"><span class="command">lemma</span></span> mm_equiv_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent mm_equiv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mm_equiv_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def closed_glob_consistent_def<span class="main">)</span>

<span class="keyword1" id="Security-mm_equiv_strong_low_bisim"><span class="command">lemma</span></span> mm_equiv_strong_low_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm mm_equiv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_glob_consistent mm_equiv"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mm_equiv_glob_consistent<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'Com</span></span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="skolem">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mm_equiv_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↝</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def mm_equiv_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym mm_equiv"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym_def mm_equiv_sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Compositionality">
<div class="head">
<h1>Theory Compositionality</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Compositionality Proof for SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Compositionality
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Security.html">Security</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_security
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Set of variables that differs between two memory states: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">differing_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">differing_vars</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">differing_vars_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">differing_vars_lists</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
   <span class="main">(</span>differing_vars <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> differing_vars <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-differing_finite"><span class="command">lemma</span></span> differing_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>differing_vars <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_def Un_UNIV_left finite_Un finite_memory<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_lists_finite"><span class="command">lemma</span></span> differing_lists_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_finite differing_vars_lists_def<span class="main">)</span>

<span class="comment1">(* Suggestive notation for substitution / function application *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">of</span>
                         None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">x</span> <span class="main">|</span>
                         Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subst_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[↦</span>_<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">[↦</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> subst <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Compositionality-subst_not_in_dom"><span class="command">lemma</span></span> subst_not_in_dom <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> dom <span class="free">σ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff subst_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">makes_compatible</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> GlobalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem <span class="main">×</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Mem<span class="main">)</span> list <span class="main">⇒</span>
  bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">makes_compatible</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">=</span>
  <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">⟶</span>
             <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cms<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span>
                                          <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">mems</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* This just restates the previous definition using meta-quantification. This allows
  more readable proof blocks that prove each part separately. *)</span>
<span class="keyword1" id="Compositionality-makes_compatible_intro"><span class="command">lemma</span></span> makes_compatible_intro <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">mems</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> dom <span class="bound">σ</span> <span class="main">=</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">⟧</span> <span class="main">⟹</span> 
          <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* First, some auxiliary lemmas about makes_compatible: *)</span>
<span class="keyword1" id="Compositionality-compat_low"><span class="command">lemma</span></span> compat_low<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span><span class="main">;</span>
     <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> High<span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-compat_different"><span class="command">lemma</span></span> compat_different<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span><span class="main">;</span>
     <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Compositionality-sound_modes_no_read"><span class="command">lemma</span></span> sound_modes_no_read <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>map snd <span class="free">cms</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> GuarNoRead<span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms</span> <span class="main">⟧</span> <span class="main">⟹</span>
  doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cms</span> <span class="skolem">mem</span> <span class="skolem">x</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="skolem">cms</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">cms</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">(</span><span class="skolem">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sound_mode_use_def list_all_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>map snd <span class="skolem">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> GuarNoRead"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="skolem">cms</span> <span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">cms</span>›</span></span> fst_conv loc_reach.refl nth_map snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-compat_different_vars"><span class="command">lemma</span></span> compat_different_vars<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">;</span>
     <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_subst"><span class="command">lemma</span></span> differing_vars_subst <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">⊇</span> differing_vars <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> domσ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_def differing_vars_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-mm_equiv_low_eq"><span class="command">lemma</span></span> mm_equiv_low_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mm_equiv.simps strong_low_bisim_mm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Compositionality-globally_sound_modes_compatible"><span class="command">lemma</span></span> globally_sound_modes_compatible<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> globally_sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> compatible_modes <span class="main">(</span>map snd <span class="free">cms</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> globally_sound_mode_use_def reachable_mode_states_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* map snd cms1 = map snd cms2 states that both global configurations use the same modes *)</span>
<span class="keyword1" id="Compositionality-compatible_different_no_read"><span class="command">lemma</span></span> compatible_different_no_read <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>i</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> compat ile x <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_low<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat ile x <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword2"><span class="keyword">and</span></span> compat ile x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    jprop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free">some_val</span> <span class="keyword1">else</span> None"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ</span> <span class="main">=</span> <span class="var">?X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mdss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> jprop domσ <span class="keyword1"><span class="command">have</span></span> subst_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat jprop domσ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> modes_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> jprop len mm_equiv_low_eq nth_map surjective_pairing<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> jprop <span class="keyword2"><span class="keyword">and</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> AsmNoRead"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> AsmNoRead"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mems_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low›</span></span> low_eq subst_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> low_mds_eq_def subst_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different_vars jprop<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?mdss</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> GuarNoRead"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes jprop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_modes_def globally_sound_modes_compatible
      length_map sound_mode_use.simps x ile<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">∧</span> doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sound_modes ile
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len modes_eq sound_modes_no_read<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">func_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≼</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">≼</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">change_respecting</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
   <span class="main">(</span><span class="tfree">'Com</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
   <span class="tfree">'Var</span> set <span class="main">⇒</span>
   <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span><span class="main">)</span> <span class="main">⇒</span>
   <span class="main">(</span><span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">change_respecting</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span>
      <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">σ</span> <span class="main">≼</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span> <span class="bound">σ'</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> dom <span class="bound">σ'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> dom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cms'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span> <span class="main">[↦</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-change_respecting_dom_unique"><span class="command">lemma</span></span> change_respecting_dom_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟶</span> <span class="bound">d</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">g</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps<span class="main">)</span>

<span class="keyword1" id="Compositionality-func_le_restrict"><span class="command">lemma</span></span> func_le_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="main">≼</span> <span class="free">g</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> dom <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">|`</span> <span class="free">X</span> <span class="main">≼</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> func_le_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_partial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_partial</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-func_le_dom"><span class="command">lemma</span></span> func_le_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≼</span> <span class="free">g</span> <span class="main">⟹</span> dom <span class="free">f</span> <span class="main">⊆</span> dom <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> func_le_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> domIff option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Compositionality-doesnt_read_mutually_exclusive"><span class="command">lemma</span></span> doesnt_read_mutually_exclusive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"doesnt_read <span class="free">c</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="free">x</span> <span class="main">=</span> <span class="free">some_val</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> prod.inject deterministic different_values fun_upd_same<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> prod.inject deterministic fun_upd_same<span class="main">)</span>

<span class="keyword1" id="Compositionality-doesnt_read_mutually_exclusive'"><span class="command">lemma</span></span> doesnt_read_mutually_exclusive'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"doesnt_read <span class="free">c</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> overwrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms doesnt_read_mutually_exclusive<span class="main">)</span>

<span class="keyword1" id="Compositionality-change_respecting_dom"><span class="command">lemma</span></span> change_respecting_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">g</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms change_respecting.simps func_le_dom<span class="main">)</span>
  
<span class="keyword1" id="Compositionality-change_respecting_intro"><span class="command">lemma</span></span> change_respecting_intro <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">⟩</span><span class="main">;</span>
     <span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟹</span>
           <span class="free">g</span> <span class="bound">f</span> <span class="main">≼</span> <span class="bound">f</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">f'</span><span class="main">.</span> dom <span class="bound">f'</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟶</span> dom <span class="main">(</span><span class="free">g</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">g</span> <span class="bound">f'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="free">g</span> <span class="bound">f</span><span class="main">]</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Used for a proof block in the following lemma *)</span>
<span class="keyword1" id="Compositionality-conjI3"><span class="command">lemma</span></span> conjI3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">;</span> <span class="free">B</span><span class="main">;</span> <span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Compositionality-noread_exists_change_respecting"><span class="command">lemma</span></span> noread_exists_change_respecting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'Var</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span> <span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> doesnt_read <span class="free">c</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="main">(</span><span class="bound">g</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>  change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span> <span class="bound">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?lc'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fin eval noread <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="free">X</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">X</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mem</span></span> <span class="quoted"><span class="free">mem'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">[↦</span> Map.empty<span class="main">]</span> <span class="main">=</span> <span class="skolem">mem</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="main">[↦</span> <span class="var">?g</span> Map.empty<span class="main">]</span> <span class="main">=</span> <span class="skolem">mem'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subst_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">{}</span> <span class="var">?g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> empty
      <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps func_le_def subst_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="skolem">X</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff<span class="main">)</span>
    <span class="comment1">(* Unfortunately, it is necessary to define the required function in advance for
       all case distinctions we want to make. *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">let</span> <span class="bound">σ'</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="bound">σ'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">σ'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span> <span class="main">::</span> <span class="tfree">'Var</span><span class="main">.</span>
                    <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">y</span>
                    <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="bound">y</span>
                    <span class="keyword1">else</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">σ'</span> <span class="bound">y</span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">σ'</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹We first show that property (2) is satisfied.›</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict inf_absorb2 subset_insertI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="free">c</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> eval<span class="hidden">⇩</span><sub>X</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        noread<span class="hidden">⇩</span><sub>x</sub><span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">≼</span> <span class="skolem">σ</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">σ'</span><span class="main">.</span> dom <span class="bound">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span> <span class="main">⟶</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI3<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> noread<span class="hidden">⇩</span><sub>x</sub> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">≼</span> <span class="skolem">σ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> nowrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
                 <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">≼</span> <span class="skolem">σ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> IH
            <span class="keyword1"><span class="command">unfolding</span></span> g_simp func_le_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> domI func_le_def restrict_in<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> overwrites<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
            <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> doesnt_read_mutually_exclusive eval<span class="hidden">⇩</span><sub>X</sub><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">≼</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting.simps<span class="main">)</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">≼</span> <span class="skolem">σ</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> func_le_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> domI restrict_in<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹This part proves that the domain of the family is unique›</span>
        <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">|`</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> dom_restrict<span class="main">)</span>
        <span class="comment1">― ‹We first show, that we are always in the same case of the no read assumption:›</span>
        <span class="keyword1"><span class="command">have</span></span> same_case<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∨</span>
           <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?N</span> <span class="main">∧</span> <span class="var">?N'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="var">?O</span> <span class="main">∧</span> <span class="var">?O'</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="comment1">― ‹By deriving a contradiction under the assumption that we are in different cases:›</span>
          <span class="keyword1"><span class="command">have</span></span> not_different<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">h</span> <span class="bound">h'</span><span class="main">.</span> <span class="main">⟦</span> dom <span class="bound">h</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">;</span> dom <span class="bound">h'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">;</span>
                        <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="bound">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
                             <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">(</span><span class="bound">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">;</span>
                        <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="bound">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
                             <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">(</span><span class="bound">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">]</span><span class="main">⟩</span> <span class="main">⟧</span>
                      <span class="main">⟹</span> False"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="comment1">― ‹Introduce new names to avoid clashes with functions in the outer scope.›</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">h'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> doms<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">h</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">h'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> nowrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
              <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">(</span><span class="skolem">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> overwrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
              <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">]</span><span class="main">⟩</span>"</span></span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">|`</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span>"</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> dom_restrict doms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> dom_restrict doms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> eval<span class="hidden">⇩</span><sub>X</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> noread<span class="hidden">⇩</span><sub>x</sub>'<span class="main">:</span>
             <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">from</span></span> overwrite <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span>
              <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> doesnt_read_mutually_exclusive fun_upd_triv<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting.simps func_le_dom rev_subsetD<span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv overwrite subst_not_in_dom<span class="main">)</span>

            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>

            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> doesnt_read <span class="free">c</span> <span class="bound">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> insert_iff<span class="main">)</span>
              
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
              IH<span class="hidden">⇩</span><sub>v</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span><span class="main">⟩</span> <span class="skolem">X</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> eval<span class="hidden">⇩</span><sub>v</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">[↦</span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
                         <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting.simps<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH<span class="hidden">⇩</span><sub>v</sub> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting.simps<span class="main">)</span>

            <span class="keyword1"><span class="command">from</span></span> eval<span class="hidden">⇩</span><sub>v</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">[↦</span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">[↦</span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">h</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> fun_upd_def
                  insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_def subst_not_in_dom<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other<span class="main">)</span>

              <span class="keyword1"><span class="command">with</span></span> nowrite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> deterministic
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>v</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> IH<span class="hidden">⇩</span><sub>v</sub> <span class="quoted"><span class="quoted">‹dom <span class="var">?h<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting_dom
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> func_le_dom insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_subsetD<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> eval<span class="hidden">⇩</span><sub>v</sub><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem'</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">from</span></span> overwrite <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mem<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> <span class="quoted">"y"</span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="skolem">h'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span>›</span></span> fun_upd_apply subst_not_in_dom<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_other<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> deterministic
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="skolem">g<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> IH<span class="hidden">⇩</span><sub>v</sub> <span class="quoted"><span class="quoted">‹dom <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> change_respecting_dom
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> func_le_dom insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>v</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> dom <span class="main">(</span><span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?h'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">mem'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">v</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> dom_restrict<span class="main">)</span>

          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> eval<span class="hidden">⇩</span><sub>X</sub>'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> noread<span class="hidden">⇩</span><sub>x</sub>'<span class="main">:</span>
             <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
              <span class="main">∨</span>
              <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> noread<span class="hidden">⇩</span><sub>x</sub> not_different <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
                                <span class="skolem">g</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">σ'</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domD<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> domD domI<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> domD domI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>
            <span class="main">∧</span>
            <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> doesnt_read_mutually_exclusive' fun_upd_triv<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="main">∧</span> <span class="skolem">g</span> <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ'<span class="hidden">⇩</span><sub>X</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ'</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">σ'</span><span class="main">.</span> dom <span class="bound">σ'</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span> <span class="main">⟶</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">g</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* Do a case distinction on the no-read statement: *)</span>
      <span class="keyword1"><span class="command">from</span></span> noread<span class="hidden">⇩</span><sub>x</sub> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nowrite<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> g_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> domD insertI1<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> nowrite <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> insertE
            restrict_in subst_def subst_not_in_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def option.simps <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> overwrites<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹doesnt_read <span class="free">c</span> <span class="skolem">x</span>›</span></span> doesnt_read_mutually_exclusive' eval<span class="hidden">⇩</span><sub>X</sub><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> g_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">g<span class="hidden">⇩</span><sub>X</sub></span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> g_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> domD insertI1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="main">(</span><span class="skolem">σ</span> <span class="main">|`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>›</span></span> insertE
            restrict_in subst_def subst_not_in_dom<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> overwrites <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="var">?σ<span class="hidden">⇩</span><sub>X</sub></span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> g_simp<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span> <span class="main">[↦</span> <span class="skolem">g</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span><span class="main">.</span> change_respecting <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span> <span class="bound">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_neg"><span class="command">lemma</span></span> differing_vars_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem1</span> <span class="free">mem2</span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem1</span> <span class="free">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_vars_neg_intro"><span class="command">lemma</span></span> differing_vars_neg_intro<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">;</span>
  <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-differing_vars_elim"><span class="command">lemma</span></span> differing_vars_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_lists_def differing_vars_def<span class="main">)</span>

<span class="keyword1" id="Compositionality-subst_overrides"><span class="command">lemma</span></span> subst_overrides<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">σ</span> <span class="main">=</span> dom <span class="free">τ</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">τ</span><span class="main">]</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="free">σ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff option.exhaust option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Compositionality-dom_restrict_total"><span class="command">lemma</span></span> dom_restrict_total<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>to_partial <span class="free">f</span> <span class="main">|`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> to_partial_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_UNIV_left dom_const dom_restrict<span class="main">)</span>

<span class="keyword1" id="Compositionality-update_nth_eq"><span class="command">lemma</span></span> update_nth_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">;</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">[</span><span class="free">n</span> <span class="main">:=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_update_id<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This property is obvious,
  so an unreadable apply-style proof is acceptable here:›</span></span>
<span class="keyword1" id="Compositionality-mm_equiv_step"><span class="command">lemma</span></span> mm_equiv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mm_equiv_strong_low_bisim
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>

<span class="keyword1" id="Compositionality-change_respecting_doesnt_modify"><span class="command">lemma</span></span> change_respecting_doesnt_modify<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> domf<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">g</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> noread<span class="main">:</span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>fst <span class="free">cms</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_partial <span class="free">mem</span> <span class="main">|`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> domf'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?f'</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> cr <span class="keyword2"><span class="keyword">and</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="bound">f</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="free">g</span> <span class="bound">f</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> eval'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span> <span class="main">[↦</span> <span class="free">g</span> <span class="var">?f'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domf'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="main">[↦</span> <span class="var">?f'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subst_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> restrict_in to_partial_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domf' subst_def subst_not_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">[↦</span> <span class="free">g</span> <span class="var">?f'</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval eval' deterministic
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">g</span> <span class="var">?f'</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="free">g</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps cr domf domf'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> x_in_dom'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="free">g</span> <span class="var">?f'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps cr domf func_le_dom in_mono x_in_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_in to_partial_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="var">?f'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cr func_le_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps domf' x_in_dom'<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem'</span> <span class="main">[↦</span> <span class="free">g</span> <span class="var">?f'</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_def x_in_dom'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem'_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Some machinery for making use of closedness under globally consistent changes:
   - We introduce the notion of an "adaptation" that replaces (finitely many)
     variables in two memory states with (possibly different) other values.
   - We then define a function to apply adaptations to memory states
*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> adaptation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_adaptation</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_adaptation</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span>
         <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">of</span>
               Some <span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="keyword1">then</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>
             <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_adaptation<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[∥<span class="hidden">⇩</span><sub>1</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">[∥<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> apply_adaptation True <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_adaptation<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[∥<span class="hidden">⇩</span><sub>2</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>900<span class="main">,</span> 0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main"><span class="free">[∥<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">≡</span> apply_adaptation False <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span> <span class="comment1">(*infix "|'" 60*)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict_total</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> to_partial <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Compositionality-differing_empty_eq"><span class="command">lemma</span></span> differing_empty_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> differing_vars <span class="free">mem</span> <span class="free">mem'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">globally_consistent_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">globally_consistent_var</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
     Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite <span class="main">∧</span> <span class="main">(</span><span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">)</span>
   <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">globally_consistent</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">globally_consistent</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">≡</span> finite <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> globally_consistent_var <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gc2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> adaptation <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gc2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> globally_consistent_var <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Compositionality-globally_consistent_dom"><span class="command">lemma</span></span> globally_consistent_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> globally_consistent <span class="free">A</span> <span class="free">mds</span><span class="main">;</span> <span class="free">X</span> <span class="main">⊆</span> dom <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> globally_consistent <span class="main">(</span><span class="free">A</span> <span class="main">|`</span> <span class="free">X</span><span class="main">)</span> <span class="free">mds</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_def globally_consistent_var_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> IntE dom_restrict inf_absorb2 restrict_in rev_finite_subset<span class="main">)</span>

<span class="keyword1" id="Compositionality-globally_consistent_writable"><span class="command">lemma</span></span> globally_consistent_writable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">A</span><span class="main">;</span> globally_consistent <span class="free">A</span> <span class="free">mds</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoWrite"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_def globally_consistent_var_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> split_part<span class="main">)</span>

<span class="keyword1" id="Compositionality-globally_consistent_loweq"><span class="command">lemma</span></span> globally_consistent_loweq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> globally_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_consistent <span class="free">A</span> <span class="free">mds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dom <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="free">A</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> globally_consistent
    <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_def globally_consistent_var_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> some split_part<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> some
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-globally_consistent_adapt_bisim"><span class="command">lemma</span></span> globally_consistent_adapt_bisim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> globally_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_consistent <span class="free">A</span> <span class="free">mds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">A</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> globally_consistent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> globally_consistent_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> globally_consistent
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"dom <span class="free">A</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> apply_adaptation_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">|`</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">A'</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_insert_left_if0 dom_restrict inf_absorb2 insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"globally_consistent <span class="skolem">A'</span> <span class="free">mds</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A'_def globally_consistent_dom subset_insertI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> bisim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A'</span><span class="main">]</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A'</span><span class="main">]</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword1"><span class="command">have</span></span> writable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoWrite"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_consistent_writable insertI1<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_def globally_consistent_var_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domD insert_iff option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> case_prodE<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> A_A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">A</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">A'</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> insert_iff restrict_in restrict_out<span class="main">)</span>

    <span class="comment1">(* The following equalities may have more elegant proofs, but
        this should suffice, since the propositions are
        quite obvious. *)</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> apply_adaptation_def A'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="improper">y</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A'_def A_A'<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> apply_adaptation_def A'_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> y<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="improper">y</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A'_def A_A'<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mm_equiv_glob_consistent
        <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bisim' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoWrite›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq<span class="hidden">⇩</span><sub>1</sub> eq<span class="hidden">⇩</span><sub>2</sub>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span>›</span></span> globally_consistent_loweq insert.prems<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> writable <span class="keyword2"><span class="keyword">and</span></span> bisim <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A'</span><span class="main">]</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mm_equiv_glob_consistent
        <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span> bisim'<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq<span class="hidden">⇩</span><sub>1</sub> eq<span class="hidden">⇩</span><sub>2</sub>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This is the central lemma. Unfortunately, I didn't find
   a nice partitioning into several easier lemmas: *)</span>
<span class="keyword1" id="Compositionality-makes_compatible_invariant"><span class="command">lemma</span></span> makes_compatible_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
                      <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">mems'</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="free">mems'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes compat modes_eq <span class="keyword1"><span class="command">have</span></span>
    a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="var">?X</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span>
                                          doesnt_read <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_different_no_read<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[</span><span class="skolem">k</span> <span class="main">:=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_elim nth_list_update_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> modes_eq <span class="keyword1"><span class="command">have</span></span> equal_size<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mds<span class="hidden">⇩</span><sub>k</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?X</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_lists_finite<span class="main">)</span>

  <span class="comment1">(* Obtaining cms' and mem<span class="hidden">⇩</span><sub>2</sub>' is not in a proof block, since we
     need some of the following statements later: *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="var">?X</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">g1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> noread_exists_change_respecting b a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Un_upper1 differing_vars_lists_def differing_vars_subst<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> b <span class="keyword2"><span class="keyword">and</span></span> c <span class="keyword1"><span class="command">have</span></span>
    eval<span class="hidden">⇩</span><sub>σ</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> b <span class="keyword2"><span class="keyword">and</span></span> compat <span class="keyword1"><span class="command">have</span></span>
    bisim<span class="hidden">⇩</span><sub>σ</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size modes_eq nth_map<span class="main">)</span>
    
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">.</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="bound">c<span class="hidden">⇩</span><sub>f</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>f</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv_step<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> domh<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">h</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> h_prop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g2</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span>
    <span class="quoted"><span class="quoted">"change_respecting <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span><span class="main">)</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">⟩</span> <span class="main">(</span><span class="var">?X</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">g2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b noread_exists_change_respecting
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_lists_finite surjective_pairing<span class="main">)</span>

  <span class="comment1">― ‹The following statements are universally quantified
      since they are reused later:›</span>
  <span class="keyword1"><span class="command">with</span></span> h_prop <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">with</span></span> domh <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_overrides<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> d <span class="keyword2"><span class="keyword">and</span></span> f <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="bound">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="bound">σ</span><span class="main">]</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> h_prop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_partial <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">unfolding</span></span> to_partial_def subst_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> f domσ_mem<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">↝</span> <span class="main">⟨</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def c<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[</span><span class="skolem">k</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="var">?mds<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">)</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> i b equal_size <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_intro<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> equal_size <span class="keyword1"><span class="command">have</span></span> new_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cms<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval length_list_update meval_elim<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> modes_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cms<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b map_update snd_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword2"><span class="keyword">and</span></span> e <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dom_g1</span></span> <span class="skolem"><span class="skolem">dom_g2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    dom_uniq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">dom_g1</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">g1</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">σ</span><span class="main">.</span> dom <span class="bound">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">dom_g2</span> <span class="main">=</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps domh<span class="main">)</span>

  <span class="comment1">― ‹This is the complicated part of the proof.›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mems'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'_k</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'_k</span> <span class="skolem">x</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span>
       <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span><span class="main">)</span>
       <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="comment1">― ‹This is used in two of the following cases, so we prove it beforehand:›</span>
    <span class="keyword1"><span class="command">have</span></span> x_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a b c
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting_doesnt_modify dom_uniq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> domh<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> eq_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_in to_partial_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>›</span></span> dom_uniq e <span class="keyword1"><span class="command">have</span></span> g_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g2</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> change_respecting.simps func_le_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total eq_mem<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="skolem">h</span><span class="main">]</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="main">[↦</span> <span class="var">?σ_mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>›</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub> domh mem<span class="hidden">⇩</span><sub>2</sub>'_def subst_overrides<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'_i</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'_i</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High<span class="main">)</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low<span class="main">)</span><span class="main">)</span>
              <span class="keyword1">then</span> <span class="main">(</span><span class="free">some_val</span><span class="main">,</span> <span class="free">some_val</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">,</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mems'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'</span> <span class="main">=</span>
       map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span>
            <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">k</span>
            <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">)</span>
            <span class="keyword1">else</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> mems'_k_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_simp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">≠</span> <span class="skolem">k</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="skolem">mems'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="free">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* Some auxiliary statements to allow reasoning about these definitions as if they were given
       by cases instead of nested if clauses. *)</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_k_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">⟧</span> <span class="main">⟹</span>
      fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_k_simp mems'_k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_k_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span> <span class="main">⟧</span> <span class="main">⟹</span>
      fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_k_simp mems'_k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_k_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span> <span class="main">⟧</span> <span class="main">⟹</span>
      fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_k_simp mems'_k_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_k_cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">.</span>
        <span class="main">⟦</span>
         <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span><span class="main">;</span>
           fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span>
           snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
         <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span><span class="main">;</span>
           fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span><span class="main">;</span>
           snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mems'_k_1 mems'_k_2 mems'_k_3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_simp<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">k</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">,</span> snd <span class="main">∘</span> <span class="skolem">mems'_i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">⟧</span> <span class="main">⟹</span>
               fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mems'_i_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_i_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span>
              fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mems'_i_def mems'_i_simp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="comment1">(* This may look complicated, but is actually a rather
       mechanical definition, as it merely spells out the cases
       of the definition: *)</span>
    <span class="keyword1"><span class="command">have</span></span> mems'_i_cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span>
         <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≠</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
           <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
             <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High<span class="main">;</span>
             fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
        <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span>  <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">some_val</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">;</span>
      <span class="main">⟦</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span><span class="main">;</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">;</span>
        fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">;</span> snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="bound">P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mems'_i_1 mems'_i_2 mems'_i_3
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Sec.exhaust<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mems'</span> <span class="bound">i</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size length_list_update new_length<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">mems'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compat new_length
        <span class="keyword1"><span class="command">unfolding</span></span> mems'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> domσ<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
        <span class="comment1">― ‹We define another  function from this and reuse the universally quantified statements
          from the first part of the proof.›</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span>
              <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>
                <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>
                     <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="skolem">x</span>
                     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>
                             <span class="keyword1">then</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span><span class="main">)</span>
                             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">h</span><span class="main">)</span><span class="main">)</span>
                                  <span class="keyword1">then</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span><span class="main">)</span>
                                  <span class="keyword1">else</span> Some <span class="free">some_val</span>
                <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> domσ'<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> domI domIff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> domD domσ<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> diff_vars_impl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> differing_vars_elim<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> differing_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> not_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>›</span></span> mems'_k_2
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> differing_vars_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="comment1">(* We now show that we can reuse the earlier statements
           by showing the following equality: *)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> x_in_X'k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ domD <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g1</span> <span class="skolem">σ'</span> <span class="main">≼</span> <span class="skolem">σ'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ'
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> domσ' <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_vars_impl differing_in_dom dom_uniq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
             
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ' c le
              <span class="keyword1"><span class="command">unfolding</span></span> func_le_def subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> diff_vars_impl option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> x_in_X'k<span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> domσ' dom_uniq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g1</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> c domσ'
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps func_le_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> σ'_def
                <span class="keyword1"><span class="command">using</span></span> domσ' domh
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">g1</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> domIff dom_uniq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> subst_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">g1</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">[↦</span> <span class="skolem">g1</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ' dom_uniq<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subst_not_in_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="comment1">(* And the same for the second memories: *)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> domσ
              <span class="keyword1"><span class="command">unfolding</span></span> subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> e <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="main">≼</span> <span class="skolem">σ'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ'
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_in_dom domσ' dom_uniq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ' c le
              <span class="keyword1"><span class="command">unfolding</span></span> func_le_def subst_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> diff_vars_impl option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ' dom_restrict_total dom_uniq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def subst_overrides<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> domσ
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> subst_not_in_dom<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> domσ'
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_uniq<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> e domσ'
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> change_respecting.simps func_le_def<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>"</span></span><span class="main">)</span>
                <span class="comment1">― ‹This can't happen, so derive a contradiction.›</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>"</span></span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">)</span>›</span></span>
                      <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>›</span></span> domIff x_unchanged<span class="main">)</span>
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                    <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>k</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>k</span> <span class="skolem">x</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">dom_g2</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> differing_vars_elim differing_vars_neg<span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">)</span>›</span></span> domIff<span class="main">)</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span>"</span></span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> σ'_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> dom <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> 
                    domIff domσ' dom_uniq domh<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> subst_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">g2</span> <span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ'</span> <span class="skolem">x</span>›</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>›</span></span> domσ domσ'
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> dom_restrict_total dom_uniq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
                  mem<span class="hidden">⇩</span><sub>2</sub>'_def subst_not_in_dom subst_overrides<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">[↦</span> <span class="skolem">g2</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ' dom_uniq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_not_in_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span>›</span></span> mems'_k_1 mems'_k_2<span class="main">)</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> mem<span class="hidden">⇩</span><sub>2</sub>'_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span>›</span></span> domσ_mem<span class="hidden">⇩</span><sub>2</sub> dom_uniq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subst_not_in_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span><span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> domσ domσ' g b <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c<span class="hidden">⇩</span><sub>2</sub>'_def cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size nth_list_update_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ'</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>
                         <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>
                              <span class="keyword1">then</span> <span class="skolem">σ</span> <span class="skolem">x</span>
                              <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
                         <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> σ'_def
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD domσ<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>
                 <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                  <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">)</span>
                 <span class="main">⟶</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> eq_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> mems'_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mems'_i_3
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> b i_le length_list_update<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eq_mem mems'_simp
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> σ'_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mems'_simp<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mems'_simp<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eq_mem mems'_simp
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> domσ mems'_simp subst_not_in_dom<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">from</span></span> o <span class="keyword1"><span class="command">have</span></span>
          p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                      <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> mems_neq<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> modified<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span>doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> b i o
            <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> loc_modes<span class="main">:</span>
            <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∧</span>
             locally_sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size list_all_length<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b equal_size modes_eq nth_map<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> loc_reach <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl prod.collapse<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> guars<span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∧</span>
                 <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> loc_modes
            <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl surjective_pairing<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoWrite"</span></span>
            <span class="keyword1"><span class="command">using</span></span> modified loc_modes locally_sound_mode_use_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>›</span></span> loc_reach.refl prod.collapse<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compatible_modes <span class="main">(</span>map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_compatible sound_mode_use.simps<span class="main">)</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> compatible_modes_def
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> i_le
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> b length_list_update length_map nth_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low<span class="main">;</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∨</span>
                   <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="bound">x</span><span class="main">;</span>
                   <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟧</span> <span class="main">⟹</span>
                 <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> b compat_different_vars i_le length_list_update mems'_i_2 o<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size i_le length_list_update new_length<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> compat <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ'</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
          bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">∪</span>
                  differing_vars <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> Δ_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Δ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> differing_finite finite_UnI<span class="main">)</span>
        <span class="comment1">― ‹We first define the adaptation, then prove that it does the right thing.›</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span>
                     <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>
                      <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High
                           <span class="keyword1">then</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>
                           <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>
                                <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="keyword1">of</span>
                                        Some <span class="bound">v</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>
                                      <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>
                                <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>
                      <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> domA<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">A</span> <span class="main">=</span> <span class="var">?Δ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">A</span> <span class="main">⊆</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> A_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domD<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Δ</span> <span class="main">⊆</span> dom <span class="skolem">A</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> A_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domIff domσ option.exhaust option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> domIff domσ option.exhaust option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> A_correct<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span>
               globally_consistent_var <span class="skolem">A</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span> <span class="main">∧</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">x</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="var">?Eq<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="var">?Eq<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> diff<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> differing_vars_def<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> p <span class="keyword2"><span class="keyword">and</span></span> diff <span class="keyword1"><span class="command">have</span></span> writable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High›</span></span> <span class="keyword1"><span class="command">have</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> A_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> writable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_var_def A_simp
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">from</span></span> A_simp <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?Eq<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="var"><span class="quoted"><span class="var">?Eq<span class="hidden">⇩</span><sub>2</sub></span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> A_def apply_adaptation_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domD domσ<span class="main">)</span>
                <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> subst_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span> <span class="keyword1"><span class="command">have</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">σ</span> <span class="skolem">x</span> <span class="keyword1">of</span>
                            Some <span class="bound">v</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>
                          <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> A_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> writable eq <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_var_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> domA <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>

              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
                <span class="keyword1"><span class="command">hence</span></span> A_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> A_def
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span> diff <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> writable <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> globally_consistent_var_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
                  <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domσ subst_not_in_dom<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> apply_adaptation_def<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?Δ</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domA domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"globally_consistent_var <span class="skolem">A</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> globally_consistent_var_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom <span class="skolem">A</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?Δ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">∧</span>
                                 <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">=</span> None›</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_def apply_adaptation_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">∧</span>
               <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> A_correct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"globally_consistent <span class="skolem">A</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Δ_finite globally_consistent_def domA<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> equal_size modes_eq nth_map<span class="main">)</span>

        <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ'</span><span class="main">]</span> <span class="main">[∥<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">A</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹globally_consistent <span class="skolem">A</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> surjective_pairing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">!</span></span> <span class="skolem"><span class="skolem">i</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing globally_consistent_adapt_bisim<span class="main">)</span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> b cms<span class="hidden">⇩</span><sub>2</sub>'_def nth_list_update_neq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>'i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">k</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g1</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">dom_g2</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro mems'_k_1 mems'_k_2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> b compat compat_different mem_eq x_unchanged<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mems'_i_cases<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> b i_le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_list_update<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
          <span class="comment1">― ‹In this case, for example, the values of (mems' ! i) are not needed.›</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> case3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
            <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> case3 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X'</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg differing_vars_elim<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> case3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b compat compat_different i_le length_list_update<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> var_changed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mems'_k_cases<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> var_changed x_unchanged<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> b
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_zeroE<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> compat
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">k</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mems'_k_cases<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_neg_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_prop <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>›</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
                  <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">mems'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_prop assms mems'_i_3
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> i_prop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms differing_vars_neg differing_vars_neg_intro<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> i_prop <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X'</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cms<span class="hidden">⇩</span><sub>2</sub>'_def equal_size length_list_update new_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Isar proof language provides a readable
way of specifying assumptions while also giving them names for subsequent
usage.›</span></span>
<span class="keyword1" id="Compositionality-compat_low_eq"><span class="command">lemma</span></span> compat_low_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_readable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoRead"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">mems</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> compat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
                    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> x_low <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> low_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">mems</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> <span class="tfree">'Val</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restrict_total<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> compat <span class="keyword2"><span class="keyword">and</span></span> j_prop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> modes_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> j_prop length_map nth_map<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub>snd <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> modes_eq j_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse mm_equiv_low_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>j</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>j</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_low x_readable j_prop <span class="quoted"><span class="quoted">‹dom <span class="skolem">σ</span> <span class="main">=</span> <span class="var">?X</span> <span class="skolem">j</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> low_mds_eq_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_not_in_dom<span class="main">)</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> j_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_different_vars<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-loc_reach_subset"><span class="command">lemma</span></span> loc_reach_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⊆</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c''</span> <span class="skolem">mds''</span> <span class="skolem">mem''</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl loc_reach.step surjective_pairing<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>›</span></span> surjective_pairing<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-locally_sound_modes_invariant"><span class="command">lemma</span></span> locally_sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv loc_reach.refl loc_reach.step snd_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes
    <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Collect_empty_eq eval loc_reach_subset subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-reachable_modes_subset"><span class="command">lemma</span></span> reachable_modes_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable_mode_states <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">⊆</span> reachable_mode_states <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mdss</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mdss</span> <span class="main">∈</span> reachable_mode_states <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_mode_states_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> assms converse_rtrancl_into_rtrancl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-globally_sound_modes_invariant"><span class="command">lemma</span></span> globally_sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> globally_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms reachable_modes_subset
  <span class="keyword1"><span class="command">unfolding</span></span> globally_sound_mode_use_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Compositionality-loc_reach_mem_diff_subset"><span class="command">lemma</span></span> loc_reach_mem_diff_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">mds</span> AsmNoWrite <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> refl
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv loc_reach.mem_diff loc_reach.refl mem_diff snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> step
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> mem_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-loc_reach_mem_diff_eq"><span class="command">lemma</span></span> loc_reach_mem_diff_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">mds</span> AsmNoWrite <span class="main">⟶</span> <span class="free">mem'</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">=</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms loc_reach_mem_diff_subset
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1" id="Compositionality-sound_modes_invariant"><span class="command">lemma</span></span> sound_modes_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword2"><span class="keyword">and</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"globally_sound_mode_use <span class="main">(</span><span class="free">cms'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_invariant sound_mode_use.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> loc_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">cms</span><span class="main">.</span> locally_sound_mode_use <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> list_all_length<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">cms</span> <span class="main">∧</span> <span class="free">cms'</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">:=</span> <span class="skolem">cms<span class="hidden">⇩</span><sub>k</sub>'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">cms'</span> <span class="main">⟹</span> locally_sound_mode_use <span class="main">(</span><span class="free">cms'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">cms'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> i_le ev loc_sound
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> locally_sound_modes_invariant nth_list_update surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">cms'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev nth_list_update_neq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sound_modes <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compatible_modes <span class="main">(</span>map snd <span class="free">cms</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> globally_sound_modes_compatible<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> GuarNoWrite"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compatible_modes_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>›</span></span> ev i_le length_map nth_map<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>fst <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ev loc_sound
        <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl surjective_pairing<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> eval <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> AsmNoWrite <span class="main">⟶</span> <span class="free">mem</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> doesnt_modify_def ev prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"loc_reach <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span> <span class="main">=</span> loc_reach <span class="main">(</span><span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach_mem_diff_eq prod.collapse<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> loc_sound i_le <span class="quoted"><span class="quoted">‹length <span class="free">cms</span> <span class="main">=</span> length <span class="free">cms'</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">cms'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">cms</span> <span class="main">!</span> <span class="skolem">i</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sound_mode_use.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> list_all_length<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-makes_compatible_eval_k"><span class="command">lemma</span></span> makes_compatible_eval_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat<span class="main">:</span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">mems</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> modes_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map snd <span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mems'</span><span class="main">.</span> sound_mode_use <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              sound_mode_use <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              map snd <span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                              <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="free">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                              makes_compatible <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="bound">mems'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* cms<span class="hidden">⇩</span><sub>1</sub>' and mem<span class="hidden">⇩</span><sub>1</sub>' need to be arbitrary so
     that the induction hypothesis is sufficiently general. *)</span>
  <span class="keyword1"><span class="command">from</span></span> eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">k</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cms<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject meval_k.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat meval_k.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> modes_eq sound_modes<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> eval''<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="skolem">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meval_k.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod_cases3 snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> eval'' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mems''</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span>
      <span class="quoted"><span class="quoted">"sound_mode_use <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       sound_mode_use <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">cms<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="skolem">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="skolem">mems''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mems'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
       <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
       makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> makes_compatible_invariant
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH eval'' meval_k.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sound_modes_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Compositionality-differing_vars_initially_empty"><span class="command">lemma</span></span> differing_vars_initially_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>zip <span class="main">(</span>replicate <span class="free">n</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> differing_vars_lists_def differing_vars_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Compositionality-compatible_refl"><span class="command">lemma</span></span> compatible_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coms_secure<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all com_sifum_secure <span class="free">cmds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
                          <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
                          <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">cmds</span><span class="main">)</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="var">?n</span> <span class="main">(</span><span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?mdss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="var">?n</span> mds<span class="hidden">⇩</span><sub>s</sub>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"differing_vars_lists <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?mems</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> diff_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?n</span><span class="main">.</span> <span class="var">?X</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> differing_vars_initially_empty ex_in_conv min.idem zip_replicate<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> add_initial_modes_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span> <span class="main">=</span> length <span class="var">?mems</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">σ</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?mems</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> coms_secure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"com_sifum_secure <span class="main">(</span><span class="free">cmds</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coms_secure
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map length_replicate list_all_length map_snd_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub>mds<span class="hidden">⇩</span><sub>s</sub></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
      <span class="main">(</span>zip <span class="free">cmds</span> <span class="main">(</span>replicate <span class="var">?n</span> mds<span class="hidden">⇩</span><sub>s</sub><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span>zip <span class="free">cmds</span> <span class="main">(</span>replicate <span class="var">?n</span> mds<span class="hidden">⇩</span><sub>s</sub><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> com_sifum_secure_def low_indistinguishable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> low_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span> <span class="main">=</span><span class="hidden">⇘</span><sub>mds<span class="hidden">⇩</span><sub>s</sub></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_def mds<span class="hidden">⇩</span><sub>s</sub>_def low_mds_eq_def low_eq_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="improper">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>1</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?mems<span class="hidden">⇩</span><sub>2</sub>i</span> <span class="main">[↦</span> <span class="skolem">σ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> diff_empty <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span>zip <span class="free">cmds</span> <span class="var">?mdss</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="var">?X</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diff_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_less bot_nat_def empty_iff length_zip low_eq min_0L<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sifum_compositionality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> com_secure<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all com_sifum_secure <span class="free">cmds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"no_assumptions_on_termination <span class="free">cmds</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sound_modes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> sound_mode_use <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="bound">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prog_sifum_secure <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prog_sifum_secure_def
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="free">cmds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mems</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zip <span class="main">(</span>replicate <span class="var">?n</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>replicate <span class="var">?n</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> low_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">=<span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> com_secure <span class="keyword1"><span class="command">have</span></span> compat<span class="main">:</span>
    <span class="quoted"><span class="quoted">"makes_compatible <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="var">?mems</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compatible_refl fst_conv length_replicate map_replicate snd_conv zip_eq_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="skolem">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mems'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
             <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="skolem">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
             makes_compatible <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="skolem">mems'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_modes makes_compatible_eval_k
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">(</span>add_initial_modes <span class="free">cmds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">→</span><span class="hidden">⇘</span><sub><span class="skolem">k</span></sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">∧</span>
                        map snd <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> map snd <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span>
                        length <span class="bound">cms<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
                        <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">cms<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> AsmNoRead<span class="main">)</span>
          <span class="main">⟶</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p compat_low_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Language">
<div class="head">
<h1>Theory Language</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Language for Instantiating the SIFUM-Security Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Language
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Preliminaries.html">Preliminaries</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'var</span> ModeUpd <span class="main">=</span> Acq <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted">Mode</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">+=<span class="hidden">⇩</span><sub>m</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>
  <span class="main">|</span> Rel <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted">Mode</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">-=<span class="hidden">⇩</span><sub>m</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt <span class="main">=</span> Assign <span class="quoted"><span class="quoted">"<span class="tfree">'var</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'aexp</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">←</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 130<span class="main">)</span>
  <span class="main">|</span> Skip
  <span class="main">|</span> ModeDecl <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'var</span> ModeUpd"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">@[</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">]</span> 150<span class="main">)</span>
  <span class="main">|</span> Seq <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">;;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 150<span class="main">)</span>
  <span class="main">|</span> If <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">|</span> While <span class="quoted"><span class="quoted">"<span class="tfree">'bexp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt"</span></span>
  <span class="main">|</span> Stop

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> EvalCxt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'aexp</span><span class="main">,</span> <span class="tfree">'bexp</span><span class="main">)</span> Stmt list"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_lang <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">aexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'BExp</span> <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dma</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Var_finite <span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'Var</span><span class="main">)</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="free">e</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">bexp_vars</span> <span class="free">b</span><span class="main">.</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">b</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">b</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_lang
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* To make the examples look a bit nicer in the PDF. *)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>latex <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  Seq <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span> _"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  Seq <span class="main">(</span><span class="quoted">"_ <span class="keyword1">;</span> _"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  If <span class="main">(</span><span class="quoted">"<span class="keyword1">if</span> _ <span class="keyword1">then</span> _ <span class="keyword1">else</span> _ <span class="keyword1">fi</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>Rule <span class="keyword2"><span class="keyword">output</span></span><span class="main">)</span>
  While <span class="main">(</span><span class="quoted">"<span class="keyword1">while</span> _ <span class="keyword1">do</span> _ <span class="keyword1">done</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">conf<span class="hidden">⇩</span><sub>w</sub>_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span>
  <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> LocalConf"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">,</span> _<span class="keyword1">,</span> _<span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span> <span class="main">[</span>0<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="keyword1"><span class="free">⟩<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">update_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> Mds"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_modes</span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">update_modes</span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updated_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_var</span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_var</span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updated_mode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> Mode"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_mode</span> <span class="main">(</span>Acq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updated_mode</span> <span class="main">(</span>Rel <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem<span class="main">)</span> rel"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">×</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Skip<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  seq_stop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Seq Stop <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  if_true<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  if_false<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span> <span class="main">|</span>
  while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>If <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">;;</span> While <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> Stop<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_simple</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">cxt_to_stmt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> EvalCxt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cxt_to_stmt</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">cxt_to_stmt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span> Seq <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">(</span><span class="free">cxt_to_stmt</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(* Design decision: Add "normal" rule for sequential statements here as well.
  Otherwise, one would have to take care of adding some sort of normalization
  later, so that one doesn't get stuck on expressions of the form (c ;; c') ;; c''.
*)</span>
<span class="comment1">(* Normalization turned out to be more difficult, as it made the proofs of several
  helpful lemmas below quite difficult. *)</span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">eval<span class="hidden">⇩</span><sub>w</sub>_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  unannotated<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span> <span class="main">|</span>
  decl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> update_modes <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1"><span class="free">↝<span class="hidden">⇩</span><sub>w</sub></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span>
         <span class="main">(</span><span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">(</span>ModeDecl <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">,</span> <span class="main">⟨</span>cxt_to_stmt <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem'</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">eval<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantic Properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas simplify working with evaluation contexts
  in the soundness proofs for the type system(s).›</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> eval_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">)</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">)</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> stop_no_eval' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Stop<span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> assign_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> skip_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Skip<span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-cxt_inv"><span class="command">lemma</span></span> cxt_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">;</span> <span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">c'</span> <span class="main">≠</span> Seq <span class="bound">p</span> <span class="bound">q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_assign"><span class="command">lemma</span></span> cxt_inv_assign<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_skip"><span class="command">lemma</span></span> cxt_inv_skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Skip <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_stop"><span class="command">lemma</span></span> cxt_inv_stop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>40<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_if"><span class="command">lemma</span></span> cxt_inv_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">p</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>37<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-cxt_inv_while"><span class="command">lemma</span></span> cxt_inv_while<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">=</span> While <span class="free">e</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> While <span class="free">e</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>39<span class="main"><span class="main">)</span></span> cxt_inv<span class="main">)</span>

<span class="keyword1" id="Language-skip_elim"><span class="command">lemma</span></span> skip_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Skip<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span> <span class="main">∧</span> <span class="free">mem</span> <span class="main">=</span> <span class="free">mem'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> cxt_inv_skip cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> skip_elim'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>20<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> cxt_inv_skip<span class="main">)</span>

<span class="keyword1" id="Language-assign_elim"><span class="command">lemma</span></span> assign_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">eval<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c c'a E<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">←</span> <span class="free">e</span> <span class="main">∧</span> <span class="improper">E</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_assign<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_assign<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> cxt_inv_assign<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> if_elim' <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-if_elim"><span class="command">lemma</span></span> if_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">P</span><span class="main">.</span>
    <span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">b</span> <span class="free">p</span> <span class="free">q</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">;</span>
     <span class="main">⟦</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">;</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">;</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">;</span>
     <span class="main">⟦</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">q</span><span class="main">;</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">;</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">;</span> <span class="main">¬</span> <span class="free">eval<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_inv_if cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> if_elim'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>36<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> cxt_inv_if<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> while_elim' <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-while_elim"><span class="command">lemma</span></span> while_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_inv_while cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_elim'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>38<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>33<span class="main"><span class="main">)</span></span> cxt_inv_while<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> upd_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-upd_elim"><span class="command">lemma</span></span> upd_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>28<span class="main"><span class="main">)</span></span> cxt_inv upd_elim'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span> cxt_inv cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Language-cxt_seq_elim"><span class="command">lemma</span></span> cxt_seq_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">E</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c'</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">E</span> <span class="main">=</span> <span class="bound">c'</span> <span class="main">#</span> <span class="bound">cs</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> cxt_to_stmt <span class="bound">cs</span> <span class="bound">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">E</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> seq_elim' <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem</span><span class="main">)</span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Language-stop_no_eval"><span class="command">lemma</span></span> stop_no_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_inv_stop stop_no_eval'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>41<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>35<span class="main"><span class="main">)</span></span> cxt_inv_stop<span class="main">)</span>

<span class="keyword1" id="Language-seq_stop_elim"><span class="command">lemma</span></span> seq_stop_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> cxt_seq_elim cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> seq_elim' stop_no_eval'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stop_no_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> Stmt.distinct<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span> cxt_seq_elim<span class="main">)</span>

<span class="keyword1" id="Language-cxt_stmt_seq"><span class="command">lemma</span></span> cxt_stmt_seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">;;</span> cxt_to_stmt <span class="free">E</span> <span class="free">c'</span> <span class="main">=</span> cxt_to_stmt <span class="main">(</span><span class="free">c'</span> <span class="main">#</span> <span class="free">E</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1" id="Language-seq_elim"><span class="command">lemma</span></span> seq_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">;</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="keyword1">↝<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">∧</span> <span class="free">c'</span> <span class="main">=</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cxt_seq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="improper">c</span><span class="main">@[</span><span class="improper">mu</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cxt_seq_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> cxt_stmt_seq cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> cxt_seq_elim<span class="main">)</span>

<span class="keyword1" id="Language-stop_cxt"><span class="command">lemma</span></span> stop_cxt<span class="main">:</span> <span class="quoted"><span class="quoted">"Stop <span class="main">=</span> cxt_to_stmt <span class="free">E</span> <span class="free">c</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> Stop"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>41<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TypeSystem">
<div class="head">
<h1>Theory TypeSystem</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Type System for Ensuring SIFUM-Security of Commands›</span></span>

<span class="keyword1"><span class="command">theory</span></span> TypeSystem
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Preliminaries.html">Preliminaries</a> <a href="Security.html">Security</a> <a href="Language.html">Language</a> <a href="Compositionality.html">Compositionality</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Rules›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Type <span class="main">=</span> <span class="quoted">Sec</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'Var</span> TyEnv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> <span class="main">⇀</span> Type"</span></span>

<span class="comment1">(* We introduce a locale that instantiates the SIFUM-security property
  for the language from SIFUM_Lang.thy *)</span>
<span class="keyword1"><span class="command">locale</span></span> sifum_types <span class="main">=</span>
  sifum_lang <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="main">+</span> sifum_security <span class="quoted"><span class="free">dma</span></span> <span class="quoted">Stop</span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_types
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Redefined since Isabelle does not seem to be able to reuse the abbreviation from the old locale *)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mm_equiv_abv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mm_equiv_abv2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> mm_equiv_abv <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval_abv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">low_indistinguishable_abv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> Stmt <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∼</span>ı _"</span> <span class="main">[</span>100<span class="main">,</span> 100<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">∼</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> low_indistinguishable <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> <span class="main">⇒</span> Sec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_total</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Sec set <span class="main">⇒</span> Sec"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_dom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> High <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">then</span> High <span class="keyword1">else</span> Low"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">type_aexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> _ <span class="keyword1">∈</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  type_aexpr <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>a</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> max_dom <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> type_aexpr_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">type_bexpr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> Type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> _ <span class="keyword1">∈</span> _ "</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  type_bexpr <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> max_dom <span class="main">(</span>image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> type_bexpr_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mds_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds_consistent</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span>
    dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'Var</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoRead<span class="main">)</span> <span class="main">∨</span>
                          <span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_anno_dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoRead<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Low <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> High <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Acq <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoRead<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Low <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> High <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span> <span class="keyword1">else</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">add_anno_dom</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Rel <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_anno</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd <span class="main">⇒</span> <span class="tfree">'Var</span> TyEnv"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊕</span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> add_anno_dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">context_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span>"</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊑<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">≡</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">.</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊑</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">has_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">{</span>_<span class="keyword1">}</span> _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  stop_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span>Stop<span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  skip_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span>Skip<span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  assign<span class="hidden">⇩</span><sub>1</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊑</span> <span class="free">dma</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  assign<span class="hidden">⇩</span><sub>2</sub> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">has_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  if_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> High <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">mds</span><span class="main">.</span> mds_consistent <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟶</span> <span class="main">(</span>low_indistinguishable <span class="bound">mds</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some High<span class="main">)</span><span class="main">)</span>
             <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span>
             <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
             <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> If <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span>"</span></span> <span class="main">|</span>
  while_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> Low <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> While <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  anno_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> Stop <span class="main">;</span>
                 <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> to_total <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">upd</span></span></span><span class="main">]</span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span>"</span></span> <span class="main">|</span>
  seq_type <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ''</span></span></span>"</span></span> <span class="main">|</span>
  sub <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Soundness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following predicate is needed to exclude some pathological
  cases, that abuse the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Stop</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> command which is not allowed to
  occur in actual programs.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">has_annotated_stop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_annotated_stop</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">@[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Stop <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_annotated_stop</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_annotated_stop</span> <span class="main">(</span>If <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> <span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_annotated_stop</span> <span class="main">(</span>While <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">has_annotated_stop</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">has_annotated_stop</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> has_type_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> has_type_stop_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> Stop <span class="main">}</span> <span class="free">Γ'</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tyenv_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=</span>ı"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">=</span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>to_total <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-tyenv_eq_sym"><span class="command">lemma</span></span> tyenv_eq_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>


<span class="comment1">(* Parametrized relations for type soundness proof *)</span>
<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ<span class="hidden">⇩</span><sub>1</sub>_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span>ı _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>1</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  intro <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">;</span> mds_consistent <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>1</sup></span></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ<span class="hidden">⇩</span><sub>2</sub>_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>ı _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  intro <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span> <span class="main">;</span>
                       <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ'</span><span class="main">.</span> <span class="free">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High <span class="main">;</span>
                       <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">;</span>
                       mds_consistent <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;</span> mds_consistent <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                     <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ℛ<span class="hidden">⇩</span><sub>3</sub>_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                 <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
                 bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span>ı _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">lc<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="free">ℛ<span class="hidden">⇩</span><sub>3</sub>_aux</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="bound">lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">lc<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>3</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>2</sub> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>3</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>3</sub> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>3</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span><span class="main">;</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>3</sup></span></span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">Γ'</span></span></span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Seq <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span>"</span></span>

<span class="comment1">(* A weaker property than bisimulation to reason about the sub-relations of ℛ: *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">weak_bisim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel <span class="main">⇒</span>
                        <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">weak_bisim</span> <span class="free"><span class="bound"><span class="entity">𝒯<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">𝒯</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">mds'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span>
  <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒯<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> 
                <span class="main">(</span><span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒯</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">ℛ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf rel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">ℛ_abv</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span>ı _"</span> <span class="main">[</span>120<span class="main">,</span> 120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>u</sup></span></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span>"</span></span> <span class="main">|</span>
  intro<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">lc'</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ℛ</span> <span class="free">Γ</span>"</span></span>

<span class="comment1">(* Some eliminators for the above relations *)</span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ_elim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim' <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim' <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim' <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>

<span class="comment1">(* To prove that ℛ is a bisimulation, we first show symmetry *)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro ℛ<span class="hidden">⇩</span><sub>1</sub>_elim' tyenv_eq_sym<span class="main">)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>2</sub> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro ℛ<span class="hidden">⇩</span><sub>2</sub>_elim' mm_equiv_sym<span class="main">)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> symD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_sym ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub> symD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ_mds"><span class="command">lemma</span></span> ℛ_mds <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mds</span> <span class="main">=</span> <span class="free">mds'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim'<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="TypeSystem-ℛ_sym"><span class="command">lemma</span></span> ℛ_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sym_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ℛ_mds <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> asm <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ.intro<span class="hidden">⇩</span><sub>2</sub> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_sym <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_sym <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_sym <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Next, we show that the relations are closed under globally consistent changes *)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="skolem">Γ'</span>
  <span class="keyword3"><span class="command">assume</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> R1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> Γ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def mds_consistent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Γ_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">;</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_Collect_eq to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span>
     <span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_closed_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>2</sub> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="skolem">Γ'</span>
  <span class="keyword3"><span class="command">assume</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> Γ_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> R2 <span class="keyword1"><span class="command">have</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ℛ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ℛ'_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ'</span> <span class="main">∧</span> strong_low_bisim_mm <span class="skolem">ℛ'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mm_equiv_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ℛ'_prop <span class="keyword1"><span class="command">have</span></span> ℛ'_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="skolem">ℛ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strong_low_bisim_mm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Γ_prop <span class="keyword2"><span class="keyword">and</span></span> ℛ'_prop
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ℛ'</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> mm_equiv_intro <span class="keyword2"><span class="keyword">and</span></span> R2
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span>
     <span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ'_prop
    <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* A predicate like this seems to be necessary to make induct generate
    the correct goal in the following lemma. Without it, it somehow does
    not "unify" the local configuration components in the goal and the assumptions. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closed_glob_helper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed_glob_helper</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> AsmNoWrite<span class="main">)</span> <span class="main">⟶</span>
           <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_closed_glob_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span>
    <span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoWrite <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">dma</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoWrite <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="bound">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> R3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_glob_helper <span class="free">Γ'</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_closed_glob_consistent <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub>
      <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> intro<span class="hidden">⇩</span><sub>3</sub>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ_closed_glob_consistent"><span class="command">lemma</span></span> ℛ_closed_glob_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> ℛ_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_closed_glob_consistent <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
    <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_closed_glob_consistent <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span>
     <span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_glob_consistent_def
    <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x</span> <span class="skolem">Γ'</span>
  <span class="keyword3"><span class="command">assume</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> High <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span>
     <span class="main">(</span><span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">mds</span> AsmNoWrite <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_closed_glob_consistent
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* It now remains to show that steps of the first of two related configurations
    can be matched by the second: *)</span>

<span class="comment1">(* Some technical lemmas: *)</span>
<span class="keyword1" id="TypeSystem-type_low_vars_low"><span class="command">lemma</span></span> type_low_vars_low<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">e</span> <span class="main">∈</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mds_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"to_total <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Sec.exhaust imageI max_dom_def type_aexpr_elim<span class="main">)</span>

<span class="keyword1" id="TypeSystem-type_low_vars_low_b"><span class="command">lemma</span></span> type_low_vars_low_b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typed <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">e</span> <span class="main">∈</span> Low"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mds_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_in_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">bexp_vars</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"to_total <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Low"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Sec.exhaust imageI max_dom_def type_bexpr.simps<span class="main">)</span>

<span class="keyword1" id="TypeSystem-mode_update_add_anno"><span class="command">lemma</span></span> mode_update_add_anno<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span> <span class="main">⟹</span> mds_consistent <span class="main">(</span>update_modes <span class="free">upd</span> <span class="free">mds</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊕</span> <span class="free">upd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_anno_dom.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_anno_def mds_consistent_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-context_le_trans"><span class="command">lemma</span></span> context_le_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Γ</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Γ'</span> <span class="main">;</span> <span class="free">Γ'</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Γ''</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Γ''</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> context_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI order_trans option.sel<span class="main">)</span>

<span class="keyword1" id="TypeSystem-context_le_refl"><span class="command">lemma</span></span> context_le_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_def order_refl<span class="main">)</span>

<span class="comment1">(* Strangely, using only ⊢ Γ { Stop } Γ' as assumption does not work *)</span>
<span class="keyword1" id="TypeSystem-stop_cxt"><span class="command">lemma</span></span> stop_cxt <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">;</span> <span class="free">c</span> <span class="main">=</span> Stop <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_trans<span class="main">)</span>

<span class="comment1">(* First we show that (roughly) typeability is preserved by evaluation steps *)</span>
<span class="keyword1" id="TypeSystem-preservation"><span class="command">lemma</span></span> preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Γ''</span><span class="main">.</span> <span class="main">(</span><span class="main">⊢</span> <span class="bound">Γ''</span> <span class="main">{</span> <span class="free">c'</span> <span class="main">}</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>mds_consistent <span class="free">mds</span> <span class="free">Γ</span> <span class="main">⟶</span> mds_consistent <span class="free">mds'</span> <span class="bound">Γ''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typed eval
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ''</span> <span class="skolem">Γ</span> <span class="skolem">upd</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> upd_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> anno_type<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ'</span> <span class="main">∧</span> <span class="main">(</span>mds_consistent <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span> <span class="main">⟶</span>
                          mds_consistent <span class="free">mds'</span> <span class="skolem">Γ'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="main">⟶</span> mds_consistent <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mode_update_add_anno<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> skip_type
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_type<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Sec.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> CollectD domI assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> CollectD domI assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> CollectE domI assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> domD mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> domD mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span> <span class="skolem">Γ'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">c</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> while_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> has_type.while_type if_type while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> seq_type stop_type type_bexpr_elim<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_stop_elim<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> context_le_refl seq_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stop_cxt sub<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim seq_type.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ'''</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span>
      <span class="main">(</span>mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span> <span class="main">⟶</span> mds_consistent <span class="free">mds'</span> <span class="skolem">Γ'''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">ultimately</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ'''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> has_type.seq_type<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">c'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ''</span> <span class="main">{</span> <span class="skolem">c'</span> <span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span>
    <span class="main">(</span>mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> mds_consistent <span class="free">mds'</span> <span class="skolem">Γ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">Γ''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> has_type.sub sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> stop_cxt stop_type<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_def sub.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def mds_consistent_def to_total_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> low_mds_eq_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mm_equiv_elim strong_low_bisim_mm_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bisim_helper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt<span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bisim_helper</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free"><span class="bound"><span class="entity">mds</span></span></span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free"><span class="bound"><span class="entity">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"bisim_helper <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq ℛ<span class="hidden">⇩</span><sub>2</sub>_mem_eq<span class="main">)</span>

<span class="comment1">(* ℛ<span class="hidden">⇩</span><sub>2</sub> is a full bisimulation so we can show the stronger step statement here: *)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_bisim_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> case2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> case2 <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">Γ'</span><span class="main">.</span> <span class="free">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> eval <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
     <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mm_equiv_strong_low_bisim strong_low_bisim_mm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="comment1">(* with aux(1) obtain ℛ' where ℛ'_props: "(⟨c<span class="hidden">⇩</span><sub>1</sub>, mds, mem<span class="hidden">⇩</span><sub>1</sub>⟩, ⟨c<span class="hidden">⇩</span><sub>2</sub>, mds, mem<span class="hidden">⇩</span><sub>2</sub>⟩) ∈ ℛ'" "strong_low_bisim_mm ℛ'" *)</span>
    <span class="comment1">(* using mm_equiv_elim *)</span>
    <span class="comment1">(* by auto *)</span>
  <span class="keyword1"><span class="command">from</span></span> case2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> preservation <span class="keyword2"><span class="keyword">and</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">{</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">}</span> <span class="free">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">}</span> <span class="free">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro aux<span class="main">(</span>2<span class="main">)</span> c<span class="hidden">⇩</span><sub>2</sub>'_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* To achieve more "symmetry" later, we prove a property analogous to the ones
    for ℛ<span class="hidden">⇩</span><sub>1</sub> and ℛ<span class="hidden">⇩</span><sub>3</sub> which are not, by themselves, bisimulations. *)</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_weak_bisim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_bisim <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>2</sub> <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_bisim_def
  <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>2</sub>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_bisim_step<span class="main">)</span>


<span class="comment1">(* Not actually needed, but an interesting "asymmetry" since
    ℛ<span class="hidden">⇩</span><sub>1</sub> and ℛ<span class="hidden">⇩</span><sub>3</sub> aren't bisimulations. *)</span>
<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>2</sub> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_sym ℛ<span class="hidden">⇩</span><sub>2</sub>_closed_glob_consistent ℛ<span class="hidden">⇩</span><sub>2</sub>_mem_eq ℛ<span class="hidden">⇩</span><sub>2</sub>_bisim_step<span class="main">)</span>

<span class="keyword1" id="TypeSystem-annotated_no_stop"><span class="command">lemma</span></span> annotated_no_stop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> has_annotated_stop <span class="main">(</span><span class="free">c</span><span class="main">@[</span><span class="free">upd</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> has_annotated_stop <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TypeSystem-typed_no_annotated_stop"><span class="command">lemma</span></span> typed_no_annotated_stop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span> has_annotated_stop <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="TypeSystem-not_stop_eval"><span class="command">lemma</span></span> not_stop_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span> <span class="main">≠</span> Stop <span class="main">;</span> <span class="main">¬</span> has_annotated_stop <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span> <span class="bound">mds</span> <span class="bound">mem</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assign <span class="skolem">x</span> <span class="skolem">exp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.assign eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Skip
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.skip<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ModeDecl <span class="skolem">c</span> <span class="skolem">mu</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_annotated_stop <span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> has_annotated_stop.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ModeDecl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> mds mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"update_modes <span class="skolem">mu</span> <span class="improper">mds</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="improper">mem</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.seq_stop eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Seq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq has_annotated_stop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">bexp</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> mds mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="improper">mem</span> <span class="skolem">bexp</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">bexp</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.while eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Stop
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-stop_bisim"><span class="command">lemma</span></span> stop_bisim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> Stop"</span></span>
  <span class="keyword1"><span class="command">from</span></span> typeable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_annotated_stop <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> typed_no_annotated_stop<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">≠</span> Stop›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">mds'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_stop_eval
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≈</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mm_equiv_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mm_equiv_strong_low_bisim
    <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> stop_no_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* This is the main part of the proof and used in ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim: *)</span>

<span class="keyword1" id="TypeSystem-ℛ_typed_step"><span class="command">lemma</span></span> ℛ_typed_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">;</span>
     mds_consistent <span class="free">mds</span> <span class="free">Γ</span> <span class="main">;</span>
     <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;</span>
     <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> has_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq_type <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ'</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_type
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_stop_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> seq_type <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊑<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">Γ''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_cxt<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_refl seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sub<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq_type <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.seq_stop eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> seq_type<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_type<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> seq_type<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub> seq_type<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> c<span class="hidden">⇩</span><sub>2</sub>''_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c<span class="hidden">⇩</span><sub>1</sub>''_props<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>anno_type <span class="skolem">Γ'</span> <span class="skolem">Γ</span> <span class="skolem">upd</span> <span class="skolem">c</span> <span class="skolem">Γ''</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Sec_def anno_type<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> anno_type<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> tyenv_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="main">(</span>update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> anno_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> anno_type<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> mode_update_add_anno<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> update_modes <span class="skolem">upd</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
    <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ''</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> anno_type
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> anno_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> upd_elim<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> stop_type
  <span class="keyword1"><span class="command">with</span></span> stop_no_eval <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>skip_type <span class="skolem">Γ</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> skip_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> skip_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword2"><span class="keyword">and</span></span> unannotated <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted">Skip</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> E <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.skip<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>1</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"to_total <span class="skolem">Γ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"to_total <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> High"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>1</sub> tyenv_eq_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"to_total <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_Sec_def to_total_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">dma</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>1</sub> <span class="quoted"><span class="quoted">‹to_total <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Low›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> to_total_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assign<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="skolem">e</span><span class="main">.</span> to_total <span class="skolem">Γ</span> <span class="bound">v</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">using</span></span> type_low_vars_low
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tyenv_eq_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tyenv_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assign<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* assign<span class="hidden">⇩</span><sub>2</sub> *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="skolem">mds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_elim assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign<span class="hidden">⇩</span><sub>2</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.assign eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="var">?Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assign<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="var">?Γ'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> insert_absorb assign<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="var">?Γ'</span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"to_total <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">aexp_vars</span> <span class="skolem">e</span> <span class="main">⟹</span> to_total <span class="skolem">Γ</span> <span class="bound">x</span> <span class="main">=</span> Low"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign<span class="hidden">⇩</span><sub>2</sub>.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> domI fun_upd_same option.sel to_total_def type_low_vars_low<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign<span class="hidden">⇩</span><sub>2</sub>.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eval_vars_det<span class="hidden">⇩</span><sub>A</sub> tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"to_total <span class="main">(</span><span class="skolem">Γ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Low"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assign<span class="hidden">⇩</span><sub>2</sub>.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> domD domI fun_upd_other to_total_def tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">t</span><span class="main">)</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Stop›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* if *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span> <span class="skolem">Γ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> if_type<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> if_elim if_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq_condition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span> <span class="main">⟹</span> <span class="var">?case</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.if_true eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def mds_consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">∉</span> dom <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> if_type<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> to_total_def tyenv_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> CollectD Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> mds_consistent_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> type_bexpr.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if_type <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> High"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq_condition <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">≠</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> if_type <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> High›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span> <span class="skolem">el</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> neq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>›</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> neq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> low_indistinguishable_def <span class="quoted"><span class="quoted">‹<span class="skolem">th</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span> <span class="skolem">el</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_type <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> High›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> if_type<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>2</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">th</span>›</span></span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> if_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">th</span> <span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span>›</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> neq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">th</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span> <span class="skolem">el</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">el</span> <span class="main">∼</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span> <span class="skolem">th</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> low_indistinguishable_sym<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> low_indistinguishable_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_type <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> High›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> if_type <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">el</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">th</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>2</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">el</span>›</span></span> if_elim if_type<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Low"</span></span>
    <span class="keyword1"><span class="command">with</span></span> if_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tyenv_eq_def <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> type_low_vars_low_b<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>b</sub></span> <span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">t</span>›</span></span> type_low_vars_low_b<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq_condition <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">(* while *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while_type <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> while_type <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.while eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while_type<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if_type<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Sec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> type_bexpr_elim<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seq_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> while_type<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span> <span class="skolem">mds</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> dom <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">Γ'</span> <span class="main">⊆</span> dom <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> context_le_def equalityE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_def sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> context_le_def domD mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> full_types<span class="main"><span class="main">)</span></span> context_le_def domD mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></sub><span class="hidden">⇙</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tyenv_eq_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> context_le_def less_eq_Sec_def sub.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sub.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> to_total_def tyenv_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">mds</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> has_type.sub sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> stop_cxt stop_type<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Λ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span>  <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sub<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_refl has_type.sub sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> context_le_refl has_type.sub sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> r2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">Γ'</span> <span class="main">⊆</span> dom <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span> context_le_def domD less_eq_Sec_def sub<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> rev_subsetD option.sel<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>.intro ℛ<span class="hidden">⇩</span><sub>2</sub>_elim' <span class="quoted"><span class="quoted">‹mds_consistent <span class="skolem">mds</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹mds_consistent <span class="skolem">mds</span> <span class="skolem">Λ<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> r2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="var">?lc<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="var">?lc<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="skolem">c</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> case1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span> <span class="skolem">Γ'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> context_le_refl has_type.sub sub.hyps<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> case1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="skolem">c''</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="main">;;</span> <span class="skolem">c''</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span><span class="skolem">c''</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_refl has_type.sub sub.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="skolem">c''</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="main">;;</span> <span class="skolem">c''</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ</span> <span class="main">{</span><span class="skolem">c''</span><span class="main">}</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> context_le_refl has_type.sub sub.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> c<span class="hidden">⇩</span><sub>2</sub>'_props <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* We can now show that ℛ<span class="hidden">⇩</span><sub>1</sub> and ℛ<span class="hidden">⇩</span><sub>3</sub> are weak bisimulations of ℛ,: *)</span>
<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_bisim <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>1</sub> <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> weak_bisim_def
  <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim ℛ_typed_step
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TypeSystem-ℛ_to_ℛ"><span class="command">lemma</span></span> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">;</span> <span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>3</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_implies_typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="main">⊢</span> <span class="bound">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="TypeSystem-ℛ"><span class="command">lemma</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_weak_bisim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"weak_bisim <span class="main">(</span>ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
    <span class="keyword3"><span class="command">assume</span></span> case3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="free">Γ'</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> case3 eval
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_elim<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.seq_stop eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_stop_elim<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop›</span></span> context_le_refl intro<span class="hidden">⇩</span><sub>1</sub>.prems intro<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> seq_stop_elim stop_cxt sub<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop›</span></span> intro<span class="hidden">⇩</span><sub>1</sub>.prems seq_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> intro<span class="hidden">⇩</span><sub>1</sub>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim <span class="keyword2"><span class="keyword">and</span></span> weak_bisim_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>2<span class="main">)</span> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">cn</span> <span class="skolem">Γ'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">cn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eval intro<span class="hidden">⇩</span><sub>2</sub> seq_stop_elim 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim'<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>2</sub> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">}</span> <span class="skolem">Γ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_implies_typeable<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Stop"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> stop_bisim <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">mds</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intro<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simplep.seq_stop eval<span class="hidden">⇩</span><sub>w</sub>p.unannotated eval<span class="hidden">⇩</span><sub>w</sub>p_eval<span class="hidden">⇩</span><sub>w</sub>_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> intro<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mds_consistent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> context_le_def stop_cxt<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> bisim <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mm_equiv.simps strong_low_bisim_mm_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="skolem">Γ</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some High"</span></span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ℛ<span class="hidden">⇩</span><sub>2</sub>_elim'<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mds_consistent <span class="skolem">mds</span> <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tyenv_eq_def low_mds_eq_def mds_consistent_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sec.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>dom <span class="skolem">Γ</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some High›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>›</span></span> domI option.sel to_total_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>1</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro intro<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Stop›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span> <span class="main">;;</span> <span class="skolem">cn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> intro<span class="hidden">⇩</span><sub>2</sub>.prems seq_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>2</sub>'''_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
          <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ<span class="hidden">⇩</span><sub>2</sub>_bisim_step intro<span class="hidden">⇩</span><sub>2</sub>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>'''</span> <span class="main">;;</span> <span class="skolem">cn</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> c<span class="hidden">⇩</span><sub>2</sub>'''_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">;;</span> <span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="var">?c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> intro<span class="hidden">⇩</span><sub>2</sub> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span> <span class="main">;;</span> <span class="skolem">cn</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="var">?c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">Γ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub> c<span class="hidden">⇩</span><sub>2</sub>'''_props intro<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mem_Collect_eq case_prodI<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>2</sub> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'''</span> <span class="main">;;</span> <span class="skolem">cn</span>›</span></span> c<span class="hidden">⇩</span><sub>2</sub>'''_props intro<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>intro<span class="hidden">⇩</span><sub>3</sub> <span class="skolem">Γ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c</span> <span class="skolem">Γ'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> Stop"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> intro<span class="hidden">⇩</span><sub>3</sub>.prems seq_elim<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main">(</span>2<span class="main">)</span> mem_Collect_eq case_prodI
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ℛ_elim<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ_to_ℛ<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="skolem">Γ</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> ℛ.intro<span class="hidden">⇩</span><sub>3</sub> ℛ<span class="hidden">⇩</span><sub>3</sub>_aux.intro<span class="hidden">⇩</span><sub>3</sub> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>''</span> <span class="main">;;</span> <span class="skolem">c</span>›</span></span> intro<span class="hidden">⇩</span><sub>3</sub><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> weak_bisim_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Hence ℛ is a bisimulation: *)</span>
<span class="keyword1" id="TypeSystem-ℛ_bisim"><span class="command">lemma</span></span> ℛ_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"strong_low_bisim_mm <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strong_low_bisim_mm_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ℛ_sym <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> ℛ_closed_glob_consistent <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_glob_consistent <span class="main">(</span>ℛ <span class="free">Γ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span><span class="hidden">⇘</span><sub><span class="skolem">mds</span></sub><span class="hidden">⇙</span><span class="keyword1"><span class="hidden">⇧</span><sup>l</sup></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ℛ<span class="hidden">⇩</span><sub>1</sub>_mem_eq ℛ<span class="hidden">⇩</span><sub>2</sub>_mem_eq ℛ<span class="hidden">⇩</span><sub>3</sub>_mem_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">mds'</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span>
  <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span> <span class="main">∧</span>
                            <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="bound">mem<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ_elim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ℛ<span class="hidden">⇩</span><sub>1</sub>_weak_bisim ℛ<span class="hidden">⇩</span><sub>2</sub>_weak_bisim ℛ<span class="hidden">⇩</span><sub>3</sub>_weak_bisim eval weak_bisim_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq case_prodI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="TypeSystem-Typed_in_ℛ"><span class="command">lemma</span></span> Typed_in_ℛ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mds_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>u</sup></span><span class="hidden">⇘</span><sub><span class="free">Γ'</span></sub><span class="hidden">⇙</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ.intro<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ℛ<span class="hidden">⇩</span><sub>1</sub>.intro <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms tyenv_eq_def<span class="main">)</span> 

<span class="comment1">(* We then prove the main soundness theorem using the fact that typeable
    configurations can be related using ℛ<span class="hidden">⇩</span><sub>1</sub> *)</span>
<span class="keyword1"><span class="command">theorem</span></span> type_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> well_typed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">Γ</span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mds_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent <span class="free">mds</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> to_total <span class="free">Γ</span> <span class="bound">x</span> <span class="main">=</span> Low <span class="main">⟶</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> <span class="main">≈</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ℛ_bisim Typed_in_ℛ
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mds_cons mem_eq mm_equiv.simps well_typed<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">Γ<span class="hidden">⇩</span><sub>0</sub></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> TyEnv"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span>

<span class="comment1">(* The typing relation for lists of commands ("thread pools"). *)</span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">type_global</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt list <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _"</span> <span class="main">[</span>120<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> <span class="main">⊢</span> Γ<span class="hidden">⇩</span><sub>0</sub> <span class="main">{</span> <span class="bound">c</span> <span class="main">}</span> Γ<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">;</span>
     <span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> sound_mode_use <span class="main">(</span>add_initial_modes <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">,</span> <span class="bound">mem</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">type_global</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> type_global_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">cs</span>"</span></span>

<span class="keyword1" id="TypeSystem-mds"><span class="command">lemma</span></span> mds<span class="hidden">⇩</span><sub>s</sub>_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"mds_consistent mds<span class="hidden">⇩</span><sub>s</sub> Γ<span class="hidden">⇩</span><sub>0</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds<span class="hidden">⇩</span><sub>s</sub>_def mds_consistent_def Γ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-typed_secure"><span class="command">lemma</span></span> typed_secure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⊢</span> Γ<span class="hidden">⇩</span><sub>0</sub> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> Γ<span class="hidden">⇩</span><sub>0</sub> <span class="main">⟧</span> <span class="main">⟹</span> com_sifum_secure <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> com_sifum_secure_def low_indistinguishable_def mds_consistent_def type_soundness<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_mds_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> type_soundness <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Γ<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span> <span class="quoted"><span class="quoted">Γ<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds<span class="hidden">⇩</span><sub>s</sub>_consistent to_total_def Γ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff mds<span class="hidden">⇩</span><sub>s</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mds_consistent <span class="free">mds</span> Γ<span class="hidden">⇩</span><sub>0</sub> <span class="main">;</span> <span class="free">dma</span> <span class="free">x</span> <span class="main">=</span> Low <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">mds</span> AsmNoRead"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mds_consistent_def Γ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">)</span>

<span class="keyword1" id="TypeSystem-list_all_set"><span class="command">lemma</span></span> list_all_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> type_soundness_global<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_assms_term<span class="main">:</span> <span class="quoted"><span class="quoted">"no_assumptions_on_termination <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prog_sifum_secure <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typeable
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> type_global_elim<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span><span class="main">.</span> com_sifum_secure <span class="bound">c</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> list_all_set no_assms_term sifum_compositionality sound_mode_use.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> list_all_iff typed_secure<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LocallySoundModeUse">
<div class="head">
<h1>Theory LocallySoundModeUse</h1>
</div>
<pre class="source"><span class="comment1">(*
Title: SIFUM-Type-Systems
Authors: Sylvia Grewe, Heiko Mantel, Daniel Schoepe
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Type System for Ensuring Locally Sound Use of Modes›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LocallySoundModeUse
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Security.html">Security</a> <a href="Language.html">Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Rules›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sifum_modes <span class="main">=</span> sifum_lang <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span></span>  <span class="main">+</span>
  sifum_security <span class="quoted"><span class="free">dma</span></span> <span class="quoted">Stop</span> <span class="quoted">eval<span class="hidden">⇩</span><sub>w</sub></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'AExp</span> <span class="main">⇒</span> <span class="tfree">'Val</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> Mem <span class="main">⇒</span> <span class="tfree">'BExp</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">context</span></span> sifum_modes
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eval_abv_modes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'Val</span><span class="main">)</span> LocalConf <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> LocalConf <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> eval<span class="hidden">⇩</span><sub>w</sub>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_annos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd list <span class="main">⇒</span> <span class="tfree">'Var</span> Mds"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 140<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_annos</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">update_annos</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">update_annos</span> <span class="main">(</span>update_modes <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">annotate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span> <span class="tfree">'Var</span> ModeUpd list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 140<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">annotate</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">@[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">mode_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Var</span> Mds <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'Var</span><span class="main">,</span> <span class="tfree">'AExp</span><span class="main">,</span> <span class="tfree">'BExp</span><span class="main">)</span> Stmt <span class="main">⇒</span>
  <span class="tfree">'Var</span> Mds <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">{</span> _ <span class="keyword1">}</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> Skip <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoWrite <span class="main">;</span> <span class="free">aexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoRead <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  if_<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">;</span>
          <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span><span class="main">)</span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">;</span>
          <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> GuarNoRead <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span>
        <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> If <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span>"</span></span> <span class="main">|</span>
  while<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">;</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> GuarNoRead <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> While <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">annos</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span>"</span></span> <span class="main">|</span>
  seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main">;</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds'</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds</span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds''</span></span></span>"</span></span> <span class="main">|</span>
  sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">{</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">mds<span class="hidden">⇩</span><sub>1</sub>'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness of the Type System›</span></span>

<span class="comment1">(* Special case for evaluation with an empty context *)</span>
<span class="keyword1" id="LocallySoundModeUse-cxt_eval"><span class="command">lemma</span></span> cxt_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>cxt_to_stmt <span class="main">[]</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>cxt_to_stmt <span class="main">[]</span> <span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-update_preserves_le"><span class="command">lemma</span></span> update_preserves_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">annos</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"update_modes <span class="skolem">a</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> update_modes <span class="skolem">a</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Annotations do not affect doesnt_read and doesnt_modify: *)</span>
<span class="keyword1" id="LocallySoundModeUse-doesnt_read_annos"><span class="command">lemma</span></span> doesnt_read_annos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_read <span class="free">c</span> <span class="free">x</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span><span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl upd_elim<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-doesnt_modify_annos"><span class="command">lemma</span></span> doesnt_modify_annos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> upd_elim<span class="main">)</span>

<span class="comment1">(* The following part contains some lemmas about evaluation of
   commands annotated using ⊗ and characterisations of loc_reach for
   commands. *)</span>

<span class="keyword1" id="LocallySoundModeUse-stop_loc_reach"><span class="command">lemma</span></span> stop_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stop_no_eval<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-stop_doesnt_access"><span class="command">lemma</span></span> stop_doesnt_access<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify Stop <span class="free">x</span> <span class="main">∧</span> doesnt_read Stop <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_read_def
  <span class="keyword1"><span class="command">using</span></span> stop_no_eval
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-skip_eval_step"><span class="command">lemma</span></span> skip_eval_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_to_stmt.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.skip<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-skip_eval_elim"><span class="command">lemma</span></span> skip_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> skip_eval_step deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_read"><span class="command">lemma</span></span> skip_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> skip_elim skip_eval_step<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_write"><span class="command">lemma</span></span> skip_doesnt_write<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_elim<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-skip_loc_reach"><span class="command">lemma</span></span> skip_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Skip <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> skip_eval_elim stop_no_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="LocallySoundModeUse-skip_doesnt_access"><span class="command">lemma</span></span> skip_doesnt_access<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">lc</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>Skip <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">;</span> <span class="free">lc</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read <span class="free">c'</span> <span class="free">x</span> <span class="main">∧</span> doesnt_modify <span class="free">c'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Skip <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_read_def stop_no_eval<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> annotate.simps skip_doesnt_read<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_modify_def stop_no_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> annotate.simps skip_doesnt_write<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> skip_loc_reach<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-assign_doesnt_modify"><span class="command">lemma</span></span> assign_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim fun_upd_apply<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-assign_annos_eval"><span class="command">lemma</span></span> assign_annos_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> annotate.simps update_annos.simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cxt_to_stmt.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-assign_annos_eval_elim"><span class="command">lemma</span></span> assign_annos_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> deterministic assign_annos_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="LocallySoundModeUse-mem_upd_commute"><span class="command">lemma</span></span> mem_upd_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">mem</span> <span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_twist<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-assign_doesnt_read"><span class="command">lemma</span></span> assign_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span>›</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign eval_vars_det<span class="hidden">⇩</span><sub>A</sub> fun_upd_apply fun_upd_upd<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> asms<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">,</span> <span class="free">y</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">)</span> <span class="main">=</span> <span class="improper">mem</span> <span class="main">(</span><span class="free">y</span> <span class="main">:=</span> <span class="improper">v</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="free">ev<span class="hidden">⇩</span><sub>A</sub></span> <span class="improper">mem</span> <span class="free">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.assign eval_vars_det<span class="hidden">⇩</span><sub>A</sub> fun_upd_apply<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mem_upd_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_elim<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LocallySoundModeUse-assign_loc_reach"><span class="command">lemma</span></span> assign_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="main">(</span><span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">←</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign_annos_eval_elim stop_no_eval<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_modify"><span class="command">lemma</span></span> if_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_modify_annos<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-vars_eval"><span class="command">lemma</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">=</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="main">(</span><span class="free">mem</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> eval_vars_det<span class="hidden">⇩</span><sub>B</sub> fun_upd_other<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_read"><span class="command">lemma</span></span> if_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> doesnt_read_annos<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c' mds' mem' v va<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="improper">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> vars_eval<span class="hidden">⇩</span><sub>B</sub><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_true"><span class="command">lemma</span></span> if_eval_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_true<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl update_annos.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_false"><span class="command">lemma</span></span> if_eval_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.if_false<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl update_annos.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_elim"><span class="command">lemma</span></span> if_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> if_eval_true deterministic<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject if_eval_false deterministic<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_eval_elim'"><span class="command">lemma</span></span> if_eval_elim'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">ev<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">mem</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_eval_elim <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-loc_reach_refl'"><span class="command">lemma</span></span> loc_reach_refl'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">lc</span><span class="main">.</span> <span class="bound">lc</span> <span class="main">∈</span> loc_reach <span class="bound">lc</span> <span class="main">∧</span> <span class="bound">lc</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.refl fst_conv snd_conv<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_loc_reach"><span class="command">lemma</span></span> if_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> if_eval_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach_refl'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach_refl'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.mem_diff<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-if_loc_reach'"><span class="command">lemma</span></span> if_loc_reach'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_loc_reach <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LocallySoundModeUse-seq_loc_reach"><span class="command">lemma</span></span> seq_loc_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span><span class="main">.</span> <span class="free">c'</span> <span class="main">=</span> <span class="bound">c''</span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">⟨</span><span class="bound">c''</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span> <span class="bound">c''</span> <span class="bound">mds''</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∧</span> 
                      <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span>  loc_reach_refl'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> loc_reach.step loc_reach_refl' seq_elim seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> loc_reach.mem_diff<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-seq_doesnt_read"><span class="command">lemma</span></span> seq_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> doesnt_read <span class="free">c</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> <span class="free">c'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_read_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> mds mem c'a mds' mem' v va<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c'a</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">∧</span> <span class="improper">mds'</span> <span class="main">=</span> <span class="improper">mds</span> <span class="main">∧</span> <span class="improper">mem'</span> <span class="main">=</span> <span class="improper">mem</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.unannotated eval<span class="hidden">⇩</span><sub>w</sub>_simple.seq_stop<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>.seq seq_elim<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-seq_doesnt_modify"><span class="command">lemma</span></span> seq_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> doesnt_modify <span class="free">c</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_modify <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> <span class="free">c'</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> doesnt_modify_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> seq_elim<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> seq_stop_elim'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span>"</span></span>

<span class="keyword1" id="LocallySoundModeUse-seq_stop_elim"><span class="command">lemma</span></span> seq_stop_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop <span class="main">;;</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟹</span>
  <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> seq_stop_elim'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated seq_stop_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> eval<span class="hidden">⇩</span><sub>w</sub>.seq seq_stop_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>28<span class="main"><span class="main">)</span></span> Stmt.simps<span class="main"><span class="main">(</span></span>34<span class="main"><span class="main">)</span></span> cxt_seq_elim<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-seq_split"><span class="command">lemma</span></span> seq_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span> <span class="bound">mds''</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span>Stop<span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">∧</span>
                 <span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mds''</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> seq_loc_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.simps<span class="main"><span class="main">(</span></span>41<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval"><span class="command">lemma</span></span> while_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="main">(</span>If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop<span class="main">)</span><span class="main">,</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">annos</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cxt_eval<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>w</sub>.unannotated<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> eval<span class="hidden">⇩</span><sub>w</sub>_simple.while<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cxt_eval eval<span class="hidden">⇩</span><sub>w</sub>.decl<span class="main">)</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval'"><span class="command">lemma</span></span> while_eval'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span>If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop<span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> while_eval <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval_elim"><span class="command">lemma</span></span> while_eval_elim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">⊕</span> <span class="free">annos</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while_eval deterministic<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LocallySoundModeUse-while_eval_elim'"><span class="command">lemma</span></span> while_eval_elim'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⟨</span>While <span class="free">e</span> <span class="free">c</span><span class="main">,</span> <span class="free">mds</span><span class="main">,</span> <span class="free">mem</span><span class="main">⟩</span> <span class="main">↝</span> <span class="main">⟨</span><span class="free">c'</span><span class="main">,</span> <span class="free">mds'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> If <span class="free">e</span> <span class="main">(</span><span class="free">c</span> <span class="main">;;</span> While <span class="free">e</span> <span class="free">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="free">mds'</span> <span class="main">=</span> <span class="free">mds</span> <span class="main">∧</span> <span class="free">mem'</span> <span class="main">=</span> <span class="free">mem</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> while_eval_elim <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-while_doesnt_read"><span class="command">lemma</span></span> while_doesnt_read<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟧</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def
  <span class="keyword1"><span class="command">using</span></span> while_eval while_eval_elim
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="LocallySoundModeUse-while_doesnt_modify"><span class="command">lemma</span></span> while_doesnt_modify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>While <span class="free">e</span> <span class="free">c</span> <span class="main">⊗</span> <span class="free">annos</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> doesnt_modify_def
  <span class="keyword1"><span class="command">using</span></span> while_eval_elim
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="comment1">(* TODO: try to find a better solution to this: *)</span>
<span class="keyword1" id="LocallySoundModeUse-disjE3"><span class="command">lemma</span></span> disjE3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">;</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-disjE5"><span class="command">lemma</span></span> disjE5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">∨</span> <span class="free">C</span> <span class="main">∨</span> <span class="free">D</span> <span class="main">∨</span> <span class="free">E</span> <span class="main">;</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">;</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LocallySoundModeUse-if_doesnt_read'"><span class="command">lemma</span></span> if_doesnt_read'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="free">e</span> <span class="main">⟹</span> doesnt_read <span class="main">(</span>If <span class="free">e</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> if_doesnt_read <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> annos <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> mode_type_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> typeable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span> <span class="free">c</span> <span class="main">}</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mode_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span>Stop<span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="free">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span> <span class="main">⟶</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="free">mds<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">∧</span> 
                locally_sound_mode_use <span class="main">⟨</span><span class="free">c</span><span class="main">,</span> <span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> typeable mode_le
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">mds<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="quoted"><span class="free">mem'</span></span> <span class="quoted"><span class="free">mem</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mode_type.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>skip <span class="skolem">mds</span> <span class="skolem">annos</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> skip_eval_step skip_loc_reach stop_no_eval update_preserves_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps skip_doesnt_access<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>assign <span class="skolem">x</span> <span class="skolem">mds</span> <span class="skolem">e</span> <span class="skolem">annos</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">mem</span><span class="main">.</span> locally_sound_mode_use <span class="main">⟨</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∨</span> <span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assign_loc_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="skolem">c'</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoRead"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">aexp_vars</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 IntI assign.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assign.prems empty_iff inf_apply le_iff_inf<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> assign_doesnt_read <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assign.prems in_mono le_fun_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> assign_doesnt_modify <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">←</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> stop_doesnt_access <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assign.prems assign_annos_eval assign_loc_reach stop_no_eval update_preserves_le<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>if_ <span class="skolem">mds</span> <span class="skolem">annos</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds''</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">annos</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> if_ <span class="keyword1"><span class="command">have</span></span> modes_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> update_preserves_le<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> modes_le' <span class="keyword2"><span class="keyword">and</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_eval_false if_eval_true if_loc_reach stop_no_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∃</span> <span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> if_loc_reach <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="skolem">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoRead"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="skolem">mds</span> GuarNoRead <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≤</span> <span class="skolem">mds</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">bexp_vars</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntD2 disjoint_iff_not_equal inf_fun_def le_iff_inf<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_read <span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_doesnt_read <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"doesnt_modify <span class="main">(</span>If <span class="skolem">e</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> if_doesnt_modify <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">mem''</span><span class="main">.</span> <span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> if_ <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> locally_sound_mode_use_def modes_le'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>while <span class="skolem">mdsa</span> <span class="skolem">mds</span> <span class="skolem">annos</span> <span class="skolem">c</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> update_preserves_le<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> while_loc_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c'</span> <span class="bound">mds'</span> <span class="bound">mem'</span> <span class="bound">mem</span><span class="main">.</span>
  <span class="main">⟨</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">mem</span><span class="main">⟩</span> <span class="main">⟹</span>
  <span class="bound">c'</span> <span class="main">=</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span> <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">=</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> Stmt.If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="bound">c'</span> <span class="main">=</span> Stop <span class="main">∧</span> <span class="bound">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c''</span> <span class="bound">mem''</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">.</span>
      <span class="bound">c'</span> <span class="main">=</span> <span class="bound">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">∧</span>
      <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span> <span class="main">∧</span> <span class="main">⟨</span><span class="bound">c''</span><span class="main">,</span> <span class="bound">mds'</span><span class="main">,</span> <span class="bound">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="bound">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="bound">mem''</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span> <span class="skolem">mem</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> loc_reach.induct<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>›</span></span> while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_eval_elim<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> while_eval_elim'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> if_eval_elim' loc_reach_refl'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> stop_no_eval<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c' mds' mem' c'' mds'' mem'' c''a<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">c''a</span> <span class="main">=</span> Stop"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> seq_stop_elim while.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> loc_reach.step seq_elim<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> loc_reach.mem_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> while <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Stmt.distinct<span class="main"><span class="main">(</span></span>35<span class="main"><span class="main">)</span></span> stop_no_eval while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while_eval while_loc_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword1"><span class="command">from</span></span> while <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="skolem">e</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span><span class="main">)</span> GuarNoRead <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> Int_empty_right Int_left_commute <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊕</span> <span class="skolem">annos</span> <span class="main">≤</span> <span class="skolem">mds</span> <span class="main">⊕</span> <span class="skolem">annos</span>›</span></span> inf_fun_def le_iff_inf<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> locally_sound_mode_use_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span> <span class="skolem">mds'</span> <span class="skolem">mem'</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="main">=</span> <span class="main">⟨</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c'</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="skolem">lc</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="skolem">c'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                 <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="skolem">c'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lc_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> while_loc_reach<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE5<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span> <span class="main">⊗</span> <span class="skolem">annos</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_modify_def
          <span class="keyword1"><span class="command">using</span></span> while_eval <span class="keyword2"><span class="keyword">and</span></span> while_eval_elim
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"If <span class="skolem">e</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> Stop"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="var">?c'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if_doesnt_read'<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI <span class="quoted"><span class="quoted">‹<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> empty_iff le_fun_def rev_subsetD while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> while.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="var">?c'</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annotate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> if_doesnt_modify<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="var">?c'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
                         <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="var">?c'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read Stop <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify Stop <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stop_doesnt_access<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c''</span> <span class="skolem">x</span> <span class="skolem">mem''</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">c''</span><span class="main">,</span> <span class="skolem">mds'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="main">(</span><span class="skolem">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span><span class="skolem">c''</span> <span class="main">;;</span> While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seq_doesnt_read<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> while<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> locally_sound_mode_use_def while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seq_doesnt_modify<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">mds<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≤</span> <span class="skolem">mdsa</span>›</span></span> locally_sound_mode_use_def while.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds'</span> <span class="main">≤</span> <span class="skolem">mdsa</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoRead <span class="main">⟶</span> doesnt_read <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">mds'</span> GuarNoWrite <span class="main">⟶</span> doesnt_modify <span class="main">(</span>While <span class="skolem">e</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> doesnt_read_def <span class="keyword2"><span class="keyword">and</span></span> doesnt_modify_def
          <span class="keyword1"><span class="command">using</span></span> while_eval' <span class="keyword2"><span class="keyword">and</span></span> while_eval_elim'
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>seq <span class="skolem">mds</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">mds''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span></span> <span class="skolem"><span class="skolem">mem''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Stop<span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">mem'</span><span class="main">⟩</span> <span class="main">∈</span> loc_reach <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span><span class="main">,</span> <span class="skolem">mem''</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≤</span> <span class="skolem">mds''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">mem</span>
    <span class="keyword1"><span class="command">from</span></span> seq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"locally_sound_mode_use <span class="main">⟨</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">;;</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">mem</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locally_sound_mode_use_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> seq_loc_reach<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> seq_doesnt_modify seq_doesnt_read<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>''</span> <span class="skolem">c</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">mds<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> inf_absorb2 le_infI1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>