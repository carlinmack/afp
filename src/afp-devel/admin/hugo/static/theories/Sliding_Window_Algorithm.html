<div id="SWA">
<div class="head">
<h1>Theory SWA</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> SWA
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sliding Window Algorithm›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tree <span class="main">=</span>
  Leaf
<span class="main">|</span> Node <span class="main">(</span><span class="free"><span class="free"><span class="entity">l</span></span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">r</span></span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">val</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">lchild</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">rchild</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> Leaf <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lchild</span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rchild</span> Leaf <span class="main">=</span> Leaf"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neq_Leaf_if_l_gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> l <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">discharge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">discharge</span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">discharge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> None <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">semigroup_add</span><span class="main">)</span> <span class="quoted">semigroup_add</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">plus_option</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_option</span> None <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">plus_option</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">plus_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> plus_option.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semigroup_add tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> Leaf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Node <span class="main">(</span>l <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>r <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> val <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span>discharge <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_non_Leaves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">;</span> <span class="free">u</span> <span class="main">≠</span> Leaf<span class="main">⟧</span> <span class="main">⟹</span> combine <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Node <span class="main">(</span>l <span class="free">t</span><span class="main">)</span> <span class="main">(</span>r <span class="free">u</span><span class="main">)</span> <span class="main">(</span>val <span class="free">t</span> <span class="main">+</span> val <span class="free">u</span><span class="main">)</span> <span class="main">(</span>discharge <span class="free">t</span><span class="main">)</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"combine <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Node <span class="main">(</span>l <span class="main">(</span>Node <span class="main">(</span>l <span class="free">t</span><span class="main">)</span> <span class="main">(</span>r <span class="free">t</span><span class="main">)</span> <span class="main">(</span>val <span class="free">t</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>r <span class="main">(</span>Node <span class="main">(</span>l <span class="free">u</span><span class="main">)</span> <span class="main">(</span>r <span class="free">u</span><span class="main">)</span> <span class="main">(</span>val <span class="free">u</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">u</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>val <span class="main">(</span>Node <span class="main">(</span>l <span class="free">t</span><span class="main">)</span> <span class="main">(</span>r <span class="free">t</span><span class="main">)</span> <span class="main">(</span>val <span class="free">t</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> val <span class="main">(</span>Node <span class="main">(</span>l <span class="free">u</span><span class="main">)</span> <span class="main">(</span>r <span class="free">u</span><span class="main">)</span> <span class="main">(</span>val <span class="free">u</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">u</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>discharge <span class="main">(</span>Node <span class="main">(</span>l <span class="free">t</span><span class="main">)</span> <span class="main">(</span>r <span class="free">t</span><span class="main">)</span> <span class="main">(</span>val <span class="free">t</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Node <span class="main">(</span>l <span class="free">u</span><span class="main">)</span> <span class="main">(</span>r <span class="free">u</span><span class="main">)</span> <span class="main">(</span>val <span class="free">u</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">u</span><span class="main">)</span> <span class="main">(</span>rchild <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> combine.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tree.exhaust_sel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_combine_non_Leaves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">;</span> <span class="free">u</span> <span class="main">≠</span> Leaf<span class="main">⟧</span> <span class="main">⟹</span> r <span class="main">(</span>combine <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> r <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_non_Leaves<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> window <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">window</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> window <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">window</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">windows</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> window list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">windows</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">w</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">.</span> window <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">w</span><span class="main">)</span> <span class="main">∧</span>
    sorted <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">reusables</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> window <span class="main">⇒</span> <span class="tfree">'a</span> tree list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reusables</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">&gt;</span> r <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> l <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>
     <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> lchild <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="bound">u</span> <span class="main">=</span> rchild <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≥</span> l <span class="bound">u</span> <span class="keyword1">then</span>
       <span class="free">reusables</span> <span class="bound">u</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">else</span> <span class="bound">u</span> <span class="main">#</span> <span class="free">reusables</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> size <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lchild_def rchild_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> reusables.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> reusables_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span> <span class="main">⟹</span> reusables Leaf <span class="free">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reusables.simps<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">well_shaped</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">well_shaped</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">well_shaped</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Leaf<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> Leaf <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> Leaf <span class="main">∧</span> <span class="free">well_shaped</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">well_shaped</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span>
      <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> l <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> r <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> Suc <span class="main">(</span>r <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> l <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_lchild_eq_l_if_well_shaped<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">&lt;</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> l <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">=</span> l <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_rchild_eq_r_if_well_shaped<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">&lt;</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> r <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span> <span class="main">=</span> r <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_lchild_eq_l_rchild_if_well_shaped<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">&lt;</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> r <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">=</span> l <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_lchild_le_r<span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">⟹</span> r <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> r <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left order.trans le_add2 tree.exhaust_sel well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_lchild<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">⟹</span> well_shaped <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_rchild<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">⟹</span> well_shaped <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjacent</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adjacent</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span>Leaf <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∧</span>
     list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> l <span class="bound">t</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span>l <span class="main">(</span>last <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> r <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="free">w</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="free">w</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">∧</span> r <span class="free">t</span> <span class="main">=</span> snd <span class="free">w</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> l <span class="free">t</span> <span class="main">=</span> fst <span class="free">w</span>
     <span class="main">|</span> <span class="bound">u</span> <span class="main">#</span> <span class="bound">us</span> <span class="main">⇒</span> adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> r <span class="bound">u</span><span class="main">)</span> <span class="free">ts</span> <span class="main">∧</span> l <span class="free">t</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_ConsI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">;</span> r <span class="free">t</span> <span class="main">=</span> snd <span class="free">w</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> l <span class="free">t</span> <span class="main">=</span> fst <span class="free">w</span>
     <span class="main">|</span> <span class="bound">u</span> <span class="main">#</span> <span class="bound">us</span> <span class="main">⇒</span> adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> r <span class="bound">u</span><span class="main">)</span> <span class="free">ts</span> <span class="main">∧</span> l <span class="free">t</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 
  adjacent <span class="free">w</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> adjacent <span class="main">(</span>l <span class="free">t</span><span class="main">,</span> r <span class="free">t</span><span class="main">)</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> append_Cons_eq_append_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_append_singletonI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">;</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_appendI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_Cons_append_singletonI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> list_all2 <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> butlast <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span> <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_all2_append_singletonI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_appendI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">us</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> adjacent <span class="free">w</span> <span class="free">ts</span>
    <span class="main">|</span> <span class="bound">u</span> <span class="main">#</span> <span class="bound">us'</span> <span class="main">⇒</span> adjacent <span class="main">(</span>Suc <span class="main">(</span>r <span class="bound">u</span><span class="main">)</span><span class="main">,</span> snd <span class="free">w</span><span class="main">)</span> <span class="free">ts</span> <span class="main">∧</span> adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> snd <span class="free">w</span> <span class="main">|</span> <span class="bound">ts</span> <span class="main">⇒</span> r <span class="bound">u</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span> <span class="main">#</span> <span class="bound">us'</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> 
  adjacent <span class="free">w</span> <span class="main">(</span><span class="free">ts</span> <span class="main">@</span> <span class="free">us</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def butlast_append
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_Cons_append_singletonI
    list_all2_appendI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> list_all2_Cons_append_singletonI<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_Cons_implies_adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> adjacent <span class="main">(</span><span class="free">a</span><span class="main">,</span> l <span class="free">t</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semigroup_add<span class="main">)</span> fold_add_add<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(+)</span> <span class="free">xs</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(+)</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">as</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semigroup_add list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ws</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"window list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">atomic</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Some <span class="main">(</span>nth <span class="free">as</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> Leaf Leaf"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atomics</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> tree list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomics</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> map atomic <span class="main">(</span>rev <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..&lt;</span> Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">slide</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> window <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slide</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">ts</span> <span class="main">=</span> atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">ts'</span> <span class="main">=</span> reusables <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>
    <span class="keyword1">in</span> fold combine <span class="main">(</span><span class="bound">ts</span> <span class="main">@</span> <span class="bound">ts'</span><span class="main">)</span> Leaf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">iterate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> window list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> slide <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span> the <span class="main">(</span>val <span class="bound">t'</span><span class="main">)</span> <span class="main">#</span> <span class="free">iterate</span> <span class="bound">t'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sliding_window</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sliding_window</span> <span class="main">=</span> iterate Leaf <span class="free">ws</span>"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sum</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> fold <span class="main">(+)</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span>nth <span class="free">as</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nth <span class="free">as</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">well_valued0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">well_valued0</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">well_valued0</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> length <span class="free">as</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Some <span class="main">(</span>sum <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">well_valued0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free">well_valued0</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Leaf <span class="main">∨</span> val <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">well_valued</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">well_valued</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span>well_valued0 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟶</span> val <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>well_shaped <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> well_valued <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"valid Leaf"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> sum <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> sum <span class="free">i</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="main">..&lt;</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span> <span class="free">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms upt_add_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="free">j</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_add_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_rchild_if_well_valued0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">t</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_lchild_if_well_valued0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">t</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_rchild_if_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">t</span> <span class="main">⟹</span> valid <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust_sel tree.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> valid_def well_shaped_rchild well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_eq_Some_sum_if_valid_neq_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">t</span><span class="main">;</span> <span class="free">t</span> <span class="main">≠</span> Leaf<span class="main">⟧</span> <span class="main">⟹</span> val <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span>sum <span class="main">(</span>l <span class="free">t</span><span class="main">)</span> <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def foldr_conv_fold<span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> One_nat_def option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject tree.exhaust_sel well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the Slide Function›</span></span>

<span class="comment1">(* fact (b) part 1 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjacent_atomics<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>atomics <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def atomics_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map last_rev nth_tl
    map_butlast<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> list_all2_conv_all_nth nth_Cons' rev_nth nth_append<span class="main">)</span>

<span class="comment1">(* fact (b) part 2 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_atomics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>atomics <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atomics_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reusables_neq_Nil_if_well_shaped_and_overlapping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≤</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> reusables <span class="free">t</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reusables.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reusables.simps Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reusables_lchild_neq_Nil_under_some_conditions<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≠</span> l <span class="free">t</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≥</span> fst <span class="free">w</span><span class="main">;</span> l <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span> <span class="main">&gt;</span> fst <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
    reusables <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_lchild_eq_l_rchild_if_well_shaped<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span>"</span></span><span class="main">]</span> r_lchild_le_r<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> reusables_neq_Nil_if_well_shaped_and_overlapping<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* fact (a) part 1 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjacent_reusables<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
  adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> r <span class="free">t</span><span class="main">)</span> <span class="main">(</span>reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reusables.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">=</span> l <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">≥</span> l <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> reusables.simps<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"reusables <span class="main">(</span>lchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"reusables <span class="main">(</span>lchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reusables_lchild_neq_Nil_under_some_conditions<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2-6<span class="main">)</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> l <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span> <span class="main">≤</span> fst <span class="skolem">w</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>fst <span class="skolem">w</span><span class="main">,</span> r <span class="main">(</span>lchild <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons r_lchild_le_r dual_order.trans<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> reusables.simps<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def adjacent_Cons r_lchild_eq_l_rchild_if_well_shaped<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reusables.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> adjacent_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reusables.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_rchild_if_well_valued0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="main">(</span>rchild <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust_sel tree.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> valid_def well_shaped_rchild well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_reusables_under_some_conditions<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> well_valued0 <span class="free">t</span><span class="main">;</span> well_shaped <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> valid <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reusables.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">=</span> l <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">w</span> <span class="main">≥</span> l <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="main">(</span>reusables <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> valid"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ball_empty dual_order.strict_trans2 leI le_neq_implies_less list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> r_rchild_eq_r_if_well_shaped reusables.simps set_ConsD valid_rchild_if_well_valued0 well_shaped_rchild well_valued0_rchild_if_well_valued0<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reusables <span class="skolem">t</span> <span class="skolem">w</span> <span class="main">=</span> reusables <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> reusables.simps<span class="main">)</span>
            <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> 1 * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="main">(</span>reusables <span class="main">(</span>lchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> valid"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans2 l_lchild_eq_l_if_well_shaped leI order_trans r_lchild_le_r well_shaped_lchild well_valued0_lchild_if_well_valued0<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> valid_rchild<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>rchild <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_rchild_if_well_valued0<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reusables <span class="skolem">t</span> <span class="skolem">w</span> <span class="main">=</span> rchild <span class="skolem">t</span> <span class="main">#</span> reusables <span class="main">(</span>lchild <span class="skolem">t</span><span class="main">)</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> reusables.simps<span class="main">)</span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="quoted"><span class="quoted">‹fst <span class="skolem">w</span> <span class="main">≠</span> l <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> fst <span class="skolem">w</span> <span class="main">&gt;</span> r <span class="skolem">t</span>›</span></span> False * valid_rchild <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_ConsD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reusables.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reusables.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* fact (a) part 2 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_reusables<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> valid <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_def valid_reusables_under_some_conditions <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reusables.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_valid_Nodes_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> l <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"l <span class="free">z</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">z</span>"</span></span>
    <span class="quoted"><span class="quoted">"well_valued0 <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"val <span class="free">a</span> <span class="main">=</span> Some <span class="free">va</span>"</span></span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"val <span class="free">z</span> <span class="main">=</span> Some <span class="free">vz</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">va</span> <span class="main">+</span> <span class="free">vz</span> <span class="main">=</span> fold <span class="main">(+)</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">[</span>l <span class="free">a</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="free">z</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="main">(</span>r <span class="free">z</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l <span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="free">a</span> <span class="main">≥</span> l <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.collapse well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="free">z</span> <span class="main">&gt;</span> r <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_lessD prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tree.collapse well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>l <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r <span class="free">a</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>r <span class="free">z</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>l <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> add_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">va</span> <span class="main">=</span> sum <span class="main">(</span>l <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI option.inject tree.collapse well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vz</span> <span class="main">=</span> sum <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>r <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI option.inject prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> tree.collapse well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(+)</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">[</span>l <span class="free">a</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="free">z</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="main">(</span>r <span class="free">z</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span>l <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_sum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> discharge_is_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"discharge <span class="free">a</span> <span class="main">=</span> Leaf <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_discharge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">a</span> <span class="main">⟹</span> well_shaped <span class="main">(</span>discharge <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_discharge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">a</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span>discharge <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_discharge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"l <span class="main">(</span>discharge <span class="free">a</span><span class="main">)</span> <span class="main">=</span> l <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_discharge<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>discharge <span class="free">a</span><span class="main">)</span> <span class="main">=</span> r <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_lr<span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">a</span> <span class="main">⟹</span> l <span class="free">a</span> <span class="main">≤</span> r <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_r<span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> r <span class="free">a</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_combine_if_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> l <span class="free">a</span><span class="main">;</span> valid <span class="free">a</span><span class="main">;</span> valid <span class="free">z</span><span class="main">;</span> <span class="free">a</span> <span class="main">≠</span> Leaf<span class="main">;</span> <span class="free">z</span> <span class="main">≠</span> Leaf<span class="main">;</span> l <span class="free">z</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="free">a</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  valid <span class="main">(</span>combine <span class="free">a</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def combine_non_Leaves combine_valid_Nodes_aux
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> well_shaped_lr well_valued0_r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_neq_Leaf_if_both_non_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">≠</span> Leaf<span class="main">;</span> <span class="free">z</span> <span class="main">≠</span> Leaf<span class="main">⟧</span> <span class="main">⟹</span>
  combine <span class="free">a</span> <span class="free">z</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_non_Leaves<span class="main">)</span>

<span class="comment1">(* generalized version of fact (c) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_fold_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">h</span> <span class="main">#</span> <span class="free">ts'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> valid <span class="bound">t</span><span class="main">;</span> adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> l <span class="free">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">ts'</span><span class="main">;</span>
    valid <span class="free">z</span><span class="main">;</span> <span class="free">z</span> <span class="main">≠</span> Leaf<span class="main">;</span> l <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> fst <span class="free">w</span> <span class="main">|</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="bound">ts''</span> <span class="main">⇒</span> Suc <span class="main">(</span>r <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">;</span> r <span class="free">z</span> <span class="main">=</span> snd <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
      valid <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">z</span><span class="main">)</span> <span class="main">∧</span>
      l <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ts'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> l <span class="skolem">a</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">ts'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adjacent_Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2-6<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>combine <span class="skolem">a</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adjacent_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> valid_combine_if_valid<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"combine <span class="skolem">a</span> <span class="skolem">z</span> <span class="main">≠</span> Leaf"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> combine_neq_Leaf_if_both_non_Leaf<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l <span class="main">(</span>combine <span class="skolem">a</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">ts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> fst <span class="free">w</span> <span class="main">|</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="bound">ts''</span> <span class="main">⇒</span> Suc <span class="main">(</span>r <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_def combine_non_Leaves <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>combine <span class="skolem">a</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> r_combine_non_Leaves<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* fact (c) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_fold_combine_Leaf<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">h</span> <span class="main">#</span> <span class="free">ts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> valid <span class="bound">t</span>"</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="free">w</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fold combine <span class="free">ts</span> Leaf<span class="main">)</span> <span class="main">∧</span>
  l <span class="main">(</span>fold combine <span class="free">ts</span> Leaf<span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>fold combine <span class="free">ts</span> Leaf<span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold combine <span class="free">ts</span> Leaf <span class="main">=</span> fold combine <span class="free">ts'</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">h</span><span class="main">)</span> <span class="main">∧</span>
    l <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>fold combine <span class="free">ts'</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> valid_fold_combine<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="free">h</span> <span class="main">#</span> <span class="free">ts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> valid <span class="bound">t</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">h</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
      <span class="quoted"><span class="quoted">"l <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> fst <span class="free">w</span> <span class="main">|</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="bound">ts''</span> <span class="main">⇒</span> Suc <span class="main">(</span>r <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons list.case_eq_if<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> l <span class="free">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def adjacent_Cons_implies_adjacent prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_atomics_nonempty_reusables<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"reusables <span class="free">t</span> <span class="free">w</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">x</span><span class="main">)</span><span class="main">,</span> snd <span class="free">w</span><span class="main">)</span> <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ts</span><span class="main">.</span> adjacent <span class="bound">p</span> <span class="bound">ts</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Leaf<span class="main">::</span><span class="tfree">'a</span> tree<span class="main">)</span> <span class="main">∉</span> set <span class="bound">ts</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">ta</span><span class="main">.</span> l <span class="bound">t</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="bound">ta</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="bound">ts</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ts</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> l <span class="main">(</span>last <span class="bound">ts</span><span class="main">)</span> <span class="main">=</span> fst <span class="bound">p</span> <span class="main">∧</span> r <span class="main">(</span>hd <span class="bound">ts</span><span class="main">)</span> <span class="main">=</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f7<span class="main">:</span> <span class="quoted"><span class="quoted">"Leaf <span class="main">∉</span> set <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">ta</span><span class="main">.</span> l <span class="bound">t</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="bound">ta</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>butlast <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> l <span class="main">(</span>last <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> r <span class="main">(</span>hd <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> snd <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_atomics <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> r <span class="free">t</span><span class="main">)</span> <span class="main">(</span>reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a4 a3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_reusables valid_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f8<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">=</span> r <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_n_not_le_n list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> max.bounded_iff max_def_raw not_le_imp_less reusables.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f8 f7 f6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_Cons_r<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span><span class="free">a</span><span class="main">,</span> r <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> adjacent <span class="main">(</span><span class="free">a</span><span class="main">,</span> r <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjacent_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_Cons_r2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"adjacent <span class="main">(</span>fst <span class="free">w</span><span class="main">,</span> r <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span> <span class="main">⟹</span> fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span> <span class="main">⟹</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span> <span class="main">⟹</span>
   atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span>
   adjacent <span class="free">w</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atomics_def adjacent_def append_is_Nil_conv diff_Suc_Suc diff_zero le_Suc_eq list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_is_Nil_conv max_Suc_Suc max_def_raw prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_is_Nil_conv upt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjacent_append_atomics_reusables<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> valid <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
    adjacent <span class="free">w</span> <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_atomics_nonempty_reusables<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> reusables_neq_Nil_if_well_shaped_and_overlapping<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    adjacent_atomics<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">w</span>"</span></span><span class="main">]</span> adjacent_reusables<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> adjacent_appendI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def max.absorb1 atomize_not
    <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> adjacent_Cons_r adjacent_Cons_r2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_append_atomics_reusables<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> valid <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> snd <span class="free">w</span> <span class="main">≤</span> length <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> valid <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_append valid_reusables <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> valid_atomics <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_atomics_reusables_neq_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> valid <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span>
  atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reusables_neq_Nil_if_well_shaped_and_overlapping valid_def atomics_def<span class="main">)</span>

<span class="comment1">(* lemma 1 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_slide<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">w</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> l <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> append_atomics_reusables_neq_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacent <span class="free">w</span> <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_append_atomics_reusables <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span><span class="main">.</span> valid <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_append_atomics_reusables <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"slide <span class="free">t</span> <span class="free">w</span> <span class="main">=</span> fold combine <span class="main">(</span>atomics <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">@</span> reusables <span class="free">t</span> <span class="free">w</span><span class="main">)</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slide_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> non_empty adjacent valid <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> l <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>slide <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * neq_Nil_conv <span class="keyword1"><span class="command">using</span></span> valid_fold_combine_Leaf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the Sliding Window Algorithm›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iterate_eq_map_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">t</span><span class="main">;</span> windows <span class="free">as</span> <span class="free">xs</span><span class="main">;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span> <span class="main">⇒</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">∧</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  iterate <span class="free">t</span> <span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> sum <span class="main">(</span>fst <span class="bound">w</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_slide windows_def window_def val_eq_Some_sum_if_valid_neq_Leaf neq_Leaf_if_l_gt0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="comment1">(* theorem 2: functional correctness *)</span>
<span class="keyword1"><span class="command">theorem</span></span> correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"windows <span class="free">as</span> <span class="free">ws</span> <span class="main">⟹</span> sliding_window <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> sum <span class="main">(</span>fst <span class="bound">w</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sliding_window_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iterate_eq_map_sum<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"sliding_window <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Summary of the Correctness Proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We closely follow Basin et al.'s proof outline~\cite{BASIN2015186}.
  \begin{enumerate}
    \item Lemma 1, the correctness result about the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SWA.slide</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is formalized 
      by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.valid_slide<span class="antiquote"><span class="antiquote">}</span></span></span></span>. It follows from the following auxiliary facts:
      \begin{itemize}
        \item Fact (a) is formalized by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.adjacent_reusables<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.valid_reusables<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
        \item Fact (b) is formalized by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.adjacent_atomics<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.valid_atomics<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
        \item Fact (c) is formalized by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.valid_fold_combine_Leaf<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      \end{itemize}
    \item Theorem 2, the correctness result about the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SWA.sliding_window</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is formalized
      by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] SWA.correctness<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \end{enumerate}
›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Alternative Slide Interface and Additional Operations›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Slide Interface›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The slide operation above takes the \emph{entire} input sequence as a parameter. This is often
  impractical. We provide an alternative interface to the slide operation that takes only the
  \emph{new} elements as a parameter.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">atomic'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomic'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">≡</span> Node <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Some <span class="main">(</span>nth <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span><span class="main">)</span> Leaf Leaf"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">atomics'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> tree list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atomics'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">sidx</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> atomic' <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">b</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">sidx</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..&lt;</span> Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">slide'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semigroup_add list <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> window <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">slide'</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">ts</span> <span class="main">=</span> atomics' <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>max <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">ts'</span> <span class="main">=</span> reusables <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>
    <span class="keyword1">in</span> fold combine <span class="main">(</span><span class="bound">ts</span> <span class="main">@</span> <span class="bound">ts'</span><span class="main">)</span> Leaf<span class="main">)</span>"</span></span>

<span class="comment1">(* examples from paper *)</span>
<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> <span class="main">(</span>slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[]</span> <span class="main">(</span>slide' <span class="main">[</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> <span class="main">(</span>slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span><span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"slide' <span class="main">[</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">]</span> <span class="main">(</span>slide' <span class="main">[</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span> <span class="main">::</span> nat<span class="main">]</span> Leaf <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lemma</span></span> slide_eq_slide'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">as</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">=</span> length <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">w</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span> <span class="main">=</span> slide' <span class="free">as'</span> <span class="free">t</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"atomics' <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> True assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atomics' <span class="free">as'</span> <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> slide_def slide'_def atomics_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">&lt;</span> snd <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atomic' <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> atomic' <span class="free">as'</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leD nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">[</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span>snd <span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> atomic' <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> atomic' <span class="free">as'</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> atomic' <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">as</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span>snd <span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> atomic' <span class="free">as'</span> <span class="bound">b</span> <span class="main">(</span><span class="bound">b</span> <span class="main">-</span> Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span>snd <span class="free">w</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atomics' <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> atomics' <span class="free">as'</span> <span class="main">(</span>max <span class="main">(</span>fst <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>r <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> slide_def slide'_def atomics_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_eq_sum_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span> sum <span class="free">as</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">as'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_eq_sum_append
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_append<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">as</span> <span class="free">t</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_valued0_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_slide_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span><span class="main">;</span> fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> valid <span class="free">as</span> <span class="free">t</span><span class="main">;</span> l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span><span class="main">;</span> snd <span class="free">w</span> <span class="main">≤</span> length <span class="free">as</span> <span class="main">+</span> length <span class="free">as'</span><span class="main">⟧</span> <span class="main">⟹</span>
  valid <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> l <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_append valid_slide<span class="main">)</span>

<span class="comment1">(* correctness of alternative slide interface *)</span>
<span class="keyword1"><span class="command">theorem</span></span> valid_slide'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">w</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">as</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> r <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as'</span> <span class="main">≥</span> snd <span class="free">w</span> <span class="main">-</span> r <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"l <span class="free">t</span> <span class="main">≤</span> fst <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> snd <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>slide' <span class="free">as'</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> l <span class="main">(</span>slide' <span class="free">as'</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>slide' <span class="free">as'</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">∧</span> l <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">w</span> <span class="main">∧</span> r <span class="main">(</span>slide <span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">as'</span><span class="main">)</span> <span class="free">t</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_slide_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left le_add_diff_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> slide_eq_slide' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_cancel_left le_add_diff_inverse length_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Updating all Values in the Tree›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  So far, we have assumed that the sequence is fixed. However, under certain conditions,
  SWA can be applied even if the sequence changes. In particular, if a function that distributes
  over the associative operation is mapped onto the sequence, validity of the tree can be preserved
  by mapping the same function onto the tree using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">map_tree</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_tree_eq_Leaf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"map_tree <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> Leaf <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_tree_eq_l<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"l <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> l <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_map_tree_eq_r<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> r <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_map_tree_neq_None<span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">≠</span> None <span class="main">⟹</span> val <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_map_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">⟹</span> well_shaped <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>fold <span class="main">(+)</span> <span class="free">list</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(+)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">list</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">list</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_rev_map_nth_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟹</span> map <span class="free">f</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_nth_eq_map_f_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> length <span class="free">as</span> <span class="main">≥</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">as</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">as</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_map_map_tree<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">y</span><span class="main">;</span> well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">;</span> r <span class="free">t</span> <span class="main">≤</span> length <span class="free">as</span><span class="main">;</span> <span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span>
     well_shaped <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> well_valued0 <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well_shaped_map_tree<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">[</span>l <span class="skolem">t1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>l <span class="skolem">t1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_rev_map_nth_eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="skolem">t1</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node<span class="main">(</span>3-7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_distr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span> val_map_tree_neq_None
      well_shaped_map_tree <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Node<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_map_map_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">as</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="free">t</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>map_tree <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_tree_eq_Leaf_iff val_map_tree_neq_None valid_def well_valued0_map_map_tree<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_zero_eq list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tree.exhaust_sel map_tree_eq_Leaf_iff valid_Leaf valid_def well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_Nil_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">[]</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">∧</span> well_valued <span class="main">[]</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_zero tree.collapse well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Updating the Rightmost Leaf of the Tree›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We provide a function to update the rightmost leaf of the tree. This may be used in an online
  setting where the input sequence is not known in advance to update the latest observed element
  using the same associative operation used in SWA. We show that validity of the tree is preserved
  in this case.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_rightmost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_rightmost</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">update_rightmost</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>map_option <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free">update_rightmost</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> update_rightmost_eq_Leaf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"update_rightmost <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> Leaf <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_update_rightmost_eq_l<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"l <span class="main">(</span>update_rightmost <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> l <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_update_rightmost_eq_r<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>update_rightmost <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> r <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_update_rightmost_neq_None<span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">≠</span> None <span class="main">⟹</span> val <span class="main">(</span>update_rightmost <span class="free">f</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> well_shaped_update_rightmost<span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span> <span class="main">⟹</span> well_shaped <span class="main">(</span>update_rightmost <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> update_rightmost_eq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_eq_sum_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> length <span class="free">xs</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sum <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">xs</span> <span class="main">≤</span> l <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> well_valued0_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">with</span></span> Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred diff_Suc_1 le_Suc_eq le_Suc_ex trans_le_add1 tree.exhaust_sel well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_Suc_1 diff_le_self le_trans tree.exhaust_sel well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Node well_valued0_t1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span>SWA.sum <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> well_valued0 <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t1</span> <span class="main">∧</span> well_valued0 <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t2</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">t2</span> <span class="main">=</span> Leaf <span class="main">∨</span> val <span class="skolem">t2</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹well_valued0 <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>›</span></span> well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="main">(</span>SWA.sum <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Node.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Node.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Node.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> One_nat_def Suc_pred le_imp_less_Suc sum_eq_sum_prepend tree.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="quoted"><span class="quoted">‹well_valued0 <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t2</span>›</span></span> well_valued0.simps<span class="main">(</span>2<span class="main">)</span> well_valued0_t1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">xs</span> <span class="main">≤</span> l <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">;</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">;</span> valid <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_valued0_prepend<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> take_eq_append_take_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">m</span> <span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse take_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_take_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span>take <span class="main">(</span>r <span class="free">t</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> well_valued0_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span>take <span class="skolem">j</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="skolem">t1</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_lchild_le_r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tree.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">j</span> <span class="free">as</span> <span class="main">=</span> take <span class="main">(</span>r <span class="skolem">t1</span><span class="main">)</span> <span class="free">as</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> r <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>r <span class="skolem">t1</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> take_eq_append_take_take_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"r <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> well_valued0_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> well_valued0_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span>take <span class="skolem">j</span> <span class="free">as</span><span class="main">)</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(+)</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="free">as</span><span class="main">)</span> <span class="main">[</span>l <span class="skolem">t1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="main">(</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      fold <span class="main">(+)</span> <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span><span class="main">(!)</span> <span class="main">(</span>take <span class="main">(</span>r <span class="skolem">t2</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>l <span class="skolem">t1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..&lt;</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="main">(</span>r <span class="skolem">t2</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> fold <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Node well_valued0_t1 well_valued0_t2 sum_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_take_r<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">as</span> <span class="free">t</span> <span class="main">⟹</span> valid <span class="main">(</span>take <span class="main">(</span>r <span class="free">t</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_valued0_take_r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_butlast<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">;</span> r <span class="free">t</span> <span class="main">&lt;</span> length <span class="free">as</span><span class="main">⟧</span> <span class="main">⟹</span> well_valued0 <span class="main">(</span>butlast <span class="free">as</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> r_le_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> length <span class="main">(</span>butlast <span class="free">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r_le_length Node <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">as</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> sum <span class="main">(</span>butlast <span class="free">as</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id le_zero_eq less_imp_le_nat list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neq_iff
      sum_eq_sum_append well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="skolem">t1</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans2 r_lchild_le_r tree.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Node r_le_length <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dual_order.strict_iff_order sum_eq tree.sel<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> tree.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
      well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_shaped_rchild well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_append_butlast_lchild<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
  well_valued0 <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>lchild <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"well_shaped <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"well_valued0 <span class="free">as</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="skolem">t1</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> well_shaped_lr<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Node assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> well_valued0_butlast well_valued0_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_update_rightmost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> length <span class="free">as</span> <span class="main">=</span> <span class="free">j</span><span class="main">⟧</span> <span class="main">⟹</span>
  sum <span class="free">as</span> <span class="free">i</span> <span class="free">j</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> sum <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> fold_add_add last_conv_nth nth_Cons' nth_butlast
     <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> fold <span class="main">_</span> <span class="bound">xs</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> well_valued0_update_rightmost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>well_shaped <span class="free">t</span><span class="main">;</span> well_valued0 <span class="free">as</span> <span class="free">t</span><span class="main">;</span> length <span class="free">as</span> <span class="main">=</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
  well_valued0 <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>update_rightmost <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_Leaf<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span> <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> well_valued0_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> well_valued0_append_butlast_lchild <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword1"><span class="command">have</span></span> well_valued0_t2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"well_valued0 <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>update_rightmost <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹well_valued0 <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">t1</span>›</span></span> dual_order.strict_iff_order
      tree.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> update_rightmost.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> well_shaped.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> well_valued0.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_update_rightmost
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_update_rightmost_neq_None<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* correctness of update_rightmost *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_update_rightmost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid <span class="free">as</span> <span class="free">t</span><span class="main">;</span> length <span class="free">as</span> <span class="main">=</span> r <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
  valid <span class="main">(</span>butlast <span class="free">as</span> <span class="main">@</span> <span class="main">[</span>last <span class="free">as</span> <span class="main">+</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>update_rightmost <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valid_def
  <span class="keyword1"><span class="command">using</span></span> well_valued0_update_rightmost
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> update_rightmost.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> val_update_rightmost_neq_None well_shaped_update_rightmost<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>