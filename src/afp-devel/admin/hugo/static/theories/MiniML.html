<div id="Maybe">
<div class="head">
<h1>Theory Maybe</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/Maybe.thy

   Author:    Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Universal error monad"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Maybe
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">option_bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> option<span class="main">,</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'b</span> option<span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> None <span class="main">=&gt;</span> None <span class="main">|</span> Some <span class="bound">r</span> <span class="main">=&gt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_option_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span><span class="tfree">'a</span> option<span class="main">,</span><span class="tfree">'b</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">:=</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">:=</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> option_bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>


<span class="comment1">― ‹constructor laws for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">option_bind</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> option_bind_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"option_bind <span class="main">(</span>Some <span class="free">s</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> option_bind_None<span class="main">:</span> <span class="quoted"><span class="quoted">"option_bind None <span class="free">f</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> option_bind_Some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> option_bind_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">― ‹expansion of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">option_bind</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> split_option_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">(</span>option_bind <span class="free">res</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span>  
          <span class="main">(</span><span class="main">(</span><span class="free">res</span> <span class="main">=</span> None <span class="main">⟶</span> <span class="free">P</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> Some <span class="bound">s</span> <span class="main">⟶</span> <span class="free">P</span><span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> option_bind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> option_bind_eq_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>option_bind <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">=</span>None<span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Some <span class="bound">p</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rotate_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">=</span> Some <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Type">
<div class="head">
<h1>Theory Type</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/Type.thy

   Author:    Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"MiniML-types and type substitutions"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Type
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Maybe.html">Maybe</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹type expressions›</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"typ"</span> <span class="main">=</span> TVar <span class="quoted">nat</span> <span class="main">|</span> Fun <span class="quoted"><span class="quoted">"typ"</span></span> <span class="quoted"><span class="quoted">"typ"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">-&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="comment1">― ‹type schemata›</span>
<span class="keyword1"><span class="command">datatype</span></span> type_scheme <span class="main">=</span> FVar <span class="quoted">nat</span> <span class="main">|</span> BVar <span class="quoted">nat</span> <span class="main">|</span> SFun <span class="quoted">type_scheme</span> <span class="quoted">type_scheme</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">=-&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="comment1">― ‹embedding types into type schemata›</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mk_scheme</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_scheme</span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mk_scheme</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">mk_scheme</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="free">mk_scheme</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹type variable substitution›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> subst <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> typ"</span></span>

<span class="keyword1"><span class="command">class</span></span> type_struct <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">free_tv</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> nat set"</span></span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"free_tv s"</span><span class="antiquote">}</span></span>: the type variables occurring freely in the type structure s›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">free_tv_ML</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> nat list"</span></span>
    <span class="comment1">― ‹executable version of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">free_tv</span><span class="antiquote">}</span></span>: Implementation with lists›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">bound_tv</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> nat set"</span></span>
    <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"bound_tv s"</span><span class="antiquote">}</span></span>: the type variables occurring bound in the type structure s›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">min_new_bound_tv</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> nat"</span></span>
    <span class="comment1">― ‹minimal new free / bound variable›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">app_subst</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span>"</span><span class="main">)</span>
    <span class="comment1">― ‹extension of substitution to type structures›</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"typ"</span> <span class="main">::</span> <span class="quoted">type_struct</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_tv_typ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  free_tv_TVar<span class="main">:</span>    <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> free_tv_Fun<span class="main">:</span>     <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">app_subst_typ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  app_subst_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> 
<span class="main">|</span> app_subst_Fun<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> type_scheme <span class="main">::</span> <span class="quoted">type_struct</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_tv_type_scheme</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">S1</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_tv_ML_type_scheme</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"free_tv_ML <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv_ML <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv_ML <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv_ML <span class="free"><span class="bound"><span class="entity">S1</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>free_tv_ML <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">bound_tv_type_scheme</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bound_tv <span class="free"><span class="bound"><span class="entity">S1</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>bound_tv <span class="free"><span class="bound"><span class="entity">S2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">min_new_bound_tv_type_scheme</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"min_new_bound_tv <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"min_new_bound_tv <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"min_new_bound_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>min_new_bound_tv <span class="free"><span class="bound"><span class="entity">sch1</span></span></span><span class="main">)</span> <span class="main">(</span>min_new_bound_tv <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">app_subst_type_scheme</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> mk_scheme <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">type_struct</span><span class="main">)</span> <span class="quoted">type_struct</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_tv_list</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"free_tv <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">free_tv_ML_list</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"free_tv_ML <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"free_tv_ML <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv_ML <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>free_tv_ML <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">bound_tv_list</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"bound_tv <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bound_tv <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>bound_tv <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_subst_list</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  app_subst_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">$</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span>  
<span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>new_tv s n›</span></span></span></span> computes whether n is a new type variable w.r.t. a type 
   structure s, i.e. whether n is greater than any type variable 
   occurring in the type structure›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">new_tv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat<span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>type_struct<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new_tv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">:</span><span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">m</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹identity›</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">id_subst</span> <span class="main">::</span> <span class="quoted">subst</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">id_subst</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> TVar <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹domain of a substitution›</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">=&gt;</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dom</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">n</span> <span class="main">≠</span> TVar <span class="bound">n</span><span class="main">}</span>"</span></span> 

<span class="comment1">― ‹codomain of a substitution: the introduced variables›</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">cod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"subst <span class="main">=&gt;</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cod</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">m</span><span class="main">:</span>dom <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">(</span>free_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">class</span></span> of_nat <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">of_nat</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">of_nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"of_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> typ_of <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">typ_of</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> typ"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"typ"</span> <span class="main">::</span> <span class="quoted">typ_of</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"typ_of <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">of_nat</span><span class="main">,</span> <span class="quoted">typ_of</span><span class="main">)</span> <span class="quoted">type_struct</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_tv_fun</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"free_tv <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> typ_of <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>dom <span class="bound">S</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>cod <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_tv <span class="free">S</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">S</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>cod <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_fun_def of_nat_nat_def typ_of_typ_def <span class="main">)</span>

<span class="comment1">― ‹unification algorithm mgu›</span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">mgu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> typ <span class="main">⇒</span> subst option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  mgu_eq<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">mgu</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Some <span class="free">U</span> <span class="main">⟹</span> <span class="main">$</span><span class="free">U</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">$</span><span class="free">U</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mgu_mg<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">(</span><span class="free">mgu</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">U</span><span class="main">;</span> <span class="main">$</span><span class="free">S</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">t2</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="free">S</span> <span class="main">=</span> <span class="main">$</span><span class="bound">R</span> <span class="main">∘</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mgu_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="free">S</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">U</span><span class="main">.</span> <span class="free">mgu</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Some <span class="bound">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mgu_free<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mgu</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Some <span class="free">U</span> <span class="main">⟹</span> <span class="main">(</span>free_tv <span class="free">U</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>free_tv <span class="free">t1</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free">t2</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">declare</span></span> mgu_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> mgu_mg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> mgu_free <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> mk_scheme_Fun <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mk_scheme <span class="free">t</span> <span class="main">=</span> <span class="free">sch1</span> <span class="main">=-&gt;</span> <span class="free">sch2</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> <span class="free">sch1</span> <span class="main">=</span> mk_scheme <span class="bound">t1</span> <span class="main">∧</span> <span class="free">sch2</span> <span class="main">=</span> mk_scheme <span class="bound">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_scheme_injective <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> mk_scheme <span class="free">t</span> <span class="main">=</span> mk_scheme <span class="bound">t'</span> <span class="main">⟶</span> <span class="free">t</span><span class="main">=</span><span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">t'</span></span>"</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">t'</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_mk_scheme<span class="main">:</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">=</span> free_tv <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> free_tv_mk_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_mk_scheme<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">S</span> <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">=</span> mk_scheme <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> subst_mk_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="comment1">― ‹constructor laws for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">app_subst</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> app_subst_Nil<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">S</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> app_subst_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> app_subst_Cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> app_subst_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> app_subst_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> app_subst_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>


<span class="comment1">― ‹constructor laws for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">new_tv</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_TVar<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span>TVar <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_FVar<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span>FVar <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_BVar<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span>BVar <span class="free">m</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Fun<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">t1</span> <span class="main">-&gt;</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>new_tv <span class="free">n</span> <span class="free">t1</span> <span class="main">∧</span> new_tv <span class="free">n</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Fun2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">t1</span> <span class="main">=-&gt;</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>new_tv <span class="free">n</span> <span class="free">t1</span> <span class="main">∧</span> new_tv <span class="free">n</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Nil<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Cons<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>new_tv <span class="free">n</span> <span class="free">x</span> <span class="main">∧</span> new_tv <span class="free">n</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_TVar_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> TVar"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def cod_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> 
  new_tv_TVar <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> new_tv_FVar <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> new_tv_BVar <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> 
  new_tv_Fun <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> new_tv_Fun2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> new_tv_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> 
  new_tv_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> new_tv_TVar_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_id_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> id_subst"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_subst_def new_tv_def free_tv_subst dom_def cod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_if_subst_type_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">⟹</span>
    <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="free">S'</span> <span class="bound">k</span><span class="main">)</span> <span class="free">sch</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> new_if_subst_type_scheme_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">⟹</span>
    <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="free">S'</span> <span class="bound">k</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="comment1">― ‹constructor laws for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">dom</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">cod</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_id_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom id_subst <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_def id_subst_def empty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cod_id_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cod id_subst <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> free_tv_id_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"free_tv id_subst <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_tv_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_nth_A_impl_free_tv_A <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">A</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">:</span> free_tv <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">:</span> free_tv <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_nth_nat_A <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nat</span><span class="main">.</span> <span class="bound">nat</span> <span class="main">&lt;</span> length <span class="free">A</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">:</span> free_tv <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">nat</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">:</span> free_tv <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">nat</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹if two substitutions yield the same result if applied to a type
   structure the substitutions coincide on the free type variables
   occurring in the type structure›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> typ_substitutions_only_on_free_variables<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>free_tv <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_free_eq_subst_te<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">S1</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S1</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S2</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> typ_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> scheme_substitutions_only_on_free_variables<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>free_tv <span class="free">sch</span><span class="main">.</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S'</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_free_eq_subst_type_scheme<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="main">(</span>free_tv <span class="free">sch</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">S1</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S1</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S2</span> <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> scheme_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_free_eq_subst_scheme_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">∈</span><span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">S1</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span><span class="free">S1</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">=</span> <span class="main">$</span><span class="free">S2</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_free_eq_subst_type_scheme<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weaken_asm_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> scheme_list_substitutions_only_on_free_variables <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>free_tv <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S'</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> weaken_asm_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> scheme_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_subst_te_eq_free<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">S1</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S2</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">:</span><span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="free">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_subst_type_scheme_eq_free <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">S1</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S2</span> <span class="free">sch</span> <span class="main">⟶</span> <span class="free">n</span><span class="main">:</span><span class="main">(</span>free_tv <span class="free">sch</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">S1</span> <span class="free">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="comment1">(* case TVar n *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="comment1">(* case BVar n *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> mk_scheme_injective<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="comment1">(* case Fun t1 t2 *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_subst_scheme_list_eq_free<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="free">S1</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">=</span> <span class="main">$</span><span class="free">S2</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">:</span><span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="free">n</span> <span class="main">=</span> <span class="free">S2</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_subst_type_scheme_eq_free<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> codD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">:</span> cod <span class="free">S</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">:</span> free_tv <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_tv_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> not_free_impl_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> free_tv <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> TVar <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_tv_subst dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_le_new_tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> new_tv <span class="free">n</span> <span class="free">t</span><span class="main">;</span> <span class="free">m</span><span class="main">:</span>free_tv <span class="free">t</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">m</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> new_tv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> cod_app_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">v</span> <span class="main">:</span> free_tv<span class="main">(</span><span class="free">S</span> <span class="free">n</span><span class="main">)</span><span class="main">;</span> <span class="free">v</span><span class="main">≠</span><span class="free">n</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">v</span> <span class="main">:</span> cod <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dom_def cod_def UNION_eq Bex_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_subst_var<span class="main">:</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="free">S</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="free">v</span> <span class="main">(</span>cod <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">:</span>dom <span class="free">S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cod_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_app_subst_te<span class="main">:</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> cod <span class="free">S</span> <span class="keyword1">Un</span> free_tv <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TVar <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst_var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_app_subst_type_scheme<span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> cod <span class="free">S</span> <span class="keyword1">Un</span> free_tv <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FVar <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst_var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>BVar <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SFun <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_app_subst_scheme_list<span class="main">:</span> <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> cod <span class="free">S</span> <span class="keyword1">Un</span> free_tv <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">al</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> free_tv_app_subst_type_scheme
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_comp_subst<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">$</span> <span class="free">s1</span> <span class="main">(</span><span class="free">s2</span> <span class="bound">u</span><span class="main">)</span> <span class="main">::</span> typ<span class="main">)</span> <span class="main">⊆</span>    
    free_tv <span class="free">s1</span> <span class="keyword1">Un</span> free_tv <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> free_tv_subst dom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cod_def dom_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>free_tv_app_subst_te <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_o_subst<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S1</span> <span class="main">∘</span> <span class="free">S2</span><span class="main">)</span> <span class="main">⊆</span> free_tv <span class="free">S1</span> <span class="keyword1">Un</span> free_tv <span class="main">(</span><span class="free">S2</span> <span class="main">::</span> nat <span class="main">=&gt;</span> typ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> free_tv_comp_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_of_substitutions_extend_to_types<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">:</span> free_tv <span class="free">t</span> <span class="main">⟹</span> free_tv <span class="main">(</span><span class="free">S</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">::</span>typ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_of_substitutions_extend_to_schemes<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">:</span> free_tv <span class="free">sch</span> <span class="main">⟹</span> free_tv <span class="main">(</span><span class="free">S</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_of_substitutions_extend_to_scheme_lists <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">:</span> free_tv <span class="free">A</span> <span class="main">⟹</span> free_tv <span class="main">(</span><span class="free">S</span> <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> free_tv_of_substitutions_extend_to_schemes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_ML_scheme<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">:</span> free_tv <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">:</span> set <span class="main">(</span>free_tv_ML <span class="free">sch</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_ML_scheme_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">:</span> free_tv <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">:</span> set <span class="main">(</span>free_tv_ML <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_ML_scheme<span class="main">)</span>


<span class="comment1">― ‹lemmata for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">bound_tv</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_tv_mk_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_tv_subst_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> bound_tv <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_tv_subst_scheme_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> bound_tv <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="comment1">― ‹lemmata for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">new_tv</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">S</span> <span class="bound">m</span> <span class="main">=</span> TVar <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>  
                 <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">S</span> <span class="bound">l</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="comment1">(* ==&gt; *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> leD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">m</span><span class="main">:</span>cod <span class="free">S</span> <span class="main">|</span> <span class="free">S</span> <span class="improper">l</span> <span class="main">=</span> TVar <span class="improper">l</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> UnI2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="improper">m</span><span class="main">:</span>free_tv <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subst <span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst cod_def dom_def<span class="main">)</span>
<span class="comment1">(* &lt;== *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> free_tv_subst cod_def dom_def<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> not_le_imp_less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_list<span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">x</span><span class="main">.</span> new_tv <span class="free">n</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">― ‹substitution affects only variables occurring freely›</span>
<span class="keyword1"><span class="command">lemma</span></span> subst_te_new_tv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">⟶</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="free">n</span> <span class="keyword1">then</span> <span class="free">t'</span> <span class="keyword1">else</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_te_new_type_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="free">n</span> <span class="keyword1">then</span> <span class="free">sch'</span> <span class="keyword1">else</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="free">sch</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_tel_new_scheme_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="free">n</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="keyword1">else</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="comment1">― ‹all greater variables are also new›</span>
<span class="keyword1"><span class="command">lemma</span></span> new_tv_le<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="free">m</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="free">t</span> <span class="main">⟹</span> new_tv <span class="free">m</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">t</span> <span class="main">⟹</span> new_tv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> new_tv_le<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_typ_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="free">m</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">⟹</span> new_tv <span class="free">m</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_scheme_list_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="free">m</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">⟹</span> new_tv <span class="free">m</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≤</span><span class="free">m</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">S</span><span class="main">::</span>subst<span class="main">)</span> <span class="main">⟹</span> new_tv <span class="free">m</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_le<span class="main">)</span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">new_tv</span><span class="antiquote">}</span></span> property remains if a substitution is applied›</span>
<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_var<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">n</span><span class="main">&lt;</span><span class="free">m</span><span class="main">;</span> new_tv <span class="free">m</span> <span class="main">(</span><span class="free">S</span><span class="main">::</span>subst<span class="main">)</span> <span class="main">|]</span> <span class="main">==&gt;</span> new_tv <span class="free">m</span> <span class="main">(</span><span class="free">S</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_te <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_type_scheme <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">S</span> <span class="main">⟶</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">⟶</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def cod_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat m<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="improper">nat</span> <span class="main">=</span> TVar <span class="improper">nat</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_scheme_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Suc_list<span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟶</span> new_tv <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>TVar <span class="free">n</span><span class="main">)</span><span class="main">#</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_only_depends_on_free_tv_type_scheme<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"free_tv <span class="free">sch</span> <span class="main">=</span> free_tv <span class="free">sch'</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="free">sch</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="free">sch'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> new_tv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_only_depends_on_free_tv_scheme_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"free_tv <span class="free">A</span> <span class="main">=</span> free_tv <span class="free">A'</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="free">A'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> new_tv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_nth_nat_A <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">nat</span><span class="main">.</span> <span class="bound">nat</span> <span class="main">&lt;</span> length <span class="free">A</span> <span class="main">⟶</span> new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟶</span> <span class="main">(</span>new_tv <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">nat</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">nat</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">― ‹composition of substitutions preserves <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">new_tv</span><span class="antiquote">}</span></span> proposition›</span>
<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_comp_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">S</span><span class="main">::</span>subst<span class="main">)</span><span class="main">;</span> new_tv <span class="free">n</span> <span class="free">R</span> <span class="main">|]</span> <span class="main">==&gt;</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">$</span> <span class="free">R</span><span class="main">)</span> <span class="main">∘</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_subst_comp_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="free">S</span><span class="main">::</span>subst<span class="main">)</span><span class="main">;</span> new_tv <span class="free">n</span> <span class="free">R</span> <span class="main">|]</span> <span class="main">==&gt;</span> new_tv <span class="free">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span><span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="free">S</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst<span class="main">)</span>

<span class="comment1">― ‹new type variables do not occur freely in a type structure›</span>
<span class="keyword1"><span class="command">lemma</span></span> new_tv_not_free_tv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">∉</span><span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_variable_types <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">t</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">nat</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"n'"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"max <span class="improper">n</span> <span class="improper">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_max_iff_disj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_variable_type_schemes <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sch</span><span class="main">::</span>type_scheme<span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">sch</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">nat</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">nat</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"n'"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"max <span class="improper">n</span> <span class="improper">n'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_max_iff_disj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_variable_type_scheme_lists <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">A</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> sch <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_type_schemes<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"n'"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>max <span class="improper">n</span> <span class="improper">n'</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">≤</span> <span class="main">(</span>max <span class="improper">n</span> <span class="improper">n'</span><span class="main">)</span> "</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n'</span> <span class="main">≤</span> <span class="main">(</span>max <span class="improper">n</span> <span class="improper">n'</span><span class="main">)</span> "</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_max_iff_disj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> make_one_new_out_of_two<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">∃</span><span class="bound">n1</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n1</span> <span class="free">x</span><span class="main">)</span><span class="main">;</span> <span class="main">∃</span><span class="bound">n2</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n2</span> <span class="free">y</span><span class="main">)</span><span class="main">|]</span> <span class="main">==&gt;</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"n1"</span> <span class="quoted">"n2"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>max <span class="improper">n1</span> <span class="improper">n2</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span> <span class="main">≤</span> max <span class="improper">n1</span> <span class="improper">n2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n2</span> <span class="main">≤</span> max <span class="improper">n1</span> <span class="improper">n2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_max_iff_disj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_fresh_variable<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">(</span><span class="bound">A'</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">(</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">(</span><span class="bound">t'</span><span class="main">::</span>typ<span class="main">)</span><span class="main">.</span>  
          <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>new_tv <span class="bound">n</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_types<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_types<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> make_one_new_out_of_two<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> V <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> new_tv <span class="bound">n</span> <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_type_scheme_lists<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_type_scheme_lists<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> make_one_new_out_of_two<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> V <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> new_tv <span class="bound">n</span> <span class="improper">A'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n2 n1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>max <span class="improper">n1</span> <span class="improper">n2</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_max_iff_disj<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹mgu does not introduce new type variables›</span>
<span class="keyword1"><span class="command">lemma</span></span> mgu_new<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">[|</span>mgu <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> Some <span class="free">u</span><span class="main">;</span> new_tv <span class="free">n</span> <span class="free">t1</span><span class="main">;</span> new_tv <span class="free">n</span> <span class="free">t2</span><span class="main">|]</span> <span class="main">==&gt;</span> new_tv <span class="free">n</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> new_tv_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mgu_free<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* lemmata for substitutions *)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_app_subst_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type_struct<span class="main">)</span> list<span class="main">.</span> length <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> length <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> app_subst_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_TVar_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> TVar <span class="free">sch</span> <span class="main">=</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_TVar_scheme_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> TVar <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_subst_list<span class="main">)</span>

<span class="comment1">― ‹application of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">id_subst</span><span class="antiquote">}</span></span> does not change type expression›</span>
<span class="keyword1"><span class="command">lemma</span></span> app_subst_id_te <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> id_subst <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> id_subst_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> app_subst_id_type_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">$</span> id_subst <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">sch</span><span class="main">::</span>type_scheme<span class="main">.</span> <span class="bound">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> id_subst_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹application of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">id_subst</span><span class="antiquote">}</span></span> does not change list of type expressions›</span>
<span class="keyword1"><span class="command">lemma</span></span> app_subst_id_tel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> id_subst <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> app_subst_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">A</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> id_subst_sch <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> id_subst <span class="free">sch</span> <span class="main">=</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_subst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_subst_A <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> id_subst <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">― ‹composition of substitutions›</span>
<span class="keyword1"><span class="command">lemma</span></span> o_id_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="free">S</span> <span class="main">∘</span> id_subst <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> id_subst_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_comp_te<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_comp_type_scheme<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span> <span class="main">)</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_comp_scheme_list<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">$</span> <span class="free">R</span> <span class="main">(</span><span class="free">S</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> app_subst_list
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xl</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_comp_type_scheme<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_id_on_type_scheme_list'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> free_tv <span class="free">A</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>TVar <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S</span> <span class="free">A</span> <span class="main">=</span> <span class="main">$</span> id_subst <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> scheme_list_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_subst_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_id_on_type_scheme_list<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> free_tv <span class="free">A</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>TVar <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">$</span> <span class="free">S</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_id_on_type_scheme_list'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_subst <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">A</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span><span class="main">!</span><span class="bound">n</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="main">(</span><span class="free">A</span><span class="main">!</span><span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"n1"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">n1</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Instance">
<div class="head">
<h1>Theory Instance</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/Instance.thy
   Author:    Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Instances of type schemes"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Instance
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Type.html">Type</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bound_typ_inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>subst<span class="main">,</span> type_scheme<span class="main">]</span> <span class="main">=&gt;</span> typ"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bound_typ_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bound_typ_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bound_typ_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">bound_typ_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch1</span></span></span><span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="free">bound_typ_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bound_scheme_inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat <span class="main">=&gt;</span> type_scheme<span class="main">,</span> type_scheme<span class="main">]</span> <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bound_scheme_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bound_scheme_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bound_scheme_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch1</span></span></span> <span class="main">=-&gt;</span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">bound_scheme_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="free">bound_scheme_inst</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">sch2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_bound_typ_instance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>typ<span class="main">,</span> type_scheme<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">&lt;|</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  is_bound_typ_instance<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">&lt;|</span></span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>bound_typ_inst <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> type_scheme <span class="main">::</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  le_type_scheme_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">sch'</span></span></span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch</span></span></span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;|</span> <span class="free"><span class="bound"><span class="entity">sch'</span></span></span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">&lt;|</span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch'</span></span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sch</span></span></span> <span class="main">::</span> type_scheme<span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">sch'</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sch'</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">sch</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst_to_scheme</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat <span class="main">=&gt;</span> type_scheme<span class="main">,</span> typ<span class="main">]</span> <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_to_scheme</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_to_scheme</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">subst_to_scheme</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="free">subst_to_scheme</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">instantiation</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">ord</span><span class="main">)</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  le_env_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"lemmas for instatiation"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_inst_mk_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bound_typ_inst <span class="free">S</span> <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_inst_composed_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"bound_typ_inst <span class="main">(</span><span class="main">$</span><span class="free">S</span> <span class="main">∘</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span><span class="free">S</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="main">(</span>bound_typ_inst <span class="free">R</span> <span class="free">sch</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_inst_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">sch</span> <span class="main">=</span> <span class="free">sch'</span> <span class="main">⟹</span> bound_typ_inst <span class="free">S</span> <span class="free">sch</span> <span class="main">=</span> bound_typ_inst <span class="free">S'</span> <span class="free">sch'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_scheme_inst_mk_scheme <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"bound_scheme_inst <span class="free">B</span> <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">=</span> mk_scheme <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> substitution_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="free">S</span> <span class="main">(</span>bound_scheme_inst <span class="free">B</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bound_scheme_inst <span class="main">(</span><span class="main">$</span><span class="free">S</span> <span class="main">∘</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">sch</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_scheme_inst_type <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> mk_scheme <span class="bound">t</span> <span class="main">=</span> bound_scheme_inst <span class="free">B</span> <span class="free">sch</span> <span class="main">⟶</span>  
          <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>bound_tv <span class="free">sch</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">=</span> mk_scheme <span class="main">(</span><span class="bound">S</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> type_scheme1 type_scheme2 t<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mk_scheme_Fun<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S1 S2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">:</span>bound_tv <span class="improper">type_scheme1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="improper">S1</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="improper">S2</span> <span class="bound">x</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_to_scheme_inverse<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">sch</span> <span class="main">⟹</span>
    subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span>  
      <span class="main">(</span>bound_typ_inst <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> TVar <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> <span class="free">sch</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_add2 diff_add_inverse2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">⟹</span>  
      subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span>  
      subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">sch</span> <span class="main">⟹</span>
  subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>bound_typ_inst <span class="free">S</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span>  
    bound_scheme_inst <span class="main">(</span><span class="main">(</span>subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="free">S</span><span class="main">)</span> <span class="free">sch</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> le_type_scheme_def2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="free">sch'</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sch'</span> <span class="main">≤</span> <span class="free">sch</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">B</span><span class="main">.</span> <span class="free">sch'</span> <span class="main">=</span> bound_scheme_inst <span class="bound">B</span> <span class="free">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> sch <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sch</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_type_schemes<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> sch <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">sch'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fresh_variable_type_schemes<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> make_one_new_out_of_two<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> V <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> new_tv <span class="bound">n</span> <span class="free">sch'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> TVar <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="improper">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> aux<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_to_scheme_inverse<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>subst_to_scheme <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="improper">n</span> <span class="main">≤</span> <span class="bound">k</span> <span class="keyword1">then</span> BVar <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> <span class="improper">n</span><span class="main">)</span> <span class="keyword1">else</span> FVar <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="improper">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aux2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> bound_typ_inst <span class="improper">S</span> <span class="main">(</span><span class="improper">B</span> <span class="bound">n</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_type_eq_is_bound_typ_instance <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="free">sch</span> <span class="main">=</span> <span class="free">t</span> <span class="main">&lt;|</span> <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_type_scheme_def2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> bound_scheme_inst_type<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mk_scheme_injective<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_env_Cons <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sch</span> <span class="main">#</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">sch'</span> <span class="main">#</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sch</span> <span class="main">≤</span> <span class="main">(</span><span class="free">sch'</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_env_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">i</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_bound_typ_instance_closed_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&lt;|</span> <span class="free">sch</span> <span class="main">⟹</span> <span class="main">$</span><span class="free">S</span> <span class="free">t</span> <span class="main">&lt;|</span> <span class="main">$</span><span class="free">S</span> <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"SA"</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="free">S</span> <span class="main">∘</span> <span class="improper">SA</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_compatible_le_scheme<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sch</span> <span class="free">sch'</span> <span class="main">::</span> <span class="quoted">type_scheme</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">sch'</span> <span class="main">≤</span> <span class="free">sch</span> <span class="main">⟹</span> <span class="main">$</span><span class="free">S</span> <span class="free">sch'</span> <span class="main">≤</span> <span class="main">$</span> <span class="free">S</span> <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_type_scheme_def2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substitution_lemma<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_compatible_le_scheme_lists<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">≤</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">$</span><span class="free">S</span> <span class="free">A'</span> <span class="main">≤</span> <span class="main">$</span> <span class="free">S</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_env_def app_subst_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S_compatible_le_scheme<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_instance_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">t</span> <span class="main">&lt;|</span> <span class="free">sch</span><span class="main">;</span> <span class="free">sch</span> <span class="main">≤</span> <span class="free">sch'</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">t</span> <span class="main">&lt;|</span> <span class="free">sch'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_type_scheme_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> le_type_scheme_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sch</span> <span class="main">≤</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_type_scheme_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> le_env_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_instance_BVar <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sch</span> <span class="main">≤</span> BVar <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_FVar <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sch</span> <span class="main">≤</span> FVar <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sch</span> <span class="main">=</span> FVar <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_FVar_le_Fun <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span>FVar <span class="free">n</span> <span class="main">≤</span> <span class="free">sch1</span> <span class="main">=-&gt;</span> <span class="free">sch2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_type_scheme_def is_bound_typ_instance <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_BVar_le_Fun <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span><span class="main">(</span>BVar <span class="free">n</span> <span class="main">≤</span> <span class="free">sch1</span> <span class="main">=-&gt;</span> <span class="free">sch2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"TVar <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Fun_le_FunD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sch1</span> <span class="main">=-&gt;</span> <span class="free">sch2</span> <span class="main">≤</span> <span class="free">sch1'</span> <span class="main">=-&gt;</span> <span class="free">sch2'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sch1</span> <span class="main">≤</span> <span class="free">sch1'</span> <span class="main">∧</span> <span class="free">sch2</span> <span class="main">≤</span> <span class="free">sch2'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_type_scheme_def is_bound_typ_instance <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> scheme_le_Fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sch'</span> <span class="main">≤</span> <span class="free">sch1</span> <span class="main">=-&gt;</span> <span class="free">sch2</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">sch'1</span> <span class="bound">sch'2</span><span class="main">.</span> <span class="free">sch'</span> <span class="main">=</span> <span class="bound">sch'1</span> <span class="main">=-&gt;</span> <span class="bound">sch'2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">sch'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> le_type_scheme_free_tv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sch'</span><span class="main">::</span>type_scheme<span class="main">.</span> <span class="free">sch</span> <span class="main">≤</span> <span class="bound">sch'</span> <span class="main">⟶</span> free_tv <span class="bound">sch'</span> <span class="main">≤</span> free_tv <span class="free">sch</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">sch'</span></span>"</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">sch'</span></span>"</span></span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">sch'</span></span>"</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Fun_le_FunD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_env_free_tv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="bound">A</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">⟶</span> free_tv <span class="free">B</span> <span class="main">≤</span> free_tv <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">A</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_env_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_type_scheme_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generalize">
<div class="head">
<h1>Theory Generalize</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/Generalize.thy
   Author:    Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Generalizing type schemes with respect to a context"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generalize
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Instance.html">Instance</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">gen</span><span class="antiquote">}</span></span>: binding (generalising) the variables which are not free in the context›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> ctxt <span class="main">=</span> <span class="quoted"><span class="quoted">"type_scheme list"</span></span>
    
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ctxt<span class="main">,</span> typ<span class="main">]</span> <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">:</span><span class="main">(</span>free_tv <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹executable version of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">gen</span><span class="antiquote">}</span></span>: implementation with <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">free_tv_ML</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gen_ML_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>nat list<span class="main">,</span> typ<span class="main">]</span> <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_ML_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">:</span> set <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>BVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_ML_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gen_ML_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">=-&gt;</span> <span class="main">(</span><span class="free">gen_ML_aux</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_ML</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ctxt<span class="main">,</span> typ<span class="main">]</span> <span class="main">=&gt;</span> type_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gen_ML_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gen_ML</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> gen_ML_aux <span class="main">(</span>free_tv_ML <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> equalityE <span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_eq_on_free_tv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"free_tv <span class="free">A</span> <span class="main">=</span> free_tv <span class="free">B</span> <span class="main">⟹</span> gen <span class="free">A</span> <span class="free">t</span> <span class="main">=</span> gen <span class="free">B</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_without_effect <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>free_tv <span class="free">sch</span><span class="main">)</span> <span class="main">⟹</span> gen <span class="free">sch</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>mk_scheme <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_gen <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>gen <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> free_tv <span class="free">t</span> <span class="keyword1">Int</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_gen_cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"free_tv <span class="main">(</span>gen <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="free">t</span> <span class="main">#</span> <span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_tv_gen <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bound_tv <span class="main">(</span>gen <span class="free">A</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>free_tv <span class="free">t1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_compatible_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">t</span> <span class="main">⟹</span> new_tv <span class="free">n</span> <span class="main">(</span>gen <span class="free">A</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_eq_gen_ML<span class="main">:</span> <span class="quoted"><span class="quoted">"gen <span class="free">A</span> <span class="free">t</span> <span class="main">=</span> gen_ML <span class="free">A</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> gen_ML_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_ML_scheme_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_ML_scheme_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_subst_commutes <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>free_tv <span class="free">S</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span><span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>  
      <span class="main">⟶</span> gen <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span>gen <span class="free">A</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">:</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> "</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">∉</span> free_tv <span class="free">S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> free_tv_app_subst_scheme_list<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_typ_inst_gen <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"free_tv<span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">⊆</span> free_tv<span class="main">(</span><span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> bound_typ_inst <span class="free">S</span> <span class="main">(</span>gen <span class="free">A</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_bound_typ_instance<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"gen <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span>gen <span class="free">A</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"R"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> bound_typ_inst <span class="improper">R</span> <span class="main">(</span>gen <span class="main">(</span><span class="main">$</span><span class="free">S</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_subset_gen_le<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"free_tv <span class="free">B</span> <span class="main">⊆</span> free_tv <span class="free">A</span> <span class="main">⟹</span> gen <span class="free">A</span> <span class="free">t</span> <span class="main">≤</span> gen <span class="free">B</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"S"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span><span class="main">:</span>free_tv <span class="free">A</span> <span class="keyword1">then</span> TVar <span class="bound">b</span> <span class="keyword1">else</span> <span class="improper">S</span> <span class="bound">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_t_le_gen_alpha_t <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟶</span>  
   gen <span class="free">A</span> <span class="free">t</span> <span class="main">≤</span> gen <span class="free">A</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> free_tv <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="improper">S</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat S<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">∈</span> free_tv <span class="free">A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_inverse<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_add1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="MiniML">
<div class="head">
<h1>Theory MiniML</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/MiniML.thy
   Author:    Dieter Nazareth, Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"MiniML with type inference rules"</span></span>

<span class="keyword1"><span class="command">theory</span></span> MiniML
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Generalize.html">Generalize</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹expressions›</span>
<span class="keyword1"><span class="command">datatype</span></span>
  expr <span class="main">=</span> Var <span class="quoted">nat</span> <span class="main">|</span> Abs <span class="quoted">expr</span> <span class="main">|</span> App <span class="quoted">expr</span> <span class="quoted">expr</span> <span class="main">|</span> LET <span class="quoted">expr</span> <span class="quoted">expr</span>

<span class="comment1">― ‹type inference rules›</span>
<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">has_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>ctxt<span class="main">,</span> expr<span class="main">,</span> typ<span class="main">]</span> <span class="main">=&gt;</span> bool"</span></span>
                  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword3">(</span>_<span class="keyword3">)</span> <span class="keyword1">|-</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span> <span class="keyword1">::</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>60<span class="main">,</span>0<span class="main">,</span>60<span class="main">]</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  VarI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&lt;|</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> Var <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> AbsI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">(</span>mk_scheme <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> Abs <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> AppI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">-&gt;</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">|]</span> 
         <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> App <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span>
<span class="main">|</span> LETI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">;</span> <span class="main">(</span>gen <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">|-</span></span> LET <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">::</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> has_type.intros <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> Un_upper1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Un_upper2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> is_bound_typ_instance_closed_subst <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> s'_t_equals_s_t<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">.</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">S</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>TVar <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> typ_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> s'_t_equals_s_t <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> s'_a_equals_s_a<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> <span class="main">(</span>free_tv <span class="bound">A</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">S</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>TVar <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">$</span><span class="free">S</span> <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> scheme_list_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> s'_a_equals_s_a <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_s_by_s'<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">|-</span>  
     <span class="free">e</span> <span class="main">::</span> <span class="main">$</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> <span class="main">(</span>free_tv <span class="free">A</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span>free_tv <span class="free">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="free">t</span>  
  <span class="main">⟹</span> <span class="main">$</span><span class="free">S</span> <span class="free">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="main">$</span><span class="free">S</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="main">$</span><span class="free">S</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ssubst<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s'_a_equals_s_a <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> free_tv <span class="free">A</span> <span class="keyword1">Un</span> free_tv <span class="main">(</span><span class="skolem">t2</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="bound">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">t2</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ssubst<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s'_t_equals_s_t <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alpha_A'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">$</span> id_subst <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> scheme_list_substitutions_only_on_free_variables<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_subst_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> alpha_A<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span> <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alpha_A' <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> ssubst<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_o_alpha_typ<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">alpha</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="free">alpha</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_o_alpha_typ'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">alpha</span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>typ<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="free">alpha</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_o_alpha_type_scheme<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">alpha</span><span class="main">)</span> <span class="main">(</span><span class="free">sch</span><span class="main">::</span>type_scheme<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="free">alpha</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S_o_alpha_type_scheme_list<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">alpha</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="free">S</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="free">alpha</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S_o_alpha_type_scheme <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> S'_A_eq_S'_alpha_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span>  
      <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">Un</span> free_tv <span class="free">t</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="bound">A</span> <span class="main">=</span>  
      <span class="main">$</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">Un</span> free_tv <span class="free">t</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">x</span> <span class="keyword1">else</span> TVar <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span>  
         <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S_o_alpha_type_scheme_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> alpha_A<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dom_S'<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> free_tv <span class="free">A</span> <span class="keyword1">Un</span> free_tv <span class="free">t</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="main">⊆</span>  
  free_tv <span class="free">A</span> <span class="keyword1">Un</span> free_tv <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> free_tv_subst dom_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cod_S'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">(</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">)</span><span class="main">.</span>   
   cod <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">Un</span> free_tv <span class="bound">t</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="main">⊆</span>  
   free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">Un</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> free_tv_subst cod_def subset_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> UN_E<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> dom_S' <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> free_tv_of_substitutions_extend_to_scheme_lists <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> free_tv_of_substitutions_extend_to_types <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_S'<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">)</span> <span class="main">(</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">)</span><span class="main">.</span>  
  free_tv <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">:</span> free_tv <span class="bound">A</span> <span class="keyword1">Un</span> free_tv <span class="bound">t</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="bound">n</span> <span class="keyword1">else</span> TVar <span class="bound">n</span><span class="main">)</span> <span class="main">⊆</span>  
  free_tv <span class="bound">A</span> <span class="keyword1">Un</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">Un</span> free_tv <span class="bound">t</span> <span class="keyword1">Un</span> free_tv <span class="main">(</span><span class="main">$</span> <span class="free">S</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> free_tv_subst<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dom_S' <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> cod_S' <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span><span class="main">::</span>typ<span class="main">.</span>  
      <span class="main">(</span>free_tv <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">-</span> free_tv <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span>  
          <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">t1</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Int_free_tv_empty_type<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">::</span>typ<span class="main">.</span> new_tv <span class="free">n</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span> <span class="keyword1">Int</span> free_tv <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> le_add1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Int_free_tv_empty_scheme<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sch</span><span class="main">::</span>type_scheme<span class="main">.</span> new_tv <span class="free">n</span> <span class="bound">sch</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span> <span class="keyword1">Int</span> free_tv <span class="bound">sch</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> le_add1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> 1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_Int_free_tv_empty_scheme_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">::</span>type_scheme list<span class="main">.</span> new_tv <span class="free">n</span> <span class="bound">A</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">y</span><span class="main">}</span> <span class="keyword1">Int</span> free_tv <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">A</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_Int_free_tv_empty_scheme<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_t_le_gen_alpha_t <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
   <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟶</span> gen <span class="free">A</span> <span class="free">t</span> <span class="main">≤</span> gen <span class="free">A</span> <span class="main">(</span><span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> TVar <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="free">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> le_type_scheme_def is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="improper">S</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">:</span> free_tv <span class="free">A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_inverse<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> has_type.intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> has_type_le_env <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> <span class="free">e</span><span class="main">::</span><span class="free">t</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">B</span><span class="main">.</span> <span class="free">A</span> <span class="main">≤</span> <span class="bound">B</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">|-</span> <span class="free">e</span><span class="main">::</span><span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_env_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bound_typ_instance_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">slow</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_env_free_tv <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> free_tv_subset_gen_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">has_type</span><span class="antiquote">}</span></span> is closed w.r.t. substitution›</span>
<span class="keyword1"><span class="command">lemma</span></span> has_type_cl_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">$</span><span class="bound">S</span> <span class="free">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="main">$</span><span class="bound">S</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type.induct<span class="main">)</span>
<span class="comment1">(* case VarI *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type.VarI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_subst_list<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_subst_list<span class="main">)</span>
  <span class="comment1">(* case AbsI *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type.AbsI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="comment1">(* case AppI *)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type.AppI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> spec<span class="main">)</span>
<span class="comment1">(* case LetI *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> replace_s_by_s'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ex_fresh_variable<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?t1.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="improper">A</span> <span class="keyword1">Un</span> free_tv <span class="improper">t</span> <span class="keyword1">then</span> <span class="improper">S</span> <span class="bound">x</span> <span class="keyword1">else</span> TVar <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="improper">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> has_type.LETI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="improper">A</span> <span class="keyword1">Un</span> free_tv <span class="improper">t</span> <span class="keyword1">then</span> <span class="improper">S</span> <span class="bound">x</span> <span class="keyword1">else</span> TVar <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> free_tv <span class="improper">A</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">n</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S'_A_eq_S'_alpha_A<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> S_o_alpha_typ<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> gen_subst_commutes<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> IntE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_S' <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_alpha <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> full_SetCompr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"new_tv <span class="main">(</span><span class="improper">n</span> <span class="main">+</span> <span class="improper">y</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span><span class="main">)</span> "</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"new_tv <span class="main">(</span><span class="improper">n</span> <span class="main">+</span> <span class="improper">y</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="improper">S</span> <span class="improper">t</span><span class="main">)</span> "</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"new_tv <span class="main">(</span><span class="improper">n</span> <span class="main">+</span> <span class="improper">y</span><span class="main">)</span> <span class="improper">A</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"new_tv <span class="main">(</span><span class="improper">n</span> <span class="main">+</span> <span class="improper">y</span><span class="main">)</span> <span class="improper">t</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_not_free_tv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type_le_env<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app_subst_Cons <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> S_compatible_le_scheme_lists<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="W">
<div class="head">
<h1>Theory W</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     HOL/MiniML/W.thy
   Author:    Dieter Nazareth, Wolfgang Naraschewski and Tobias Nipkow
   Copyright  1996 TU Muenchen
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Correctness and completeness of type inference algorithm W"</span></span>

<span class="keyword1"><span class="command">theory</span></span> W
<span class="keyword2"><span class="keyword">imports</span></span> <a href="MiniML.html">MiniML</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> result_W <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst <span class="main">*</span> typ <span class="main">*</span> nat<span class="main">)</span> option"</span></span>

<span class="comment1">― ‹type inference algorithm W›</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">W</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>expr<span class="main">,</span> ctxt<span class="main">,</span> nat<span class="main">]</span> <span class="main">=&gt;</span> result_W"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>  
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> Some<span class="main">(</span> id_subst<span class="main">,</span>   
                                 bound_typ_inst <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> TVar<span class="main">(</span><span class="bound">b</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>   
                                 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">(</span>min_new_bound_tv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>  
                      <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">:=</span> <span class="free">W</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span>FVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span>
                     Some<span class="main">(</span> <span class="bound">S</span><span class="main">,</span> <span class="main">(</span><span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">-&gt;</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">)</span>"</span></span>
  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span><span class="bound">t1</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">:=</span> <span class="free">W</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
                         <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">t2</span><span class="main">,</span><span class="bound">m2</span><span class="main">)</span> <span class="main">:=</span> <span class="free">W</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">(</span><span class="main">$</span><span class="bound">S1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">m1</span><span class="main">;</span>
                         <span class="bound">U</span> <span class="main">:=</span> mgu <span class="main">(</span><span class="main">$</span><span class="bound">S2</span> <span class="bound">t1</span><span class="main">)</span> <span class="main">(</span><span class="bound">t2</span> <span class="main">-&gt;</span> <span class="main">(</span>TVar <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                         Some<span class="main">(</span> <span class="main">$</span><span class="bound">U</span> <span class="main">∘</span> <span class="main">$</span><span class="bound">S2</span> <span class="main">∘</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">U</span> <span class="bound">m2</span><span class="main">,</span> Suc <span class="bound">m2</span><span class="main">)</span> <span class="main">)</span>"</span></span>
  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">(</span>LET <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="bound">S1</span><span class="main">,</span><span class="bound">t1</span><span class="main">,</span><span class="bound">m1</span><span class="main">)</span> <span class="main">:=</span> <span class="free">W</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
                         <span class="main">(</span><span class="bound">S2</span><span class="main">,</span><span class="bound">t2</span><span class="main">,</span><span class="bound">m2</span><span class="main">)</span> <span class="main">:=</span> <span class="free">W</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">(</span><span class="main">(</span>gen <span class="main">(</span><span class="main">$</span><span class="bound">S1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">t1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="main">$</span><span class="bound">S1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">m1</span><span class="main">;</span>
                         Some<span class="main">(</span> <span class="main">$</span><span class="bound">S2</span> <span class="main">∘</span> <span class="bound">S1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">,</span> <span class="bound">m2</span><span class="main">)</span> <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">declare</span></span> Suc_le_lessD <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> has_type_casesE<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> Var <span class="free">n</span> <span class="main">::</span> <span class="free">t</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> Abs <span class="free">e</span> <span class="main">::</span> <span class="free">t</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> App <span class="free">e1</span> <span class="free">e2</span> <span class="main">::</span><span class="free">t</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-</span> LET <span class="free">e1</span> <span class="free">e2</span> <span class="main">::</span><span class="free">t</span>"</span></span>


<span class="comment1">― ‹the resulting type variable is always greater or equal than the given one›</span>
<span class="keyword1"><span class="command">lemma</span></span> W_var_ge <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="bound">n</span> <span class="bound">S</span> <span class="bound">t</span> <span class="bound">m</span><span class="main">.</span> W <span class="free">e</span> <span class="bound">A</span> <span class="bound">n</span>  <span class="main">=</span> Some <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">n</span><span class="main">≤</span><span class="bound">m</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span></span><span class="main">)</span>
<span class="comment1">(* case Var(n) *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="comment1">(* case Abs e *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Suc_leD<span class="main">)</span>
<span class="comment1">(* case App e1 e2 *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_SucI le_trans<span class="main">)</span>
<span class="comment1">(* case LET e1 e2 *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> W_var_ge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> W_var_geD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">t</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> W <span class="free">e</span> <span class="free">A</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">≤</span><span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_compatible_W<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">A</span> <span class="main">⟹</span> Some <span class="main">(</span><span class="free">S</span><span class="main">,</span><span class="free">t</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> W <span class="free">e</span> <span class="free">A</span> <span class="free">n</span> <span class="main">⟹</span> new_tv <span class="free">m</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> W_var_geD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_scheme_list_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_tv_bound_typ_inst_sch <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"new_tv <span class="free">n</span> <span class="free">sch</span> <span class="main">⟶</span> new_tv <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">(</span>min_new_bound_tv <span class="free">sch</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bound_typ_inst <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> TVar <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">sch</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_le<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> add_le_mono<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> new_tv_bound_typ_inst_sch <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">― ‹resulting type variable is new›</span>
<span class="keyword1"><span class="command">lemma</span></span> new_tv_W <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">A</span> <span class="bound">S</span> <span class="bound">t</span> <span class="bound">m</span><span class="main">.</span> new_tv <span class="bound">n</span> <span class="bound">A</span> <span class="main">⟶</span> W <span class="free">e</span> <span class="bound">A</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⟶</span>     
               new_tv <span class="bound">m</span> <span class="bound">S</span> <span class="main">∧</span> new_tv <span class="bound">m</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Var <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> new_tv_nth_nat_A<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Abs <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst new_tv_Suc_list <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>FVar <span class="improper">n</span><span class="main">)</span> <span class="main">#</span><span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tv_subst new_tv_Suc_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> App <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S1 t1 n1 S2 t2 n2 S3<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="improper">S1</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def rotate_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_subst_comp_2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_subst_comp_2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> new_tv_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> new_tv_subst_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rotate_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> W_var_geD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> new_scheme_list_le new_tv_subst_scheme_list lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le <span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> new_tv_subst_le<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> mgu_new<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> W_var_geD
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> new_tv_le<span class="main"><span class="main">]</span></span> new_tv_subst_te 
      new_tv_subst_scheme_list new_scheme_list_le new_tv_le<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> W_var_geD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> new_tv_subst_scheme_list new_scheme_list_le new_tv_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> new_tv_subst_var<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> mgu_new<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> W_var_geD
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lessI <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> new_tv_le<span class="main"><span class="main">]</span></span> new_tv_subst_te 
      new_tv_subst_scheme_list new_scheme_list_le new_tv_le<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> W_var_geD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> new_tv_subst_scheme_list new_scheme_list_le new_tv_le<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> LET <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> notE impE<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">tactic</span> <span class="quoted">"assume_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">2</span>"</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> new_tv_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> W_var_ge<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> free_tv_subst<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">best</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_tv_subst_comp_2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> W_var_ge <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> new_tv_subst_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_bound_typ_inst1 <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">∉</span> free_tv <span class="free">sch</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">v</span> <span class="main">∈</span> free_tv <span class="main">(</span>bound_typ_inst <span class="main">(</span>TVar <span class="main">∘</span> <span class="free">S</span><span class="main">)</span> <span class="free">sch</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="free">S</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">sch</span></span>"</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> free_tv_bound_typ_inst1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> free_tv_W <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">A</span> <span class="bound">S</span> <span class="bound">t</span> <span class="bound">m</span> <span class="bound">v</span><span class="main">.</span> W <span class="free">e</span> <span class="bound">A</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⟶</span>             
          <span class="main">(</span><span class="bound">v</span><span class="main">∈</span>free_tv <span class="bound">S</span> <span class="main">∨</span> <span class="bound">v</span><span class="main">∈</span>free_tv <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">v</span><span class="main">&lt;</span><span class="bound">n</span> <span class="main">⟶</span> <span class="bound">v</span><span class="main">∈</span>free_tv <span class="bound">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v</span> <span class="main">:</span> free_tv <span class="main">(</span><span class="improper">A</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_bound_typ_inst1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">case</span></span> Abs <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S t n1 v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"FVar <span class="improper">n</span> <span class="main">#</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">bestsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cod_app_subst <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">case</span></span> App <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S t n1 S1 t1 n2 S2 v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="comment1">(* second case *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI <span class="main"><span class="keyword3">|</span></span> <span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rotate_Some o_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> W_var_geD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> W_var_geD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span> <span class="main">(</span><span class="operator">frule</span> less_le_trans<span class="main">)</span> <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_comp_subst <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> mgu_free<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> free_tv_comp_subst <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> mgu_free<span class="main"><span class="main">]</span></span> codD free_tv_app_subst_te <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> less_le_trans less_not_refl2 subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span> <span class="main">(</span><span class="operator">frule</span> less_le_trans<span class="main">)</span> <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mgu_free<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mgu_free codD free_tv_subst_var <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> free_tv_app_subst_te <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> less_le_trans subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> LET <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S1 t1 n2 S2 t2 n3 v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rotate_tac</span> -1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span><span class="operator">erule_tac</span>  x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> codD free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> free_tv_o_subst <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> W_var_ge <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> codD free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> W_var_ge <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> weaken_A_Int_B_eq_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> weaken_not_elem_A_minus_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">― ‹correctness of W with respect to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">has_type</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> W_correct_lemma <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="bound">S</span> <span class="bound">t</span> <span class="bound">m</span> <span class="bound">n</span> <span class="main">.</span> new_tv <span class="bound">n</span> <span class="bound">A</span> <span class="main">⟶</span> Some <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">=</span> W <span class="free">e</span> <span class="bound">A</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="main">$</span><span class="bound">S</span> <span class="bound">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span></span><span class="main">)</span>
<span class="comment1">(* case Var n *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type.VarI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bound_typ_instance<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="comment1">(* case Abs e *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_subst_list <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>mk_scheme <span class="main">(</span>TVar <span class="improper">n</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type.AbsI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> le_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> le_SucI<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> new_scheme_list_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> notE impE<span class="main"><span class="keyword3">,</span></span> <span class="operator">tactic</span> <span class="quoted">"assume_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_numeral">2</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="comment1">(* case App e1 e2 *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S1 t1 n1 S2 t2 n2 S3<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?t2.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S3</span> <span class="improper">t2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> has_type.AppI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> app_subst_TVar <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app_subst_Fun <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="improper">S3</span> <span class="main">(</span><span class="improper">t2</span> <span class="main">-&gt;</span> <span class="main">(</span>TVar <span class="improper">n2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span><span class="improper">S3</span> <span class="main">(</span><span class="main">$</span><span class="improper">S2</span> <span class="improper">t1</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subst<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> o_def<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> has_type_cl_sub <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> has_type_cl_sub <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> o_def has_type_cl_sub eq_sym_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type_cl_sub <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> new_tv_W<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> conjunct1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> new_tv_subst_scheme_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> new_scheme_list_le<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> W_var_ge<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> thin_rl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="comment1">(* case Let e1 e2 *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="comment1">(*by (rename_tac "w q m1 S1 t1 m2 S2 t n2" 1); *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> S1 t1 m1 S2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?t1.0</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S2</span> <span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> has_type.LETI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type_cl_sub <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_subst_commutes <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> app_subst_Cons <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subst<span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> thin_rl<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"gen <span class="main">(</span><span class="main">$</span><span class="improper">S1</span> <span class="improper">A</span><span class="main">)</span> <span class="improper">t1</span> <span class="main">#</span> <span class="main">$</span> <span class="improper">S1</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> new_tv_W<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> new_tv_Cons new_tv_compatible_W new_tv_compatible_gen new_tv_subst_scheme_list<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> weaken_A_Int_B_eq_empty<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> weaken_not_elem_A_minus_B<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> free_tv_W free_tv_gen_cons free_tv_le_new_tv new_tv_W<span class="main">)</span>

<span class="comment1">― ‹Completeness of W w.r.t. <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">has_type</span><span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">lemma</span></span> W_complete_lemma <span class="main">[</span><span class="operator">rule_format</span> <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">no_asm</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S'</span> <span class="bound">A</span> <span class="bound">t'</span> <span class="bound">n</span><span class="main">.</span> <span class="main">$</span><span class="bound">S'</span> <span class="bound">A</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="bound">t'</span> <span class="main">⟶</span> new_tv <span class="bound">n</span> <span class="bound">A</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> W <span class="free">e</span> <span class="bound">A</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                       <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="main">$</span><span class="bound">S'</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">$</span><span class="bound">R</span> <span class="main">(</span><span class="main">$</span><span class="bound">S</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="main">=</span> <span class="main">$</span><span class="bound">R</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="comment1">(* case Var n *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type_casesE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bound_typ_instance<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> <span class="quoted">"S"</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="improper">n</span> <span class="keyword1">then</span> <span class="improper">S'</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">S</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="improper">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_typ_inst_composed_subst <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> new_tv_nth_nat_A o_def nth_subst 
      <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bound_typ_inst_composed_subst<span class="main">)</span>

<span class="comment1">(* case Abs e *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type_casesE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="improper">n</span> <span class="keyword1">then</span> <span class="improper">t1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="improper">S'</span> <span class="bound">x</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>FVar <span class="improper">n</span><span class="main">)</span> <span class="main">#</span><span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Suc <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">bestsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mk_scheme_injective <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>

<span class="comment1">(* case App e1 e2 *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type_casesE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t2</span> <span class="main">-&gt;</span> <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">R</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span> new_tv_W <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span> new_scheme_list_le new_tv_subst_scheme_list<span class="main">)</span>

<span class="comment1">(** LEVEL 33 **)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="improper">ma</span> <span class="keyword1">then</span> <span class="improper">t'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span><span class="main">:</span> <span class="main">(</span>free_tv <span class="improper">t</span> <span class="main">-</span> free_tv <span class="improper">Sa</span><span class="main">)</span> <span class="keyword1">then</span> <span class="improper">R</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">Ra</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="improper">Sa</span> <span class="improper">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="improper">ma</span> <span class="keyword1">then</span> <span class="improper">t'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span><span class="main">:</span> <span class="main">(</span>free_tv <span class="improper">t</span> <span class="main">-</span> free_tv <span class="improper">Sa</span><span class="main">)</span> <span class="keyword1">then</span> <span class="improper">R</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">Ra</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="improper">ta</span> <span class="main">-&gt;</span> <span class="main">(</span>TVar <span class="improper">ma</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="improper">ma</span> <span class="keyword1">then</span> <span class="improper">t'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span><span class="main">:</span> <span class="main">(</span>free_tv <span class="improper">t</span> <span class="main">-</span> free_tv <span class="improper">Sa</span><span class="main">)</span> <span class="keyword1">then</span> <span class="improper">R</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="improper">Ra</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">$</span> <span class="improper">Sa</span> <span class="improper">t</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">$</span> <span class="improper">Ra</span> <span class="improper">ta</span><span class="main">)</span> <span class="main">-&gt;</span> <span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ssubst<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_comp_te<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> eq_free_eq_subst_te<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">na</span> <span class="main">≠</span><span class="improper">ma</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">best</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_W sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span> new_tv_not_free_tv new_tv_le<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">na</span><span class="main">:</span>free_tv <span class="improper">Sa</span>"</span></span><span class="main">)</span>
    <span class="comment1">(* n1 ∉ free_tv S1 *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> not_free_impl_id<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="comment1">(* na : free_tv Sa *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> A1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_comp_scheme_list<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> eq_subst_scheme_list_eq_free<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> free_tv_W free_tv_le_new_tv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_W<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">na</span><span class="main">:</span>dom <span class="improper">Sa</span>"</span></span><span class="main">)</span>
    <span class="comment1">(* na ∉ dom Sa *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
    <span class="comment1">(* na : dom Sa *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> eq_free_eq_subst_te<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">nb</span> <span class="main">≠</span> <span class="improper">ma</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> new_tv_W<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> new_tv_subst_scheme_list<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> new_scheme_list_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_W new_tv_not_free_tv <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cod_def free_tv_subst<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cod_def free_tv_subst<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> eq_free_eq_subst_te<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> strip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">na</span> <span class="main">≠</span> <span class="improper">ma</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> new_tv_W<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_scheme_list_le new_tv_subst_scheme_list new_tv_W new_tv_not_free_tv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="improper">na</span><span class="main">:</span> free_tv <span class="improper">t</span> <span class="main">-</span> free_tv <span class="improper">Sa</span>"</span></span><span class="main">)</span>
    <span class="comment1">(* case na ∉ free_tv t - free_tv Sa *)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span>
    <span class="comment1">(* case na : free_tv t - free_tv Sa *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> A1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">$</span> <span class="improper">R</span> <span class="main">(</span><span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_comp_scheme_list<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> eq_subst_scheme_list_eq_free<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> free_tv_W free_tv_le_new_tv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_W<span class="main">)</span>
    <span class="comment1">(** LEVEL 73 **)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_option_bind<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mgu_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>  
    <span class="comment1">(** LEVEL 78 *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mgu_mg<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">Rb</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">ma</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fun_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_sym_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> A1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">$</span> <span class="improper">Sa</span> <span class="main">(</span><span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def eq_sym_conv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> sym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_free_eq_subst_scheme_list<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ma</span> <span class="main">≠</span> <span class="improper">na</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> new_tv_W<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> new_tv_subst_scheme_list<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> new_scheme_list_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sym <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> W_var_geD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> n <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> new_tv_W<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹
    <span class="main">(</span><span class="entity">fast_tac</span> <span class="main">(</span><span class="entity">put_claset</span> <span class="main">(</span><span class="entity">claset_of</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">theory_context</span> <a href="../../HOL/HOL/Fun.html">Fun</a><span class="antiquote">}</span></span></span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
      <span class="entity">addDs</span> <span class="main">[</span><span class="entity">sym</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> W_var_geD<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> new_scheme_list_le<span class="antiquote">}</span></span></span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> codD<span class="antiquote">}</span></span></span><span class="main">,</span>
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> new_tv_not_free_tv<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span> <span class="inner_numeral">2</span><span class="main">)</span>›</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">na</span><span class="main">:</span> free_tv <span class="improper">t</span> <span class="main">-</span> free_tv <span class="improper">Sa</span>"</span></span><span class="main">)</span>
    <span class="comment1">(* case na ∉ free_tv t - free_tv Sa *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="comment1">(* case na : free_tv t - free_tv Sa *)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> free_tv_app_subst_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> codD trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_comp_scheme_list<span class="main"><span class="main">]</span></span>
      eq_subst_scheme_list_eq_free 
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_tv_subst dom_def<span class="main">)</span>
    <span class="comment1">(* case Let e1 e2 *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> has_type_casesE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">S'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> notE impE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">R</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"gen <span class="main">(</span><span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span><span class="main">)</span> <span class="improper">t</span> <span class="main">#</span> <span class="main">$</span> <span class="improper">S</span> <span class="improper">A</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_type_le_env<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_bound_typ_instance<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> new_tv_compatible_W<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> new_tv_compatible_gen new_tv_subst_scheme_list new_tv_W<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">Ra</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def subst_comp_scheme_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">theorem</span></span> W_complete<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">|-</span> <span class="free">e</span> <span class="main">::</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> W <span class="free">e</span> <span class="main">[]</span> <span class="free">n</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">t</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="main">(</span><span class="main">∃</span><span class="bound">R</span><span class="main">.</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">$</span> <span class="bound">R</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> W_complete_lemma app_subst_Nil new_tv_Nil<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>